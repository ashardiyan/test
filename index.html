<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Al Rehman Electronics</title>
  <meta name="theme-color" content="#161B22" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    /* ...styles unchanged... */
    :root {
      --bg1: #0C1220;
      --bg2: #161B22;
      --bg3: #212936;
      --accent: #2563EB;
      --accent-hover: #164eab;
      --accent2: #06B6D4;
      --accent2-hover: #1095b7;
      --gray: #AEB9C7;
      --text: #F3F7FF;
      --text-muted: #B0B9C6;
      --radius: 16px;
      --radius-card: 13px;
      --shadow: 0 8px 32px 0 rgba(60,120,220,0.17);
      --shadow-soft: 0 2px 8px rgba(40,98,180,.11);
      --danger: #ef4444;
      --success: #10b981;
      --rounded-btn: 10px;
      --button-skyblue: #06B6D4;
      --button-gradient: linear-gradient(90deg, #06B6D4 40%, #2563EB 100%);
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      font-size: 17px;
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
      color: var(--text);
      min-height: 100vh;
    }
    body { display:flex; flex-direction:column; min-height:100vh; }
    .container { max-width:640px; margin:0 auto; padding:34px 12px 54px; width:100%; box-sizing:border-box; }
    header { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:20px; gap:10px; }
    .logo-wrap { display:flex; align-items:center; gap:14px; }
    .app-logo { width:50px; height:50px; border-radius:18px; background:linear-gradient(135deg,var(--accent),var(--accent2)75%); display:flex; align-items:center; justify-content:center; font-size:2.11rem; box-shadow:var(--shadow-soft); color:#fff; font-weight:700; overflow: hidden; }
    .app-title { font-weight:900; font-size:1.7rem; line-height:1.13; letter-spacing:-1px; color:var(--text); margin-left:2px; }
    .top-controls { display:flex; align-items:center; gap:10px; }
    button.icon-btn { background:none; border:none; color:var(--accent2); font-size:1.23rem; padding:8px 10px; border-radius:9px; cursor:pointer; outline:none; }
    button#settingsBtn { font-size:1.33rem; color:var(--text); background:#1b2430; padding:8px 11px; border-radius:9px; box-shadow:0 1px 6px #0008; }
    #installPromptBtn, #installAsAppBtn { display:none; margin-left:12px; font-size:.99em; padding:8px 14px; border-radius:8px; background:linear-gradient(91deg,var(--accent2),var(--accent)); color:#fff; font-weight:700; border:none; cursor:pointer; box-shadow:0 1px 11px #2e5fad23; }
    #mobileInstallInstructions { display:none; margin-left:10px; padding:8px 10px; border-radius:8px; background:#1a2233; color:var(--accent2); font-size:.93em; font-style:italic; box-shadow:0 2px 8px #222c3d22; max-width:310px; line-height:1.45; }

    .main-content { display:flex; flex-direction:column; gap:0; align-items:stretch; width:100%; }
    .card { background:var(--bg2); border-radius:var(--radius-card); box-shadow:var(--shadow); margin-bottom:32px; padding:1.6rem 1.6rem 1.3rem; animation:fadeUp .7s cubic-bezier(.43,.8,.52,1.18); opacity:0; transform:translateY(36px); animation-fill-mode:forwards; border:none; transition:box-shadow .15s, background .16s; }
    .card.show { opacity:1; transform:none; }
    @keyframes fadeUp { 0%{opacity:0;transform:translateY(45px);}65%{opacity:.6;}100%{opacity:1;transform:translateY(0);} }
    .products-top-actions { display:flex; align-items:flex-end; gap:11px; margin-bottom:17px; flex-wrap:wrap; }
    .product-search-wrap { position:relative; flex:1 1 192px; max-width:370px; margin-bottom:0; }
    #productSearch { width:100%; border-radius:8px; border:none; background:var(--bg3); color:var(--text); font-size:1.06em; padding:9px 38px 9px 15px; outline:none; box-shadow:0 1.5px 6px #35455a23; transition:border .13s; border:1.5px solid #23314a; }
    #productSearch:focus { border-color:var(--accent); }
    .search-icon { position:absolute; right:13px; top:50%; transform:translateY(-50%); color:var(--accent2); font-size:1.15em; opacity:0.7; pointer-events:none; }

    /* Multi-select controls */
    #multiSelectControls {
      display: none;
      gap: 10px;
      margin-top: 6px;
      margin-left: 2px;
      align-items: center;
    }
    #multiSelectControls.active { display: flex; }
    #deleteSelectedBtn {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 18px;
      font-size: 0.97em;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 1px 7px #ef444433;
      transition: background .14s, box-shadow .13s;
      margin-left: 6px;
    }
    #deleteSelectedBtn:disabled { background: #ce5353a0; cursor: not-allowed; }
    #selectAllCheckbox { accent-color: var(--accent2); margin-left:4px; margin-right:0; transform: scale(1.1); }

    .product-list { margin:0; padding:0; list-style:none; }

    /* Stylish Skyblue Buttons */
    .rounded-sky-btn {
      background: var(--button-gradient);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 20px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1.5px 10px #2eb9f733;
      transition: background .15s, box-shadow .14s, transform .10s;
      outline: none;
      margin: 2px 0;
      letter-spacing: 0.02em;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent; 
      -webkit-user-select: none;
      user-select: none;
    }
    .rounded-sky-btn:hover,
    .rounded-sky-btn:active {
      background: linear-gradient(90deg, #0e9fec, #2563EB 95%);
      box-shadow: 0 3px 16px #43c7fc43;
      transform: translateY(-1.5px) scale(1.03);
    }
    .rounded-sky-btn.cancel {
      background: #18313c;
      color: var(--button-skyblue);
      border: 1.5px solid var(--button-skyblue);
      font-weight: 600;
    }
    .rounded-sky-btn.cancel:hover, .rounded-sky-btn.cancel:active {
      background: #22384a;
      color: #fff;
      border-color: #1095b7;
    }
    /* Biometric Button */
    #biometricUnlockBtn {
      background: linear-gradient(90deg, #10b981 30%, #059669 100%);
      width: 100%;
      margin-top: 10px;
      display: none; /* hidden by default */
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    /* Remove tap highlight globally */
    button, .rounded-sky-btn, .prod-actions button, .modal-close, input[type="button"], input[type="submit"], .remove-photo-btn {
      -webkit-tap-highlight-color: transparent !important;
      tap-highlight-color: transparent !important;
      outline: none !important;
    }
    button:focus, .rounded-sky-btn:focus, .prod-actions button:focus, .modal-close:focus, .remove-photo-btn:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    input[type="button"]:focus, input[type="submit"]:focus { outline:none !important; box-shadow:none !important; }
    .card button:focus-visible, .card button:focus, .prod-actions button:focus, .rounded-sky-btn:focus, .remove-photo-btn:focus {
      outline: none !important;
      box-shadow: none !important;
      border-color: inherit !important;
      background-clip: padding-box;
    }
    .prod-card, .prod-card * {
      -webkit-tap-highlight-color: transparent !important;
      tap-highlight-color: transparent !important;
    }
    button:focus:not(:focus-visible), .rounded-sky-btn:focus:not(:focus-visible), .modal-close:focus:not(:focus-visible), .remove-photo-btn:focus:not(:focus-visible) {
      outline: none !important;
      box-shadow: none !important;
    }

    .modal-file-upload-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 13px;
      margin-top: 2px;
    }
    .modal-file-label {
      font-weight: 600;
      font-size: .96em;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
    }
    .modal-file-upload-btn {
      display: inline-block;
      position: relative;
    }
    .modal-file-upload-btn input[type="file"] {
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    /* --- Photo REMOVE X button --- */
    .remove-photo-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      font-size: 1.18em;
      font-weight: bold;
      margin-left: 4px;
      cursor: pointer;
      transition: background 0.14s, color 0.12s;
      box-shadow: 0 1px 5px #ef444433;
      z-index: 2;
      vertical-align: middle;
    }
    .remove-photo-btn:hover, .remove-photo-btn:focus {
      background: #ce3737;
      color: #fff;
    }
    .photo-preview-wrap {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .photo-preview-img-thumb {
      max-width: 42px;
      max-height: 42px;
      border-radius: 7px;
      object-fit: cover;
      border: 2px solid var(--accent2-hover);
      margin-right: 2px;
      background: #273855;
      display: block;
    }

    .prod-card { background:var(--bg3); border-radius:13px; margin-bottom:16px; box-shadow:0 2px 10px #2c345128; display:flex; gap:19px; align-items:center; padding:18px 20px; position:relative; animation:fadeUp .35s; opacity:0; transform:translateY(25px); animation-fill-mode:forwards; cursor:pointer; border:2px solid transparent; transition:box-shadow .14s, border-color .16s; }
    .prod-card.show { opacity:1; transform:none; }
    .prod-card:hover { border-color:var(--accent2); box-shadow:0 6px 24px #18346023; }
    .prod-img { min-width:43px; width:43px; height:43px; border-radius:10px; background:#21293f; flex-shrink:0; display:flex; align-items:center; justify-content:center; color:var(--accent2); font-size:1.45em; overflow:hidden; }
    .prod-photo-thumb { max-width:100%; max-height:43px; border-radius:8px; object-fit:cover; background:#232b36; display:block; }
    .prod-name { font-weight:700; font-size:1.15em; color:var(--text); letter-spacing:-0.5px; margin-bottom:1.5px; }
    .prod-details { color:var(--gray); font-size:.97em; margin-top:2px; margin-bottom:2px; }
    .prod-actions { margin-left:auto; display:flex; gap:7px; align-items:center; }
    .prod-actions button { background:none; border:none; color:var(--accent2); font-size:1.32em; cursor:pointer; transition:color .13s; border-radius:5px; padding:3px 5px; outline:none; }
    .prod-select-checkbox {
      margin-right: 18px;
      transform: scale(1.25);
      accent-color: var(--accent2);
      cursor:pointer;
    }
    .prod-card.selected { border-color: var(--danger); background: #1b1d2d; box-shadow: 0 4px 16px #ef44441a;}
    .prod-card .prod-select-checkbox:focus { outline: 2px solid var(--accent2); outline-offset:1px;}

    .no-products { text-align:center; color:var(--text-muted); font-size:1.12em; margin:34px 0 14px 0; letter-spacing:.01em; }
    .modal-backdrop { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(18,23,32,0.92); z-index:4999; display:flex; align-items:center; justify-content:center; opacity:1; visibility:visible; transition:opacity .21s; }
    .modal-backdrop.hide { opacity:0; visibility:hidden; pointer-events:none; }
    .modal { min-width:320px; max-width:98vw; background:var(--bg2); border-radius:var(--radius-card); box-shadow:var(--shadow); z-index:6000; padding:36px 22px 23px 22px; animation:fadeUp .4s; display:flex; flex-direction:column; align-items:stretch; position:relative; }
    .modal h3 { margin:0 0 18px 0; color:var(--accent2); text-align:center; font-weight:800; font-size:1.26em; letter-spacing:-.2px; }
    .modal-close { position:absolute; top:13px; right:14px; background:none; border:none; color:var(--accent2); font-size:1.24em; cursor:pointer; font-weight:bold; outline:none; }
    .modal label { font-weight:600; font-size:.96em; color:var(--text-muted); margin-bottom:4px; }
    .modal input[type=text], .modal input[type=number], .modal input[type=file], .modal input[type=password], .modal textarea { border-radius:7px; border:1.5px solid #253048; background:var(--bg3); color:var(--text); font-size:1em; padding:8px 11px; margin-bottom:13px; margin-top:2px; outline:none; width:100%; box-sizing:border-box; transition:border .13s; }
    .modal textarea { min-height:54px; resize:vertical; }
    .modal-btnbar { display:flex; align-items:center; justify-content:flex-end; gap:13px; margin-top:6px; }
    .modal button[type=submit] { background:linear-gradient(95deg,var(--accent2),var(--accent)); color:#fff; padding:11px 22px; font-size:1em; border:none; border-radius:8px; font-weight:700; cursor:pointer; box-shadow:0 2px 10px #1b314e28; margin:6px 0; transition:background .14s; outline:none; }
    .modal .error { font-size:.98em; color:var(--danger); margin-bottom:7px; min-height:18px; text-align:left; }
    #detailModal .prod-detail-photo { display:block; width:124px; height:124px; object-fit:cover; border-radius:19px; margin:6px auto 0 auto; box-shadow:0 2px 12px #1b314e22; background:#21293f; }

    /* --- Show/hide password button styles (for login screen) --- */
    .show-password-wrap {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
    }
    #showLoginPINBtn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--accent2);
      cursor: pointer;
      font-size: 1.11em;
      opacity: 0.79;
      padding: 2px 7px;
      border-radius: 8px;
      z-index: 5;
      user-select: none;
      -webkit-tap-highlight-color: transparent !important;
      outline: none !important;
    }
    #showLoginPINBtn:active, #showLoginPINBtn:focus {
      background: #1f2336;
      color: var(--accent2-hover);
      outline: none !important;
      box-shadow: none !important;
    }

    body.modal-open {
      overflow: hidden !important;
      position: fixed !important;
      width: 100vw;
    }
    body.detail-modal-open {
      overflow: hidden !important;
    }

    @media (max-width:650px){
      .container{padding:14px 1vw 23px 1vw;}
      .card{padding:.8rem .4rem 1.05rem .75rem;}
      .app-title{font-size:1.2rem;}
      .prod-card{padding:12px 7px;}
      .modal{padding:14vw 3vw 7vw 3vw; min-width:unset;}
      #detailModal .prod-detail-photo{ width:74px; height:74px;}
      #mobileInstallInstructions{max-width:94vw;font-size:0.96em;}
      #multiSelectControls{font-size:0.99em; flex-wrap:wrap;}
      .photo-preview-img-thumb { max-width:32px; max-height:32px; }
      .remove-photo-btn { width:22px; height:22px; font-size:1em;}
    }
    ::selection{background:var(--accent2); color:#fff;}
    a{color:var(--accent);}
    .hidden { display:none !important; }
    /* Style for keep-logged-in toggle */
    .keep-logged-toggle {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-top: 8px;
      user-select: none;
      font-size: .99em;
      color: var(--text-muted);
      cursor: pointer;
    }
    .keep-logged-toggle input[type="checkbox"] {
      accent-color: var(--accent2);
      transform: scale(1.13);
      margin-right: 2px;
    }
    #timeoutNotice {
      font-size: .97em;
      color: var(--accent2);
      margin-top: 11px;
      text-align: center;
      display: none;
      font-weight: 600;
      background: #122447;
      padding: 8px 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="login-modal" style="position:fixed; inset:0; z-index:7000; background:rgba(22,27,34,0.89); display:flex; justify-content:center; align-items:center;">
    <form class="login-dialog modal" id="loginForm" autocomplete="off" novalidate style="max-width:380px;">
      <button class="modal-close" type="button" id="loginCloseBtn" title="Close" aria-label="Close dialog" role="button" style="display:none">‚úñ</button>
      <h3 style="text-align:center;color:var(--accent2);margin-bottom:12px">üîê Dealer Login</h3>
      <div class="error input-error" id="login-error" style="min-height:18px;margin-bottom:8px"></div>

      <label id="pinLabel" for="loginPIN">Create a secure PIN / Password</label>
      <div class="show-password-wrap">
        <input type="password" id="loginPIN" minlength="4" maxlength="32" required placeholder="Set PIN or password" autocomplete="new-password" />
        <button type="button" id="showLoginPINBtn" title="Show/Hide PIN" tabindex="-1" aria-label="Show password" style="display:inline-flex;align-items:center;">
          <span id="showLoginPINBtnIcon" aria-hidden="true">&#128065;</span>
        </button>
      </div>

      <label class="keep-logged-toggle" title="If checked, you stay logged in for 5 minutes unless the app is closed or device is locked.">
        <input type="checkbox" id="keepLoggedInToggle" />
        <span>Keep me logged in for 5 Minutes</span>
      </label>
      <div id="timeoutNotice"></div>

      <div style="display:flex; flex-direction:column; gap:10px; align-items:center; width:100%; margin-top:10px;">
        <button type="submit" id="loginBtn" style="width:100%;">Set PIN</button>
        <button type="button" id="biometricUnlockBtn" class="rounded-sky-btn" title="Unlock with Fingerprint">
           üëÜ Unlock with Fingerprint
        </button>
        <button type="button" id="forgotBtn" style="display:none; background:transparent; border:1px solid #253048; color:var(--text); padding:9px 12px; border-radius:8px; cursor:pointer;">Forgot</button>
      </div>

      <small style="display:block;margin-top:12px;color:var(--text-muted);">All data is stored locally in your browser. PIN is hashed before saving.</small>
    </form>
  </div>

  <div id="dealerApp" class="" style="display:none;">
    <div class="container">
      <header>
        <div class="logo-wrap">
          <div class="app-logo" title="Al Rahman Electronics" style="padding:0;">
            <img src="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true" alt="App Logo" style="width:100%;height:100%;border-radius:16px;object-fit:cover;background:#fff;border:none;"/>
          </div>
          <span class="app-title">Al Rahman Electronics</span>
        </div>
        <div class="top-controls">
          <button id="installPromptBtn" title="Install as App">üì≤ Install</button>
          <button id="installAsAppBtn" title="Install as App (force)">üõ†Ô∏è</button>
          <button id="settingsBtn" title="Settings (‚ãÆ)">‚ãÆ</button>
          <span id="mobileInstallInstructions"></span>
        </div>
      </header>

      <div class="main-content">
        <section class="card" style="animation-delay:.06s">
          <div class="products-top-actions">
            <div class="product-search-wrap">
              <input type="search" placeholder="Search by name, category, or note..." id="productSearch" autocomplete="off" />
              <span class="search-icon">&#128269;</span>
            </div>
            <button type="button" id="addProductBtn" class="rounded-sky-btn">+ Add</button>
            <button type="button" id="exportBtn" class="rounded-sky-btn">Export</button>
            <button type="button" id="importBtn" class="rounded-sky-btn">Import</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
          <div id="multiSelectControls">
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="selectAllCheckbox" title="Select all" />
              <span style="user-select:none;">Select all</span>
            </label>
            <button type="button" id="deleteSelectedBtn" disabled>üóëÔ∏è Delete Selected</button>
            <span id="selectedCountText" style="color:var(--danger);font-weight:600;font-size:0.99em;"></span>
          </div>
          <ul class="product-list" id="productList"></ul>
          <div class="no-products" id="noProducts" style="display:none">No products yet. Click <b>+ Add</b> to get started!</div>
        </section>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="productModalBackdrop">
    <form class="modal" id="productModal" autocomplete="off">
      <button class="modal-close" type="button" id="closeModalBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3 id="modalTitle">Add Product</h3>
      <div class="error" id="modalError" style="min-height:18px"></div>
      <label for="prodName">Name</label>
      <input type="text" id="prodName" required maxlength="64" />
      <label for="prodMrp">MRP (‚Ç®)</label>
      <input type="number" id="prodMrp" min="0" max="100000" step="0.01" required />
      <label for="prodCost">Cost Price (‚Ç®)</label>
      <input type="number" id="prodCost" min="0" max="100000" step="0.01"/>
      <label for="prodQty">Quantity</label>
      <input type="number" id="prodQty" min="0" max="100000" required />
      <label for="prodCategory">Category</label>
      <input type="text" id="prodCategory" maxlength="32" />
      <label for="prodNotes">Notes</label>
      <textarea id="prodNotes" maxlength="120" placeholder=""></textarea>
      <span class="modal-file-label">Photo <span title="Base64 photos use much more space than compressed images. Large images may slow the app. Compressed automatically." style="font-size:1.1em;color:var(--accent2)">[auto-compressed]</span></span>
      <div class="modal-file-upload-wrap" id="fileUploadWrap">
        <span class="modal-file-upload-btn rounded-sky-btn" id="uploadBtnText">
          <svg width="18" height="18" style="margin-right:6px;vertical-align:-4px" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <span id="uploadBtnInnerText">Choose Image</span>
          <input type="file" id="prodPhoto" accept="image/*" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;"/>
        </span>
        <span id="prodPhotoFileContainer" class="photo-preview-wrap" style="min-width:1em;"></span>
        <span id="prodPhotoFileName" style="color:var(--text-muted);font-size:.99em;"></span>
      </div>
      <div class="modal-btnbar">
        <button type="submit" id="saveProductBtn" class="rounded-sky-btn">Save</button>
      </div>
      <div id="imageCompressMsg" style="font-size:.99em;color:var(--text-muted);margin-top:10px;user-select:none;display:none"></div>
    </form>
  </div>

  <div class="modal-backdrop hide" id="deleteModalBackdrop">
    <form class="modal" id="deleteModal">
      <button class="modal-close" type="button" id="closeDeleteBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>Delete Product</h3>
      <div style="margin:11px 0 17px 0">Are you sure you want to delete <b id="deleteName"></b>?</div>
      <div class="modal-btnbar">
        <button type="button" id="cancelDeleteBtn" class="rounded-sky-btn cancel">Cancel</button>
        <button type="submit" style="background:var(--danger);border-radius:10px;padding:10px 22px;color:#fff;border:none;font-weight:700;box-shadow:0 2px 10px #1b314e28;transition:background .14s;outline:none;">Yes, Delete</button>
      </div>
    </form>
  </div>

  <div class="modal-backdrop hide" id="detailModalBackdrop">
    <div class="modal" id="detailModal" tabindex="-1">
      <button class="modal-close" type="button" id="closeDetailModalBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>Product Details</h3>
      <div id="detailModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="settingsBackdrop">
    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <button class="modal-close" type="button" id="closeSettingsBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3 id="settingsTitle">Settings</h3>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">Account</div>
            <div style="color:var(--text-muted);font-size:.94em;">Logout or reset your PIN</div>
          </div>
        </div>

        <button id="logoutBtn" style="padding:10px;border-radius:8px;border:none;background:#2b2f3a;color:var(--text);cursor:pointer;">üîí Logout</button>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700; display:flex; align-items:center; gap:6px;">
          Fingerprint / Face ID
        </div>
        <button id="setupBiometricBtn" class="rounded-sky-btn" style="background:#2b2f3a; border:1px solid #364052;">
           üëÜ Setup Fingerprint
        </button>
        <div style="color:var(--text-muted);font-size:.85em;margin-bottom:6px;">
           Enable easy unlock using your device's sensor.
        </div>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700">Reset PIN</div>
        <div style="color:var(--text-muted);font-size:.93em;margin-bottom:6px;">Enter your current PIN, then choose a new one.</div>

        <label for="oldPin">Current PIN</label>
        <input type="password" id="oldPin" placeholder="Current PIN" maxlength="32" />

        <label for="newPin">New PIN</label>
        <input type="password" id="newPin" placeholder="New PIN (min 4 chars)" maxlength="32" />

        <label for="confirmPin">Confirm New PIN</label>
        <input type="password" id="confirmPin" placeholder="Confirm new PIN" maxlength="32" />

        <div class="error" id="resetPinError" style="min-height:18px;"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px;">
          <button id="resetPinCancel" class="rounded-sky-btn cancel">Cancel</button>
          <button id="resetPinSubmit" class="rounded-sky-btn">Reset PIN</button>
        </div>
      </div>

    </div>
  </div>

  <input type="file" id="hiddenImport" accept="application/json" style="display:none">

  <script>
    /****************************************************************
     * BIOMETRIC (FINGERPRINT/FACE ID) LOGIC
     * Using 'platform' attachment to force device sensor instead of passkey/usb
     ****************************************************************/
    
    // Helpers for WebAuthn Buffer conversion
    const strToBuffer = (str) => Uint8Array.from(str, c => c.charCodeAt(0));
    const randomBuffer = (len) => {
      const arr = new Uint8Array(len);
      window.crypto.getRandomValues(arr);
      return arr;
    };

    // Check if biometric is set up
    function hasBiometricSetup() {
       return !!localStorage.getItem('dealer-bio-cred-id');
    }

    // 1. Setup/Register Fingerprint (Called from Settings)
    async function registerBiometric() {
        if (!window.PublicKeyCredential) {
            alert("Biometrics not supported on this browser.");
            return;
        }

        const userId = window.localStorage.getItem('dealer-hash') || 'default-user';
        
        try {
            const publicKeyCredentialCreationOptions = {
                challenge: randomBuffer(32),
                rp: { 
                    name: "Al Rahman Electronics", 
                    id: window.location.hostname 
                },
                user: {
                    id: strToBuffer(userId),
                    name: "dealer@local",
                    displayName: "Dealer"
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }, { alg: -257, type: "public-key" }],
                authenticatorSelection: {
                    authenticatorAttachment: "platform", // Forces device sensor
                    userVerification: "required",
                    residentKey: "preferred"
                },
                timeout: 60000,
                attestation: "none"
            };

            const credential = await navigator.credentials.create({
                publicKey: publicKeyCredentialCreationOptions
            });

            const credId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
            localStorage.setItem('dealer-bio-cred-id', credId);
            
            alert("Fingerprint setup successful! You can now use it to unlock.");
            checkBiometricButtonVisibility();

        } catch (err) {
            console.error(err);
            if(err.name === 'NotAllowedError') {
                alert("Setup cancelled or timed out.");
            } else if (window.location.protocol === 'file:') {
                alert("Security Error: Biometrics do not work on local files (file://). You must use a server (localhost or https).");
            } else {
                alert("Setup failed: " + err.message);
            }
        }
    }

    // 2. Authenticate/Unlock (Called from Login Screen)
    async function authenticateBiometric() {
        if (!hasBiometricSetup()) return;

        try {
            const publicKeyCredentialRequestOptions = {
                challenge: randomBuffer(32),
                rpId: window.location.hostname,
                userVerification: "required", // Forces the biometric prompt
                allowCredentials: [{
                    id: Uint8Array.from(atob(localStorage.getItem('dealer-bio-cred-id')), c => c.charCodeAt(0)),
                    type: 'public-key',
                    transports: ['internal']
                }]
            };

            const assertion = await navigator.credentials.get({
                publicKey: publicKeyCredentialRequestOptions
            });

            if (assertion) {
                // Success! Unlock the app.
                showDealerApp();
                const keepLoggedInToggle = document.getElementById('keepLoggedInToggle');
                if (keepLoggedInToggle.checked) {
                     setKeepSessionActive(Date.now() + KEEP_LOGGED_TIMEOUT_MS);
                     startSessionTimeoutMonitor();
                } else {
                     clearKeepSession();
                     stopSessionTimeoutMonitor();
                }
            }
        } catch (err) {
            console.error(err);
            const loginError = document.getElementById('login-error');
            loginError.textContent = "Fingerprint not recognized. Use PIN.";
            loginError.style.color = 'var(--danger)';
        }
    }

    // UI: Show/Hide the biometric button on login screen
    function checkBiometricButtonVisibility() {
        const btn = document.getElementById('biometricUnlockBtn');
        if(hasBiometricSetup() && getHasPIN()) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }

    /****************************************************************
     * EXISTING APP LOGIC
     ****************************************************************/
    
    // Modal background scroll lock
    (function() {
      function lockBodyScroll() {
        if (!document.body.classList.contains('modal-open')) {
          document.body.dataset.scrollY = window.scrollY;
          document.body.style.top = `-${window.scrollY}px`;
          document.body.classList.add('modal-open');
        }
      }
      function unlockBodyScroll() {
        if (document.body.classList.contains('modal-open')) {
          document.body.classList.remove('modal-open');
          const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
          document.body.style.top = '';
          window.scrollTo(0, scrollY);
          delete document.body.dataset.scrollY;
        }
      }

      function observeProductModalOpen() {
        const productModalBackdrop = document.getElementById('productModalBackdrop');
        if (!productModalBackdrop) return;
        const config = { attributes: true, attributeFilter: ['class'] };
        const observer = new MutationObserver(() => {
          if (!productModalBackdrop.classList.contains('hide')) {
            lockBodyScroll();
          } else {
            unlockBodyScroll();
          }
        });
        observer.observe(productModalBackdrop, config);
        window.addEventListener('beforeunload', unlockBodyScroll);
      }
      window.addEventListener('DOMContentLoaded', observeProductModalOpen);
      window.addEventListener('keydown', function(e) {
        if (e.key === "Escape") {
          unlockBodyScroll();
        }
      });
    })();
  </script>
  <script>
    /****************************************************************
     * Keep-logged-in authentication logic
     ****************************************************************/
    const KEEP_LOGGED_TIMEOUT_MS = 5*60*1000; // 5 minutes

    function setKeepSessionActive(expiresAt) {
      try { sessionStorage.setItem('dealer-keep-expires', String(expiresAt)); } catch(e) {}
    }
    function getKeepSessionActive() {
      try {
        const val = sessionStorage.getItem('dealer-keep-expires');
        return val && /^\d+$/.test(val) ? parseInt(val, 10) : null;
      } catch(e) { return null; }
    }
    function clearKeepSession() {
      try { sessionStorage.removeItem('dealer-keep-expires'); } catch(e) {}
    }
    function showTimeoutNotice(msg) {
      const t = document.getElementById('timeoutNotice');
      t.textContent = msg || '';
      t.style.display = msg ? 'block' : 'none';
    }
    function isSessionStillActive() {
      const expiresAt = getKeepSessionActive();
      return !!expiresAt && Date.now() < expiresAt;
    }
    function showTimeoutCountdownIfAny() {
      const expiresAt = getKeepSessionActive();
      if (expiresAt && Date.now() < expiresAt) {
        const secs = Math.max(0, Math.round((expiresAt-Date.now())/1000));
        if(secs<60) showTimeoutNotice("Session will auto-lock in "+secs+" sec" + (secs===1?"":"s") + ".");
        else if(secs<90) showTimeoutNotice("Session will auto-lock in about 1 min.");
        else showTimeoutNotice("Session will auto-lock in about "+Math.ceil(secs/60)+" min.");
      } else {
        showTimeoutNotice("");
      }
    }
    let timeoutCountdownInterval = null;

    function checkQuickAutoUnlock() {
      if (isSessionStillActive()) {
        updatePINUI(getHasPIN());
        showDealerApp();
        startSessionTimeoutMonitor();
        return true;
      }
      return false;
    }
    function startSessionTimeoutMonitor() {
      if (timeoutCountdownInterval) clearInterval(timeoutCountdownInterval);
      function check() {
        showTimeoutCountdownIfAny();
        if (!isSessionStillActive()) {
          showTimeoutNotice("Session expired for security. Please login again.");
          setTimeout(()=>manualLogoutDueToTimeout(), 1100);
        }
      }
      timeoutCountdownInterval = setInterval(check, 800);
      check();
    }
    function stopSessionTimeoutMonitor() {
      if (timeoutCountdownInterval) clearInterval(timeoutCountdownInterval);
      showTimeoutNotice("");
    }
    function manualLogoutDueToTimeout() {
      stopSessionTimeoutMonitor();
      clearKeepSession();
      document.getElementById('dealerApp').style.display = 'none';
      showLoginModal("Session expired for security. Please login again.");
      updatePINUI(getHasPIN());
    }
    function addSessionAutoLogoutHandlers() {
      window.addEventListener('pagehide', function(e) {
        clearKeepSession();
      });
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          clearKeepSession();
        }
      });
    }
    addSessionAutoLogoutHandlers();

    /****************************************************************
     * Service Worker & PWA
     ****************************************************************/
    (function createManifestAndServiceWorker() {
      const imgIcon = "https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true";
      const manifestObj = {
        name: "Al Rahman Electronics",
        short_name: "ARE",
        description: "Local-only dealer product listing (offline-first)",
        start_url: "./index.html", 
        display: "standalone",
        background_color: "#161B22",
        theme_color: "#161B22",
        icons: [
          { src: imgIcon, sizes: "192x192", type: "image/png" },
          { src: imgIcon, sizes: "512x512", type: "image/png" }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifestObj)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(manifestBlob);
      (function setManifestLink() {
        let existing = document.querySelector('link[rel="manifest"]');
        if (!existing) {
          existing = document.createElement('link');
          existing.rel = 'manifest';
          document.head.appendChild(existing);
        }
        existing.href = manifestURL;
      })();

      const swScript = `
        const CACHE_NAME = 'local-dealer-cache-v3';
        const OFFLINE_URL = self.registration.scope.endsWith('/') ? self.registration.scope + 'index.html' : self.registration.scope + '/index.html';
        const FILES_TO_CACHE = [
          OFFLINE_URL,
          './index.html'
        ];
        self.addEventListener('install', function(event) {
          event.waitUntil(
            caches.open(CACHE_NAME).then(function(cache) {
              return cache.addAll(FILES_TO_CACHE);
            })
          );
          self.skipWaiting();
        });
        self.addEventListener('activate', function(event) {
          event.waitUntil(self.clients.claim());
        });
        self.addEventListener('fetch', function(event) {
          if (event.request.method !== 'GET') return;
          event.respondWith(
            caches.match(event.request, {ignoreSearch:true}).then(function(response) {
              if (response) return response;
              return fetch(event.request).then(function(resp) {
                if (resp && resp.status === 200 && resp.type === 'basic' && /\.(html|js|css|png|jpg|jpeg|svg|woff2?|json)$/i.test(event.request.url)) {
                  const respClone = resp.clone();
                  caches.open(CACHE_NAME).then(function(cache) {
                    cache.put(event.request, respClone);
                  });
                }
                return resp;
              }).catch(function() {
                if (event.request.mode === 'navigate' || event.request.destination === 'document') {
                  return caches.match(OFFLINE_URL);
                }
                return undefined;
              });
            })
          );
        });
      `;
      try {
        const swBlob = new Blob([swScript], { type: 'text/javascript' });
        const swURL = URL.createObjectURL(swBlob);
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register(swURL);
          });
        }
      } catch (e) {}
    })();

    /**************************************************************
     * Start animation
     **************************************************************/
    window.addEventListener('DOMContentLoaded', function(){
      setTimeout(function() {
        document.querySelectorAll(".card").forEach((el,i)=> {
          setTimeout(()=>{ el.classList.add('show') }, 160+60*i);
        });
      }, 180);
    });

    /**************************************************************
     * PWA install prompt
     **************************************************************/
    let deferredPrompt;
    const installBtn = document.getElementById('installPromptBtn');
    const installAsAppBtn = document.getElementById('installAsAppBtn');
    const mobileInstall = document.getElementById('mobileInstallInstructions');

    function isMobileChromeStandaloneCapable() {
      const ua = navigator.userAgent || '';
      return /Android/.test(ua) && /Chrome\/[.0-9]* Mobile/.test(ua) && !window.matchMedia('(display-mode: standalone)').matches;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
      installAsAppBtn.style.display = 'inline-block';
      mobileInstall.style.display = 'none';
    });

    installBtn && (installBtn.onclick = async function() {
      installBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installBtn.disabled = false;
      } else {
        installBtn.disabled = false;
      }
    });

    installAsAppBtn && (installAsAppBtn.onclick = async function() {
      installAsAppBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installAsAppBtn.disabled = false;
      } else {
        alert("Install prompt not available right now. Use Chrome's menu: Add to Home screen.");
        installAsAppBtn.disabled = false;
      }
    });

    window.addEventListener('appinstalled', ()=>{
      installBtn.style.display='none';
      installAsAppBtn.style.display='none';
      deferredPrompt = null;
      mobileInstall.style.display='none';
    });

    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (!window.matchMedia('(display-mode: standalone)').matches &&
            !window.matchMedia('(display-mode: fullscreen)').matches &&
            isMobileChromeStandaloneCapable()
        ) {
          if ((installBtn.style.display === "none" || getComputedStyle(installBtn).display === "none") &&
              (installAsAppBtn.style.display === "none" || getComputedStyle(installAsAppBtn).display === "none"))
          {
            mobileInstall.innerHTML =
              "To install this app: tap <b><span style='font-size:1.22em;'>‚ãÆ</span></b> at the top right of Chrome, and choose <b>Add to Home screen</b>.";
            mobileInstall.style.display = "inline-block";
          }
        }
      }, 1100);
    });

    /**************************************************************
     * Android Back Button Logic
     **************************************************************/
    (function handleAndroidBackButton() {
      function isStandalone() {
        return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
               (window.navigator.standalone === true);
      }
      let openedModals = [];
      const modalPriority = ['productModalBackdrop', 'deleteModalBackdrop', 'settingsBackdrop', 'detailModalBackdrop'];

      function pushMainStateToHistory() {
        if (!isStandalone()) return;
        try { history.replaceState({dealerAppMain: true}, document.title, window.location.href); } catch (e) {}
      }
      function pushModalState(modalId) {
        if (!isStandalone()) return;
        try {
          history.pushState({modal: modalId}, document.title, window.location.href);
          openedModals.push(modalId);
        } catch (e) {}
      }
      function enablePwaBackHandler() {
        pushMainStateToHistory();
        window.addEventListener('popstate', function(e) {
          if (document.getElementById('dealerApp').style.display !== 'none') {
            const topOpenModal = (() => {
              for (let i = 0; i < modalPriority.length; ++i) {
                const el = document.getElementById(modalPriority[i]);
                if (el && !el.classList.contains('hide')) return modalPriority[i];
              }
              return null;
            })();

            if (topOpenModal) {
              document.getElementById(topOpenModal).classList.add('hide');
              setTimeout(()=>{},10);
              return;
            }
            pushMainStateToHistory();
          }
        });
      }
      function setupModalHistoryTracking() {
        modalPriority.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const observer = new MutationObserver(() => {
            if (!el.classList.contains('hide')) {
              if (!openedModals.includes(id)) pushModalState(id);
            } else {
              const idx = openedModals.indexOf(id);
              if (idx !== -1) openedModals.splice(idx, 1);
            }
          });
          observer.observe(el, { attributes: true, attributeFilter: ['class'] });
        });
      }
      window.__enablePwaBackHandler = function() {
        enablePwaBackHandler();
        setupModalHistoryTracking();
      };
    })();

    /**************************************************************
     * PIN hashing & auth helpers
     **************************************************************/
    async function hashPIN(pin) {
      let salt = window.localStorage.getItem('dealer-app-salt');
      if (!salt) {
        const arr = new Uint8Array(16);
        window.crypto.getRandomValues(arr);
        salt = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        window.localStorage.setItem('dealer-app-salt', salt);
      }
      const encoder = new TextEncoder();
      try {
        const baseKey = await window.crypto.subtle.importKey('raw', encoder.encode(pin), 'PBKDF2', false, ['deriveBits']);
        const rawBits = await window.crypto.subtle.deriveBits({ name: "PBKDF2", salt: encoder.encode(salt), iterations: 3000, hash: "SHA-256" }, baseKey, 256);
        const hashArr = new Uint8Array(rawBits);
        return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) {
        return pin + salt; // Fallback
      }
    }
    function getHasPIN() { return !!window.localStorage.getItem('dealer-hash'); }
    
    function showDealerApp() {
      document.getElementById('dealerApp').style.display = '';
      document.getElementById('login-modal').style.display = 'none';
      setTimeout(refreshProductList, 220);
      if (typeof window.__enablePwaBackHandler === 'function') window.__enablePwaBackHandler();
    }
    
    function showLoginModal(msg) {
      document.getElementById('dealerApp').style.display = 'none';
      const loginModal = document.getElementById('login-modal');
      loginModal.style.display = 'flex';
      if (msg) { 
        document.getElementById('login-error').textContent = msg; 
        document.getElementById('login-error').style.color = 'var(--danger)';
      } else { 
        document.getElementById('login-error').textContent = ''; 
        document.getElementById('login-error').style.color = '';
      }
      document.getElementById('loginPIN').value = '';
      
      // FIXED: Only focus PIN (showing keyboard) if fingerprint is NOT setup
      if (!hasBiometricSetup()) {
          setTimeout(()=>document.getElementById('loginPIN').focus(),120);
      }
      
      // Check if we should show fingerprint button
      checkBiometricButtonVisibility();
    }
    
    let justSetPIN = false;

    window.addEventListener('load', ()=> {
      updatePINUI(getHasPIN());
      if (!checkQuickAutoUnlock()) {
        showLoginModal();
        
        // FIXED: Automatically trigger fingerprint scan on load
        if (hasBiometricSetup()) {
             // Slight delay to ensure modal is rendered
             setTimeout(authenticateBiometric, 400); 
        }
      }
      setTimeout(function() {
        if ("serviceWorker" in navigator && window.matchMedia('(display-mode: standalone)').matches) {
          try { history.replaceState({start:true}, document.title, window.location.href); } catch (e) {}
        }
      }, 180);
    });

    const loginBtn = document.getElementById('loginBtn');
    const loginForm = document.getElementById('loginForm');
    const loginPIN = document.getElementById('loginPIN');
    const loginError = document.getElementById('login-error');
    const pinLabel = document.getElementById('pinLabel');
    const keepLoggedInToggle = document.getElementById('keepLoggedInToggle');
    // Grab the new buttons
    const setupBiometricBtn = document.getElementById('setupBiometricBtn');
    const biometricUnlockBtn = document.getElementById('biometricUnlockBtn');

    // Attach listeners for new buttons
    setupBiometricBtn.onclick = (e) => { e.preventDefault(); registerBiometric(); };
    biometricUnlockBtn.onclick = (e) => { e.preventDefault(); authenticateBiometric(); };

    (function() {
      const showBtn = document.getElementById('showLoginPINBtn');
      const pinInput = document.getElementById('loginPIN');
      const iconSpan = document.getElementById('showLoginPINBtnIcon');
      let visible = false;
      if (showBtn && pinInput) {
        showBtn.addEventListener('click', function(e) {
          e.preventDefault();
          visible = !visible;
          pinInput.type = visible ? 'text' : 'password';
          iconSpan.textContent = visible ? 'üôà' : 'üëÅÔ∏è'; 
          showBtn.setAttribute('aria-label', visible ? "Hide PIN" : "Show PIN");
        });
        pinInput.addEventListener('keydown', function(e) {
          if (visible && e.key === "Escape") {
            pinInput.type = 'password';
            visible = false;
            iconSpan.textContent = 'üëÅÔ∏è';
            showBtn.setAttribute('aria-label', "Show PIN");
          }
        });
      }
    })();

    function updatePINUI(hasPIN) {
      if (hasPIN) {
        loginBtn.textContent = "Unlock";
        pinLabel.textContent = "Enter your PIN / Password:";
        loginPIN.placeholder = "Enter PIN or password";
        loginPIN.autocomplete = "current-password";
      } else {
        loginBtn.textContent = "Set PIN";
        pinLabel.textContent = "Create a secure PIN / Password:";
        loginPIN.placeholder = "Set PIN or password";
        loginPIN.autocomplete = "new-password";
      }
      loginError.textContent = '';
      loginError.style.color = '';
      checkBiometricButtonVisibility();
    }

    loginForm.onsubmit = async function(e) {
      e.preventDefault();
      loginError.textContent = '';
      loginError.style.color = '';
      const pinVal = (loginPIN.value || '').trim();
      const hasPIN = getHasPIN();
      if (!pinVal || pinVal.length < 4) {
        loginError.style.color = 'var(--danger)';
        loginError.textContent = hasPIN ? "Enter your PIN/Password." : "PIN/password must be at least 4 characters.";
        return;
      }
      loginBtn.disabled = true;
      try {
        const hash = await hashPIN(pinVal);
        if (!hasPIN) {
          window.localStorage.setItem('dealer-hash', hash);
          justSetPIN = true;
          updatePINUI(true);
          loginError.style.color = 'var(--success)';
          loginError.textContent = "PIN set. Now use it to unlock.";
          loginBtn.disabled = false;
          loginPIN.value = '';
          setTimeout(()=>{
            loginError.textContent = '';
            loginError.style.color='';
          }, 1500);
          keepLoggedInToggle.checked = false;
          return;
        }
        const userHash = window.localStorage.getItem('dealer-hash');
        if (userHash === hash) {
          if (keepLoggedInToggle.checked) {
            setKeepSessionActive(Date.now() + KEEP_LOGGED_TIMEOUT_MS);
            startSessionTimeoutMonitor();
          } else {
            clearKeepSession();
            stopSessionTimeoutMonitor();
          }
          showDealerApp();
          loginBtn.disabled = false;
          loginError.textContent = '';
          loginError.style.color = '';
          justSetPIN = false;
        } else {
          loginBtn.disabled = false;
          loginError.style.color='var(--danger)';
          loginError.textContent = 'Incorrect PIN / Password.';
        }
      } catch (ex) {
        loginBtn.disabled = false;
        loginError.style.color='var(--danger)';
        loginError.textContent = 'An error occurred. Try again.';
      }
    };

    keepLoggedInToggle.onchange = function() {
      showTimeoutNotice("");
      if (!this.checked) clearKeepSession();
    };

    document.getElementById('login-modal').addEventListener('transitionend', function() {
      loginPIN.value = '';
    });

    function doLogout(showMsg) {
      stopSessionTimeoutMonitor();
      clearKeepSession();
      document.getElementById('dealerApp').style.display = 'none';
      showLoginModal(showMsg || 'You have been logged out.');
      updatePINUI(getHasPIN());
    }

    /**************************************************************
     * Settings Modal Logic 
     **************************************************************/
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const resetPinSubmit = document.getElementById('resetPinSubmit');
    const resetPinCancel = document.getElementById('resetPinCancel');
    const resetPinError = document.getElementById('resetPinError');

    settingsBtn.onclick = () => {
      settingsBackdrop.classList.remove('hide');
      document.getElementById('oldPin').value = '';
      document.getElementById('newPin').value = '';
      document.getElementById('confirmPin').value = '';
      resetPinError.textContent = '';
      resetPinError.style.color = '';
    };
    closeSettingsBtn.onclick = () => settingsBackdrop.classList.add('hide');

    logoutBtn.onclick = () => {
      settingsBackdrop.classList.add('hide');
      doLogout();
    };

    resetPinCancel.onclick = () => {
      resetPinError.textContent = '';
      resetPinError.style.color = '';
      settingsBackdrop.classList.add('hide');
    };

    resetPinSubmit.onclick = async function() {
      resetPinError.textContent = '';
      resetPinError.style.color = '';
      const oldPin = (document.getElementById('oldPin').value || '').trim();
      const newPin = (document.getElementById('newPin').value || '').trim();
      const confirmPin = (document.getElementById('confirmPin').value || '').trim();
      if (!oldPin || oldPin.length < 4) { resetPinError.textContent = "Enter current PIN (min 4 chars)."; resetPinError.style.color='var(--danger)'; return; }
      if (!newPin || newPin.length < 4) { resetPinError.textContent = "New PIN must be at least 4 characters."; resetPinError.style.color='var(--danger)'; return; }
      if (newPin !== confirmPin) { resetPinError.textContent = "New PIN and confirmation do not match."; resetPinError.style.color='var(--danger)'; return; }
      if (oldPin === newPin) { resetPinError.textContent = "New PIN cannot be same as old PIN."; resetPinError.style.color='var(--danger)'; return;}
      resetPinSubmit.disabled = true;
      try {
        const oldHash = await hashPIN(oldPin);
        const stored = window.localStorage.getItem('dealer-hash');
        if (stored !== oldHash) {
          resetPinError.textContent = "Current PIN is incorrect.";
          resetPinError.style.color='var(--danger)';
          resetPinSubmit.disabled = false;
          return;
        }
        const newHash = await hashPIN(newPin);
        window.localStorage.setItem('dealer-hash', newHash);
        resetPinError.style.color = 'var(--success)';
        resetPinError.textContent = "PIN updated successfully.";
        setTimeout(()=>{
          resetPinError.textContent = '';
          resetPinError.style.color = '';
          settingsBackdrop.classList.add('hide');
        }, 1000);
      } catch (err) {
        resetPinError.textContent = "Failed to update PIN.";
        resetPinError.style.color='var(--danger)';
      }
      resetPinSubmit.disabled = false;
    };

    /**************************************************************
     * Product Logic (Add/Edit/Delete/Import)
     **************************************************************/
    const productListElem = document.getElementById('productList');
    const noProductsElem = document.getElementById('noProducts');
    let products = [];
    let selectedProductIds = new Set();

    function saveProducts() {
      try { window.localStorage.setItem('dealer-products', JSON.stringify(products)); } catch(e){}
      refreshProductList();
    }
    function loadProducts() {
      products = [];
      try {
        const str = window.localStorage.getItem('dealer-products');
        if (str) products = JSON.parse(str) || [];
      } catch (e) { products = []; }
    }
    function escapeHTML(v) {
      if (typeof v !== "string") return v === undefined || v === null ? "" : String(v);
      return v.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'" :'&#39;','"':'&quot;'}[c]));
    }

    function handleCheckboxChange(productId, checked) {
      if (checked) selectedProductIds.add(productId);
      else selectedProductIds.delete(productId);
      updateMultiSelectControls();
    }

    function updateMultiSelectControls() {
      const multiSelectControls = document.getElementById('multiSelectControls');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const selectedCountText = document.getElementById('selectedCountText');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectedProductIds.size > 0) {
        multiSelectControls.classList.add('active');
        deleteSelectedBtn.disabled = false;
        selectedCountText.textContent = `${selectedProductIds.size} selected`;
      } else {
        multiSelectControls.classList.remove('active');
        deleteSelectedBtn.disabled = true;
        selectedCountText.textContent = "";
      }
      if (products.length && selectedProductIds.size === products.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedProductIds.size > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function createProductCard(product, idx) {
      const li = document.createElement('li');
      li.className = 'prod-card';
      li.setAttribute('tabindex','0');
      setTimeout(()=>li.classList.add('show'), 121+idx*64);
      let imgHTML = product.photo ? `<img src="${escapeHTML(product.photo)}" class="prod-photo-thumb" alt="Product Photo">` : `<span>üì¶</span>`;
      const nameSafe = escapeHTML(product.name || "Unnamed");
      const qtyNum = Number(product.qty) || 0;
      const mrpNum = Number(product.mrp) || 0;
      let checkboxHTML = `<input type="checkbox" class="prod-select-checkbox" title="Select" data-id="${product.id}" tabindex="0" ${selectedProductIds.has(product.id) ? "checked" : ""}/>`;

      li.innerHTML = `
        ${checkboxHTML}
        <div class="prod-img">${imgHTML}</div>
        <div class="prod-main-details">
          <div class="prod-name">${nameSafe}</div>
          <div class="prod-details">Stock: <b style="color:var(--success);font-weight:600">${qtyNum}</b> ‚Ä¢ ‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</div>
          ${product.notes?`<div class="prod-details">${escapeHTML(String(product.notes)).slice(0,55)}</div>`:""}
        </div>
        <div class="prod-actions">
          <button type="button" title="Edit" aria-label="Edit product" role="button" class="edit" data-id="${product.id}">‚úèÔ∏è</button>
        </div>
      `;
      if (selectedProductIds.has(product.id)) li.classList.add('selected');
      const checkbox = li.querySelector('.prod-select-checkbox');
      if (checkbox) {
        checkbox.addEventListener('change', (e) => {
          handleCheckboxChange(product.id, checkbox.checked);
        });
        checkbox.addEventListener('click', (e)=>e.stopPropagation());
        checkbox.addEventListener('keydown', (e)=>e.stopPropagation());
      }
      const editBtn = li.querySelector('.edit');
      if (editBtn) editBtn.onclick = (e)=>{ e.stopPropagation(); showProductModal('edit', product); };
      li.addEventListener('click', function(e){
        if(e.target.classList.contains('prod-select-checkbox')) return;
        if(!e.target.closest('.prod-actions')) showDetailModal(product);
      });
      li.addEventListener('keydown', function(e){
        if((e.key==="Enter"||e.key===" ") && !e.target.closest('.prod-actions')) { e.preventDefault(); showDetailModal(product); }
      });
      return li;
    }

    document.getElementById("selectAllCheckbox").addEventListener("change", function() {
      if (this.checked) {
        products.forEach(prod => selectedProductIds.add(prod.id));
      } else {
        selectedProductIds.clear();
      }
      refreshProductList();
      updateMultiSelectControls();
    });

    document.getElementById("deleteSelectedBtn").onclick = function() {
      if (selectedProductIds.size === 0) return;
      if (!confirm(`Are you sure you want to delete ${selectedProductIds.size} selected item(s)?`)) return;
      products = products.filter(p => !selectedProductIds.has(p.id));
      selectedProductIds.clear();
      saveProducts();
      updateMultiSelectControls();
    };

    const detailModalBackdrop = document.getElementById('detailModalBackdrop');
    const detailModalBody = document.getElementById('detailModalBody');
    function disableDetailBackgroundScroll() {
      document.body.classList.add('detail-modal-open');
    }
    function enableDetailBackgroundScroll() {
      document.body.classList.remove('detail-modal-open');
    }
    function showDetailModal(product) {
      const nameSafe = escapeHTML(product.name || 'Unnamed');
      const photoBlock = product.photo ? `<img src="${escapeHTML(product.photo)}" class="prod-detail-photo" alt="${nameSafe}"/>` : `<div class="prod-detail-photo" style="font-size:60px;padding:22px 0 12px 0;">üì¶</div>`;
      const mrpNum = Number(product.mrp) || 0;
      const costNum = (product.cost !== undefined && product.cost !== null) ? Number(product.cost) : null;

      detailModalBody.innerHTML = `
        <div style="text-align:center;">${photoBlock}</div>
        <ul style="list-style:none;padding:0;margin:10px 0 0 0;display:flex;flex-direction:column;gap:.57em;">
          <li><b>Name:</b> <span style="color:var(--accent2);font-weight:600">${nameSafe}</span></li>
          ${product.category?`<li><b>Category:</b> <span style="color:var(--accent2);font-weight:600">${escapeHTML(String(product.category))}</span></li>`:""}
          <li><b>Stock:</b> <span style="color:var(--accent2);font-weight:600">${Number(product.qty)||0}</span></li>
          <li><b>MRP:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>
          ${costNum!==null?`<li><b>Cost:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${costNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>`:""}
        </ul>
        ${product.notes?`<div style="margin-top:.8em;color:var(--text-muted);background:#213047;border-radius:8px;padding:.7em .9em">${escapeHTML(String(product.notes))}</div>`:""}
      `;
      detailModalBackdrop.classList.remove('hide');
      disableDetailBackgroundScroll();
      setTimeout(()=>document.getElementById('closeDetailModalBtn').focus(),100);
    }
    document.getElementById('closeDetailModalBtn').onclick = function(){
      detailModalBackdrop.classList.add('hide');
      detailModalBody.innerHTML = '';
      enableDetailBackgroundScroll();
    };
    document.addEventListener('keydown', function(e){
      if (e.key === "Escape") {
        let closedAModal = false;
        if (!detailModalBackdrop.classList.contains('hide')) { 
          detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML='';
          enableDetailBackgroundScroll();
          closedAModal = true;
        }
        if (!productModalBackdrop.classList.contains('hide')) { productModalBackdrop.classList.add('hide'); closedAModal = true; }
        if (!deleteModalBackdrop.classList.contains('hide')) { deleteModalBackdrop.classList.add('hide'); closedAModal = true; }
        if (!settingsBackdrop.classList.contains('hide')) { settingsBackdrop.classList.add('hide'); closedAModal = true; }
        if (closedAModal) enableDetailBackgroundScroll();
      }
    });
    function maybeResetBodyScroll() {
      if (
        detailModalBackdrop.classList.contains('hide') &&
        (!productModalBackdrop || productModalBackdrop.classList.contains('hide')) &&
        (!settingsBackdrop || settingsBackdrop.classList.contains('hide')) &&
        (!deleteModalBackdrop || deleteModalBackdrop.classList.contains('hide'))
      ) {
        enableDetailBackgroundScroll();
      }
    }
    detailModalBackdrop.addEventListener('transitionend', maybeResetBodyScroll);
    detailModalBackdrop.addEventListener('animationend', maybeResetBodyScroll);
    window.addEventListener('popstate', maybeResetBodyScroll);

    const searchInput = document.getElementById('productSearch');
    searchInput.addEventListener('input', function(){ refreshProductList(); });
    searchInput.addEventListener('keydown', function(e){ if(e.key==='Escape'){ searchInput.value=''; refreshProductList(); } });

    function refreshProductList() {
      loadProducts();
      productListElem.innerHTML = '';
      let q = (searchInput.value || '').trim().toLowerCase();
      let filtered = !q ? products : products.filter(prod =>
        (String(prod.name||"").toLowerCase().includes(q)) ||
        (String(prod.category||"").toLowerCase().includes(q)) ||
        (String(prod.notes||"").toLowerCase().includes(q))
      );
      if (!filtered.length) {
        noProductsElem.style.display = "";
        document.getElementById('multiSelectControls').classList.remove('active');
        return;
      }
      noProductsElem.style.display = "none";
      filtered.sort((a,b) => (Number(b.qty)-Number(a.qty)) || (String(a.name||'').localeCompare(String(b.name||''))));
      filtered.forEach((prod,i)=>productListElem.appendChild(createProductCard(prod,i)));
      updateMultiSelectControls();
    }

    let productEditing = null;
    const prodName = document.getElementById('prodName');
    const prodMrp = document.getElementById('prodMrp');
    const prodCost = document.getElementById('prodCost');
    const prodQty = document.getElementById('prodQty');
    const prodCategory = document.getElementById('prodCategory');
    const prodNotes = document.getElementById('prodNotes');
    const prodPhoto = document.getElementById('prodPhoto');
    const productModalBackdrop = document.getElementById('productModalBackdrop');
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modalError');
    const prodPhotoFileName = document.getElementById('prodPhotoFileName');
    const uploadBtnInnerText = document.getElementById('uploadBtnInnerText');
    const prodPhotoFileContainer = document.getElementById('prodPhotoFileContainer');
    const fileUploadWrap = document.getElementById('fileUploadWrap');
    const imageCompressMsg = document.getElementById('imageCompressMsg');
    let currentProductPhotoDataUrl = null;

    async function compressImageFile(file, maxDim = 260, quality = 0.72) {
      return new Promise((resolve, reject) => {
        if (!/^image\//.test(file.type)) return reject("Not an image file.");
        let img = new window.Image();
        let url = URL.createObjectURL(file);
        img.onload = function() {
          let [w, h] = [img.naturalWidth, img.naturalHeight];
          if (w > maxDim || h > maxDim) {
            if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
            else { w = Math.round(w * maxDim / h); h = maxDim; }
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          canvas.toBlob(blob => {
            if (!blob) return reject("Compression error.");
            const reader = new FileReader();
            reader.onload = e => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          }, 'image/jpeg', quality);
          URL.revokeObjectURL(url);
        };
        img.onerror = () => { URL.revokeObjectURL(url); reject("Invalid image"); };
        img.src = url;
      });
    }

    function updatePhotoPreviewUI() {
      prodPhotoFileContainer.innerHTML = '';
      if (currentProductPhotoDataUrl) {
        const img = document.createElement('img');
        img.src = currentProductPhotoDataUrl;
        img.alt = "Product Photo";
        img.className = 'photo-preview-img-thumb';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-photo-btn';
        removeBtn.title = 'Remove image';
        removeBtn.innerHTML = '‚úñ';
        removeBtn.onclick = function() {
          currentProductPhotoDataUrl = null;
          prodPhoto.value = '';
          prodPhotoFileName.textContent = '';
          uploadBtnInnerText.textContent = 'Choose Image';
          imageCompressMsg.style.display = 'none';
          updatePhotoPreviewUI();
        };
        prodPhotoFileContainer.appendChild(img);
        prodPhotoFileContainer.appendChild(removeBtn);
      }
    }

    function showProductModal(mode, product) {
      productModal.reset();
      modalError.textContent = '';
      prodPhotoFileName.textContent = '';
      uploadBtnInnerText.textContent = 'Choose Image';
      currentProductPhotoDataUrl = null;
      imageCompressMsg.style.display = 'none';
      updatePhotoPreviewUI();
      if (mode === 'add') {
        modalTitle.textContent = "Add Product";
        productEditing = null;
        prodName.value = ""; prodMrp.value = ""; prodCost.value = ""; prodQty.value = ""; prodCategory.value = ""; prodNotes.value = ""; prodPhoto.value = "";
      } else {
        modalTitle.textContent = "Edit Product";
        productEditing = product;
        prodName.value = product.name || ""; prodMrp.value = product.mrp !== undefined ? product.mrp : ""; prodCost.value = product.cost !== undefined ? product.cost : ""; prodQty.value = product.qty !== undefined ? product.qty : ""; prodCategory.value = product.category || ""; prodNotes.value = product.notes || ""; prodPhoto.value = "";
        if (product.photo) {
          currentProductPhotoDataUrl = product.photo;
          updatePhotoPreviewUI();
        }
      }
      productModalBackdrop.classList.remove('hide');
      if (!document.body.classList.contains('modal-open')) {
        document.body.dataset.scrollY = window.scrollY;
        document.body.style.top = `-${window.scrollY}px`;
        document.body.classList.add('modal-open');
      }
      setTimeout(()=>prodName.focus(),150);
      firstSubmitAttempt = true;
    }

    let firstSubmitAttempt = true;
    let prodPhotoLastPendingPromise = null;

    prodPhoto.addEventListener('change', function () {
      if (prodPhoto.files && prodPhoto.files.length) {
        const file = prodPhoto.files[0];
        prodPhotoFileName.textContent = file.name;
        uploadBtnInnerText.textContent = "Image Selected";
        imageCompressMsg.textContent = "Compressing image...";
        imageCompressMsg.style.display = 'block';
        const filePromise = compressImageFile(file, 260, 0.72).then(dataUrl => {
          const kb = Math.round((dataUrl.length * 3 / 4) / 1024);
          currentProductPhotoDataUrl = dataUrl;
          updatePhotoPreviewUI();
          imageCompressMsg.textContent = `Photo compressed: ~${kb} KB (max 260px, JPEG)`;
          imageCompressMsg.style.display = 'block';
        }).catch(err => {
          modalError.textContent = "Image compression failed. Please select another file.";
          prodPhoto.value = '';
          prodPhotoFileName.textContent = '';
          uploadBtnInnerText.textContent = 'Choose Image';
          imageCompressMsg.textContent = '';
          imageCompressMsg.style.display = 'none';
          currentProductPhotoDataUrl = null;
          updatePhotoPreviewUI();
        });
        prodPhotoLastPendingPromise = filePromise;
      } else {
        prodPhotoFileName.textContent = '';
        uploadBtnInnerText.textContent = 'Choose Image';
        currentProductPhotoDataUrl = null;
        imageCompressMsg.style.display = 'none';
        updatePhotoPreviewUI();
        prodPhotoLastPendingPromise = null;
      }
    });

    document.getElementById('addProductBtn').onclick = ()=>showProductModal('add');
    document.getElementById('closeModalBtn').onclick = ()=>{
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) {
        document.body.classList.remove('modal-open');
        const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
        document.body.style.top = '';
        window.scrollTo(0, scrollY);
        delete document.body.dataset.scrollY;
      }
      imageCompressMsg.style.display = 'none';
    };

    productModal.onsubmit = async function(e) {
      e.preventDefault();
      modalError.textContent = "";
      if (firstSubmitAttempt && prodPhoto.files && prodPhoto.files.length && !currentProductPhotoDataUrl && prodPhotoLastPendingPromise) {
        try { await prodPhotoLastPendingPromise; } catch (err) { modalError.textContent = "Image failed to load, please select again."; return; }
        firstSubmitAttempt = false;
        productModal.onsubmit(e);
        return;
      }
      firstSubmitAttempt = false;
      const name = (prodName.value || '').trim();
      const mrpVal = prodMrp.value;
      const costVal = prodCost.value;
      const qtyVal = prodQty.value;
      const category = (prodCategory.value || '').trim();
      const notes = (prodNotes.value || '').trim();
      if (!name) { modalError.textContent = "Name required."; return; }
      if (mrpVal === "" || isNaN(Number(mrpVal)) || Number(mrpVal) < 0) { modalError.textContent = "Valid MRP required."; return; }
      if (qtyVal === "" || isNaN(Number(qtyVal)) || Number(qtyVal) < 0) { modalError.textContent = "Valid quantity required."; return; }
      let photoData = null;
      if (currentProductPhotoDataUrl) photoData = currentProductPhotoDataUrl;
      const productObj = {
        id: productEditing ? productEditing.id : genID(),
        name,
        mrp: Number(mrpVal),
        cost: costVal !== "" ? Number(costVal) : null,
        qty: Number(qtyVal),
        category,
        notes,
        photo: photoData
      };
      if (!productEditing) products.push(productObj);
      else {
        const idx = products.findIndex(p => p.id === productEditing.id);
        if (idx >= 0) products[idx] = productObj; else products.push(productObj);
      }
      saveProducts();
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) {
        document.body.classList.remove('modal-open');
        const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
        document.body.style.top = '';
        window.scrollTo(0, scrollY);
        delete document.body.dataset.scrollY;
      }
      selectedProductIds.clear();
      updateMultiSelectControls();
    };

    const deleteModalBackdrop = document.getElementById('deleteModalBackdrop');
    const deleteModal = document.getElementById('deleteModal');
    const deleteName = document.getElementById('deleteName');
    let productToDelete = null;

    function showDeleteModal(product) {
      deleteModalBackdrop.classList.remove('hide');
      deleteName.textContent = product.name || '';
      productToDelete = product;
      setTimeout(()=>document.getElementById('cancelDeleteBtn').focus(),60);
    }
    document.getElementById('closeDeleteBtn').onclick =
    document.getElementById('cancelDeleteBtn').onclick = () => {
      deleteModalBackdrop.classList.add('hide'); productToDelete = null;
    };
    deleteModal.onsubmit = function(e){
      e.preventDefault();
      if (!productToDelete) return;
      products = products.filter(p => p.id !== productToDelete.id);
      saveProducts();
      deleteModalBackdrop.classList.add('hide'); productToDelete = null;
      selectedProductIds.delete(productToDelete.id);
      updateMultiSelectControls();
    };
    function genID() { return 'p' + (Date.now() + ('' + Math.random()).slice(2,7)); }

    document.getElementById('exportBtn').onclick = function() {
      const dataStr = JSON.stringify(products || [], null, 2);
      const blob = new Blob([dataStr], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.style.display='none'; a.href = url; a.download = 'dealer-products-backup.json'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url);
      setTimeout(()=>{ document.body.removeChild(a); },200);
    };

    document.getElementById('importBtn').onclick = function () {
      let fileInput = document.getElementById('hiddenImport');
      if (fileInput) fileInput.value = '';
      if (fileInput) fileInput.click();
    };

    document.getElementById('hiddenImport').onchange = async function (e) {
      const fileInput = e.target;
      if (!fileInput.files || !fileInput.files.length) return;
      const file = fileInput.files[0];
      if (!(file && (file.type === 'application/json' || /\.json$/i.test(file.name)))) {
        alert('Please select a .json backup/export file.');
        return;
      }
      try {
        let text = '';
        if (file.text) text = await file.text();
        else {
          text = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file);
          });
        }
        let arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error('Invalid file - data not array');
        arr = arr.filter(prod => prod && typeof prod === 'object' && 'name' in prod && 'qty' in prod);
        if (!arr.length) throw new Error('No valid products in file!');
        if (!confirm(`Import will OVERWRITE your current products with ${arr.length} product(s).\nAre you sure?`)) return;
        window.localStorage.setItem('dealer-products', JSON.stringify(arr));
        products = arr;
        refreshProductList();
        selectedProductIds.clear();
        updateMultiSelectControls();
        alert('Import successful. Product list replaced.');
      } catch (ex) {
        alert("Failed to import products: " + (ex.message || ex));
      }
    };

    window.addEventListener('load', function() {
      loadProducts();
    });
  </script>
</body>
</html>
