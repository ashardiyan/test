<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Al Rehman Electronics</title>
  <meta name="theme-color" content="#161B22" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  
  <link rel="icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">

  <style>
    :root {
      --bg1: #0C1220;
      --bg2: #161B22;
      --bg3: #212936;
      --accent: #2563EB;
      --accent-hover: #164eab;
      --accent2: #06B6D4;
      --accent2-hover: #1095b7;
      --gray: #AEB9C7;
      --text: #F3F7FF;
      --text-muted: #B0B9C6;
      --radius: 16px;
      --radius-card: 13px;
      --shadow: 0 8px 32px 0 rgba(60,120,220,0.17);
      --shadow-soft: 0 2px 8px rgba(40,98,180,.11);
      --danger: #ef4444;
      --success: #10b981;
      --rounded-btn: 10px;
      --button-skyblue: #06B6D4;
      --button-gradient: linear-gradient(90deg, #06B6D4 40%, #2563EB 100%);
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      font-size: 17px;
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
      color: var(--text);
      min-height: 100vh;
    }
    body { display:flex; flex-direction:column; min-height:100vh; }
    .container { max-width:640px; margin:0 auto; padding:34px 12px 54px; width:100%; box-sizing:border-box; }
    header { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:20px; gap:10px; }
    .logo-wrap { display:flex; align-items:center; gap:14px; }
    .app-logo { width:50px; height:50px; border-radius:18px; background:linear-gradient(135deg,var(--accent),var(--accent2)75%); display:flex; align-items:center; justify-content:center; font-size:2.11rem; box-shadow:var(--shadow-soft); color:#fff; font-weight:700; overflow: hidden; }
    .app-title { font-weight:900; font-size:1.7rem; line-height:1.13; letter-spacing:-1px; color:var(--text); margin-left:2px; }
    .top-controls { display:flex; align-items:center; gap:10px; }
    button.icon-btn { background:none; border:none; color:var(--accent2); font-size:1.23rem; padding:8px 10px; border-radius:9px; cursor:pointer; outline:none; }
    button#settingsBtn { font-size:1.33rem; color:var(--text); background:#1b2430; padding:8px 11px; border-radius:9px; box-shadow:0 1px 6px #0008; }
    #installPromptBtn, #installAsAppBtn { display:none; margin-left:12px; font-size:.99em; padding:8px 14px; border-radius:8px; background:linear-gradient(91deg,var(--accent2),var(--accent)); color:#fff; font-weight:700; border:none; cursor:pointer; box-shadow:0 1px 11px #2e5fad23; }
    #mobileInstallInstructions { display:none; margin-left:10px; padding:8px 10px; border-radius:8px; background:#1a2233; color:var(--accent2); font-size:.93em; font-style:italic; box-shadow:0 2px 8px #222c3d22; max-width:310px; line-height:1.45; }

    .main-content { display:flex; flex-direction:column; gap:0; align-items:stretch; width:100%; }
    
    .card { background:var(--bg2); border-radius:var(--radius-card); box-shadow:var(--shadow); margin-bottom:32px; padding:1.6rem 1.6rem 1.3rem; animation:fadeUp .5s ease-out; opacity:0; transform:translateY(20px); animation-fill-mode:forwards; border:none; transition:box-shadow .15s, background .16s; }
    .card.show { opacity:1; transform:none; }
    @keyframes fadeUp { 0%{opacity:0;transform:translateY(20px);}100%{opacity:1;transform:translateY(0);} }
    
    .products-top-actions { display:flex; align-items:flex-end; gap:11px; margin-bottom:17px; flex-wrap:wrap; }
    .product-search-wrap { position:relative; flex:1 1 192px; max-width:370px; margin-bottom:0; }
    #productSearch { width:100%; border-radius:8px; border:none; background:var(--bg3); color:var(--text); font-size:1.06em; padding:9px 38px 9px 15px; outline:none; box-shadow:0 1.5px 6px #35455a23; transition:border .13s; border:1.5px solid #23314a; }
    #productSearch:focus { border-color:var(--accent); }
    .search-icon { position:absolute; right:13px; top:50%; transform:translateY(-50%); color:var(--accent2); font-size:1.15em; opacity:0.7; pointer-events:none; }

    #multiSelectControls {
      display: none;
      gap: 8px;
      margin-top: 6px;
      margin-left: 2px;
      align-items: center;
      flex-wrap: wrap;
    }
    #multiSelectControls.active { display: flex; }
    #deleteSelectedBtn {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 18px;
      font-size: 0.97em;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 1px 7px #ef444433;
      transition: background .14s, box-shadow .13s;
      margin-left: 0;
    }
    #shareSelectedBtn {
      background: #2b3548;
      color: var(--accent2);
      border: 1px solid #364052;
      border-radius: var(--rounded-btn);
      padding: 10px 16px;
      font-size: 0.95em;
      font-weight: 700;
      cursor: pointer;
      margin-left: 0;
    }
    #exportSelectedBtn {
      background: #18313c;
      color: var(--button-skyblue);
      border: 1.5px solid var(--button-skyblue);
      border-radius: var(--rounded-btn);
      padding: 10px 16px;
      font-size: 0.95em;
      font-weight: 700;
      cursor: pointer;
      margin-left: 0;
    }
    #exportSelectedBtn:disabled { background:#333; color:#777; border-color:transparent; cursor:not-allowed;}
    
    #deleteSelectedBtn:disabled, #shareSelectedBtn:disabled { background: #333; color:#777; cursor: not-allowed; border-color:transparent;}
    #selectAllCheckbox { accent-color: var(--accent2); margin-left:4px; margin-right:0; transform: scale(1.1); }

    .product-list { margin:0; padding:0; list-style:none; }

    .rounded-sky-btn {
      background: var(--button-gradient);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 20px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1.5px 10px #2eb9f733;
      transition: background .15s, box-shadow .14s, transform .10s;
      outline: none;
      margin: 2px 0;
      letter-spacing: 0.02em;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent; 
      -webkit-user-select: none;
      user-select: none;
      flex-shrink: 0;
    }
    .rounded-sky-btn:hover,
    .rounded-sky-btn:active {
      background: linear-gradient(90deg, #0e9fec, #2563EB 95%);
      box-shadow: 0 3px 16px #43c7fc43;
      transform: translateY(-1.5px) scale(1.03);
    }
    .rounded-sky-btn.cancel {
      background: #18313c;
      color: var(--button-skyblue);
      border: 1.5px solid var(--button-skyblue);
      font-weight: 600;
    }
    .rounded-sky-btn.cancel:hover, .rounded-sky-btn.cancel:active {
      background: #22384a;
      color: #fff;
      border-color: #1095b7;
    }
    
    /* Small Button Variant for Uploads */
    .btn-small {
        padding: 8px 12px !important;
        font-size: 0.9em !important;
    }
    
    #biometricUnlockBtn {
      background: linear-gradient(90deg, #10b981 30%, #059669 100%);
      width: 100%;
      margin-top: 10px;
      display: none; 
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    button, .rounded-sky-btn, .prod-actions button, .modal-close, input[type="button"], input[type="submit"], .remove-photo-btn {
      -webkit-tap-highlight-color: transparent !important;
      tap-highlight-color: transparent !important;
      outline: none !important;
    }
    button:focus, .rounded-sky-btn:focus, .prod-actions button:focus, .modal-close:focus, .remove-photo-btn:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    input[type="button"]:focus, input[type="submit"]:focus { outline:none !important; box-shadow:none !important; }
    .card button:focus-visible, .card button:focus, .prod-actions button:focus, .rounded-sky-btn:focus, .remove-photo-btn:focus {
      outline: none !important;
      box-shadow: none !important;
      border-color: inherit !important;
      background-clip: padding-box;
    }
    .prod-card, .prod-card * {
      -webkit-tap-highlight-color: transparent !important;
      tap-highlight-color: transparent !important;
    }
    button:focus:not(:focus-visible), .rounded-sky-btn:focus:not(:focus-visible), .modal-close:focus:not(:focus-visible), .remove-photo-btn:focus:not(:focus-visible) {
      outline: none !important;
      box-shadow: none !important;
    }

    .modal-file-upload-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 13px;
      margin-top: 2px;
    }
    .modal-file-label {
      font-weight: 600;
      font-size: .96em;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
    }
    .modal-file-upload-btn {
      display: inline-block;
      position: relative;
    }
    .modal-file-upload-btn input[type="file"] {
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .remove-photo-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      font-size: 1.18em;
      font-weight: bold;
      margin-left: 4px;
      cursor: pointer;
      transition: background 0.14s, color 0.12s;
      box-shadow: 0 1px 5px #ef444433;
      z-index: 2;
      vertical-align: middle;
    }
    .remove-photo-btn:hover, .remove-photo-btn:focus {
      background: #ce3737;
      color: #fff;
    }
    .photo-preview-wrap {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .photo-preview-img-thumb {
      max-width: 42px;
      max-height: 42px;
      border-radius: 7px;
      object-fit: cover;
      border: 2px solid var(--accent2-hover);
      margin-right: 2px;
      background: #273855;
      display: block;
    }

    .prod-card { 
      background:var(--bg3); 
      border-radius:13px; 
      margin-bottom:16px; 
      box-shadow:0 2px 10px #2c345128; 
      display:flex; 
      gap:19px; 
      align-items:center; 
      padding:18px 20px; 
      position:relative; 
      animation:fadeUp .3s ease-out; 
      opacity:0; 
      transform:translateY(15px); 
      animation-fill-mode:forwards; 
      cursor:pointer; 
      border:2px solid transparent; 
      transition:box-shadow .14s, border-color .16s; 
      content-visibility: auto; 
    }
    .prod-card.show { opacity:1; transform:none; }
    .prod-card:hover { border-color:var(--accent2); box-shadow:0 6px 24px #18346023; }
    
    .prod-img { 
        min-width:43px; width:43px; height:43px; 
        border-radius:10px; background:#21293f; 
        flex-shrink:0; display:flex; align-items:center; justify-content:center; 
        color:var(--accent2); font-size:1.45em; overflow:hidden; 
        cursor: zoom-in;
    }
    .prod-photo-thumb { max-width:100%; max-height:43px; border-radius:8px; object-fit:cover; background:#232b36; display:block; }
    
    .prod-name { font-weight:700; font-size:1.15em; color:var(--text); letter-spacing:-0.5px; margin-bottom:1.5px; }
    .prod-details { color:var(--gray); font-size:.97em; margin-top:2px; margin-bottom:2px; }
    .prod-actions { margin-left:auto; display:flex; gap:7px; align-items:center; }
    .prod-actions button { background:none; border:none; color:var(--accent2); font-size:1.32em; cursor:pointer; transition:color .13s; border-radius:5px; padding:3px 5px; outline:none; }
    .prod-select-checkbox {
      margin-right: 18px;
      transform: scale(1.25);
      accent-color: var(--accent2);
      cursor:pointer;
    }
    .prod-card.selected { border-color: var(--danger); background: #1b1d2d; box-shadow: 0 4px 16px #ef44441a;}
    .prod-card .prod-select-checkbox:focus { outline: 2px solid var(--accent2); outline-offset:1px;}

    .category-header {
        font-size: 0.95em;
        font-weight: 800;
        color: var(--accent2);
        background: rgba(33, 41, 54, 0.5);
        padding: 8px 12px;
        margin-top: 15px;
        margin-bottom: 12px;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-left: 4px solid var(--accent);
    }
    .category-header:first-child { margin-top: 0; }
    
    #activeCategoryDisplay {
        display: none;
        width: 100%;
        margin-bottom: 12px;
        padding: 8px 12px;
        background: rgba(6, 182, 212, 0.15);
        color: var(--accent2);
        border: 1px dashed var(--accent2);
        border-radius: 10px;
        font-weight: 700;
        text-align: center;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
    }
    #activeCategoryDisplay:hover { background: rgba(6, 182, 212, 0.25); }
    #activeCategoryDisplay.show { display: flex; }
    #activeCategoryDisplay.show { box-sizing: border-box; }
    
    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 50vh;
        overflow-y: auto;
    }
    .category-item-btn {
        background: #253048;
        color: var(--text);
        border: 1px solid #364052;
        padding: 12px;
        border-radius: 10px;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: background 0.15s, transform 0.1s;
    }
    .category-item-btn:hover { background: #303d58; transform: translateY(-2px); border-color: var(--accent2); }
    .category-item-btn.active { background: var(--button-gradient); color: #fff; border-color: transparent; }

    .no-products { text-align:center; color:var(--text-muted); font-size:1.12em; margin:34px 0 14px 0; letter-spacing:.01em; }
    .modal-backdrop { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(18,23,32,0.92); z-index:4999; display:flex; align-items:center; justify-content:center; opacity:1; visibility:visible; transition:opacity .21s; }
    .modal-backdrop.hide { opacity:0; visibility:hidden; pointer-events:none; }
    .modal { min-width:320px; max-width:98vw; background:var(--bg2); border-radius:var(--radius-card); box-shadow:var(--shadow); z-index:6000; padding:36px 22px 23px 22px; animation:fadeUp .3s; display:flex; flex-direction:column; align-items:stretch; position:relative; }
    
    #categoryModal {
        max-width: 650px; 
        width: 92%;
    }
    
    .modal h3 { margin:0 0 18px 0; color:var(--accent2); text-align:center; font-weight:800; font-size:1.26em; letter-spacing:-.2px; }
    .modal-close { position:absolute; top:13px; right:14px; background:none; border:none; color:var(--accent2); font-size:1.24em; cursor:pointer; font-weight:bold; outline:none; }
    .modal label { font-weight:600; font-size:.96em; color:var(--text-muted); margin-bottom:4px; }
    .modal input[type=text], .modal input[type=number], .modal input[type=file], .modal input[type=password], .modal textarea { border-radius:7px; border:1.5px solid #253048; background:var(--bg3); color:var(--text); font-size:1em; padding:8px 11px; margin-bottom:13px; margin-top:2px; outline:none; width:100%; box-sizing:border-box; transition:border .13s; }
    .modal textarea { min-height:54px; resize:vertical; }
    .modal-btnbar { display:flex; align-items:center; justify-content:flex-end; gap:13px; margin-top:6px; }
    .modal button[type=submit] { background:linear-gradient(95deg,var(--accent2),var(--accent)); color:#fff; padding:11px 22px; font-size:1em; border:none; border-radius:8px; font-weight:700; cursor:pointer; box-shadow:0 2px 10px #1b314e28; margin:6px 0; transition:background .14s; outline:none; }
    .modal .error { font-size:.98em; color:var(--danger); margin-bottom:7px; min-height:18px; text-align:left; }
    
#detailModal {
  max-width: 260px;
  width: 85%;
  padding-top: 30px;
}

#detailModal .prod-detail-photo { 
  display: block; 
  width: 85%; 
  max-width: 170px;
  height: 170px;
  object-fit: cover; 
  border-radius: 20px; 
  margin: 8px auto 16px auto; 
  box-shadow: 0 4px 16px #1b314e33; 
  background: #21293f; 
}

#detailModalBody ul { font-size: 0.78em; }
#detailModalBody ul li { margin-bottom: 6px; }

    .show-password-wrap {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
    }
    #showLoginPINBtn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--accent2);
      cursor: pointer;
      font-size: 1.11em;
      opacity: 0.79;
      padding: 2px 7px;
      border-radius: 8px;
      z-index: 5;
      user-select: none;
      -webkit-tap-highlight-color: transparent !important;
      outline: none !important;
    }
    #showLoginPINBtn:active, #showLoginPINBtn:focus {
      background: #1f2336;
      color: var(--accent2-hover);
      outline: none !important;
      box-shadow: none !important;
    }
    
    .share-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 20px;
    }
    .share-option-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        background: #1e2530;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
    }
    .share-option-row:hover { background: #262f3d; }
    .share-option-row input[type="checkbox"] {
        width: auto;
        margin: 0;
        transform: scale(1.2);
        accent-color: var(--accent2);
        cursor: pointer;
    }

    /* --- FULL SCREEN IMAGE VIEWER --- */
    #imageViewerOverlay {
        position: fixed;
        inset: 0;
        z-index: 8000;
        background: rgba(0,0,0,0.95);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s ease-out;
    }
    #imageViewerOverlay.show { display: flex; }
    #imageViewerImg {
        max-width: 95vw;
        max-height: 85vh;
        object-fit: contain;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #imageViewerClose {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        background: rgba(255,255,255,0.1);
        border: none;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }
    #imageViewerClose:hover { background: rgba(255,255,255,0.25); }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    /* --- PRINTING STYLES (PDF Generation) --- */
    #printableArea {
        display: none;
        background: white;
        color: black;
        font-family: 'Arial', sans-serif;
        padding: 40px;
    }
    @media print {
        body > *:not(#printableArea) {
            display: none !important;
        }
        #printableArea {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            z-index: 9999;
            background: white !important;
            color: black !important;
        }
        .print-product-page {
            page-break-after: always;
            margin-bottom: 50px;
        }
        .print-product-page:last-child {
            page-break-after: auto;
        }
        .print-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .print-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .print-title { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .print-product-img {
            max-width: 300px;
            max-height: 300px;
            display: block;
            margin: 20px auto;
            border: 1px solid #ddd;
        }
        .print-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 18px;
        }
        .print-details-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .print-label { font-weight: bold; width: 40%; }
        .print-notes-box {
            margin-top: 30px;
            padding: 15px;
            border: 1px dashed #aaa;
            background: #f9f9f9;
        }
    }

    body.modal-open {
      overflow: hidden !important;
      position: fixed !important;
      width: 100vw;
    }
    body.detail-modal-open {
      overflow: hidden !important;
    }

    @media (max-width:650px){
      html, body { font-size: 15.5px; }
      .container{padding:10px 2vw 17px 2vw;}
      .card{padding:.54rem .26rem 0.7rem .47rem;}
      .app-title{font-size:1.02rem;}
      
      .prod-card{
        padding: 12px 10px;
        gap: 14px;
        border-radius: 9px;
        margin-bottom: 10px;
        min-height: 64px;
      }
      
      .prod-img{ 
          min-width: 48px; width: 48px; height: 48px; 
          font-size: 1.5em; border-radius: 9px;
      }
      .prod-photo-thumb { max-width:100%; max-height:48px; border-radius:8px; }
      
      .prod-name{ font-size: 1.1em; margin-bottom: 1px;}
      .prod-details{ font-size: 0.92em; margin-top: 2px; margin-bottom: 2px;}
      
      .prod-actions{ gap: 8px; }
      .prod-actions button{font-size: 1.15em; padding: 4px;}
      
      .prod-select-checkbox { margin-right: 12px; transform: scale(1.35); padding: 5px; }
      
      .modal{padding:12vw 2vw 3vw 2vw; min-width:unset;}
      
      #detailModal .prod-detail-photo{ width: 100%; max-width: 190px; height: 190px;}
      
      #mobileInstallInstructions{max-width:98vw;font-size:0.92em;}
      #multiSelectControls{font-size:0.96em; flex-wrap:wrap;}
      .photo-preview-img-thumb { max-width:22px; max-height:22px; }
      .remove-photo-btn { width:18px; height:18px; font-size:.95em;}
    }
    ::selection{background:var(--accent2); color:#fff;}
    a{color:var(--accent);}
    .hidden { display:none !important; }
    
    .keep-logged-toggle {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-top: 8px;
      user-select: none;
      font-size: .99em;
      color: var(--text-muted);
      cursor: pointer;
    }
    .keep-logged-toggle input[type="checkbox"] {
      accent-color: var(--accent2);
      transform: scale(1.13);
      margin-right: 2px;
    }
    #timeoutNotice {
      font-size: .97em;
      color: var(--accent2);
      margin-top: 11px;
      text-align: center;
      display: none;
      font-weight: 600;
      background: #122447;
      padding: 8px 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="printableArea"></div>

  <div id="imageViewerOverlay">
      <button id="imageViewerClose">‚úñ</button>
      <img id="imageViewerImg" src="" alt="Full Screen" />
  </div>

  <div id="login-modal" style="position:fixed; inset:0; z-index:7000; background:rgba(22,27,34,0.89); display:flex; justify-content:center; align-items:center;">
    <form class="login-dialog modal" id="loginForm" autocomplete="off" novalidate style="max-width:380px;">
      <button class="modal-close" type="button" id="loginCloseBtn" title="Close" aria-label="Close dialog" role="button" style="display:none">‚úñ</button>
      <h3 style="text-align:center;color:var(--accent2);margin-bottom:12px">üîê Dealer Login</h3>
      <div class="error input-error" id="login-error" style="min-height:18px;margin-bottom:8px"></div>

      <label id="pinLabel" for="loginPIN">Create a secure PIN / Password</label>
      <div class="show-password-wrap">
        <input type="password" id="loginPIN" minlength="4" maxlength="32" required placeholder="Set PIN or password" autocomplete="new-password" />
        <button type="button" id="showLoginPINBtn" title="Show/Hide PIN" tabindex="-1" aria-label="Show password" style="display:inline-flex;align-items:center;">
          <span id="showLoginPINBtnIcon" aria-hidden="true">&#128065;</span>
        </button>
      </div>

      <label class="keep-logged-toggle" title="If checked, you stay logged in for 5 minutes unless the app is closed or device is locked.">
        <input type="checkbox" id="keepLoggedInToggle" />
        <span>Keep me logged in for 30 Minutes</span>
      </label>
      <div id="timeoutNotice"></div>

      <div style="display:flex; flex-direction:column; gap:10px; align-items:center; width:100%; margin-top:10px;">
        <button type="submit" id="loginBtn" style="width:100%;">Set PIN</button>
        <button type="button" id="biometricUnlockBtn" class="rounded-sky-btn" title="Unlock with Fingerprint">
           üëÜ Unlock with Fingerprint
        </button>
        <button type="button" id="forgotBtn" style="display:none; background:transparent; border:1px solid #253048; color:var(--text); padding:9px 12px; border-radius:8px; cursor:pointer;">Forgot</button>
      </div>

      <small style="display:block;margin-top:12px;color:var(--text-muted);">All data is stored locally in your browser. PIN is hashed before saving.</small>
    </form>
  </div>

  <div id="dealerApp" class="" style="display:none;">
    <div class="container">
      <header>
        <div class="logo-wrap">
          <div class="app-logo" title="Al Rehman Electronics" style="padding:0;">
            <img src="https://github.com/ashardiyan/test/blob/e8a700de371269b411bebca7c951e8ce92c400d8/Al%20Rahman%20Electronics-02.png?raw=true" alt="App Logo" style="width:100%;height:100%;border-radius:16px;object-fit:cover;background:#fff;border:none;"/>
          </div>
          <span class="app-title">Al Rehman Electronics</span>
        </div>
        <div class="top-controls">
          <button id="installPromptBtn" title="Install as App">üì≤ Install</button>
          <button id="installAsAppBtn" title="Install as App (force)">üõ†Ô∏è</button>
          <button id="settingsBtn" title="Settings (‚ãÆ)">‚ãÆ</button>
          <span id="mobileInstallInstructions"></span>
        </div>
      </header>

      <div class="main-content">
        <section class="card" style="animation-delay:.06s">
          <div class="products-top-actions">
            <div class="product-search-wrap">
              <input type="search" placeholder="Search by name, category, or note..." id="productSearch" autocomplete="off" />
              <span class="search-icon">&#128269;</span>
            </div>
            <button type="button" id="addProductBtn" class="rounded-sky-btn">+ Add</button>
            <button type="button" id="categoryFilterBtn" class="rounded-sky-btn">Category</button>
            <button type="button" id="exportBtn" class="rounded-sky-btn">Export</button>
            <button type="button" id="importBtn" class="rounded-sky-btn">Import</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
          
          <div id="activeCategoryDisplay"></div>
          
          <div id="multiSelectControls">
            <label style="display:flex;align-items:center;gap:4px;margin-right:10px;">
              <input type="checkbox" id="selectAllCheckbox" title="Select all" />
              <span style="user-select:none;">Select all</span>
            </label>
            <div style="display:flex;gap:6px; flex-wrap:wrap;">
                <button type="button" id="deleteSelectedBtn" disabled>üóëÔ∏è Delete</button>
                <button type="button" id="exportSelectedBtn" disabled>üíæ Export JSON</button>
                <button type="button" id="shareSelectedBtn" disabled>üì§ Share PDF</button>
            </div>
            <span id="selectedCountText" style="color:var(--danger);font-weight:600;font-size:0.99em;margin-left:5px;"></span>
          </div>
          <ul class="product-list" id="productList"></ul>
          <div class="no-products" id="noProducts" style="display:none">No products yet. Click <b>+ Add</b> to get started!</div>
        </section>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="productModalBackdrop">
    <form class="modal" id="productModal" autocomplete="off">
      <button class="modal-close" type="button" id="closeModalBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3 id="modalTitle">Add Product</h3>
      <div class="error" id="modalError" style="min-height:18px"></div>
      <label for="prodName">Name</label>
      <input type="text" id="prodName" required maxlength="64" />
      <label for="prodMrp">MRP (‚Ç®)</label>
      <input type="number" id="prodMrp" min="0" max="100000" step="0.01" required />
      <label for="prodCost">Cost Price (‚Ç®)</label>
      <input type="number" id="prodCost" min="0" max="100000" step="0.01"/>
      <label for="prodQty">Quantity</label>
      <input type="number" id="prodQty" min="0" max="100000" required />
      <label for="prodCategory">Category</label>
      <input type="text" id="prodCategory" maxlength="32" placeholder="e.g. Washing Machine" />
      <label for="prodNotes">Notes</label>
      <textarea id="prodNotes" maxlength="120" placeholder=""></textarea>
      <span class="modal-file-label">Photo <span title="Binary Blob storage used for maximum efficiency." style="font-size:1.1em;color:var(--accent2)">[efficient binary format]</span></span>
      <div class="modal-file-upload-wrap" id="fileUploadWrap">
        <span class="modal-file-upload-btn rounded-sky-btn btn-small" id="uploadBtnText" style="flex:1; text-align:center;">
          <svg width="18" height="18" style="margin-right:6px;vertical-align:-4px" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <span id="uploadBtnInnerText">Gallery</span>
          <input type="file" id="prodPhoto" accept="image/jpeg, image/png" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;"/>
        </span>
        
        <span class="modal-file-upload-btn rounded-sky-btn btn-small" id="cameraBtnText" style="flex:1; text-align:center; background: var(--accent2);">
          <span style="font-size:1.15em; margin-right:4px;">üì∑</span>
          <span>Camera</span>
          <input type="file" id="prodCamera" accept="image/jpeg, image/png" capture="environment" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;"/>
        </span>
      </div>
      <div id="prodPhotoFileContainer" class="photo-preview-wrap" style="min-width:1em; margin-bottom: 8px;">
        <span id="prodPhotoFileName" style="color:var(--text-muted);font-size:.99em;"></span>
      </div>
      
      <div class="modal-btnbar">
        <button type="submit" id="saveProductBtn" class="rounded-sky-btn">Save</button>
      </div>
      <div id="imageCompressMsg" style="font-size:.99em;color:var(--text-muted);margin-top:10px;user-select:none;display:none"></div>
    </form>
  </div>
  
  <div class="modal-backdrop hide" id="categoryModalBackdrop">
    <div class="modal" id="categoryModal">
        <button class="modal-close" type="button" id="closeCategoryBtn" title="Close" aria-label="Close dialog">‚úñ</button>
        <h3>Select Category</h3>
        <div id="categoryGrid" class="category-grid">
            </div>
    </div>
  </div>
  
  <div class="modal-backdrop hide" id="shareModalBackdrop">
    <div class="modal" id="shareModal">
      <button class="modal-close" type="button" id="closeShareBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>üì§ Share Product PDF</h3>
      <div id="shareSubtitle" style="margin-bottom:15px;color:var(--text-muted);text-align:center;">Select fields to include in the generated PDF/Print.</div>
      
      <div class="share-options">
          <label class="share-option-row">
              <input type="checkbox" id="sharePhoto" checked> <span>Include Photo</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareMrp" checked> <span>Include MRP (Price)</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareCost"> <span>Include Cost Price</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareQty" checked> <span>Include Quantity</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareCategory" checked> <span>Include Category</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareNotes" checked> <span>Include Notes</span>
          </label>
      </div>

      <div class="modal-btnbar">
        <button type="button" id="generatePdfBtn" class="rounded-sky-btn">üñ®Ô∏è Generate PDF / Print</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="deleteModalBackdrop">
    <form class="modal" id="deleteModal">
      <button class="modal-close" type="button" id="closeDeleteBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>Delete Product</h3>
      <div style="margin:11px 0 17px 0">Are you sure you want to delete <b id="deleteName"></b>?</div>
      <div class="modal-btnbar">
        <button type="button" id="cancelDeleteBtn" class="rounded-sky-btn cancel">Cancel</button>
        <button type="submit" style="background:var(--danger);border-radius:10px;padding:10px 22px;color:#fff;border:none;font-weight:700;box-shadow:0 2px 10px #1b314e28;transition:background .14s;outline:none;">Yes, Delete</button>
      </div>
    </form>
  </div>

  <div class="modal-backdrop hide" id="detailModalBackdrop">
    <div class="modal" id="detailModal" tabindex="-1">
      <button class="modal-close" type="button" id="closeDetailModalBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>Product Details</h3>
      <div id="detailModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="settingsBackdrop">
    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <button class="modal-close" type="button" id="closeSettingsBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3 id="settingsTitle">Settings</h3>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">Account</div>
            <div style="color:var(--text-muted);font-size:.94em;">Logout or reset your PIN</div>
          </div>
        </div>

        <button id="logoutBtn" style="padding:10px;border-radius:8px;border:none;background:#2b2f3a;color:var(--text);cursor:pointer;">üîí Logout</button>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700; display:flex; align-items:center; gap:6px;">
          Fingerprint / Face ID
        </div>
        <button id="setupBiometricBtn" class="rounded-sky-btn" style="background:#2b2f3a; border:1px solid #364052;">
           üëÜ Setup Fingerprint
        </button>
        <div style="color:var(--text-muted);font-size:.85em;margin-bottom:6px;">
           Enable easy unlock using your device's sensor.
        </div>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700">Reset PIN</div>
        <div style="color:var(--text-muted);font-size:.93em;margin-bottom:6px;">Enter your current PIN, then choose a new one.</div>

        <label for="oldPin">Current PIN</label>
        <input type="password" id="oldPin" placeholder="Current PIN" maxlength="32" />

        <label for="newPin">New PIN</label>
        <input type="password" id="newPin" placeholder="New PIN (min 4 chars)" maxlength="32" />

        <label for="confirmPin">Confirm New PIN</label>
        <input type="password" id="confirmPin" placeholder="Confirm new PIN" maxlength="32" />

        <div class="error" id="resetPinError" style="min-height:18px;"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px;">
          <button id="resetPinCancel" class="rounded-sky-btn cancel">Cancel</button>
          <button id="resetPinSubmit" class="rounded-sky-btn">Reset PIN</button>
        </div>
      </div>

    </div>
  </div>

  <input type="file" id="hiddenImport" accept="application/json" style="display:none">

  <script>
    /****************************************************************
     * BIOMETRIC (FINGERPRINT/FACE ID) LOGIC
     ****************************************************************/
    const strToBuffer = (str) => Uint8Array.from(str, c => c.charCodeAt(0));
    const randomBuffer = (len) => {
      const arr = new Uint8Array(len);
      window.crypto.getRandomValues(arr);
      return arr;
    };

    function hasBiometricSetup() {
       return !!localStorage.getItem('dealer-bio-cred-id');
    }

    async function registerBiometric() {
        if (!window.PublicKeyCredential) {
            alert("Biometrics not supported on this browser.");
            return;
        }
        const userId = window.localStorage.getItem('dealer-hash') || 'default-user';
        try {
            const publicKeyCredentialCreationOptions = {
                challenge: randomBuffer(32),
                rp: { name: "Al Rehman Electronics", id: window.location.hostname },
                user: { id: strToBuffer(userId), name: "dealer@local", displayName: "Dealer" },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }, { alg: -257, type: "public-key" }],
                authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required", residentKey: "preferred" },
                timeout: 60000,
                attestation: "none"
            };
            const credential = await navigator.credentials.create({ publicKey: publicKeyCredentialCreationOptions });
            const credId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
            localStorage.setItem('dealer-bio-cred-id', credId);
            alert("Fingerprint setup successful! You can now use it to unlock.");
            checkBiometricButtonVisibility();
        } catch (err) {
            console.error(err);
            if(err.name === 'NotAllowedError') alert("Setup cancelled or timed out.");
            else if (window.location.protocol === 'file:') alert("Security Error: Biometrics do not work on local files (file://).");
            else alert("Setup failed: " + err.message);
        }
    }

    async function authenticateBiometric() {
        if (!hasBiometricSetup()) return;
        try {
            const publicKeyCredentialRequestOptions = {
                challenge: randomBuffer(32),
                rpId: window.location.hostname,
                userVerification: "required",
                allowCredentials: [{ id: Uint8Array.from(atob(localStorage.getItem('dealer-bio-cred-id')), c => c.charCodeAt(0)), type: 'public-key', transports: ['internal'] }]
            };
            const assertion = await navigator.credentials.get({ publicKey: publicKeyCredentialRequestOptions });
            if (assertion) {
                showDealerApp();
                const keepLoggedInToggle = document.getElementById('keepLoggedInToggle');
                if (keepLoggedInToggle.checked) {
                     setKeepSessionActive(Date.now() + KEEP_LOGGED_TIMEOUT_MS);
                     startSessionTimeoutMonitor();
                } else {
                     clearKeepSession();
                     stopSessionTimeoutMonitor();
                }
            }
        } catch (err) {
            console.error(err);
            const loginError = document.getElementById('login-error');
            loginError.textContent = "Fingerprint not recognized. Use PIN.";
            loginError.style.color = 'var(--danger)';
        }
    }

    function checkBiometricButtonVisibility() {
        const btn = document.getElementById('biometricUnlockBtn');
        if(hasBiometricSetup() && getHasPIN()) btn.style.display = 'flex';
        else btn.style.display = 'none';
    }

    /****************************************************************
     * EXISTING APP LOGIC
     ****************************************************************/
    (function() {
      function lockBodyScroll() {
        if (!document.body.classList.contains('modal-open')) {
          document.body.dataset.scrollY = window.scrollY;
          document.body.style.top = `-${window.scrollY}px`;
          document.body.classList.add('modal-open');
        }
      }
      function unlockBodyScroll() {
        if (document.body.classList.contains('modal-open')) {
          document.body.classList.remove('modal-open');
          const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
          document.body.style.top = '';
          window.scrollTo(0, scrollY);
          delete document.body.dataset.scrollY;
        }
      }

      function observeProductModalOpen() {
        const productModalBackdrop = document.getElementById('productModalBackdrop');
        if (!productModalBackdrop) return;
        const config = { attributes: true, attributeFilter: ['class'] };
        const observer = new MutationObserver(() => {
          if (!productModalBackdrop.classList.contains('hide')) {
            lockBodyScroll();
          } else {
            unlockBodyScroll();
          }
        });
        observer.observe(productModalBackdrop, config);
        window.addEventListener('beforeunload', unlockBodyScroll);
      }
      window.addEventListener('DOMContentLoaded', observeProductModalOpen);
      window.addEventListener('keydown', function(e) {
        if (e.key === "Escape") {
          unlockBodyScroll();
        }
      });
    })();
  </script>
  <script>
    /****************************************************************
     * Keep-logged-in authentication logic
     ****************************************************************/
    const KEEP_LOGGED_TIMEOUT_MS = 30*60*1000;

    function setKeepSessionActive(expiresAt) { try { localStorage.setItem('dealer-keep-expires', String(expiresAt)); } catch(e) {} }
    function getKeepSessionActive() { try { const val = localStorage.getItem('dealer-keep-expires'); return val && /^\d+$/.test(val) ? parseInt(val, 10) : null; } catch(e) { return null; } }
    function clearKeepSession() { try { localStorage.removeItem('dealer-keep-expires'); } catch(e) {} }
    
    function showTimeoutNotice(msg) {
      const t = document.getElementById('timeoutNotice');
      t.textContent = msg || '';
      t.style.display = msg ? 'block' : 'none';
    }
    
    function isSessionStillActive() { const expiresAt = getKeepSessionActive(); return !!expiresAt && Date.now() < expiresAt; }
    
    function showTimeoutCountdownIfAny() {
      const expiresAt = getKeepSessionActive();
      if (expiresAt && Date.now() < expiresAt) {
        const secs = Math.max(0, Math.round((expiresAt-Date.now())/1000));
        if(secs<60) showTimeoutNotice("Session will auto-lock in "+secs+" sec" + (secs===1?"":"s") + ".");
        else if(secs<90) showTimeoutNotice("Session will auto-lock in about 1 min.");
        else showTimeoutNotice("Session will auto-lock in about "+Math.ceil(secs/60)+" min.");
      } else {
        showTimeoutNotice("");
      }
    }
    let timeoutCountdownInterval = null;

    function checkQuickAutoUnlock() {
      if (isSessionStillActive()) {
        updatePINUI(getHasPIN());
        showDealerApp();
        startSessionTimeoutMonitor();
        return true;
      }
      return false;
    }
    function startSessionTimeoutMonitor() {
      if (timeoutCountdownInterval) clearInterval(timeoutCountdownInterval);
      function check() {
        showTimeoutCountdownIfAny();
        if (!isSessionStillActive()) {
          showTimeoutNotice("Session expired for security. Please login again.");
          setTimeout(()=>manualLogoutDueToTimeout(), 1100);
        }
      }
      timeoutCountdownInterval = setInterval(check, 800);
      check();
    }
    function stopSessionTimeoutMonitor() { if (timeoutCountdownInterval) clearInterval(timeoutCountdownInterval); showTimeoutNotice(""); }
    
    function manualLogoutDueToTimeout() {
      stopSessionTimeoutMonitor();
      clearKeepSession();
      document.getElementById('dealerApp').style.display = 'none';
      showLoginModal("Session expired for security. Please login again.");
      updatePINUI(getHasPIN());
    }

    /****************************************************************
     * Service Worker & PWA
     ****************************************************************/
    (function createManifestAndServiceWorker() {
      const imgIcon = "https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true";
      const manifestObj = {
        name: "Al Rehman Electronics",
        short_name: "ARE",
        description: "Local-only dealer product listing (offline-first)",
        start_url: "./index.html", 
        display: "standalone",
        background_color: "#161B22",
        theme_color: "#161B22",
        icons: [{ src: imgIcon, sizes: "192x192", type: "image/png" }, { src: imgIcon, sizes: "512x512", type: "image/png" }]
      };
      const manifestBlob = new Blob([JSON.stringify(manifestObj)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(manifestBlob);
      (function setManifestLink() {
        let existing = document.querySelector('link[rel="manifest"]');
        if (!existing) { existing = document.createElement('link'); existing.rel = 'manifest'; document.head.appendChild(existing); }
        existing.href = manifestURL;
      })();

      const swScript = `
        const CACHE_NAME = 'local-dealer-cache-v14';
        const OFFLINE_URL = self.registration.scope.endsWith('/') ? self.registration.scope + 'index.html' : self.registration.scope + '/index.html';
        const FILES_TO_CACHE = [ OFFLINE_URL, './index.html' ];
        self.addEventListener('install', function(event) { event.waitUntil(caches.open(CACHE_NAME).then(function(cache) { return cache.addAll(FILES_TO_CACHE); })); self.skipWaiting(); });
        self.addEventListener('activate', function(event) { event.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', function(event) {
          if (event.request.method !== 'GET') return;
          event.respondWith(caches.match(event.request, {ignoreSearch:true}).then(function(response) {
              if (response) return response;
              return fetch(event.request).then(function(resp) {
                if (resp && resp.status === 200 && resp.type === 'basic' && /\.(html|js|css|png|jpg|jpeg|svg|woff2?|json)$/i.test(event.request.url)) {
                  const respClone = resp.clone();
                  caches.open(CACHE_NAME).then(function(cache) { cache.put(event.request, respClone); });
                }
                return resp;
              }).catch(function() {
                if (event.request.mode === 'navigate' || event.request.destination === 'document') return caches.match(OFFLINE_URL);
                return undefined;
              });
            })
          );
        });
      `;
      try {
        const swBlob = new Blob([swScript], { type: 'text/javascript' });
        const swURL = URL.createObjectURL(swBlob);
        if ('serviceWorker' in navigator) { window.addEventListener('load', function() { navigator.serviceWorker.register(swURL); }); }
      } catch (e) {}
    })();

    window.addEventListener('DOMContentLoaded', function(){
      setTimeout(function() { document.querySelectorAll(".card").forEach((el,i)=> { el.classList.add('show'); }); }, 100);
    });

    let deferredPrompt;
    const installBtn = document.getElementById('installPromptBtn');
    const installAsAppBtn = document.getElementById('installAsAppBtn');
    const mobileInstall = document.getElementById('mobileInstallInstructions');
    function isMobileChromeStandaloneCapable() { const ua = navigator.userAgent || ''; return /Android/.test(ua) && /Chrome\/[.0-9]* Mobile/.test(ua) && !window.matchMedia('(display-mode: standalone)').matches; }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'inline-block'; installAsAppBtn.style.display = 'inline-block'; mobileInstall.style.display = 'none';
    });

    installBtn && (installBtn.onclick = async function() {
      installBtn.disabled = true;
      if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display = 'none'; installAsAppBtn.style.display = 'none'; installBtn.disabled = false; }
    });

    installAsAppBtn && (installAsAppBtn.onclick = async function() {
      installAsAppBtn.disabled = true;
      if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display = 'none'; installAsAppBtn.style.display = 'none'; installAsAppBtn.disabled = false; } else { alert("Install prompt not available right now."); installAsAppBtn.disabled = false; }
    });

    window.addEventListener('appinstalled', ()=>{ installBtn.style.display='none'; installAsAppBtn.style.display='none'; deferredPrompt = null; mobileInstall.style.display='none'; });

    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (!window.matchMedia('(display-mode: standalone)').matches && !window.matchMedia('(display-mode: fullscreen)').matches && isMobileChromeStandaloneCapable()) {
          if ((installBtn.style.display === "none" || getComputedStyle(installBtn).display === "none") && (installAsAppBtn.style.display === "none" || getComputedStyle(installAsAppBtn).display === "none")) {
            mobileInstall.innerHTML = "To install this app: tap <b><span style='font-size:1.22em;'>‚ãÆ</span></b> at the top right of Chrome, and choose <b>Add to Home screen</b>."; mobileInstall.style.display = "inline-block";
          }
        }
      }, 1100);
    });

    (function handleAndroidBackButton() {
      let isHandlerAttached = false; // FIX: Prevents duplicate listener attachment
      let openedModals = [];
      const modalPriority = ['imageViewerOverlay', 'productModalBackdrop', 'deleteModalBackdrop', 'settingsBackdrop', 'detailModalBackdrop', 'shareModalBackdrop', 'categoryModalBackdrop'];

      function pushMainStateToHistory() { try { history.replaceState({dealerAppMain: true}, document.title, window.location.href); } catch (e) {} }
      function pushModalState(modalId) { try { history.pushState({modal: modalId}, document.title, window.location.href); openedModals.push(modalId); } catch (e) {} }
      
      function enablePwaBackHandler() {
        pushMainStateToHistory();
        window.addEventListener('popstate', function(e) {
            
          const topOpenModal = (() => { 
                for (let i = 0; i < modalPriority.length; ++i) { 
                    const el = document.getElementById(modalPriority[i]); 
                    if (!el) continue;
                    if (modalPriority[i] === 'imageViewerOverlay') {
                         if (el.classList.contains('show')) return modalPriority[i];
                    } else {
                         if (!el.classList.contains('hide')) return modalPriority[i];
                    }
                } 
                return null; 
            })();
            
            if (topOpenModal) { 
                if (topOpenModal === 'imageViewerOverlay') {
                    document.getElementById(topOpenModal).classList.remove('show');
                    document.getElementById('imageViewerImg').src = '';
                } else {
                    document.getElementById(topOpenModal).classList.add('hide'); 
                }
                setTimeout(()=>{},10); 
                return; 
            }

            if (activeCategoryFilter) {
                activeCategoryFilter = null;
                refreshProductList();
                return;
            }

            const searchInput = document.getElementById('productSearch');
            if (document.getElementById('dealerApp').style.display !== 'none' && searchInput && searchInput.value) {
                 searchInput.value = '';
                 refreshProductList();
                 return; 
            }

            pushMainStateToHistory();
        });
      }
      function setupModalHistoryTracking() {
        modalPriority.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const observer = new MutationObserver(() => {
            let isOpen = false;
            if (id === 'imageViewerOverlay') isOpen = el.classList.contains('show');
            else isOpen = !el.classList.contains('hide');
            
            if (isOpen) { if (!openedModals.includes(id)) pushModalState(id); } 
            else { const idx = openedModals.indexOf(id); if (idx !== -1) openedModals.splice(idx, 1); }
          });
          observer.observe(el, { attributes: true, attributeFilter: ['class'] });
        });
      }
      
      // FIX: Check if already attached before running
      window.__enablePwaBackHandler = function() { 
          if(isHandlerAttached) return;
          isHandlerAttached = true;
          enablePwaBackHandler(); 
          setupModalHistoryTracking(); 
      };
    })();

    async function hashPIN(pin) {
      let salt = window.localStorage.getItem('dealer-app-salt');
      if (!salt) { const arr = new Uint8Array(16); window.crypto.getRandomValues(arr); salt = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join(''); window.localStorage.setItem('dealer-app-salt', salt); }
      const encoder = new TextEncoder();
      try {
        const baseKey = await window.crypto.subtle.importKey('raw', encoder.encode(pin), 'PBKDF2', false, ['deriveBits']);
        const rawBits = await window.crypto.subtle.deriveBits({ name: "PBKDF2", salt: encoder.encode(salt), iterations: 3000, hash: "SHA-256" }, baseKey, 256);
        const hashArr = new Uint8Array(rawBits);
        return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) { return pin + salt; }
    }
    function getHasPIN() { return !!window.localStorage.getItem('dealer-hash'); }
    
    function showDealerApp() {
      document.getElementById('dealerApp').style.display = '';
      document.getElementById('login-modal').style.display = 'none';
      setTimeout(refreshProductList, 100);
      if (typeof window.__enablePwaBackHandler === 'function') window.__enablePwaBackHandler();
    }
    
    function showLoginModal(msg) {
      document.getElementById('dealerApp').style.display = 'none';
      const loginModal = document.getElementById('login-modal');
      loginModal.style.display = 'flex';
      if (msg) { document.getElementById('login-error').textContent = msg; document.getElementById('login-error').style.color = 'var(--danger)'; } else { document.getElementById('login-error').textContent = ''; document.getElementById('login-error').style.color = ''; }
      document.getElementById('loginPIN').value = '';
      if (!hasBiometricSetup()) { setTimeout(()=>document.getElementById('loginPIN').focus(),120); }
      checkBiometricButtonVisibility();
    }
    
    let justSetPIN = false;

    window.addEventListener('load', async ()=> {
      await loadProducts(); 
      updatePINUI(getHasPIN());
      if (!checkQuickAutoUnlock()) { showLoginModal(); if (hasBiometricSetup()) { setTimeout(authenticateBiometric, 400); } }
      setTimeout(function() { if ("serviceWorker" in navigator && window.matchMedia('(display-mode: standalone)').matches) { try { history.replaceState({start:true}, document.title, window.location.href); } catch (e) {} } }, 180);
    });

    const loginBtn = document.getElementById('loginBtn');
    const loginForm = document.getElementById('loginForm');
    const loginPIN = document.getElementById('loginPIN');
    const loginError = document.getElementById('login-error');
    const pinLabel = document.getElementById('pinLabel');
    const keepLoggedInToggle = document.getElementById('keepLoggedInToggle');
    const setupBiometricBtn = document.getElementById('setupBiometricBtn');
    const biometricUnlockBtn = document.getElementById('biometricUnlockBtn');

    setupBiometricBtn.onclick = (e) => { e.preventDefault(); registerBiometric(); };
    biometricUnlockBtn.onclick = (e) => { e.preventDefault(); authenticateBiometric(); };

    (function() {
      const showBtn = document.getElementById('showLoginPINBtn');
      const pinInput = document.getElementById('loginPIN');
      const iconSpan = document.getElementById('showLoginPINBtnIcon');
      let visible = false;
      if (showBtn && pinInput) {
        showBtn.addEventListener('click', function(e) { e.preventDefault(); visible = !visible; pinInput.type = visible ? 'text' : 'password'; iconSpan.textContent = visible ? 'üôà' : 'üëÅÔ∏è'; showBtn.setAttribute('aria-label', visible ? "Hide PIN" : "Show PIN"); });
        pinInput.addEventListener('keydown', function(e) { if (visible && e.key === "Escape") { pinInput.type = 'password'; visible = false; iconSpan.textContent = 'üëÅÔ∏è'; showBtn.setAttribute('aria-label', "Show PIN"); } });
      }
    })();

    function updatePINUI(hasPIN) {
      if (hasPIN) { loginBtn.textContent = "Unlock"; pinLabel.textContent = "Enter your PIN / Password:"; loginPIN.placeholder = "Enter PIN or password"; loginPIN.autocomplete = "current-password"; } else { loginBtn.textContent = "Set PIN"; pinLabel.textContent = "Create a secure PIN / Password:"; loginPIN.placeholder = "Set PIN or password"; loginPIN.autocomplete = "new-password"; }
      loginError.textContent = ''; loginError.style.color = ''; checkBiometricButtonVisibility();
    }

    loginForm.onsubmit = async function(e) {
      e.preventDefault(); loginError.textContent = ''; loginError.style.color = '';
      const pinVal = (loginPIN.value || '').trim();
      const hasPIN = getHasPIN();
      if (!pinVal || pinVal.length < 4) { loginError.style.color = 'var(--danger)'; loginError.textContent = hasPIN ? "Enter your PIN/Password." : "PIN/password must be at least 4 characters."; return; }
      loginBtn.disabled = true;
      try {
        const hash = await hashPIN(pinVal);
        if (!hasPIN) {
          window.localStorage.setItem('dealer-hash', hash);
          justSetPIN = true; updatePINUI(true); loginError.style.color = 'var(--success)'; loginError.textContent = "PIN set. Now use it to unlock."; loginBtn.disabled = false; loginPIN.value = '';
          setTimeout(()=>{ loginError.textContent = ''; loginError.style.color=''; }, 1500); keepLoggedInToggle.checked = false; return;
        }
        const userHash = window.localStorage.getItem('dealer-hash');
        if (userHash === hash) {
          if (keepLoggedInToggle.checked) { setKeepSessionActive(Date.now() + KEEP_LOGGED_TIMEOUT_MS); startSessionTimeoutMonitor(); } else { clearKeepSession(); stopSessionTimeoutMonitor(); }
          showDealerApp(); loginBtn.disabled = false; loginError.textContent = ''; loginError.style.color = ''; justSetPIN = false;
        } else { loginBtn.disabled = false; loginError.style.color='var(--danger)'; loginError.textContent = 'Incorrect PIN / Password.'; }
      } catch (ex) { loginBtn.disabled = false; loginError.style.color='var(--danger)'; loginError.textContent = 'An error occurred. Try again.'; }
    };

    keepLoggedInToggle.onchange = function() { showTimeoutNotice(""); if (!this.checked) clearKeepSession(); };
    document.getElementById('login-modal').addEventListener('transitionend', function() { loginPIN.value = ''; });
    function doLogout(showMsg) { stopSessionTimeoutMonitor(); clearKeepSession(); document.getElementById('dealerApp').style.display = 'none'; showLoginModal(showMsg || 'You have been logged out.'); updatePINUI(getHasPIN()); }

    const settingsBtn = document.getElementById('settingsBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const resetPinSubmit = document.getElementById('resetPinSubmit');
    const resetPinCancel = document.getElementById('resetPinCancel');
    const resetPinError = document.getElementById('resetPinError');

    settingsBtn.onclick = () => { settingsBackdrop.classList.remove('hide'); document.getElementById('oldPin').value = ''; document.getElementById('newPin').value = ''; document.getElementById('confirmPin').value = ''; resetPinError.textContent = ''; resetPinError.style.color = ''; };
    closeSettingsBtn.onclick = () => settingsBackdrop.classList.add('hide');
    logoutBtn.onclick = () => { settingsBackdrop.classList.add('hide'); doLogout(); };
    resetPinCancel.onclick = () => { resetPinError.textContent = ''; resetPinError.style.color = ''; settingsBackdrop.classList.add('hide'); };

    resetPinSubmit.onclick = async function() {
      resetPinError.textContent = ''; resetPinError.style.color = '';
      const oldPin = (document.getElementById('oldPin').value || '').trim();
      const newPin = (document.getElementById('newPin').value || '').trim();
      const confirmPin = (document.getElementById('confirmPin').value || '').trim();
      if (!oldPin || oldPin.length < 4) { resetPinError.textContent = "Enter current PIN (min 4 chars)."; resetPinError.style.color='var(--danger)'; return; }
      if (!newPin || newPin.length < 4) { resetPinError.textContent = "New PIN must be at least 4 characters."; resetPinError.style.color='var(--danger)'; return; }
      if (newPin !== confirmPin) { resetPinError.textContent = "New PIN and confirmation do not match."; resetPinError.style.color='var(--danger)'; return; }
      if (oldPin === newPin) { resetPinError.textContent = "New PIN cannot be same as old PIN."; resetPinError.style.color='var(--danger)'; return;}
      resetPinSubmit.disabled = true;
      try {
        const oldHash = await hashPIN(oldPin);
        const stored = window.localStorage.getItem('dealer-hash');
        if (stored !== oldHash) { resetPinError.textContent = "Current PIN is incorrect."; resetPinError.style.color='var(--danger)'; resetPinSubmit.disabled = false; return; }
        const newHash = await hashPIN(newPin);
        window.localStorage.setItem('dealer-hash', newHash);
        resetPinError.style.color = 'var(--success)'; resetPinError.textContent = "PIN updated successfully.";
        setTimeout(()=>{ resetPinError.textContent = ''; resetPinError.style.color = ''; settingsBackdrop.classList.add('hide'); }, 1000);
      } catch (err) { resetPinError.textContent = "Failed to update PIN."; resetPinError.style.color='var(--danger)'; }
      resetPinSubmit.disabled = false;
    };

    const productListElem = document.getElementById('productList');
    const noProductsElem = document.getElementById('noProducts');
    let products = [];
    let selectedProductIds = new Set();
    
    let currentFilteredProducts = []; 
    let activeCategoryFilter = null; 

    // ***************************************************************
    // * INDEXED DB STORAGE ENGINE (Replaces LocalStorage)         *
    // ***************************************************************
    const DB_NAME = 'DealerDB';
    const STORE_NAME = 'products';
    const DB_VERSION = 1;

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = function(e) {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
            request.onsuccess = e => resolve(e.target.result);
            request.onerror = e => reject(e.target.error);
        });
    }

    async function saveProductsToDB(productsArray) {
        const db = await openDB();
        // Clear old
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        await new Promise((resolve, reject) => {
            const req = store.clear();
            req.onsuccess = resolve;
            req.onerror = reject;
        });

        // Add new
        const tx2 = db.transaction(STORE_NAME, 'readwrite');
        const store2 = tx2.objectStore(STORE_NAME);
        productsArray.forEach(p => store2.put(p));
        return new Promise((resolve, reject) => {
            tx2.oncomplete = resolve;
            tx2.onerror = reject;
        });
    }

    async function loadProductsFromDB() {
        // MIGRATION STEP: Check if LocalStorage has old data
        const localData = localStorage.getItem('dealer-products');
        if (localData) {
            try {
                const parsed = JSON.parse(localData);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    console.log("Migrating data from LocalStorage to IndexedDB...");
                    await saveProductsToDB(parsed);
                    localStorage.removeItem('dealer-products'); // Clear LocalStorage
                    console.log("Migration Complete. LocalStorage cleared.");
                    return parsed;
                }
            } catch(e) { console.error("Migration check failed", e); }
        }

        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        return new Promise((resolve, reject) => {
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => reject(req.error);
        });
    }

    async function saveProducts() { 
        // We update memory immediately, but save async
        try { await saveProductsToDB(products); } catch(e){ console.error("Save failed", e); }
        refreshProductList(); 
    }
    
    async function loadProducts() { 
        products = []; 
        try { products = await loadProductsFromDB(); } catch (e) { products = []; } 
    }

    function escapeHTML(v) { if (typeof v !== "string") return v === undefined || v === null ? "" : String(v); return v.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'" :'&#39;','"':'&quot;'}[c])); }

    function handleCheckboxChange(productId, checked) { if (checked) selectedProductIds.add(productId); else selectedProductIds.delete(productId); updateMultiSelectControls(); }
    
    function updateMultiSelectControls() {
      const multiSelectControls = document.getElementById('multiSelectControls');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const shareSelectedBtn = document.getElementById('shareSelectedBtn');
      const exportSelectedBtn = document.getElementById('exportSelectedBtn');
      const selectedCountText = document.getElementById('selectedCountText');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      
      if (selectedProductIds.size > 0) { 
          multiSelectControls.classList.add('active'); 
          deleteSelectedBtn.disabled = false; 
          shareSelectedBtn.disabled = false;
          if(exportSelectedBtn) exportSelectedBtn.disabled = false;
          selectedCountText.textContent = `${selectedProductIds.size} selected`; 
      } else { 
          multiSelectControls.classList.remove('active'); 
          deleteSelectedBtn.disabled = true; 
          shareSelectedBtn.disabled = true;
          if(exportSelectedBtn) exportSelectedBtn.disabled = true;
          selectedCountText.textContent = ""; 
      }
      
      if (currentFilteredProducts.length > 0) {
          const allVisibleSelected = currentFilteredProducts.every(p => selectedProductIds.has(p.id));
          const someVisibleSelected = currentFilteredProducts.some(p => selectedProductIds.has(p.id));
          
          if(allVisibleSelected) {
              selectAllCheckbox.checked = true;
              selectAllCheckbox.indeterminate = false;
          } else if (someVisibleSelected) {
              selectAllCheckbox.checked = false;
              selectAllCheckbox.indeterminate = true;
          } else {
              selectAllCheckbox.checked = false;
              selectAllCheckbox.indeterminate = false;
          }
      } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
      }
    }
    
    const imageViewerOverlay = document.getElementById('imageViewerOverlay');
    const imageViewerImg = document.getElementById('imageViewerImg');
    const imageViewerClose = document.getElementById('imageViewerClose');
    
    function openImageViewer(src) {
        if(!src) return;
        imageViewerImg.src = src;
        imageViewerOverlay.classList.add('show');
    }
    
    imageViewerClose.onclick = () => { imageViewerOverlay.classList.remove('show'); imageViewerImg.src = ''; };
    imageViewerOverlay.onclick = (e) => {
        if(e.target === imageViewerOverlay) { imageViewerOverlay.classList.remove('show'); imageViewerImg.src = ''; }
    };

    // --- HELPER: GET URL FROM BLOB OR STRING ---
    // If it's a blob (new data), create object URL. If string (old data), use as is.
    function getPhotoSrc(photo) {
        if (!photo) return null;
        if (photo instanceof Blob) {
            return URL.createObjectURL(photo);
        }
        return photo; // Base64 string
    }

    function createProductCard(product, idx) {
      const li = document.createElement('li');
      li.className = 'prod-card';
      li.setAttribute('tabindex','0');
      li.classList.add('show');

      const imgSrc = getPhotoSrc(product.photo);
      let imgHTML = imgSrc ? `<img src="${imgSrc}" class="prod-photo-thumb" alt="Product Photo" loading="lazy">` : `<span>üì¶</span>`;
      
      const nameSafe = escapeHTML(product.name || "Unnamed");
      const qtyNum = Number(product.qty) || 0;
      const mrpNum = Number(product.mrp) || 0;
      let checkboxHTML = `<input type="checkbox" class="prod-select-checkbox" title="Select" data-id="${product.id}" tabindex="0" ${selectedProductIds.has(product.id) ? "checked" : ""}/>`;

      li.innerHTML = `
        ${checkboxHTML}
        <div class="prod-img">${imgHTML}</div>
        <div class="prod-main-details">
          <div class="prod-name">${nameSafe}</div>
          <div class="prod-details">Stock: <b style="color:var(--success);font-weight:600">${qtyNum}</b> ‚Ä¢ ‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</div>
          ${product.notes?`<div class="prod-details">${escapeHTML(String(product.notes)).slice(0,55)}</div>`:""}
        </div>
        <div class="prod-actions">
           <button type="button" title="Edit" aria-label="Edit product" role="button" class="edit" data-id="${product.id}">‚úèÔ∏è</button>
           <button type="button" title="Share PDF" aria-label="Share product" role="button" class="share" data-id="${product.id}">üì§</button>
        </div>
      `;
      if (selectedProductIds.has(product.id)) li.classList.add('selected');
      const checkbox = li.querySelector('.prod-select-checkbox');
      if (checkbox) {
        checkbox.addEventListener('change', (e) => { handleCheckboxChange(product.id, checkbox.checked); });
        checkbox.addEventListener('click', (e)=>e.stopPropagation());
        checkbox.addEventListener('keydown', (e)=>e.stopPropagation());
      }
      
      const editBtn = li.querySelector('.edit');
      if (editBtn) editBtn.onclick = (e)=>{ e.stopPropagation(); showProductModal('edit', product); };
      
      const shareBtn = li.querySelector('.share');
      if (shareBtn) shareBtn.onclick = (e)=>{ e.stopPropagation(); openShareModal(product); };
      
      const thumb = li.querySelector('.prod-img');
      if (thumb && imgSrc) {
          thumb.onclick = (e) => {
              e.stopPropagation();
              openImageViewer(imgSrc);
          };
      }

      li.addEventListener('click', function(e){ if(e.target.classList.contains('prod-select-checkbox')) return; if(!e.target.closest('.prod-actions')) showDetailModal(product); });
      li.addEventListener('keydown', function(e){ if((e.key==="Enter"||e.key===" ") && !e.target.closest('.prod-actions')) { e.preventDefault(); showDetailModal(product); } });
      return li;
    }

    document.getElementById("selectAllCheckbox").addEventListener("change", function() { 
        if (this.checked) { 
            currentFilteredProducts.forEach(prod => selectedProductIds.add(prod.id)); 
        } else { 
            currentFilteredProducts.forEach(prod => selectedProductIds.delete(prod.id)); 
        } 
        refreshProductList(); 
        updateMultiSelectControls(); 
    });
    
    document.getElementById("deleteSelectedBtn").onclick = function() { if (selectedProductIds.size === 0) return; if (!confirm(`Are you sure you want to delete ${selectedProductIds.size} selected item(s)?`)) return; products = products.filter(p => !selectedProductIds.has(p.id)); selectedProductIds.clear(); saveProducts(); updateMultiSelectControls(); };

    document.getElementById("shareSelectedBtn").onclick = function() {
        if (selectedProductIds.size === 0) return;
        const itemsToShare = products.filter(p => selectedProductIds.has(p.id));
        if(itemsToShare.length > 0) {
            openShareModal(null, itemsToShare);
        }
    };

    // --- UPDATED EXPORT LOGIC: CONVERT BLOBS TO BASE64 STRINGS ---
    document.getElementById('exportBtn').onclick = async function() {
      const now = new Date();
      const dateStr = now.toISOString().slice(0,10);
      const timeStr = now.toTimeString().slice(0,5).replace(':','-');
      const filename = `dealer-backup-${dateStr}_${timeStr}.json`;
      
      // Convert Blobs to Base64 for JSON storage
      const dataToExport = await Promise.all(products.map(async (p) => {
          let photoData = p.photo;
          if (p.photo instanceof Blob) {
              photoData = await new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onloadend = () => resolve(reader.result);
                  reader.readAsDataURL(p.photo);
              });
          }
          return { ...p, photo: photoData };
      }));

      const dataStr = JSON.stringify(dataToExport, null, 2);
      const blob = new Blob([dataStr], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.style.display='none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); setTimeout(()=>{ document.body.removeChild(a); }, 200);
    };

    document.getElementById('importBtn').onclick = function () { 
        let fileInput = document.getElementById('hiddenImport'); 
        if (fileInput) fileInput.value = ''; 
        if (fileInput) fileInput.click(); 
    };

    // --- UPDATED IMPORT LOGIC: CONVERT BASE64 STRINGS BACK TO BLOBS ---
    document.getElementById('hiddenImport').onchange = async function (e) {
      const fileInput = e.target;
      if (!fileInput.files || !fileInput.files.length) return;
      const file = fileInput.files[0];

      if (!(file && (file.type === 'application/json' || /\.json$/i.test(file.name)))) { alert('Please select a valid .json backup file.'); return; }

      try {
        let text = await file.text();
        let importedArr = JSON.parse(text); 
        if (!Array.isArray(importedArr)) throw new Error('Invalid file format. Data must be an array.');
        
        // Convert Base64 strings back to Blobs for efficiency
        importedArr = await Promise.all(importedArr.map(async (p) => {
            if (p.photo && typeof p.photo === 'string' && p.photo.startsWith('data:')) {
                try {
                    const res = await fetch(p.photo);
                    const blob = await res.blob();
                    p.photo = blob;
                } catch(err) { /* fallback to string */ }
            }
            return p;
        }));

        importedArr = importedArr.filter(p => p && typeof p === 'object' && p.name);
        if (!importedArr.length) throw new Error('No valid products found in this file.');

        const userWantsToMerge = confirm(`Found ${importedArr.length} products in file.\n\n‚Ä¢ Click [OK] to MERGE.\n(Adds new items and updates existing ones. Safe.)\n\n‚Ä¢ Click [Cancel] to REPLACE.\n(Deletes everything currently in app and restores backup.)`);

        if (userWantsToMerge) {
            const productMap = new Map();
            products.forEach(p => productMap.set(p.id, p));
            let addedCount = 0;
            let updatedCount = 0;
            importedArr.forEach(p => {
                if (!p.id) p.id = genID();
                if (productMap.has(p.id)) { productMap.set(p.id, p); updatedCount++; } else { productMap.set(p.id, p); addedCount++; }
            });
            products = Array.from(productMap.values());
            alert(`Import Successful!\n\nüÜï Added: ${addedCount}\nüîÑ Updated: ${updatedCount}`);
        } else {
            if(!confirm("‚ö†Ô∏è WARNING: This will DELETE all current products and replace them with the backup.\n\nAre you sure?")) { return; }
            products = importedArr;
            products.forEach(p => { if(!p.id) p.id = genID(); });
            alert(`Restore Successful! App now has ${products.length} products.`);
        }
        saveProducts(); selectedProductIds.clear(); updateMultiSelectControls(); 
      } catch (ex) { alert("Failed to import: " + (ex.message || ex)); }
    };

    const detailModalBackdrop = document.getElementById('detailModalBackdrop');
    const detailModalBody = document.getElementById('detailModalBody');
    function disableDetailBackgroundScroll() { document.body.classList.add('detail-modal-open'); }
    function enableDetailBackgroundScroll() { document.body.classList.remove('detail-modal-open'); }
    function showDetailModal(product) {
      const nameSafe = escapeHTML(product.name || 'Unnamed');
      const imgSrc = getPhotoSrc(product.photo);
      const photoBlock = imgSrc ? `<img src="${imgSrc}" class="prod-detail-photo" alt="${nameSafe}"/>` : `<div class="prod-detail-photo" style="font-size:60px;padding:22px 0 12px 0;">üì¶</div>`;
      const mrpNum = Number(product.mrp) || 0;
      const costNum = (product.cost !== undefined && product.cost !== null) ? Number(product.cost) : null;
      detailModalBody.innerHTML = `
        <div style="text-align:center;">${photoBlock}</div>
        <ul style="list-style:none;padding:0;margin:10px 0 0 0;display:flex;flex-direction:column;gap:.57em;">
          <li><b>Name:</b> <span style="color:var(--accent2);font-weight:600">${nameSafe}</span></li>
          ${product.category?`<li><b>Category:</b> <span style="color:var(--accent2);font-weight:600">${escapeHTML(String(product.category))}</span></li>`:""}
          <li><b>Stock:</b> <span style="color:var(--accent2);font-weight:600">${Number(product.qty)||0}</span></li>
          <li><b>MRP:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>
          ${costNum!==null?`<li><b>Cost:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${costNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>`:""}
        </ul>
        ${product.notes?`<div style="margin-top:.8em;color:var(--text-muted);background:#213047;border-radius:8px;padding:.7em .9em">${escapeHTML(String(product.notes))}</div>`:""}
      `;
      setTimeout(()=>{
          const detailImg = detailModalBody.querySelector('.prod-detail-photo');
          if(detailImg && imgSrc) {
              detailImg.style.cursor = 'zoom-in';
              detailImg.onclick = () => openImageViewer(imgSrc);
          }
      }, 50);

      detailModalBackdrop.classList.remove('hide'); disableDetailBackgroundScroll(); setTimeout(()=>document.getElementById('closeDetailModalBtn').focus(),100);
    }
    document.getElementById('closeDetailModalBtn').onclick = function(){ detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML = ''; enableDetailBackgroundScroll(); };
    
    document.addEventListener('keydown', function(e){
      if (e.key === "Escape") {
        let closedAModal = false;
        if(imageViewerOverlay.classList.contains('show')) { imageViewerOverlay.classList.remove('show'); imageViewerImg.src = ''; closedAModal=true; }
        else if (!detailModalBackdrop.classList.contains('hide')) { detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML=''; enableDetailBackgroundScroll(); closedAModal = true; }
        else if (!productModalBackdrop.classList.contains('hide')) { productModalBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!deleteModalBackdrop.classList.contains('hide')) { deleteModalBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!settingsBackdrop.classList.contains('hide')) { settingsBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!shareModalBackdrop.classList.contains('hide')) { shareModalBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!categoryModalBackdrop.classList.contains('hide')) { categoryModalBackdrop.classList.add('hide'); closedAModal = true; }
        if (closedAModal) enableDetailBackgroundScroll();
      }
    });
    
    function maybeResetBodyScroll() {
      if (
        detailModalBackdrop.classList.contains('hide') &&
        (!productModalBackdrop || productModalBackdrop.classList.contains('hide')) &&
        (!settingsBackdrop || settingsBackdrop.classList.contains('hide')) &&
        (!deleteModalBackdrop || deleteModalBackdrop.classList.contains('hide')) &&
        (!shareModalBackdrop || shareModalBackdrop.classList.contains('hide')) &&
        (!categoryModalBackdrop || categoryModalBackdrop.classList.contains('hide'))
      ) {
        enableDetailBackgroundScroll();
      }
    }
    detailModalBackdrop.addEventListener('transitionend', maybeResetBodyScroll);
    detailModalBackdrop.addEventListener('animationend', maybeResetBodyScroll);
    window.addEventListener('popstate', maybeResetBodyScroll);

    const searchInput = document.getElementById('productSearch');
    let isSearchState = false;
    searchInput.addEventListener('input', function(){ 
        const hasText = (this.value || '').trim().length > 0;
        if(hasText && !isSearchState) {
             try { history.pushState({search: true}, document.title, window.location.href); isSearchState = true; } catch(e) {}
        }
        refreshProductList(); 
    });
    searchInput.addEventListener('keydown', function(e){ if(e.key==='Escape'){ searchInput.value=''; refreshProductList(); } });

    // --- NEW: CATEGORY BUTTON & MODAL LOGIC ---
    const categoryBtn = document.getElementById('categoryFilterBtn');
    const categoryModalBackdrop = document.getElementById('categoryModalBackdrop');
    const categoryGrid = document.getElementById('categoryGrid');
    const closeCategoryBtn = document.getElementById('closeCategoryBtn');
    const activeCategoryDisplay = document.getElementById('activeCategoryDisplay');

    categoryBtn.onclick = function() {
        const uniqueCategories = [...new Set(products.map(p => p.category ? p.category.trim() : "").filter(c => c))];
        uniqueCategories.sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        
        const seenLower = new Set();
        const cleanedCats = [];
        uniqueCategories.forEach(c => {
            const low = c.toLowerCase();
            if(!seenLower.has(low)){
                seenLower.add(low);
                const niceName = c.charAt(0).toUpperCase() + c.slice(1);
                cleanedCats.push(niceName);
            }
        });
        
        let html = `<div class="category-item-btn ${activeCategoryFilter === null ? 'active' : ''}" onclick="selectCategory(null)">All Categories</div>`;
        cleanedCats.forEach(cat => {
            const isActive = (activeCategoryFilter && activeCategoryFilter.toLowerCase() === cat.toLowerCase()) ? 'active' : '';
            html += `<div class="category-item-btn ${isActive}" onclick="selectCategory('${escapeHTML(cat)}')">${escapeHTML(cat)}</div>`;
        });
        
        categoryGrid.innerHTML = html;
        categoryModalBackdrop.classList.remove('hide');
    };

    closeCategoryBtn.onclick = function() { categoryModalBackdrop.classList.add('hide'); };

    window.selectCategory = function(cat) {
        activeCategoryFilter = cat; // null means 'All'
        categoryModalBackdrop.classList.add('hide');
        refreshProductList();
        
        if(activeCategoryFilter) {
            try { history.pushState({category: true}, document.title, window.location.href); } catch(e){}
        }
    };

    activeCategoryDisplay.onclick = function() {
        activeCategoryFilter = null;
        refreshProductList();
    };

    function refreshProductList() {
      productListElem.innerHTML = '';
      let q = (searchInput.value || '').trim().toLowerCase();
      const terms = q.split(/\s+/).filter(t => t.length > 0);
      
      let filtered = products;

      if (terms.length > 0) {
          filtered = products.filter(prod => {
             const searchString = ((prod.name || "") + " " + (prod.category || "") + " " + (prod.notes || "")).toLowerCase();
             return terms.every(term => searchString.includes(term));
          });
      }

      if (activeCategoryFilter) {
          const targetLower = activeCategoryFilter.toLowerCase();
          filtered = filtered.filter(p => (p.category || '').trim().toLowerCase() === targetLower);
          
          const displayNice = activeCategoryFilter.charAt(0).toUpperCase() + activeCategoryFilter.slice(1);
          activeCategoryDisplay.textContent = `Filtered by: ${displayNice} ‚úñ`;
          activeCategoryDisplay.classList.add('show');
      } else {
          activeCategoryDisplay.classList.remove('show');
      }
      
      currentFilteredProducts = filtered;

      if (!filtered.length) { noProductsElem.style.display = ""; document.getElementById('multiSelectControls').classList.remove('active'); return; }
      noProductsElem.style.display = "none";
      
      filtered.sort((a,b) => {
          const catA = (a.category || '').trim().toLowerCase();
          const catB = (b.category || '').trim().toLowerCase();
          if (catA < catB) return -1;
          if (catA > catB) return 1;
          return (a.name || '').localeCompare(b.name || '');
      });
      
      const fragment = document.createDocumentFragment();
      let lastCategoryLower = "@@INIT@@";

      filtered.forEach((prod,i) => {
          const currentCatRaw = (prod.category || '').trim();
          const currentCatLower = currentCatRaw.toLowerCase();
          
          let displayCat = currentCatRaw || "Uncategorized";
          if (displayCat !== "Uncategorized") {
              displayCat = displayCat.charAt(0).toUpperCase() + displayCat.slice(1);
          }
          
          if (currentCatLower !== lastCategoryLower) {
              const header = document.createElement('div');
              header.className = 'category-header';
              header.textContent = `--- ${displayCat} ---`;
              fragment.appendChild(header);
              lastCategoryLower = currentCatLower;
          }

          fragment.appendChild(createProductCard(prod,i));
      });
      productListElem.appendChild(fragment);
      
      updateMultiSelectControls();
    }

    let productEditing = null;
    const prodName = document.getElementById('prodName');
    const prodMrp = document.getElementById('prodMrp');
    const prodCost = document.getElementById('prodCost');
    const prodQty = document.getElementById('prodQty');
    const prodCategory = document.getElementById('prodCategory');
    const prodNotes = document.getElementById('prodNotes');
    const prodPhoto = document.getElementById('prodPhoto');
    const prodCamera = document.getElementById('prodCamera');
    const productModalBackdrop = document.getElementById('productModalBackdrop');
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modalError');
    const prodPhotoFileName = document.getElementById('prodPhotoFileName');
    const uploadBtnInnerText = document.getElementById('uploadBtnInnerText');
    const prodPhotoFileContainer = document.getElementById('prodPhotoFileContainer');
    const fileUploadWrap = document.getElementById('fileUploadWrap');
    const imageCompressMsg = document.getElementById('imageCompressMsg');
    
    // CHANGED: This variable now holds a BLOB, not a DataURL string
    let currentProductBlob = null;

    /****************************************************************
     * BINARY BLOB COMPRESSION (NO BASE64 STRINGS)
     ****************************************************************/
    async function compressImageFileToBlob(file, maxDim = 800, quality = 0.85) { 
      // 1. SAFETY CHECK
      if (file.size > 20 * 1024 * 1024) return Promise.reject("File too large (>20MB).");
      if (!/^image\//.test(file.type)) return Promise.reject("Not an image file.");
      
      // 2. ATTEMPT: createImageBitmap (Low Memory)
      if ('createImageBitmap' in window) {
          try {
              const bitmap = await createImageBitmap(file);
              let { width, height } = bitmap;
              if (width > maxDim || height > maxDim) {
                  const scale = maxDim / Math.max(width, height);
                  width = Math.round(width * scale);
                  height = Math.round(height * scale);
              }
              const canvas = document.createElement('canvas');
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(bitmap, 0, 0, width, height);
              bitmap.close(); 
              
              return new Promise((resolve, reject) => {
                  canvas.toBlob(blob => {
                      canvas.width = 0; canvas.height = 0; 
                      if (!blob) return reject("Compression error.");
                      resolve(blob);
                  }, 'image/jpeg', quality);
              });
          } catch(e) {
              console.warn("createImageBitmap failed, falling back.", e);
          }
      }

      // 3. FALLBACK: Standard Image Load
      return new Promise((resolve, reject) => {
        let img = new window.Image();
        let url = URL.createObjectURL(file);
        
        img.onload = function() {
          let [w, h] = [img.naturalWidth, img.naturalHeight];
          if (w > maxDim || h > maxDim) {
            if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
            else { w = Math.round(w * maxDim / h); h = maxDim; }
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          URL.revokeObjectURL(url);
          img.src = ""; img = null;

          canvas.toBlob(blob => {
            canvas.width = 0; canvas.height = 0; 
            if (!blob) return reject("Compression error.");
            resolve(blob);
          }, 'image/jpeg', quality);
        };
        img.onerror = () => { URL.revokeObjectURL(url); img = null; reject("Invalid image data"); };
        img.src = url;
      });
    }

    function updatePhotoPreviewUI() {
      prodPhotoFileContainer.innerHTML = '';
      if (currentProductBlob) {
        const img = document.createElement('img');
        
        // --- FIX: Handle BOTH Blob (New) and String (Old) ---
        if (currentProductBlob instanceof Blob) {
             img.src = URL.createObjectURL(currentProductBlob);
        } else {
             // It is likely a base64 string from old data
             img.src = currentProductBlob; 
        }
        
        img.alt = "Product Photo"; 
        img.className = 'photo-preview-img-thumb';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button'; removeBtn.className = 'remove-photo-btn'; removeBtn.title = 'Remove image'; removeBtn.innerHTML = '‚úñ';
        removeBtn.onclick = function() { 
            currentProductBlob = null; 
            prodPhoto.value = ''; 
            prodCamera.value = '';
            prodPhotoFileName.textContent = ''; 
            imageCompressMsg.style.display = 'none'; 
            updatePhotoPreviewUI(); 
        };
        prodPhotoFileContainer.appendChild(img); prodPhotoFileContainer.appendChild(removeBtn);
      }
    }

    function showProductModal(mode, product) {
      productModal.reset(); 
      modalError.textContent = ''; 
      prodPhotoFileName.textContent = ''; 
      currentProductBlob = null; 
      imageCompressMsg.style.display = 'none'; 
      updatePhotoPreviewUI();
      
      if (mode === 'add') {
        modalTitle.textContent = "Add Product"; productEditing = null;
        prodName.value = ""; prodMrp.value = ""; prodCost.value = ""; prodQty.value = ""; prodCategory.value = activeCategoryFilter || ""; prodNotes.value = ""; prodPhoto.value = ""; prodCamera.value = "";
      } else {
        modalTitle.textContent = "Edit Product"; productEditing = product;
        prodName.value = product.name || ""; prodMrp.value = product.mrp !== undefined ? product.mrp : ""; prodCost.value = product.cost !== undefined ? product.cost : ""; prodQty.value = product.qty !== undefined ? product.qty : ""; prodCategory.value = product.category || ""; prodNotes.value = product.notes || ""; prodPhoto.value = ""; prodCamera.value = "";
        
        // Handle existing photo (Blob or String)
        if (product.photo) {
            currentProductBlob = product.photo; 
            updatePhotoPreviewUI();
        }
      }
      productModalBackdrop.classList.remove('hide');
      if (!document.body.classList.contains('modal-open')) { document.body.dataset.scrollY = window.scrollY; document.body.style.top = `-${window.scrollY}px`; document.body.classList.add('modal-open'); }
      setTimeout(()=>prodName.focus(),150);
      firstSubmitAttempt = true;
    }

    let firstSubmitAttempt = true;
    let prodPhotoLastPendingPromise = null;

    // --- SHARED IMAGE HANDLER FOR BOTH BUTTONS ---
    function handleImageSelection(file) {
        if(!file) return;
        prodPhotoFileName.textContent = file.name; 
        imageCompressMsg.textContent = "Processing image..."; 
        imageCompressMsg.style.display = 'block';
        
        const filePromise = compressImageFileToBlob(file, 600, 0.70).then(blob => {
          const kb = Math.round(blob.size / 1024); 
          currentProductBlob = blob; // Store Blob, NOT string
          updatePhotoPreviewUI();
          imageCompressMsg.textContent = `Photo processed: ~${kb} KB`; 
          imageCompressMsg.style.display = 'block';
        }).catch(err => { 
            console.error(err);
            modalError.textContent = String(err) || "Photo processing failed."; 
            prodPhoto.value = ''; 
            prodCamera.value = '';
            prodPhotoFileName.textContent = ''; 
            imageCompressMsg.style.display = 'none'; 
            currentProductBlob = null; 
            updatePhotoPreviewUI(); 
        });
        prodPhotoLastPendingPromise = filePromise;
    }

    prodPhoto.addEventListener('change', function () {
      if (prodPhoto.files && prodPhoto.files.length) {
          handleImageSelection(prodPhoto.files[0]);
      } else {
          currentProductBlob = null; 
          updatePhotoPreviewUI();
      }
    });
    
    prodCamera.addEventListener('change', function () {
      if (prodCamera.files && prodCamera.files.length) {
          handleImageSelection(prodCamera.files[0]);
      }
    });

    document.getElementById('addProductBtn').onclick = ()=>showProductModal('add');
    document.getElementById('closeModalBtn').onclick = ()=>{
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) { document.body.classList.remove('modal-open'); const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0; document.body.style.top = ''; window.scrollTo(0, scrollY); delete document.body.dataset.scrollY; }
      imageCompressMsg.style.display = 'none';
    };

    productModal.onsubmit = async function(e) {
      e.preventDefault(); modalError.textContent = "";
      if (firstSubmitAttempt && (prodPhoto.files.length || prodCamera.files.length) && !currentProductBlob && prodPhotoLastPendingPromise) {
        try { await prodPhotoLastPendingPromise; } catch (err) { modalError.textContent = "Image failed to load, please select again."; return; }
        firstSubmitAttempt = false; productModal.onsubmit(e); return;
      }
      firstSubmitAttempt = false;
      const name = (prodName.value || '').trim(); const mrpVal = prodMrp.value; const costVal = prodCost.value; const qtyVal = prodQty.value; const notes = (prodNotes.value || '').trim();
      
      let category = (prodCategory.value || '').trim();
      if(category.length > 0) {
          category = category.charAt(0).toUpperCase() + category.slice(1);
      }
      
      if (!name) { modalError.textContent = "Name required."; return; }
      if (mrpVal === "" || isNaN(Number(mrpVal)) || Number(mrpVal) < 0) { modalError.textContent = "Valid MRP required."; return; }
      if (qtyVal === "" || isNaN(Number(qtyVal)) || Number(qtyVal) < 0) { modalError.textContent = "Valid quantity required."; return; }
      
      // Store the BLOB directly
      const productObj = { id: productEditing ? productEditing.id : genID(), name, mrp: Number(mrpVal), cost: costVal !== "" ? Number(costVal) : null, qty: Number(qtyVal), category, notes, photo: currentProductBlob };
      
      if (!productEditing) products.push(productObj); else { const idx = products.findIndex(p => p.id === productEditing.id); if (idx >= 0) products[idx] = productObj; else products.push(productObj); }
      
      saveProducts();
      
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) { document.body.classList.remove('modal-open'); const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0; document.body.style.top = ''; window.scrollTo(0, scrollY); delete document.body.dataset.scrollY; }
      selectedProductIds.clear(); updateMultiSelectControls();
    };

    const deleteModalBackdrop = document.getElementById('deleteModalBackdrop');
    const deleteModal = document.getElementById('deleteModal');
    const deleteName = document.getElementById('deleteName');
    let productToDelete = null;

    function showDeleteModal(product) { deleteModalBackdrop.classList.remove('hide'); deleteName.textContent = product.name || ''; productToDelete = product; setTimeout(()=>document.getElementById('cancelDeleteBtn').focus(),60); }
    document.getElementById('closeDeleteBtn').onclick = document.getElementById('cancelDeleteBtn').onclick = () => { deleteModalBackdrop.classList.add('hide'); productToDelete = null; };
    deleteModal.onsubmit = function(e){ e.preventDefault(); if (!productToDelete) return; products = products.filter(p => p.id !== productToDelete.id); saveProducts(); deleteModalBackdrop.classList.add('hide'); productToDelete = null; selectedProductIds.delete(productToDelete.id); updateMultiSelectControls(); };
    function genID() { return 'p' + (Date.now() + ('' + Math.random()).slice(2,7)); }

    /****************************************************************
     * SHARE / PDF LOGIC
     ****************************************************************/
    const shareModalBackdrop = document.getElementById('shareModalBackdrop');
    const closeShareBtn = document.getElementById('closeShareBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const shareSubtitle = document.getElementById('shareSubtitle');
    
    const chkPhoto = document.getElementById('sharePhoto');
    const chkMrp = document.getElementById('shareMrp');
    const chkCost = document.getElementById('shareCost');
    const chkQty = document.getElementById('shareQty');
    const chkCategory = document.getElementById('shareCategory');
    const chkNotes = document.getElementById('shareNotes');
    
    let productsToShareQueue = [];
    
    function openShareModal(product, list = null) {
        if(list) {
            productsToShareQueue = list;
            shareSubtitle.textContent = `Generate PDF for ${list.length} selected product(s).`;
        } else {
            productsToShareQueue = [product];
            shareSubtitle.textContent = "Select fields to include in the generated PDF/Print.";
        }
        chkPhoto.checked = true; chkMrp.checked = true; chkCost.checked = false; chkQty.checked = true; chkCategory.checked = true; chkNotes.checked = true;
        shareModalBackdrop.classList.remove('hide');
    }
    closeShareBtn.onclick = () => { shareModalBackdrop.classList.add('hide'); productsToShareQueue = []; };
    
    generatePdfBtn.onclick = function() {
        if(productsToShareQueue.length === 0) return;
        const printableArea = document.getElementById('printableArea');
        let fullHtml = '';
        productsToShareQueue.forEach(prod => {
            const imgSrc = getPhotoSrc(prod.photo);
            let html = `
                <div class="print-product-page">
                    <div class="print-header">
                        <img src="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true" class="print-logo" />
                        <div class="print-title">Al Rehman Electronics</div>
                        <div style="font-size:14px;color:#555">Product Specification Sheet</div>
                        <div style="font-size:12px;color:#777">Generated: ${new Date().toLocaleDateString()}</div>
                    </div>
                    <h1 style="text-align:center;margin-top:20px;">${escapeHTML(prod.name)}</h1>
            `;
            if(chkPhoto.checked && imgSrc) { html += `<img src="${imgSrc}" class="print-product-img" />`; }
            html += `<table class="print-details-table"><tbody>`;
            if(chkCategory.checked && prod.category) { html += `<tr><td class="print-label">Category</td><td>${escapeHTML(prod.category)}</td></tr>`; }
            if(chkQty.checked) { html += `<tr><td class="print-label">In Stock</td><td>${prod.qty}</td></tr>`; }
            if(chkMrp.checked) { html += `<tr><td class="print-label">Price (MRP)</td><td>‚Ç® ${Number(prod.mrp).toLocaleString()}</td></tr>`; }
            if(chkCost.checked && prod.cost !== null && prod.cost !== undefined) { html += `<tr><td class="print-label">Cost Price</td><td>‚Ç® ${Number(prod.cost).toLocaleString()}</td></tr>`; }
            html += `</tbody></table>`;
            if(chkNotes.checked && prod.notes) { html += `<div class="print-notes-box"><strong>Notes:</strong><br/>${escapeHTML(prod.notes)}</div>`; }
            html += `<div style="text-align:center; margin-top:50px; font-size:12px; color:#888;">Thank you for your interest.For any detail contact on this Phone number:0300-3685270</div></div>`;
            fullHtml += html;
        });
        printableArea.innerHTML = fullHtml;
        shareModalBackdrop.classList.add('hide');
        setTimeout(() => { window.print(); productsToShareQueue = []; }, 300);
    };

  </script>
</body>
</html>
