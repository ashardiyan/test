<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Al Rehman Electronics</title>
  <meta name="theme-color" content="#161B22" />
  <!-- Add PWA meta for mobile -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg1: #0C1220;
      --bg2: #161B22;
      --bg3: #212936;
      --accent: #2563EB;
      --accent-hover: #164eab;
      --accent2: #06B6D4;
      --accent2-hover: #1095b7;
      --gray: #AEB9C7;
      --text: #F3F7FF;
      --text-muted: #B0B9C6;
      --radius: 16px;
      --radius-card: 13px;
      --shadow: 0 8px 32px 0 rgba(60,120,220,0.17);
      --shadow-soft: 0 2px 8px rgba(40,98,180,.11);
      --danger: #ef4444;
      --success: #10b981;
      --rounded-btn: 10px;
      --button-skyblue: #06B6D4;
      --button-gradient: linear-gradient(90deg, #06B6D4 40%, #2563EB 100%);
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      font-size: 17px;
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
      color: var(--text);
      min-height: 100vh;
    }
    body { display:flex; flex-direction:column; min-height:100vh; }
    .container { max-width:640px; margin:0 auto; padding:34px 12px 54px; width:100%; box-sizing:border-box; }
    header { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:20px; gap:10px; }
    .logo-wrap { display:flex; align-items:center; gap:14px; }
    .app-logo { width:50px; height:50px; border-radius:18px; background:linear-gradient(135deg,var(--accent),var(--accent2)75%); display:flex; align-items:center; justify-content:center; font-size:2.11rem; box-shadow:var(--shadow-soft); color:#fff; font-weight:700; overflow: hidden; }
    .app-title { font-weight:900; font-size:1.7rem; line-height:1.13; letter-spacing:-1px; color:var(--text); margin-left:2px; }
    .top-controls { display:flex; align-items:center; gap:10px; }
    button.icon-btn { background:none; border:none; color:var(--accent2); font-size:1.23rem; padding:8px 10px; border-radius:9px; cursor:pointer; outline:none; }
    button#settingsBtn { font-size:1.33rem; color:var(--text); background:#1b2430; padding:8px 11px; border-radius:9px; box-shadow:0 1px 6px #0008; }
    #installPromptBtn, #installAsAppBtn { display:none; margin-left:12px; font-size:.99em; padding:8px 14px; border-radius:8px; background:linear-gradient(91deg,var(--accent2),var(--accent)); color:#fff; font-weight:700; border:none; cursor:pointer; box-shadow:0 1px 11px #2e5fad23; }
    #mobileInstallInstructions { display:none; margin-left:10px; padding:8px 10px; border-radius:8px; background:#1a2233; color:var(--accent2); font-size:.93em; font-style:italic; box-shadow:0 2px 8px #222c3d22; max-width:310px; line-height:1.45; }

    .main-content { display:flex; flex-direction:column; gap:0; align-items:stretch; width:100%; }
    .card { background:var(--bg2); border-radius:var(--radius-card); box-shadow:var(--shadow); margin-bottom:32px; padding:1.6rem 1.6rem 1.3rem; animation:fadeUp .7s cubic-bezier(.43,.8,.52,1.18); opacity:0; transform:translateY(36px); animation-fill-mode:forwards; border:none; transition:box-shadow .15s, background .16s; }
    .card.show { opacity:1; transform:none; }
    @keyframes fadeUp { 0%{opacity:0;transform:translateY(45px);}65%{opacity:.6;}100%{opacity:1;transform:translateY(0);} }
    .products-top-actions { display:flex; align-items:flex-end; gap:11px; margin-bottom:17px; flex-wrap:wrap; }
    .product-search-wrap { position:relative; flex:1 1 192px; max-width:370px; margin-bottom:0; }
    #productSearch { width:100%; border-radius:8px; border:none; background:var(--bg3); color:var(--text); font-size:1.06em; padding:9px 38px 9px 15px; outline:none; box-shadow:0 1.5px 6px #35455a23; transition:border .13s; border:1.5px solid #23314a; }
    #productSearch:focus { border-color:var(--accent); }
    .search-icon { position:absolute; right:13px; top:50%; transform:translateY(-50%); color:var(--accent2); font-size:1.15em; opacity:0.7; pointer-events:none; }

    /* Multi-select controls */
    #multiSelectControls {
      display: none;
      gap: 10px;
      margin-top: 6px;
      margin-left: 2px;
      align-items: center;
    }
    #multiSelectControls.active { display: flex; }
    #deleteSelectedBtn {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 18px;
      font-size: 0.97em;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 1px 7px #ef444433;
      transition: background .14s, box-shadow .13s;
      margin-left: 6px;
    }
    #deleteSelectedBtn:disabled { background: #ce5353a0; cursor: not-allowed; }
    #selectAllCheckbox { accent-color: var(--accent2); margin-left:4px; margin-right:0; transform: scale(1.1); }

    .product-list { margin:0; padding:0; list-style:none; }

    /* Stylish Skyblue Buttons (for add/export/import/cancel and file uploads) */
    .rounded-sky-btn {
      background: var(--button-gradient);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 20px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1.5px 10px #2eb9f733;
      transition: background .15s, box-shadow .14s, transform .10s;
      outline: none;
      margin: 2px 0;
      letter-spacing: 0.02em;
      position: relative;
      /* for file input overlays */
      overflow: hidden;
    }
    .rounded-sky-btn:hover,
    .rounded-sky-btn:active {
      background: linear-gradient(90deg, #0e9fec, #2563EB 95%);
      box-shadow: 0 3px 16px #43c7fc43;
      transform: translateY(-1.5px) scale(1.03);
    }
    .rounded-sky-btn.cancel {
      background: #18313c;
      color: var(--button-skyblue);
      border: 1.5px solid var(--button-skyblue);
      font-weight: 600;
    }
    .rounded-sky-btn.cancel:hover, .rounded-sky-btn.cancel:active {
      background: #22384a;
      color: #fff;
      border-color: #1095b7;
    }

    /* NEW: For the styled file button in modal */
    .modal-file-upload-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 13px;
      margin-top: 2px;
    }
    .modal-file-label {
      font-weight: 600;
      font-size: .96em;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
    }
    .modal-file-upload-btn {
      display: inline-block;
      position: relative;
    }
    /* Hide the original input */
    .modal-file-upload-btn input[type="file"] {
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    /* --- Photo REMOVE X button --- */
    .remove-photo-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      font-size: 1.18em;
      font-weight: bold;
      margin-left: 4px;
      cursor: pointer;
      transition: background 0.14s, color 0.12s;
      box-shadow: 0 1px 5px #ef444433;
      z-index: 2;
      vertical-align: middle;
    }
    .remove-photo-btn:hover, .remove-photo-btn:focus {
      background: #ce3737;
      color: #fff;
    }
    .photo-preview-wrap {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .photo-preview-img-thumb {
      max-width: 42px;
      max-height: 42px;
      border-radius: 7px;
      object-fit: cover;
      border: 2px solid var(--accent2-hover);
      margin-right: 2px;
      background: #273855;
      display: block;
    }

    .prod-card { background:var(--bg3); border-radius:13px; margin-bottom:16px; box-shadow:0 2px 10px #2c345128; display:flex; gap:19px; align-items:center; padding:18px 20px; position:relative; animation:fadeUp .35s; opacity:0; transform:translateY(25px); animation-fill-mode:forwards; cursor:pointer; border:2px solid transparent; transition:box-shadow .14s, border-color .16s; }
    .prod-card.show { opacity:1; transform:none; }
    .prod-card:hover { border-color:var(--accent2); box-shadow:0 6px 24px #18346023; }
    .prod-img { min-width:43px; width:43px; height:43px; border-radius:10px; background:#21293f; flex-shrink:0; display:flex; align-items:center; justify-content:center; color:var(--accent2); font-size:1.45em; overflow:hidden; }
    .prod-photo-thumb { max-width:100%; max-height:43px; border-radius:8px; object-fit:cover; background:#232b36; display:block; }
    .prod-name { font-weight:700; font-size:1.15em; color:var(--text); letter-spacing:-0.5px; margin-bottom:1.5px; }
    .prod-details { color:var(--gray); font-size:.97em; margin-top:2px; margin-bottom:2px; }
    .prod-actions { margin-left:auto; display:flex; gap:7px; align-items:center; }
    .prod-actions button { background:none; border:none; color:var(--accent2); font-size:1.32em; cursor:pointer; transition:color .13s; border-radius:5px; padding:3px 5px; outline:none; }
    .prod-select-checkbox {
      margin-right: 18px;
      transform: scale(1.25);
      accent-color: var(--accent2);
      cursor:pointer;
    }
    .prod-card.selected { border-color: var(--danger); background: #1b1d2d; box-shadow: 0 4px 16px #ef44441a;}
    .prod-card .prod-select-checkbox:focus { outline: 2px solid var(--accent2); outline-offset:1px;}

    .no-products { text-align:center; color:var(--text-muted); font-size:1.12em; margin:34px 0 14px 0; letter-spacing:.01em; }
    .modal-backdrop { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(18,23,32,0.92); z-index:4999; display:flex; align-items:center; justify-content:center; opacity:1; visibility:visible; transition:opacity .21s; }
    .modal-backdrop.hide { opacity:0; visibility:hidden; pointer-events:none; }
    .modal { min-width:320px; max-width:98vw; background:var(--bg2); border-radius:var(--radius-card); box-shadow:var(--shadow); z-index:6000; padding:36px 22px 23px 22px; animation:fadeUp .4s; display:flex; flex-direction:column; align-items:stretch; position:relative; }
    .modal h3 { margin:0 0 18px 0; color:var(--accent2); text-align:center; font-weight:800; font-size:1.26em; letter-spacing:-.2px; }
    .modal-close { position:absolute; top:13px; right:14px; background:none; border:none; color:var(--accent2); font-size:1.24em; cursor:pointer; font-weight:bold; outline:none; }
    .modal label { font-weight:600; font-size:.96em; color:var(--text-muted); margin-bottom:4px; }
    .modal input[type=text], .modal input[type=number], .modal input[type=file], .modal input[type=password], .modal textarea { border-radius:7px; border:1.5px solid #253048; background:var(--bg3); color:var(--text); font-size:1em; padding:8px 11px; margin-bottom:13px; margin-top:2px; outline:none; width:100%; box-sizing:border-box; transition:border .13s; }
    .modal textarea { min-height:54px; resize:vertical; }
    .modal-btnbar { display:flex; align-items:center; justify-content:flex-end; gap:13px; margin-top:6px; }
    .modal button[type=submit] { background:linear-gradient(95deg,var(--accent2),var(--accent)); color:#fff; padding:11px 22px; font-size:1em; border:none; border-radius:8px; font-weight:700; cursor:pointer; box-shadow:0 2px 10px #1b314e28; margin:6px 0; transition:background .14s; outline:none; }
    .modal .error { font-size:.98em; color:var(--danger); margin-bottom:7px; min-height:18px; text-align:left; }
    #detailModal .prod-detail-photo { display:block; width:124px; height:124px; object-fit:cover; border-radius:19px; margin:6px auto 0 auto; box-shadow:0 2px 12px #1b314e22; background:#21293f; }

    /* Prevent background scrolling when modal is open */
    body.modal-open {
      overflow: hidden !important;
      position: fixed !important;
      width: 100vw;
    }

    /* Custom class to prevent background scrolling when product detail is open */
    body.detail-modal-open {
      overflow: hidden !important;
      /* Don't use position:fixed because it causes iOS bugs and scroll jumps, just hide overflow */
    }

    @media (max-width:650px){
      .container{padding:14px 1vw 23px 1vw;}
      .card{padding:.8rem .4rem 1.05rem .75rem;}
      .app-title{font-size:1.2rem;}
      .prod-card{padding:12px 7px;}
      .modal{padding:14vw 3vw 7vw 3vw; min-width:unset;}
      #detailModal .prod-detail-photo{ width:74px; height:74px;}
      #mobileInstallInstructions{max-width:94vw;font-size:0.96em;}
      #multiSelectControls{font-size:0.99em; flex-wrap:wrap;}
      .photo-preview-img-thumb { max-width:32px; max-height:32px; }
      .remove-photo-btn { width:22px; height:22px; font-size:1em;}
    }
    ::selection{background:var(--accent2); color:#fff;}
    a{color:var(--accent);}
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <!-- LOGIN / SET PIN modal - always shown on load (no auto login) -->
  <div id="login-modal" style="position:fixed; inset:0; z-index:7000; background:rgba(22,27,34,0.89); display:flex; justify-content:center; align-items:center;">
    <form class="login-dialog modal" id="loginForm" autocomplete="off" novalidate style="max-width:380px;">
      <button class="modal-close" type="button" id="loginCloseBtn" title="Close" style="display:none">‚úñ</button>
      <h3 style="text-align:center;color:var(--accent2);margin-bottom:12px">üîê Dealer Login</h3>
      <div class="error input-error" id="login-error" style="min-height:18px;margin-bottom:8px"></div>

      <label id="pinLabel" for="loginPIN">Create a secure PIN / Password</label>
      <input type="password" id="loginPIN" minlength="4" maxlength="32" required placeholder="Set PIN or password" autocomplete="new-password" />

      <div style="display:flex; gap:8px; align-items:center;">
        <button type="submit" id="loginBtn" style="flex:1;">Set PIN</button>
        <button type="button" id="forgotBtn" style="display:none; background:transparent; border:1px solid #253048; color:var(--text); padding:9px 12px; border-radius:8px; cursor:pointer;">Forgot</button>
      </div>

      <small style="display:block;margin-top:12px;color:var(--text-muted);">All data is stored locally in your browser. PIN is hashed before saving.</small>
    </form>
  </div>

  <!-- Main app container (hidden until correct login) -->
  <div id="dealerApp" class="" style="display:none;">
    <div class="container">
      <header>
        <div class="logo-wrap">
          <div class="app-logo" title="Al Rahman Electronics" style="padding:0;">
            <img src="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true" alt="App Logo" style="width:100%;height:100%;border-radius:16px;object-fit:cover;background:#fff;border:none;"/>
          </div>
          <span class="app-title">Al Rahman Electronics</span>
        </div>
        <div class="top-controls">
          <button id="installPromptBtn" title="Install as App">üì≤ Install</button>
          <button id="installAsAppBtn" title="Install as App (force)">üõ†Ô∏è</button>
          <button id="settingsBtn" title="Settings (‚ãÆ)">‚ãÆ</button>
          <span id="mobileInstallInstructions"></span>
        </div>
      </header>

      <div class="main-content">
        <section class="card" style="animation-delay:.06s">
          <div class="products-top-actions">
            <div class="product-search-wrap">
              <input type="search" placeholder="Search by name, category, or note..." id="productSearch" autocomplete="off" />
              <span class="search-icon">&#128269;</span>
            </div>
            <button type="button" id="addProductBtn" class="rounded-sky-btn">+ Add</button>
            <button type="button" id="exportBtn" class="rounded-sky-btn">Export</button>
            <button type="button" id="importBtn" class="rounded-sky-btn">Import</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
          <div id="multiSelectControls">
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="selectAllCheckbox" title="Select all" />
              <span style="user-select:none;">Select all</span>
            </label>
            <button type="button" id="deleteSelectedBtn" disabled>üóëÔ∏è Delete Selected</button>
            <span id="selectedCountText" style="color:var(--danger);font-weight:600;font-size:0.99em;"></span>
          </div>
          <ul class="product-list" id="productList"></ul>
          <div class="no-products" id="noProducts" style="display:none">No products yet. Click <b>+ Add</b> to get started!</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Product Add/Edit Modal -->
  <div class="modal-backdrop hide" id="productModalBackdrop">
    <form class="modal" id="productModal" autocomplete="off">
      <button class="modal-close" type="button" id="closeModalBtn" title="Close">‚úñ</button>
      <h3 id="modalTitle">Add Product</h3>
      <div class="error" id="modalError" style="min-height:18px"></div>
      <label for="prodName">Name</label>
      <input type="text" id="prodName" required maxlength="64" />
      <label for="prodMrp">MRP (‚Ç®)</label>
      <input type="number" id="prodMrp" min="0" max="100000" step="0.01" required />
      <label for="prodCost">Cost Price (‚Ç®)</label>
      <input type="number" id="prodCost" min="0" max="100000" step="0.01"/>
      <label for="prodQty">Quantity</label>
      <input type="number" id="prodQty" min="0" max="100000" required />
      <label for="prodCategory">Category</label>
      <input type="text" id="prodCategory" maxlength="32" />
      <label for="prodNotes">Notes</label>
      <textarea id="prodNotes" maxlength="120" placeholder=""></textarea>
      <span class="modal-file-label">Photo</span>
      <div class="modal-file-upload-wrap" id="fileUploadWrap">
        <span class="modal-file-upload-btn rounded-sky-btn" id="uploadBtnText">
          <svg width="18" height="18" style="margin-right:6px;vertical-align:-4px" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <span id="uploadBtnInnerText">Choose Image</span>
          <input type="file" id="prodPhoto" accept="image/*" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;"/>
        </span>
        <span id="prodPhotoFileContainer" class="photo-preview-wrap" style="min-width:1em;">
          <!-- Will dynamically insert img and remove btn -->
        </span>
        <span id="prodPhotoFileName" style="color:var(--text-muted);font-size:.99em;"></span>
      </div>
      <div class="modal-btnbar">
        <button type="submit" id="saveProductBtn" class="rounded-sky-btn">Save</button>
      </div>
    </form>
  </div>

  <!-- Delete confirmation modal -->
  <div class="modal-backdrop hide" id="deleteModalBackdrop">
    <form class="modal" id="deleteModal">
      <button class="modal-close" type="button" id="closeDeleteBtn" title="Close">‚úñ</button>
      <h3>Delete Product</h3>
      <div style="margin:11px 0 17px 0">Are you sure you want to delete <b id="deleteName"></b>?</div>
      <div class="modal-btnbar">
        <button type="button" id="cancelDeleteBtn" class="rounded-sky-btn cancel">Cancel</button>
        <button type="submit" style="background:var(--danger);border-radius:10px;padding:10px 22px;color:#fff;border:none;font-weight:700;box-shadow:0 2px 10px #1b314e28;transition:background .14s;outline:none;">Yes, Delete</button>
      </div>
    </form>
  </div>

  <!-- Product Detail Modal -->
  <div class="modal-backdrop hide" id="detailModalBackdrop">
    <div class="modal" id="detailModal" tabindex="-1">
      <button class="modal-close" type="button" id="closeDetailModalBtn" title="Close">‚úñ</button>
      <h3>Product Details</h3>
      <div id="detailModalBody"></div>
    </div>
  </div>

  <!-- Settings Modal (contains Logout + Reset PIN) -->
  <div class="modal-backdrop hide" id="settingsBackdrop">
    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <button class="modal-close" type="button" id="closeSettingsBtn" title="Close">‚úñ</button>
      <h3 id="settingsTitle">Settings</h3>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">Account</div>
            <div style="color:var(--text-muted);font-size:.94em;">Logout or reset your PIN</div>
          </div>
        </div>

        <button id="logoutBtn" style="padding:10px;border-radius:8px;border:none;background:#2b2f3a;color:var(--text);cursor:pointer;">üîí Logout</button>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700">Reset PIN</div>
        <div style="color:var(--text-muted);font-size:.93em;margin-bottom:6px;">Enter your current PIN, then choose a new one.</div>

        <label for="oldPin">Current PIN</label>
        <input type="password" id="oldPin" placeholder="Current PIN" maxlength="32" />

        <label for="newPin">New PIN</label>
        <input type="password" id="newPin" placeholder="New PIN (min 4 chars)" maxlength="32" />

        <label for="confirmPin">Confirm New PIN</label>
        <input type="password" id="confirmPin" placeholder="Confirm new PIN" maxlength="32" />

        <div class="error" id="resetPinError" style="min-height:18px;"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px;">
          <button id="resetPinCancel" class="rounded-sky-btn cancel">Cancel</button>
          <button id="resetPinSubmit" class="rounded-sky-btn">Reset PIN</button>
        </div>
      </div>

    </div>
  </div>

  <input type="file" id="hiddenImport" accept="application/json" style="display:none">

  <script>
    /****************************************************************
     * Modal background scroll lock
     ****************************************************************/
    (function() {
      function lockBodyScroll() {
        if (!document.body.classList.contains('modal-open')) {
          document.body.dataset.scrollY = window.scrollY;
          document.body.style.top = `-${window.scrollY}px`;
          document.body.classList.add('modal-open');
        }
      }
      function unlockBodyScroll() {
        if (document.body.classList.contains('modal-open')) {
          document.body.classList.remove('modal-open');
          const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
          document.body.style.top = '';
          window.scrollTo(0, scrollY);
          delete document.body.dataset.scrollY;
        }
      }

      function observeProductModalOpen() {
        const productModalBackdrop = document.getElementById('productModalBackdrop');
        if (!productModalBackdrop) return;
        const config = { attributes: true, attributeFilter: ['class'] };
        const observer = new MutationObserver(() => {
          if (!productModalBackdrop.classList.contains('hide')) {
            lockBodyScroll();
          } else {
            unlockBodyScroll();
          }
        });
        observer.observe(productModalBackdrop, config);
        window.addEventListener('beforeunload', unlockBodyScroll);
      }
      window.addEventListener('DOMContentLoaded', observeProductModalOpen);
      window.addEventListener('keydown', function(e) {
        if (e.key === "Escape") {
          unlockBodyScroll();
        }
      });
    })();
  </script>
  <script>
    /****************************************************************
     * PWA manifest & service worker (dynamically created)
     ****************************************************************/
    // ... (PWA manifest/service worker unchanged) ...
    (function createManifestAndServiceWorker() {
      // Using a PNG icon as requested
      const imgIcon = "https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true";
      const manifestObj = {
        name: "Al Rahman Electronics",
        short_name: "ARE",
        description: "Local-only dealer product listing (offline-first)",
        start_url: "/index.html",
        display: "standalone",
        background_color: "#161B22",
        theme_color: "#161B22",
        icons: [
          { src: imgIcon, sizes: "192x192", type: "image/png" },
          { src: imgIcon, sizes: "512x512", type: "image/png" }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifestObj)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(manifestBlob);
      (function setManifestLink() {
        let existing = document.querySelector('link[rel="manifest"]');
        if (!existing) {
          existing = document.createElement('link');
          existing.rel = 'manifest';
          document.head.appendChild(existing);
        }
        existing.href = manifestURL;
      })();

      // Improved service worker for offline opening
      const swScript = `
        const CACHE_NAME = 'local-dealer-cache-v2';
        const FILES_TO_CACHE = [
          '/',
          '/index.html',
          location.pathname.endsWith('.html') ? location.pathname : '/index.html'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME).then(cache => cache.addAll(FILES_TO_CACHE))
          );
          self.skipWaiting();
        });

        self.addEventListener('activate', event => {
          event.waitUntil(clients.claim());
        });

        self.addEventListener('fetch', event => {
          if (event.request.method !== 'GET') return;
          event.respondWith(
            caches.match(event.request).then(response => {
              return response || fetch(event.request).then(resp => {
                // Cache new file
                if (resp && resp.status === 200 && resp.type === 'basic') {
                  const respClone = resp.clone();
                  caches.open(CACHE_NAME).then(cache => {
                    cache.put(event.request, respClone);
                  });
                }
                return resp;
              }).catch(() => {
                // If HTML navigation request, fallback to offline page
                if (event.request.mode === 'navigate' || (event.request.destination === 'document')) {
                  return caches.match('/index.html');
                }
                return undefined;
              });
            })
          );
        });
      `;
      try {
        const swBlob = new Blob([swScript], { type: 'text/javascript' });
        const swURL = URL.createObjectURL(swBlob);
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register(swURL).catch(()=>{});
          });
        }
      } catch (e) {}
    })();

    /**************************************************************
     * UI fade
     **************************************************************/
    window.addEventListener('DOMContentLoaded', function(){
      setTimeout(function() {
        document.querySelectorAll(".card").forEach((el,i)=> {
          setTimeout(()=>{ el.classList.add('show') }, 160+60*i);
        });
      }, 180);
    });

    /**************************************************************
     * PWA install prompt
     **************************************************************/
    let deferredPrompt;
    const installBtn = document.getElementById('installPromptBtn');
    const installAsAppBtn = document.getElementById('installAsAppBtn');
    const mobileInstall = document.getElementById('mobileInstallInstructions');

    function isMobileChromeStandaloneCapable() {
      const ua = navigator.userAgent || '';
      return /Android/.test(ua) && /Chrome\/[.0-9]* Mobile/.test(ua) && !window.matchMedia('(display-mode: standalone)').matches;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
      installAsAppBtn.style.display = 'inline-block';
      mobileInstall.style.display = 'none';
    });

    installBtn && (installBtn.onclick = async function() {
      installBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installBtn.disabled = false;
      } else {
        installBtn.disabled = false;
      }
    });

    installAsAppBtn && (installAsAppBtn.onclick = async function() {
      installAsAppBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installAsAppBtn.disabled = false;
      } else {
        alert("Install prompt not available right now. Use Chrome's menu: Add to Home screen.");
        installAsAppBtn.disabled = false;
      }
    });

    window.addEventListener('appinstalled', ()=>{
      installBtn.style.display='none';
      installAsAppBtn.style.display='none';
      deferredPrompt = null;
      mobileInstall.style.display='none';
    });

    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (!window.matchMedia('(display-mode: standalone)').matches &&
            !window.matchMedia('(display-mode: fullscreen)').matches &&
            isMobileChromeStandaloneCapable()
        ) {
          if ((installBtn.style.display === "none" || getComputedStyle(installBtn).display === "none") &&
              (installAsAppBtn.style.display === "none" || getComputedStyle(installAsAppBtn).display === "none"))
          {
            mobileInstall.innerHTML =
              "To install this app: tap <b><span style='font-size:1.22em;'>‚ãÆ</span></b> at the top right of Chrome, and choose <b>Add to Home screen</b>.";
            mobileInstall.style.display = "inline-block";
          }
        }
      }, 1100);
    });

    /**************************************************************
     * Handle Android back button in PWA (prevent full exit)
     **************************************************************/
    (function handleAndroidBackButton() {
      // Only for standalone PWA mode
      function isStandalone() {
        return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
               (window.navigator.standalone === true);
      }
      let canGoBack = false;

      // Push initial state once on entering app after successful login
      function pushDummyHistory() {
        if (!isStandalone()) return;
        try {
          history.replaceState({dummy:true}, document.title, window.location.href);
          history.pushState({dummy:true}, document.title, window.location.href);
        } catch (e) {}
      }

      // After successful login, push history state so back button is intercepted
      function enablePwaBackHandler() {
        pushDummyHistory();
        window.addEventListener('popstate', function(e) {
          if (document.getElementById('dealerApp').style.display !== 'none') {
            // If any modal/popover open, close it first
            let anyClosed = false;
            ['productModalBackdrop','deleteModalBackdrop','settingsBackdrop','detailModalBackdrop'].forEach(id=>{
              let el=document.getElementById(id);
              if(el && !el.classList.contains('hide')) {
                el.classList.add('hide');
                anyClosed = true;
              }
            });
            if(anyClosed) {
              // Closed a modal, but remain in app - push again to prevent quit
              pushDummyHistory();
              return;
            }
            // Instead of quitting app, show login modal (lock the app)
            document.getElementById('dealerApp').style.display = 'none';
            document.getElementById('login-modal').style.display = 'flex';
            window.setTimeout(()=>document.getElementById('loginPIN').focus(),150);
            pushDummyHistory();
          } else {
            // On login screen, allow exit with back (one level)
            // But push dummy to at least prevent double-tap accidental exits
            pushDummyHistory();
          }
        });
      }

      // Attach after showDealerApp is called
      window.__enablePwaBackHandler = enablePwaBackHandler;
    })();

    /**************************************************************
     * PIN hashing & auth helpers
     **************************************************************/
    async function hashPIN(pin) {
      let salt = window.localStorage.getItem('dealer-app-salt');
      if (!salt) {
        const arr = new Uint8Array(16);
        window.crypto.getRandomValues(arr);
        salt = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        window.localStorage.setItem('dealer-app-salt', salt);
      }
      const encoder = new TextEncoder();
      try {
        const baseKey = await window.crypto.subtle.importKey('raw', encoder.encode(pin), 'PBKDF2', false, ['deriveBits']);
        const rawBits = await window.crypto.subtle.deriveBits({ name: "PBKDF2", salt: encoder.encode(salt), iterations: 3000, hash: "SHA-256" }, baseKey, 256);
        const hashArr = new Uint8Array(rawBits);
        return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) {
        const data = encoder.encode(pin + salt);
        const arrBuf = await window.crypto.subtle.digest('SHA-256', data);
        const hashArr = new Uint8Array(arrBuf);
        return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
      }
    }

    function getHasPIN() { return !!window.localStorage.getItem('dealer-hash'); }
    function showDealerApp() {
      document.getElementById('dealerApp').style.display = '';
      document.getElementById('login-modal').style.display = 'none';
      setTimeout(refreshProductList, 220);
      // Enable PWA back handler for Android after entering app
      if (typeof window.__enablePwaBackHandler === 'function') window.__enablePwaBackHandler();
    }
    function showLoginModal(msg) {
      document.getElementById('dealerApp').style.display = 'none';
      const loginModal = document.getElementById('login-modal');
      loginModal.style.display = 'flex';
      if (msg) { document.getElementById('login-error').textContent = msg; } else { document.getElementById('login-error').textContent = ''; }
      document.getElementById('loginPIN').value = '';
      setTimeout(()=>document.getElementById('loginPIN').focus(),120);
    }

    // Always require PIN on load -> do not auto-unlock
    window.addEventListener('load', ()=> {
      // show login modal always
      updatePINUI(getHasPIN());
      showLoginModal();
      // Push dummy back state to help installs that open to blank (workaround for Chrome bug)
      setTimeout(function() {
        if ("serviceWorker" in navigator && window.matchMedia('(display-mode: standalone)').matches) {
          try { history.replaceState({start:true}, document.title, window.location.href); } catch (e) {}
        }
      }, 180);
    });

    // Update login UI depending on whether PIN exists
    const loginBtn = document.getElementById('loginBtn');
    const loginForm = document.getElementById('loginForm');
    const loginPIN = document.getElementById('loginPIN');
    const loginError = document.getElementById('login-error');
    const pinLabel = document.getElementById('pinLabel');

    function updatePINUI(hasPIN) {
      if (hasPIN) {
        loginBtn.textContent = "Unlock";
        pinLabel.textContent = "Enter your PIN / Password:";
        loginPIN.placeholder = "Enter PIN or password";
        loginPIN.autocomplete = "current-password";
      } else {
        loginBtn.textContent = "Set PIN";
        pinLabel.textContent = "Create a secure PIN / Password:";
        loginPIN.placeholder = "Set PIN or password";
        loginPIN.autocomplete = "new-password";
      }
      loginError.textContent = '';
    }

    loginForm.onsubmit = async function(e) {
      e.preventDefault();
      loginError.textContent = '';
      const pinVal = (loginPIN.value || '').trim();
      const hasPIN = getHasPIN();
      if (!pinVal || pinVal.length < 4) {
        loginError.textContent = hasPIN ? "Enter your PIN/Password." : "PIN/password must be at least 4 characters.";
        return;
      }
      loginBtn.disabled = true;
      try {
        const hash = await hashPIN(pinVal);
        if (!hasPIN) {
          window.localStorage.setItem('dealer-hash', hash);
          updatePINUI(true);
          loginError.style.color = 'var(--success)';
          loginError.textContent = "PIN set. Now use it to unlock.";
          setTimeout(()=>{ loginError.textContent = ''; loginError.style.color=''; },1500);
          loginBtn.disabled = false;
          loginPIN.value = '';
          return;
        }
        const userHash = window.localStorage.getItem('dealer-hash');
        if (userHash === hash) {
          loginBtn.disabled = false;
          loginError.textContent = '';
          showDealerApp();
        } else {
          loginBtn.disabled = false;
          loginError.style.color = '';
          loginError.textContent = 'Incorrect PIN / Password.';
        }
      } catch (ex) {
        loginBtn.disabled = false;
        loginError.textContent = 'An error occurred.';
      }
    };

    /**************************************************************
     * Settings modal logic: logout + reset PIN
     **************************************************************/
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const resetPinSubmit = document.getElementById('resetPinSubmit');
    const resetPinCancel = document.getElementById('resetPinCancel');
    const resetPinError = document.getElementById('resetPinError');

    settingsBtn.onclick = () => {
      settingsBackdrop.classList.remove('hide');
      // populate/clear reset form
      document.getElementById('oldPin').value = '';
      document.getElementById('newPin').value = '';
      document.getElementById('confirmPin').value = '';
      resetPinError.textContent = '';
    };
    closeSettingsBtn.onclick = () => settingsBackdrop.classList.add('hide');

    logoutBtn.onclick = () => {
      // do not delete PIN or products, just lock UI
      settingsBackdrop.classList.add('hide');
      showLoginModal('You have been logged out.');
      updatePINUI(getHasPIN());
    };

    resetPinCancel.onclick = () => {
      resetPinError.textContent = '';
      settingsBackdrop.classList.add('hide');
    };

    resetPinSubmit.onclick = async function() {
      resetPinError.textContent = '';
      const oldPin = (document.getElementById('oldPin').value || '').trim();
      const newPin = (document.getElementById('newPin').value || '').trim();
      const confirmPin = (document.getElementById('confirmPin').value || '').trim();

      if (!oldPin || oldPin.length < 4) { resetPinError.textContent = "Enter current PIN (min 4 chars)."; return; }
      if (!newPin || newPin.length < 4) { resetPinError.textContent = "New PIN must be at least 4 characters."; return; }
      if (newPin !== confirmPin) { resetPinError.textContent = "New PIN and confirmation do not match."; return; }

      resetPinSubmit.disabled = true;
      try {
        const oldHash = await hashPIN(oldPin);
        const stored = window.localStorage.getItem('dealer-hash');
        if (stored !== oldHash) {
          resetPinError.textContent = "Current PIN is incorrect.";
          resetPinSubmit.disabled = false;
          return;
        }
        const newHash = await hashPIN(newPin);
        window.localStorage.setItem('dealer-hash', newHash);
        // feedback and close
        resetPinError.style.color = 'var(--success)';
        resetPinError.textContent = "PIN updated successfully.";
        setTimeout(()=>{
          resetPinError.textContent = '';
          resetPinError.style.color = '';
          settingsBackdrop.classList.add('hide');
        }, 1000);
      } catch (err) {
        resetPinError.textContent = "Failed to update PIN.";
      }
      resetPinSubmit.disabled = false;
    };

    /**************************************************************
     * Products store & UI (same as previous working code)
     **************************************************************/
    const productListElem = document.getElementById('productList');
    const noProductsElem = document.getElementById('noProducts');
    let products = [];
    let multiSelectMode = false;
    let selectedProductIds = new Set();

    function saveProducts() {
      try { window.localStorage.setItem('dealer-products', JSON.stringify(products)); } catch(e){ console.error("Saving products failed",e); }
      refreshProductList();
    }
    function loadProducts() {
      products = [];
      try {
        const str = window.localStorage.getItem('dealer-products');
        if (str) products = JSON.parse(str) || [];
      } catch (e) { products = []; }
    }
    function escapeHTML(v) {
      if (typeof v !== "string") return v === undefined || v === null ? "" : String(v);
      return v.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'" :'&#39;','"':'&quot;'}[c]));
    }

    function handleCheckboxChange(productId, checked) {
      if (checked) selectedProductIds.add(productId);
      else selectedProductIds.delete(productId);
      updateMultiSelectControls();
    }

    function updateMultiSelectControls() {
      const multiSelectControls = document.getElementById('multiSelectControls');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const selectedCountText = document.getElementById('selectedCountText');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');

      // Show/hide controls only if there is at least 1 selected item
      if (selectedProductIds.size > 0) {
        multiSelectControls.classList.add('active');
        deleteSelectedBtn.disabled = false;
        selectedCountText.textContent = `${selectedProductIds.size} selected`;
      } else {
        multiSelectControls.classList.remove('active');
        deleteSelectedBtn.disabled = true;
        selectedCountText.textContent = "";
      }

      // Set "selectAllCheckbox" state
      if (products.length && selectedProductIds.size === products.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedProductIds.size > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function createProductCard(product, idx) {
      const li = document.createElement('li');
      li.className = 'prod-card';
      li.setAttribute('tabindex','0');
      setTimeout(()=>li.classList.add('show'), 121+idx*64);
      let imgHTML = product.photo ? `<img src="${escapeHTML(product.photo)}" class="prod-photo-thumb" alt="Product Photo">` : `<span>üì¶</span>`;
      const nameSafe = escapeHTML(product.name || "Unnamed");
      const cat = product.category ? `<span class="prod-cat">${escapeHTML(String(product.category)).slice(0,18)}</span>` : '';
      const qtyNum = Number(product.qty) || 0;
      const mrpNum = Number(product.mrp) || 0;
      const costNum = (product.cost !== undefined && product.cost !== null) ? Number(product.cost) : null;

      // Multi-select checkbox
      let checkboxHTML = `<input type="checkbox" class="prod-select-checkbox" title="Select" data-id="${product.id}" tabindex="0" ${selectedProductIds.has(product.id) ? "checked" : ""}/>`;

      li.innerHTML = `
        ${checkboxHTML}
        <div class="prod-img">${imgHTML}</div>
        <div class="prod-main-details">
          <div class="prod-name">${nameSafe}${cat}</div>
          <div class="prod-details">Stock: <b style="color:var(--success);font-weight:600">${qtyNum}</b> ‚Ä¢ ‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}${costNum!==null?` <span style="color:var(--text-muted);font-size:.928em;">(Cost: ‚Ç®${costNum.toLocaleString(undefined,{maximumFractionDigits:2})})</span>`:""}</div>
          ${product.notes?`<div class="prod-details">${escapeHTML(String(product.notes)).slice(0,55)}</div>`:""}
        </div>
        <div class="prod-actions">
          <button type="button" title="Edit" class="edit" data-id="${product.id}">‚úèÔ∏è</button>
        </div>
      `;

      // highlight selection
      if (selectedProductIds.has(product.id)) li.classList.add('selected');

      // Checkboxes
      const checkbox = li.querySelector('.prod-select-checkbox');
      if (checkbox) {
        checkbox.addEventListener('change', (e) => {
          handleCheckboxChange(product.id, checkbox.checked);
        });
        checkbox.addEventListener('click', (e)=>e.stopPropagation()); // don't fire detail modal
        checkbox.addEventListener('keydown', (e)=>e.stopPropagation());
      }

      const editBtn = li.querySelector('.edit');
      if (editBtn) editBtn.onclick = (e)=>{ e.stopPropagation(); showProductModal('edit', product); };

      li.addEventListener('click', function(e){
        if(e.target.classList.contains('prod-select-checkbox')) return;
        if(!e.target.closest('.prod-actions')) showDetailModal(product);
      });
      li.addEventListener('keydown', function(e){
        if((e.key==="Enter"||e.key===" ") && !e.target.closest('.prod-actions')) { e.preventDefault(); showDetailModal(product); }
      });
      return li;
    }

    /**************************************************************
     * Multi-select controls
     **************************************************************/

    document.getElementById("selectAllCheckbox").addEventListener("change", function() {
      if (this.checked) {
        products.forEach(prod => selectedProductIds.add(prod.id));
      } else {
        selectedProductIds.clear();
      }
      refreshProductList();
      updateMultiSelectControls();
    });

    document.getElementById("deleteSelectedBtn").onclick = function() {
      if (selectedProductIds.size === 0) return;
      if (!confirm(`Are you sure you want to delete ${selectedProductIds.size} selected item(s)?`)) return;
      products = products.filter(p => !selectedProductIds.has(p.id));
      selectedProductIds.clear();
      saveProducts();
      updateMultiSelectControls();
    };

    /**************************************************************
     * Detail modal
     **************************************************************/
    const detailModalBackdrop = document.getElementById('detailModalBackdrop');
    const detailModalBody = document.getElementById('detailModalBody');

    function disableDetailBackgroundScroll() {
      document.body.classList.add('detail-modal-open');
      // Optionally also store scroll position if you ever want to restore it (not necessary with overflow:hidden)
    }
    function enableDetailBackgroundScroll() {
      document.body.classList.remove('detail-modal-open');
    }

    function showDetailModal(product) {
      const nameSafe = escapeHTML(product.name || 'Unnamed');
      const photoBlock = product.photo ? `<img src="${escapeHTML(product.photo)}" class="prod-detail-photo" alt="${nameSafe}"/>` : `<div class="prod-detail-photo" style="font-size:60px;padding:22px 0 12px 0;">üì¶</div>`;
      const mrpNum = Number(product.mrp) || 0;
      const costNum = (product.cost !== undefined && product.cost !== null) ? Number(product.cost) : null;

      detailModalBody.innerHTML = `
        <div style="text-align:center;">${photoBlock}</div>
        <ul style="list-style:none;padding:0;margin:10px 0 0 0;display:flex;flex-direction:column;gap:.57em;">
          <li><b>Name:</b> <span style="color:var(--accent2);font-weight:600">${nameSafe}</span></li>
          ${product.category?`<li><b>Category:</b> <span style="color:var(--accent2);font-weight:600">${escapeHTML(String(product.category))}</span></li>`:""}
          <li><b>Stock:</b> <span style="color:var(--accent2);font-weight:600">${Number(product.qty)||0}</span></li>
          <li><b>MRP:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>
          ${costNum!==null?`<li><b>Cost:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${costNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>`:""}
        </ul>
        ${product.notes?`<div style="margin-top:.8em;color:var(--text-muted);background:#213047;border-radius:8px;padding:.7em .9em">${escapeHTML(String(product.notes))}</div>`:""}
      `;
      detailModalBackdrop.classList.remove('hide');
      disableDetailBackgroundScroll();
      setTimeout(()=>document.getElementById('closeDetailModalBtn').focus(),100);
    }

    document.getElementById('closeDetailModalBtn').onclick = function(){
      detailModalBackdrop.classList.add('hide');
      detailModalBody.innerHTML = '';
      enableDetailBackgroundScroll();
    };

    // Prevent scroll when detail modal is open (background locked when detail modal is NOT .hide)
    // Also ensure it unlocks on other modal closes and Escape, and on navigation/back

    document.addEventListener('keydown', function(e){
      if (e.key === "Escape") {
        let closedAModal = false;
        if (!detailModalBackdrop.classList.contains('hide')) { 
          detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML='';
          enableDetailBackgroundScroll();
          closedAModal = true;
        }
        if (!productModalBackdrop.classList.contains('hide')) { productModalBackdrop.classList.add('hide'); closedAModal = true; }
        if (!deleteModalBackdrop.classList.contains('hide')) { deleteModalBackdrop.classList.add('hide'); closedAModal = true; }
        if (!settingsBackdrop.classList.contains('hide')) { settingsBackdrop.classList.add('hide'); closedAModal = true; }
        // when closing detail modal, always enable scroll
        if (closedAModal) enableDetailBackgroundScroll();
      }
    });

    // Defensive: re-enable scroll on any click in the body if all modals are shut (e.g. browser back, unusual nav)
    function maybeResetBodyScroll() {
      if (
        detailModalBackdrop.classList.contains('hide') &&
        (!productModalBackdrop || productModalBackdrop.classList.contains('hide')) &&
        (!settingsBackdrop || settingsBackdrop.classList.contains('hide')) &&
        (!deleteModalBackdrop || deleteModalBackdrop.classList.contains('hide'))
      ) {
        enableDetailBackgroundScroll();
      }
    }
    detailModalBackdrop.addEventListener('transitionend', maybeResetBodyScroll);
    detailModalBackdrop.addEventListener('animationend', maybeResetBodyScroll);
    window.addEventListener('popstate', maybeResetBodyScroll);

    /**************************************************************
     * Search
     **************************************************************/
    const searchInput = document.getElementById('productSearch');
    searchInput.addEventListener('input', function(){ refreshProductList(); });
    searchInput.addEventListener('keydown', function(e){ if(e.key==='Escape'){ searchInput.value=''; refreshProductList(); } });

    /**************************************************************
     * Refresh product list
     **************************************************************/
    function refreshProductList() {
      loadProducts();
      productListElem.innerHTML = '';
      let q = (searchInput.value || '').trim().toLowerCase();
      let filtered = !q ? products : products.filter(prod =>
        (String(prod.name||"").toLowerCase().includes(q)) ||
        (String(prod.category||"").toLowerCase().includes(q)) ||
        (String(prod.notes||"").toLowerCase().includes(q))
      );
      if (!filtered.length) {
        noProductsElem.style.display = "";
        document.getElementById('multiSelectControls').classList.remove('active');
        return;
      }
      noProductsElem.style.display = "none";
      filtered.sort((a,b) => (Number(b.qty)-Number(a.qty)) || (String(a.name||'').localeCompare(String(b.name||''))));
      filtered.forEach((prod,i)=>productListElem.appendChild(createProductCard(prod,i)));
      updateMultiSelectControls();
    }

    /**************************************************************
     * Add / Edit product modal
     **************************************************************/
    let productEditing = null;
    const prodName = document.getElementById('prodName');
    const prodMrp = document.getElementById('prodMrp');
    const prodCost = document.getElementById('prodCost');
    const prodQty = document.getElementById('prodQty');
    const prodCategory = document.getElementById('prodCategory');
    const prodNotes = document.getElementById('prodNotes');
    const prodPhoto = document.getElementById('prodPhoto');
    const productModalBackdrop = document.getElementById('productModalBackdrop');
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modalError');
    const prodPhotoFileName = document.getElementById('prodPhotoFileName');
    const uploadBtnInnerText = document.getElementById('uploadBtnInnerText');
    const prodPhotoFileContainer = document.getElementById('prodPhotoFileContainer');
    const fileUploadWrap = document.getElementById('fileUploadWrap');

    // Store current selected photo preview (dataurl or null)
    let currentProductPhotoDataUrl = null;

    function updatePhotoPreviewUI() {
      prodPhotoFileContainer.innerHTML = '';
      if (currentProductPhotoDataUrl) {
        const img = document.createElement('img');
        img.src = currentProductPhotoDataUrl;
        img.alt = "Product Photo";
        img.className = 'photo-preview-img-thumb';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-photo-btn';
        removeBtn.title = 'Remove image';
        removeBtn.innerHTML = '‚úñ';
        removeBtn.onclick = function() {
          currentProductPhotoDataUrl = null;
          prodPhoto.value = '';
          prodPhotoFileName.textContent = '';
          uploadBtnInnerText.textContent = 'Choose Image';
          updatePhotoPreviewUI();
        };

        prodPhotoFileContainer.appendChild(img);
        prodPhotoFileContainer.appendChild(removeBtn);
      }
    }

    function showProductModal(mode, product) {
      productModal.reset();
      modalError.textContent = '';
      prodPhotoFileName.textContent = '';
      uploadBtnInnerText.textContent = 'Choose Image';
      currentProductPhotoDataUrl = null;
      updatePhotoPreviewUI();

      if (mode === 'add') {
        modalTitle.textContent = "Add Product";
        productEditing = null;
        prodName.value = ""; prodMrp.value = ""; prodCost.value = ""; prodQty.value = ""; prodCategory.value = ""; prodNotes.value = ""; prodPhoto.value = "";
      } else {
        modalTitle.textContent = "Edit Product";
        productEditing = product;
        prodName.value = product.name || ""; prodMrp.value = product.mrp !== undefined ? product.mrp : ""; prodCost.value = product.cost !== undefined ? product.cost : ""; prodQty.value = product.qty !== undefined ? product.qty : ""; prodCategory.value = product.category || ""; prodNotes.value = product.notes || ""; prodPhoto.value = "";

        if (product.photo) {
          currentProductPhotoDataUrl = product.photo;
          updatePhotoPreviewUI();
        }
      }
      productModalBackdrop.classList.remove('hide');
      // Lock body scroll when opening modal
      if (!document.body.classList.contains('modal-open')) {
        document.body.dataset.scrollY = window.scrollY;
        document.body.style.top = `-${window.scrollY}px`;
        document.body.classList.add('modal-open');
      }
      setTimeout(()=>prodName.focus(),150);
      // --- PATCH: Reset firstSubmitAttempt state ---
      firstSubmitAttempt = true;
    }

    // --- PATCH BEGIN: Fix "first image upload not saved" bug ---
    // Explanation: On initial submit, the image's FileReader async might not finish before submit, so form closes but photo is not processed.
    // Solution: When submitting, if file input has file and currentProductPhotoDataUrl is not set, wait for readFileAsDataURL promise before proceeding with save.

    // Whether this is first time submit since opening modal
    let firstSubmitAttempt = true;
    // Store last pending file read promise, so form submit can wait for it
    let prodPhotoLastPendingPromise = null;

    prodPhoto.addEventListener('change', function() {
      if (prodPhoto.files && prodPhoto.files.length) {
        prodPhotoFileName.textContent = prodPhoto.files[0].name;
        uploadBtnInnerText.textContent = "Image Selected";
        // Get file and preview
        const filePromise = readFileAsDataURL(prodPhoto.files[0]).then(dataUrl => {
          currentProductPhotoDataUrl = dataUrl;
          updatePhotoPreviewUI();
        });
        prodPhotoLastPendingPromise = filePromise;
      } else {
        prodPhotoFileName.textContent = '';
        uploadBtnInnerText.textContent = 'Choose Image';
        currentProductPhotoDataUrl = null;
        updatePhotoPreviewUI();
        prodPhotoLastPendingPromise = null;
      }
    });

    document.getElementById('addProductBtn').onclick = ()=>showProductModal('add');
    document.getElementById('closeModalBtn').onclick = ()=>{
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) {
        document.body.classList.remove('modal-open');
        const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
        document.body.style.top = '';
        window.scrollTo(0, scrollY);
        delete document.body.dataset.scrollY;
      }
    };

    productModal.onsubmit = async function(e) {
      e.preventDefault();
      modalError.textContent = "";

      // PATCH: Only on first submit after opening modal, if user chose an image and preview not processed yet, wait for FileReader to finish
      // This ensures if user clicks "Save" immediately after picking image, it will be saved
      // Once handled, any further submit is "normal"
      if (firstSubmitAttempt && prodPhoto.files && prodPhoto.files.length && !currentProductPhotoDataUrl && prodPhotoLastPendingPromise) {
        try {
          await prodPhotoLastPendingPromise;
        } catch (err) {
          modalError.textContent = "Image failed to load, please select again.";
          return;
        }
        // Only do this extra wait logic once per modal open
        firstSubmitAttempt = false;
        // Now try submitting again automatically
        productModal.onsubmit(e);
        return;
      }
      firstSubmitAttempt = false;

      const name = (prodName.value || '').trim();
      const mrpVal = prodMrp.value;
      const costVal = prodCost.value;
      const qtyVal = prodQty.value;
      const category = (prodCategory.value || '').trim();
      const notes = (prodNotes.value || '').trim();

      if (!name) { modalError.textContent = "Name required."; return; }
      if (mrpVal === "" || isNaN(Number(mrpVal)) || Number(mrpVal) < 0) { modalError.textContent = "Valid MRP required."; return; }
      if (qtyVal === "" || isNaN(Number(qtyVal)) || Number(qtyVal) < 0) { modalError.textContent = "Valid quantity required."; return; }

      let photoData = null;
      // Use the dataUrl from preview
      if (currentProductPhotoDataUrl) {
        photoData = currentProductPhotoDataUrl;
      }

      const productObj = {
        id: productEditing ? productEditing.id : genID(),
        name,
        mrp: Number(mrpVal),
        cost: costVal !== "" ? Number(costVal) : null,
        qty: Number(qtyVal),
        category,
        notes,
        photo: photoData
      };

      if (!productEditing) products.push(productObj);
      else {
        const idx = products.findIndex(p => p.id === productEditing.id);
        if (idx >= 0) products[idx] = productObj; else products.push(productObj);
      }
      saveProducts();
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) {
        document.body.classList.remove('modal-open');
        const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
        document.body.style.top = '';
        window.scrollTo(0, scrollY);
        delete document.body.dataset.scrollY;
      }
      selectedProductIds.clear();
      updateMultiSelectControls();
    };
    // --- PATCH END ---

    function readFileAsDataURL(file) {
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /**************************************************************
     * Delete modal
     **************************************************************/
    const deleteModalBackdrop = document.getElementById('deleteModalBackdrop');
    const deleteModal = document.getElementById('deleteModal');
    const deleteName = document.getElementById('deleteName');
    let productToDelete = null;

    function showDeleteModal(product) {
      deleteModalBackdrop.classList.remove('hide');
      deleteName.textContent = product.name || '';
      productToDelete = product;
      setTimeout(()=>document.getElementById('cancelDeleteBtn').focus(),60);
    }

    document.getElementById('closeDeleteBtn').onclick =
    document.getElementById('cancelDeleteBtn').onclick = () => {
      deleteModalBackdrop.classList.add('hide'); productToDelete = null;
    };

    deleteModal.onsubmit = function(e){
      e.preventDefault();
      if (!productToDelete) return;
      products = products.filter(p => p.id !== productToDelete.id);
      saveProducts();
      deleteModalBackdrop.classList.add('hide'); productToDelete = null;
      // Remove from multi-select, if any
      selectedProductIds.delete(productToDelete.id);
      updateMultiSelectControls();
    };

    function genID() { return 'p' + (Date.now() + ('' + Math.random()).slice(2,7)); }

    /**************************************************************
     * Export / Import
     **************************************************************/
    document.getElementById('exportBtn').onclick = function() {
      const dataStr = JSON.stringify(products || [], null, 2);
      const blob = new Blob([dataStr], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.style.display='none'; a.href = url; a.download = 'dealer-products-backup.json'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url);
      setTimeout(()=>{ document.body.removeChild(a); },200);
    };

    document.getElementById('importBtn').onclick = ()=>document.getElementById('importFile').click();
    document.getElementById('importFile').onchange = function(evt) {
      let file = evt.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(e){
        try {
          let arr = JSON.parse(e.target.result);
          if (Array.isArray(arr)) {
            arr.forEach(prod => { if (!prod.id) prod.id = genID(); });
            products = arr;
            saveProducts();
          } else throw new Error("Not an array");
        } catch (err) {
          alert("Invalid file - import failed.");
        }
      };
      reader.readAsText(file);
      evt.target.value = '';
    };

    /**************************************************************
     * Initial load
     **************************************************************/
    window.addEventListener('load', function() {
      loadProducts();
      // do not auto-show app; user must login each time
    });
  </script>
</body>
</html>
