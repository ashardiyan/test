let currentDetailProduct = null; // Track current product in detail view

    function showDetailModal(product) {
      currentDetailProduct = product; 
      const nameSafe = escapeHTML(product.name || 'Unnamed');
      
      let galleryHtml = "";
      if(product.photos && product.photos.length > 0) {
          galleryHtml = `<div class="detail-gallery">`;
          // Iterate with index to allow opening specific photo
          product.photos.forEach((photo, index) => {
              const src = getPhotoSrc(photo);
              if(src) {
                  galleryHtml += `<img src="${src}" onclick="openDetailPhoto(${index})" alt="${nameSafe}"/>`;
              }
          });
          galleryHtml += `</div>`;
      } else {
          galleryHtml = `<div class="prod-detail-photo" style="font-size:60px;padding:22px 0 12px 0;text-align:center;">ðŸ“¦</div>`;
      }
      
      const mrpNum = Number(product.mrp) || 0;
      const costNum = (product.cost !== undefined && product.cost !== null) ? Number(product.cost) : null;
      const barcodeHtml = product.barcode ? `<li><b>Barcode:</b> <span style="font-family:monospace;background:#2b3548;padding:2px 6px;border-radius:4px;">${escapeHTML(product.barcode)}</span></li>` : "";

      detailModalBody.innerHTML = `
        ${galleryHtml}
        <ul style="list-style:none;padding:0;margin:10px 0 0 0;display:flex;flex-direction:column;gap:.57em;">
          <li><b>Name:</b> <span style="color:var(--accent2);font-weight:600">${nameSafe}</span></li>
          ${barcodeHtml}
          ${product.category?`<li><b>Category:</b> <span style="color:var(--accent2);font-weight:600">${escapeHTML(String(product.category))}</span></li>`:""}
          <li><b>Stock:</b> <span style="color:var(--accent2);font-weight:600">${Number(product.qty)||0}</span></li>
          <li><b>MRP:</b> <span style="color:var(--accent2);font-weight:600">â‚¨${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>
          ${costNum!==null?`<li><b>Cost:</b> <span style="color:var(--accent2);font-weight:600">â‚¨${costNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>`:""}
        </ul>
        ${product.notes?`<div style="margin-top:.8em;color:var(--text-muted);background:#213047;border-radius:8px;padding:.7em .9em">${escapeHTML(String(product.notes))}</div>`:""}
      `;

      detailModalBackdrop.classList.remove('hide'); disableDetailBackgroundScroll(); setTimeout(()=>document.getElementById('closeDetailModalBtn').focus(),100);
    }

    document.getElementById('closeDetailModalBtn').onclick = function(){ detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML = ''; enableDetailBackgroundScroll(); };

    // Helper function called by the inline HTML onclick
    window.openDetailPhoto = function(index) {
        if(currentDetailProduct && currentDetailProduct.photos) {
            openImageViewer(index, currentDetailProduct.photos);
        }
    };
