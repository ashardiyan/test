<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Al Rehman Electronics</title>
  <meta name="theme-color" content="#161B22" />
  <!-- Add PWA meta for mobile -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1: #0C1220;
      --bg2: #161B22;
      --bg3: #212936;
      --accent: #2563EB;
      --accent-hover: #164eab;
      --accent2: #06B6D4;
      --accent2-hover: #1095b7;
      --gray: #AEB9C7;
      --text: #F3F7FF;
      --text-muted: #B0B9C6;
      --radius: 16px;
      --radius-card: 22px;
      --shadow: 0 8px 32px 0 rgba(60,120,220,0.17);
      --shadow-soft: 0 2px 8px rgba(40,98,180,.10);
      --shadow-strong: 0 10px 26px 0 rgba(4,19,60,0.04);
      --danger: #ef4444;
      --success: #10b981;
      --rounded-btn: 10px;
      --button-skyblue: #06B6D4;
      --button-gradient: linear-gradient(90deg, #06B6D4 40%, #2563EB 100%);
      --card-glass: rgba(30, 39, 56, 0.70);
      --card-border: #11d3ff22;
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      font-size: 17px;
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
      color: var(--text);
      min-height: 100vh;
    }
    body { display:flex; flex-direction:column; min-height:100vh; }
    .container { max-width:670px; margin:0 auto; padding:34px 12px 54px; width:100%; box-sizing:border-box; }
    header { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:20px; gap:10px; }
    .logo-wrap { display:flex; align-items:center; gap:14px; }
    .app-logo { width:50px; height:50px; border-radius:18px; background:linear-gradient(135deg,var(--accent),var(--accent2)75%); display:flex; align-items:center; justify-content:center; font-size:2.11rem; box-shadow:var(--shadow-soft); color:#fff; font-weight:700; overflow: hidden; }
    .app-title { font-weight:900; font-size:1.7rem; line-height:1.13; letter-spacing:-1px; color:var(--text); margin-left:2px; }
    .top-controls { display:flex; align-items:center; gap:10px; }

    /* Custom modern product card design */
    .product-list {
      margin:0; padding:0; list-style:none;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 24px 19px;
    }
    .prod-card {
      background: var(--card-glass);
      border-radius: 22px;
      box-shadow: var(--shadow), var(--shadow-strong);
      border: 2px solid var(--card-border);
      padding: 0;
      margin: 0;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-height: 176px;
      transition: box-shadow .19s, border-color .17s, background .19s, scale .13s;
      opacity:0; 
      transform: translateY(25px) scale(.97); 
      animation: fadeUp .48s cubic-bezier(.49,.85,.55,1.18); 
      animation-fill-mode:forwards;
      cursor: pointer;
      will-change: box-shadow, transform, background;
    }
    .prod-card.show {
      opacity: 1;
      transform: none;
    }
    .prod-card:hover {
      box-shadow: 0 8px 34px #16cefe1b, 0 0 0 2.2px var(--accent2-hover);
      border-color: var(--accent2-hover);
      background: linear-gradient(120deg, #162340b0 55%, #1e395f66 180%);
      scale:1.013;
    }
    .prod-card.selected {
      border-color: var(--danger);
      box-shadow: 0 8px 32px #ef444438, 0 0 0 3px var(--danger);
      background: linear-gradient(110deg, #241a33 60%, #362232 100%);
    }

    .prod-card-top {
      display: flex; align-items: flex-start; gap: 18px; padding: 20px 19px 8px 19px;
    }
    .prod-select-checkbox {
      margin-right: 4px;
      transform: scale(1.19);
      accent-color: var(--accent2);
      cursor:pointer;
      margin-top: 2px;
      margin-left: 0;
      flex-shrink: 0;
    }
    .prod-img {
      display: flex;
      justify-content: center;
      align-items: center;
      min-width:54px;
      width:54px;
      height:54px;
      border-radius:15px;
      background:linear-gradient(120deg,#0ca1ec 0%, #233d54 60%, #1dade4 100%);
      box-shadow: 0 2.5px 13px #24c5ff35;
      color: #fff;
      font-size:2.16em;
      font-weight: 900;
      overflow: hidden;
      flex-shrink: 0;
      border:2.7px solid #233d54;
    }
    .prod-photo-thumb { max-width:100%; max-height:54px; border-radius:13px; object-fit:cover; display:block; background:#232b36;}
    .prod-main-details { 
      flex: 1;
      min-width: 0;
      padding-right: 2px;
    }
    .prod-name {
      font-weight: 750;
      font-size: 1.17em;
      color: var(--accent2);
      letter-spacing: -0.5px;
      margin-bottom:3px;
      display: flex;
      align-items: center;
      gap: 7px;
      word-break: break-word;
    }
    .prod-cat {
      background: #1e405bf2;
      color: var(--accent2);
      font-size: .93em;
      padding: .17em .74em;
      border-radius: 12px;
      font-weight: 600;
      margin-left: 5px;
      letter-spacing: 0.05em;
      user-select: none;
      box-shadow: 0 1px 5px #234f7622;
      display: inline-block;
      max-width: 118px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }
    .prod-details {
      color: var(--gray);
      font-size: .965em;
      margin-top:2px;
      margin-bottom:2px;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap: wrap;
    }
    .prod-card-bottom {
      border-top: 1.5px solid #273b53ad;
      margin: 0 19px 0 19px;
      padding: 10px 0 6px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }
    .prod-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-left: 0;
      z-index:2;
    }
    .prod-actions button {
      background: none;
      border: none;
      color: var(--accent2);
      font-size: 1.28em;
      cursor: pointer;
      transition: color .11s, background .11s;
      border-radius: 7px;
      padding: 3.5px 6px;
      outline: none;
    }
    .prod-actions button:active, .prod-actions button:focus { background: #192b36; }

    .prod-stock {
      font-weight: 700;
      color: var(--success);
      padding-right: 6px;
    }
    .prod-mrp {
      font-weight: 600;
      color: #23c4e7;
      background:rgba(4,20,38,.15);
      border-radius:8px;
      padding:2px 9px;
      margin-right: 0;
      font-size:.97em;
      letter-spacing: 0.01em;
      display: inline-block;
    }
    .prod-cost {
      font-size:.96em;
      color:var(--text-muted);
      margin-left:3.5px;
      letter-spacing:0.01em;
    }
    .prod-note {
      margin-top:3px;
      color:var(--text-muted);
      font-size:.958em;
      background:#232b40e0;
      border-radius:8px;
      padding:4px 11px 5px 11px;
      min-height: 23px;
      word-break: break-word;
    }
    .prod-card .prod-select-checkbox:focus {
       outline: 2px solid var(--accent2);
       outline-offset:1.5px;
    }

    .no-products {
      text-align:center;
      color:var(--text-muted);
      font-size:1.12em;
      margin:34px 0 14px 0;
      letter-spacing:.01em;
    }

    @media (max-width: 750px){
      .container{padding:13px 1vw 22px 1vw;}
      .product-list { grid-template-columns: 1fr; gap: 19px;}
      .card{padding:.8rem .4rem 1.05rem .75rem;}
      .app-title{font-size:1.2rem;}
      .prod-card{min-height:160px;}
      .prod-card-top{padding:12px 9px 5px 11px;}
      .prod-card-bottom{margin:0 10px 0 10px; padding:7px 0 5px 0;}
    }
    ::selection{background:var(--accent2); color:#fff;}
    a{color:var(--accent);}
    .hidden { display:none !important; }
    /* Fingerprint icon for unlock button */
    .fingerprint-btn {
      display:inline-flex;
      align-items:center;
      background: #183345;
      color: var(--accent2);
      border: none;
      border-radius: 9px;
      padding: 7px 15px 7px 7px;
      font-size:1.13em;
      font-family:inherit;
      font-weight:600;
      gap:7px;
      box-shadow: 0 2px 10px #12e8ff22;
      cursor: pointer;
      margin-top:10px;
      margin-bottom:2px;
      transition:background .16s;
    }
    .fingerprint-btn:hover, .fingerprint-btn:active { background:#1e4967; }
    .fingerprint-btn svg {
      margin-right:2px;
      display:inline-block;
      vertical-align:middle;
    }
    #login-fingerprint-status {
      display: block;
      color: var(--text-muted);
      margin-top:2px;
      font-size:.98em;
      min-height:18px;
      text-align:center;
    }
  </style>
</head>
<body>
  <!-- LOGIN / SET PIN modal - always shown on load (no auto login) -->
  <div id="login-modal" style="position:fixed; inset:0; z-index:7000; background:rgba(22,27,34,0.89); display:flex; justify-content:center; align-items:center;">
    <form class="login-dialog modal" id="loginForm" autocomplete="off" novalidate style="max-width:380px;">
      <button class="modal-close" type="button" id="loginCloseBtn" title="Close" style="display:none">‚úñ</button>
      <h3 style="text-align:center;color:var(--accent2);margin-bottom:12px">üîê Dealer Login</h3>
      <div class="error input-error" id="login-error" style="min-height:18px;margin-bottom:8px"></div>

      <label id="pinLabel" for="loginPIN">Create a secure PIN / Password</label>
      <input type="password" id="loginPIN" minlength="4" maxlength="32" required placeholder="Set PIN or password" autocomplete="new-password" />

      <div style="display:flex; gap:8px; align-items:center;">
        <button type="submit" id="loginBtn" style="flex:1;">Set PIN</button>
        <button type="button" id="forgotBtn" style="display:none; background:transparent; border:1px solid #253048; color:var(--text); padding:9px 12px; border-radius:8px; cursor:pointer;">Forgot</button>
      </div>
      <!-- Fingerprint unlock UI will be inserted here dynamically -->
      <div id="fingerprint-unlock-container" style="width:100%;text-align:center;"></div>
      <span id="login-fingerprint-status"></span>
      <small style="display:block;margin-top:12px;color:var(--text-muted);">All data is stored locally in your browser. PIN is hashed before saving.</small>
    </form>
  </div>

  <!-- Main app container (hidden until correct login) -->
  <div id="dealerApp" class="" style="display:none;">
    <div class="container">
      <header>
        <div class="logo-wrap">
          <div class="app-logo" title="Al Rahman Electronics" style="padding:0;">
            <img src="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true" alt="App Logo" style="width:100%;height:100%;border-radius:16px;object-fit:cover;background:#fff;border:none;"/>
          </div>
          <span class="app-title">Al Rahman Electronics</span>
        </div>
        <div class="top-controls">
          <button id="installPromptBtn" title="Install as App">üì≤ Install</button>
          <button id="installAsAppBtn" title="Install as App (force)">üõ†Ô∏è</button>
          <button id="settingsBtn" title="Settings (‚ãÆ)">‚ãÆ</button>
          <span id="mobileInstallInstructions"></span>
        </div>
      </header>

      <div class="main-content">
        <section class="card" style="animation-delay:.06s">
          <div class="products-top-actions">
            <div class="product-search-wrap">
              <input type="search" placeholder="Search by name, category, or note..." id="productSearch" autocomplete="off" />
              <span class="search-icon">&#128269;</span>
            </div>
            <button type="button" id="addProductBtn" class="rounded-sky-btn">+ Add</button>
            <button type="button" id="exportBtn" class="rounded-sky-btn">Export</button>
            <button type="button" id="importBtn" class="rounded-sky-btn">Import</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
          <div id="multiSelectControls">
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="selectAllCheckbox" title="Select all" />
              <span style="user-select:none;">Select all</span>
            </label>
            <button type="button" id="deleteSelectedBtn" disabled>üóëÔ∏è Delete Selected</button>
            <span id="selectedCountText" style="color:var(--danger);font-weight:600;font-size:0.99em;"></span>
          </div>
          <ul class="product-list" id="productList"></ul>
          <div class="no-products" id="noProducts" style="display:none">No products yet. Click <b>+ Add</b> to get started!</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Product Add/Edit Modal -->
  <div class="modal-backdrop hide" id="productModalBackdrop">
    <form class="modal" id="productModal" autocomplete="off">
      <button class="modal-close" type="button" id="closeModalBtn" title="Close">‚úñ</button>
      <h3 id="modalTitle">Add Product</h3>
      <div class="error" id="modalError" style="min-height:18px"></div>
      <label for="prodName">Name</label>
      <input type="text" id="prodName" required maxlength="64" />
      <label for="prodMrp">MRP (‚Ç®)</label>
      <input type="number" id="prodMrp" min="0" max="100000" step="0.01" required />
      <label for="prodCost">Cost Price (‚Ç®)</label>
      <input type="number" id="prodCost" min="0" max="100000" step="0.01"/>
      <label for="prodQty">Quantity</label>
      <input type="number" id="prodQty" min="0" max="100000" required />
      <label for="prodCategory">Category</label>
      <input type="text" id="prodCategory" maxlength="32" />
      <label for="prodNotes">Notes</label>
      <textarea id="prodNotes" maxlength="120" placeholder=""></textarea>
      <span class="modal-file-label">Photo</span>
      <div class="modal-file-upload-wrap">
        <span class="modal-file-upload-btn rounded-sky-btn" id="uploadBtnText">
          <svg width="18" height="18" style="margin-right:6px;vertical-align:-4px" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <span id="uploadBtnInnerText">Choose Image</span>
          <input type="file" id="prodPhoto" accept="image/*" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;"/>
        </span>
        <span id="prodPhotoFileName" style="color:var(--text-muted);font-size:.99em;"></span>
      </div>
      <div class="modal-btnbar">
        <button type="submit" id="saveProductBtn" class="rounded-sky-btn">Save</button>
      </div>
    </form>
  </div>

  <!-- Delete confirmation modal -->
  <div class="modal-backdrop hide" id="deleteModalBackdrop">
    <form class="modal" id="deleteModal">
      <button class="modal-close" type="button" id="closeDeleteBtn" title="Close">‚úñ</button>
      <h3>Delete Product</h3>
      <div style="margin:11px 0 17px 0">Are you sure you want to delete <b id="deleteName"></b>?</div>
      <div class="modal-btnbar">
        <button type="button" id="cancelDeleteBtn" class="rounded-sky-btn cancel">Cancel</button>
        <button type="submit" style="background:var(--danger);border-radius:10px;padding:10px 22px;color:#fff;border:none;font-weight:700;box-shadow:0 2px 10px #1b314e28;transition:background .14s;outline:none;">Yes, Delete</button>
      </div>
    </form>
  </div>

  <!-- Product Detail Modal -->
  <div class="modal-backdrop hide" id="detailModalBackdrop">
    <div class="modal" id="detailModal" tabindex="-1">
      <button class="modal-close" type="button" id="closeDetailModalBtn" title="Close">‚úñ</button>
      <h3>Product Details</h3>
      <div id="detailModalBody"></div>
    </div>
  </div>

  <!-- Settings Modal (contains Logout + Reset PIN) -->
  <div class="modal-backdrop hide" id="settingsBackdrop">
    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <button class="modal-close" type="button" id="closeSettingsBtn" title="Close">‚úñ</button>
      <h3 id="settingsTitle">Settings</h3>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">Account</div>
            <div style="color:var(--text-muted);font-size:.94em;">Logout or reset your PIN</div>
          </div>
        </div>

        <button id="logoutBtn" style="padding:10px;border-radius:8px;border:none;background:#2b2f3a;color:var(--text);cursor:pointer;">üîí Logout</button>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700">Reset PIN</div>
        <div style="color:var(--text-muted);font-size:.93em;margin-bottom:6px;">Enter your current PIN, then choose a new one.</div>

        <label for="oldPin">Current PIN</label>
        <input type="password" id="oldPin" placeholder="Current PIN" maxlength="32" />

        <label for="newPin">New PIN</label>
        <input type="password" id="newPin" placeholder="New PIN (min 4 chars)" maxlength="32" />

        <label for="confirmPin">Confirm New PIN</label>
        <input type="password" id="confirmPin" placeholder="Confirm new PIN" maxlength="32" />

        <div class="error" id="resetPinError" style="min-height:18px;"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px;">
          <button id="resetPinCancel" class="rounded-sky-btn cancel">Cancel</button>
          <button id="resetPinSubmit" class="rounded-sky-btn">Reset PIN</button>
        </div>
      </div>

    </div>
  </div>

  <input type="file" id="hiddenImport" accept="application/json" style="display:none">

  <script>
    /****************************************************************
     * PWA manifest & service worker (dynamically created)
     ****************************************************************/
    (function createManifestAndServiceWorker() {
      // Using a PNG icon as requested
      const imgIcon = "https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true";
      const manifestObj = {
        name: "Al Rahman Electronics",
        short_name: "ARE",
        description: "Local-only dealer product listing (offline-first)",
        start_url: "/index.html",
        display: "standalone",
        background_color: "#161B22",
        theme_color: "#161B22",
        icons: [
          { src: imgIcon, sizes: "192x192", type: "image/png" },
          { src: imgIcon, sizes: "512x512", type: "image/png" }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifestObj)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(manifestBlob);
      (function setManifestLink() {
        let existing = document.querySelector('link[rel="manifest"]');
        if (!existing) {
          existing = document.createElement('link');
          existing.rel = 'manifest';
          document.head.appendChild(existing);
        }
        existing.href = manifestURL;
      })();

      // Improved service worker for offline opening
      const swScript = `
        const CACHE_NAME = 'local-dealer-cache-v2';
        const FILES_TO_CACHE = [
          '/',
          '/index.html',
          location.pathname.endsWith('.html') ? location.pathname : '/index.html'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME).then(cache => cache.addAll(FILES_TO_CACHE))
          );
          self.skipWaiting();
        });

        self.addEventListener('activate', event => {
          event.waitUntil(clients.claim());
        });

        self.addEventListener('fetch', event => {
          if (event.request.method !== 'GET') return;
          event.respondWith(
            caches.match(event.request).then(response => {
              return response || fetch(event.request).then(resp => {
                // Cache new file
                if (resp && resp.status === 200 && resp.type === 'basic') {
                  const respClone = resp.clone();
                  caches.open(CACHE_NAME).then(cache => {
                    cache.put(event.request, respClone);
                  });
                }
                return resp;
              }).catch(() => {
                // If HTML navigation request, fallback to offline page
                if (event.request.mode === 'navigate' || (event.request.destination === 'document')) {
                  return caches.match('/index.html');
                }
                return undefined;
              });
            })
          );
        });
      `;
      try {
        const swBlob = new Blob([swScript], { type: 'text/javascript' });
        const swURL = URL.createObjectURL(swBlob);
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register(swURL).catch(()=>{});
          });
        }
      } catch (e) {}
    })();

    /**************************************************************
     * UI fade
     **************************************************************/
    window.addEventListener('DOMContentLoaded', function(){
      setTimeout(function() {
        document.querySelectorAll(".card").forEach((el,i)=> {
          setTimeout(()=>{ el.classList.add('show') }, 160+60*i);
        });
      }, 180);
    });

    /**************************************************************
     * PWA install prompt
     **************************************************************/
    let deferredPrompt;
    const installBtn = document.getElementById('installPromptBtn');
    const installAsAppBtn = document.getElementById('installAsAppBtn');
    const mobileInstall = document.getElementById('mobileInstallInstructions');

    function isMobileChromeStandaloneCapable() {
      const ua = navigator.userAgent || '';
      return /Android/.test(ua) && /Chrome\/[.0-9]* Mobile/.test(ua) && !window.matchMedia('(display-mode: standalone)').matches;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
      installAsAppBtn.style.display = 'inline-block';
      mobileInstall.style.display = 'none';
    });

    installBtn && (installBtn.onclick = async function() {
      installBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installBtn.disabled = false;
      } else {
        installBtn.disabled = false;
      }
    });

    installAsAppBtn && (installAsAppBtn.onclick = async function() {
      installAsAppBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installAsAppBtn.disabled = false;
      } else {
        alert("Install prompt not available right now. Use Chrome's menu: Add to Home screen.");
        installAsAppBtn.disabled = false;
      }
    });

    window.addEventListener('appinstalled', ()=>{
      installBtn.style.display='none';
      installAsAppBtn.style.display='none';
      deferredPrompt = null;
      mobileInstall.style.display='none';
    });

    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (!window.matchMedia('(display-mode: standalone)').matches &&
            !window.matchMedia('(display-mode: fullscreen)').matches &&
            isMobileChromeStandaloneCapable()
        ) {
          if ((installBtn.style.display === "none" || getComputedStyle(installBtn).display === "none") &&
              (installAsAppBtn.style.display === "none" || getComputedStyle(installAsAppBtn).display === "none"))
          {
            mobileInstall.innerHTML =
              "To install this app: tap <b><span style='font-size:1.22em;'>‚ãÆ</span></b> at the top right of Chrome, and choose <b>Add to Home screen</b>.";
            mobileInstall.style.display = "inline-block";
          }
        }
      }, 1100);
    });

    /**************************************************************
     * Fingerprint Unlock (Android app mode via Chrome)
     **************************************************************/
    async function isFingerprintAvailable() {
      // For Chrome on Android and only when standalone
      if (!window.PublicKeyCredential) return false;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isChrome = /Chrome\//i.test(navigator.userAgent);
      let hasPIN = !!window.localStorage.getItem('dealer-hash');
      // Only show fingerprint if dealer PIN is set (prevents first time users from confusion)
      return isStandalone && isAndroid && isChrome && hasPIN;
    }

    function displayFingerprintButton() {
      const fpDiv = document.getElementById('fingerprint-unlock-container');
      if (!fpDiv) return;

      if (document.getElementById('fingerprintUnlockBtn')) return; // Prevent double
      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = "fingerprint-btn";
      btn.id = "fingerprintUnlockBtn";
      btn.innerHTML = `<svg width="21" height="21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M12 11V17"/></svg>Unlock with Fingerprint`;
      fpDiv.appendChild(btn);
      btn.onclick = doFingerprintUnlock;
    }
    function removeFingerprintButton() {
      const fpDiv = document.getElementById('fingerprint-unlock-container');
      if(fpDiv) fpDiv.innerHTML = "";
      document.getElementById('login-fingerprint-status').textContent = "";
    }

    async function doFingerprintUnlock() {
      const statusElem = document.getElementById('login-fingerprint-status');
      statusElem.textContent = "Waiting for fingerprint...";
      // Create a dummy challenge value (could use PIN hash's salt, but value doesn't matter)
      const challenge = new Uint8Array(24);
      window.crypto.getRandomValues(challenge);
      try {
        // These options are purely for authentication prompt; credentialId is not needed for local scenarios
        // In a full FIDO implementation, you would store credentialId per user, but for local
        // unlock (where simply verifying a local safe login is enough) this suffices
        let publicKeyOptions = {
          publicKey: {
            challenge,
            timeout: 15000,
            userVerification: "required"
          }
        };

        await navigator.credentials.get(publicKeyOptions);
        // If no error, fingerprint verified
        statusElem.style.color = "var(--success)";
        statusElem.textContent = "Fingerprint verified! Unlocking...";
        setTimeout(()=>{
          statusElem.textContent = '';
          statusElem.style.color = '';
          showDealerApp();
        }, 370);
      } catch (err) {
        // Possible errors: NotAllowedError (canceled/timeout), NotSupportedError, SecurityError, etc.
        statusElem.style.color = "var(--danger)";
        if (err && err.name === "NotAllowedError") {
          statusElem.textContent = "Fingerprint was cancelled or timed out.";
        } else if (err && err.name === "NotSupportedError") {
          statusElem.textContent = "No biometric method is enrolled or found.";
        } else {
          statusElem.textContent = "Fingerprint unavailable: " + (err && err.message ? err.message : "Unknown error");
        }
        setTimeout(()=>{
          statusElem.textContent = '';
          statusElem.style.color = '';
        }, 1850);
      }
    }

    // Run on page load, show button if available
    window.addEventListener('DOMContentLoaded', async function(){
      if (await isFingerprintAvailable()) {
        displayFingerprintButton();
      }
    });

    // Update fingerprint UI on PIN set/removed
    function fingerprintUpdateWatcher(){
      setTimeout(async function() {
        if(await isFingerprintAvailable()) displayFingerprintButton();
        else removeFingerprintButton();
      },100);
    }

    // Whenever PIN status changes
    window.addEventListener('storage', fingerprintUpdateWatcher);

    /**************************************************************
     * Handle Android back button in PWA (prevent full exit)
     **************************************************************/
    (function handleAndroidBackButton() {
      // Only for standalone PWA mode
      function isStandalone() {
        return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
               (window.navigator.standalone === true);
      }
      let canGoBack = false;

      // Push initial state once on entering app after successful login
      function pushDummyHistory() {
        if (!isStandalone()) return;
        try {
          history.replaceState({dummy:true}, document.title, window.location.href);
          history.pushState({dummy:true}, document.title, window.location.href);
        } catch (e) {}
      }

      // After successful login, push history state so back button is intercepted
      function enablePwaBackHandler() {
        pushDummyHistory();
        window.addEventListener('popstate', function(e) {
          if (document.getElementById('dealerApp').style.display !== 'none') {
            // If any modal/popover open, close it first
            let anyClosed = false;
            ['productModalBackdrop','deleteModalBackdrop','settingsBackdrop','detailModalBackdrop'].forEach(id=>{
              let el=document.getElementById(id);
              if(el && !el.classList.contains('hide')) {
                el.classList.add('hide');
                anyClosed = true;
              }
            });
            if(anyClosed) {
              // Closed a modal, but remain in app - push again to prevent quit
              pushDummyHistory();
              return;
            }
            // Instead of quitting app, show login modal (lock the app)
            document.getElementById('dealerApp').style.display = 'none';
            document.getElementById('login-modal').style.display = 'flex';
            window.setTimeout(()=>document.getElementById('loginPIN').focus(),150);
            pushDummyHistory();
            fingerprintUpdateWatcher();
          } else {
            // On login screen, allow exit with back (one level)
            // But push dummy to at least prevent double-tap accidental exits
            pushDummyHistory();
          }
        });
      }

      // Attach after showDealerApp is called
      window.__enablePwaBackHandler = enablePwaBackHandler;
    })();

    /**************************************************************
     * PIN hashing & auth helpers
     **************************************************************/
    async function hashPIN(pin) {
      let salt = window.localStorage.getItem('dealer-app-salt');
      if (!salt) {
        const arr = new Uint8Array(16);
        window.crypto.getRandomValues(arr);
        salt = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        window.localStorage.setItem('dealer-app-salt', salt);
      }
      const encoder = new TextEncoder();
      try {
        const baseKey = await window.crypto.subtle.importKey('raw', encoder.encode(pin), 'PBKDF2', false, ['deriveBits']);
        const rawBits = await window.crypto.subtle.deriveBits({ name: "PBKDF2", salt: encoder.encode(salt), iterations: 3000, hash: "SHA-256" }, baseKey, 256);
        const hashArr = new Uint8Array(rawBits);
        return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) {
        const data = encoder.encode(pin + salt);
        const arrBuf = await window.crypto.subtle.digest('SHA-256', data);
        const hashArr = new Uint8Array(arrBuf);
        return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
      }
    }

    function getHasPIN() { return !!window.localStorage.getItem('dealer-hash'); }
    function showDealerApp() {
      document.getElementById('dealerApp').style.display = '';
      document.getElementById('login-modal').style.display = 'none';
      setTimeout(refreshProductList, 220);
      // Enable PWA back handler for Android after entering app
      if (typeof window.__enablePwaBackHandler === 'function') window.__enablePwaBackHandler();
    }
    function showLoginModal(msg) {
      document.getElementById('dealerApp').style.display = 'none';
      const loginModal = document.getElementById('login-modal');
      loginModal.style.display = 'flex';
      if (msg) { document.getElementById('login-error').textContent = msg; } else { document.getElementById('login-error').textContent = ''; }
      document.getElementById('loginPIN').value = '';
      setTimeout(()=>document.getElementById('loginPIN').focus(),120);
      fingerprintUpdateWatcher();
    }

    // Always require PIN on load -> do not auto-unlock
    window.addEventListener('load', ()=> {
      // show login modal always
      updatePINUI(getHasPIN());
      showLoginModal();
      // Push dummy back state to help installs that open to blank (workaround for Chrome bug)
      setTimeout(function() {
        if ("serviceWorker" in navigator && window.matchMedia('(display-mode: standalone)').matches) {
          try { history.replaceState({start:true}, document.title, window.location.href); } catch (e) {}
        }
      }, 180);
    });

    // Update login UI depending on whether PIN exists
    const loginBtn = document.getElementById('loginBtn');
    const loginForm = document.getElementById('loginForm');
    const loginPIN = document.getElementById('loginPIN');
    const loginError = document.getElementById('login-error');
    const pinLabel = document.getElementById('pinLabel');

    function updatePINUI(hasPIN) {
      if (hasPIN) {
        loginBtn.textContent = "Unlock";
        pinLabel.textContent = "Enter your PIN / Password:";
        loginPIN.placeholder = "Enter PIN or password";
        loginPIN.autocomplete = "current-password";
      } else {
        loginBtn.textContent = "Set PIN";
        pinLabel.textContent = "Create a secure PIN / Password:";
        loginPIN.placeholder = "Set PIN or password";
        loginPIN.autocomplete = "new-password";
      }
      loginError.textContent = '';
      fingerprintUpdateWatcher();
    }

    loginForm.onsubmit = async function(e) {
      e.preventDefault();
      loginError.textContent = '';
      const pinVal = (loginPIN.value || '').trim();
      const hasPIN = getHasPIN();
      if (!pinVal || pinVal.length < 4) {
        loginError.textContent = hasPIN ? "Enter your PIN/Password." : "PIN/password must be at least 4 characters.";
        return;
      }
      loginBtn.disabled = true;
      try {
        const hash = await hashPIN(pinVal);
        if (!hasPIN) {
          window.localStorage.setItem('dealer-hash', hash);
          updatePINUI(true);
          loginError.style.color = 'var(--success)';
          loginError.textContent = "PIN set. Now use it to unlock.";
          setTimeout(()=>{ loginError.textContent = ''; loginError.style.color=''; },1500);
          loginBtn.disabled = false;
          loginPIN.value = '';
          fingerprintUpdateWatcher();
          return;
        }
        const userHash = window.localStorage.getItem('dealer-hash');
        if (userHash === hash) {
          loginBtn.disabled = false;
          loginError.textContent = '';
          showDealerApp();
        } else {
          loginBtn.disabled = false;
          loginError.style.color = '';
          loginError.textContent = 'Incorrect PIN / Password.';
        }
      } catch (ex) {
        loginBtn.disabled = false;
        loginError.textContent = 'An error occurred.';
      }
    };

    /**************************************************************
     * Settings modal logic: logout + reset PIN
     **************************************************************/
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const resetPinSubmit = document.getElementById('resetPinSubmit');
    const resetPinCancel = document.getElementById('resetPinCancel');
    const resetPinError = document.getElementById('resetPinError');

    settingsBtn.onclick = () => {
      settingsBackdrop.classList.remove('hide');
      // populate/clear reset form
      document.getElementById('oldPin').value = '';
      document.getElementById('newPin').value = '';
      document.getElementById('confirmPin').value = '';
      resetPinError.textContent = '';
    };
    closeSettingsBtn.onclick = () => settingsBackdrop.classList.add('hide');

    logoutBtn.onclick = () => {
      // do not delete PIN or products, just lock UI
      settingsBackdrop.classList.add('hide');
      showLoginModal('You have been logged out.');
      updatePINUI(getHasPIN());
      fingerprintUpdateWatcher();
    };

    resetPinCancel.onclick = () => {
      resetPinError.textContent = '';
      settingsBackdrop.classList.add('hide');
      fingerprintUpdateWatcher();
    };

    resetPinSubmit.onclick = async function() {
      resetPinError.textContent = '';
      const oldPin = (document.getElementById('oldPin').value || '').trim();
      const newPin = (document.getElementById('newPin').value || '').trim();
      const confirmPin = (document.getElementById('confirmPin').value || '').trim();

      if (!oldPin || oldPin.length < 4) { resetPinError.textContent = "Enter current PIN (min 4 chars)."; return; }
      if (!newPin || newPin.length < 4) { resetPinError.textContent = "New PIN must be at least 4 characters."; return; }
      if (newPin !== confirmPin) { resetPinError.textContent = "New PIN and confirmation do not match."; return; }

      resetPinSubmit.disabled = true;
      try {
        const oldHash = await hashPIN(oldPin);
        const stored = window.localStorage.getItem('dealer-hash');
        if (stored !== oldHash) {
          resetPinError.textContent = "Current PIN is incorrect.";
          resetPinSubmit.disabled = false;
          return;
        }
        const newHash = await hashPIN(newPin);
        window.localStorage.setItem('dealer-hash', newHash);
        // feedback and close
        resetPinError.style.color = 'var(--success)';
        resetPinError.textContent = "PIN updated successfully.";
        setTimeout(()=>{
          resetPinError.textContent = '';
          resetPinError.style.color = '';
          settingsBackdrop.classList.add('hide');
          fingerprintUpdateWatcher();
        }, 1000);
      } catch (err) {
        resetPinError.textContent = "Failed to update PIN.";
      }
      resetPinSubmit.disabled = false;
    };

    /**************************************************************
     * Products store & UI (same as previous working code)
     **************************************************************/
    const productListElem = document.getElementById('productList');
    const noProductsElem = document.getElementById('noProducts');
    let products = [];

    // -- Multi-select state
    let multiSelectMode = false;
    let selectedProductIds = new Set();

    function saveProducts() {
      try { window.localStorage.setItem('dealer-products', JSON.stringify(products)); } catch(e){ console.error("Saving products failed",e); }
      refreshProductList();
    }
    function loadProducts() {
      products = [];
      try {
        const str = window.localStorage.getItem('dealer-products');
        if (str) products = JSON.parse(str) || [];
      } catch (e) { products = []; }
    }
    function escapeHTML(v) {
      if (typeof v !== "string") return v === undefined || v === null ? "" : String(v);
      return v.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'" :'&#39;','"':'&quot;'}[c]));
    }

    function handleCheckboxChange(productId, checked) {
      if (checked) selectedProductIds.add(productId);
      else selectedProductIds.delete(productId);
      updateMultiSelectControls();
    }

    function updateMultiSelectControls() {
      const multiSelectControls = document.getElementById('multiSelectControls');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const selectedCountText = document.getElementById('selectedCountText');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');

      if (selectedProductIds.size > 0) {
        multiSelectMode = true;
        multiSelectControls.classList.add('active');
        deleteSelectedBtn.disabled = false;
        selectedCountText.textContent = `${selectedProductIds.size} selected`;
      } else {
        deleteSelectedBtn.disabled = true;
        selectedCountText.textContent = "";
      }

      // Decide whether hide controls if none selected
      if (!multiSelectMode && selectedProductIds.size === 0) {
        multiSelectControls.classList.remove('active');
      } else {
        multiSelectControls.classList.add('active');
      }

      // Select all checkbox indeterminate
      if (products.length && selectedProductIds.size === products.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedProductIds.size > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    function createProductCard(product, idx) {
      const li = document.createElement('li');
      li.className = 'prod-card';
      li.setAttribute('tabindex','0');
      setTimeout(()=>li.classList.add('show'), 121+idx*54);

      // Modernized inner layout:
      // product, image, grid, color badges, bottom bar for actions + highlight

      let imgHTML = product.photo
        ? `<img src="${escapeHTML(product.photo)}" class="prod-photo-thumb" alt="Product Photo">`
        : `<span>üì¶</span>`;

      const nameSafe = escapeHTML(product.name || "Unnamed");
      const cat = product.category
        ? `<span class="prod-cat">${escapeHTML(String(product.category)).slice(0,18)}</span>`
        : '';
      const qtyNum = Number(product.qty) || 0;
      const mrpNum = Number(product.mrp) || 0;
      const costNum = (product.cost !== undefined && product.cost !== null) ? Number(product.cost) : null;

      // Multi-select checkbox
      let checkboxHTML = `<input type="checkbox" class="prod-select-checkbox" title="Select" data-id="${product.id}" tabindex="0" ${selectedProductIds.has(product.id) ? "checked" : ""}/>`;

      // Product note preview
      const noteHtml = product.notes
        ? `<div class="prod-note">${escapeHTML(String(product.notes)).slice(0,72)}</div>`
        : "";

      li.innerHTML = `
        <div class="prod-card-top">
          ${checkboxHTML}
          <div class="prod-img">${imgHTML}</div>
          <div class="prod-main-details">
            <div class="prod-name">${nameSafe}${cat}</div>
            <div class="prod-details">
              <span class="prod-stock">Stock: <b>${qtyNum}</b></span>
              <span class="prod-mrp">‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span>
              ${costNum !== null ? `<span class="prod-cost">(Cost: ‚Ç®${costNum.toLocaleString(undefined,{maximumFractionDigits:2})})</span>` : ""}
            </div>
            ${noteHtml}
          </div>
        </div>
        <div class="prod-card-bottom">
          <span></span>
          <div class="prod-actions">
            <button type="button" title="Edit" class="edit" data-id="${product.id}">‚úèÔ∏è</button>
          </div>
        </div>
      `;

      if (selectedProductIds.has(product.id)) li.classList.add('selected');

      // Checkbox event
      const checkbox = li.querySelector('.prod-select-checkbox');
      if (checkbox) {
        checkbox.addEventListener('change', (e) => {
          handleCheckboxChange(product.id, checkbox.checked);
        });
        checkbox.addEventListener('click', (e)=>e.stopPropagation());
        checkbox.addEventListener('keydown', (e)=>e.stopPropagation());
      }

      // Edit event
      const editBtn = li.querySelector('.edit');
      if (editBtn) editBtn.onclick = (e)=>{ e.stopPropagation(); showProductModal('edit', product); };

      li.addEventListener('click', function(e){
        if(e.target.classList.contains('prod-select-checkbox')) return;
        if(!e.target.closest('.prod-actions')) showDetailModal(product);
      });
      li.addEventListener('keydown', function(e){
        if((e.key==="Enter"||e.key===" ") && !e.target.closest('.prod-actions')) { e.preventDefault(); showDetailModal(product); }
      });
      return li;
    }

    // ... the rest is unchanged ...
  </script>
</body>
</html>
