<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Local Dealer App</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#161B22" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg1: #0C1220;
      --bg2: #161B22;
      --bg3: #212936;
      --accent: #2563EB;
      --accent-hover: #164eab;
      --accent2: #06B6D4;
      --accent2-hover: #1095b7;
      --gray: #AEB9C7;
      --text: #F3F7FF;
      --text-muted: #B0B9C6;
      --radius: 16px;
      --radius-card: 13px;
      --shadow: 0 8px 32px 0 rgba(60,120,220,0.17);
      --shadow-soft: 0 2px 8px rgba(40,98,180,.11);
      --danger: #ef4444;
      --success: #10b981;
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      font-size: 17px;
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
      color: var(--text);
      min-height: 100vh;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 34px 12px 54px 12px;
      box-sizing: border-box;
      width: 100%;
    }
    header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 10px;
    }
    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .app-logo {
      width: 50px;
      height: 50px;
      border-radius: 18px;
      background: linear-gradient(135deg, var(--accent), var(--accent2) 75%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.11rem;
      box-shadow: var(--shadow-soft);
      color: #fff;
      font-weight: 700;
    }
    .app-title {
      font-weight: 900;
      font-size: 1.7rem;
      line-height: 1.13;
      letter-spacing: -1px;
      color: var(--text);
      margin-left: 2px;
    }
    #installPromptBtn {
      display: none;
      margin-left: 12px;
      font-size: .99em;
      padding: 8px 17px;
      border-radius: 8px;
      background: linear-gradient(91deg, var(--accent2), var(--accent));
      color: #fff;
      font-weight: 700;
      border: none;
      cursor: pointer;
      box-shadow: 0 1px 11px #2e5fad23;
      transition: background .17s;
    }
    #installPromptBtn:active, #installPromptBtn:hover {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }
    #installAsAppBtn {
      display: none;
      margin-left: 12px;
      font-size: .99em;
      padding: 8px 17px;
      border-radius: 8px;
      background: linear-gradient(91deg, var(--accent2), var(--accent));
      color: #fff;
      font-weight: 700;
      border: none;
      cursor: pointer;
      box-shadow: 0 1px 11px #2e5fad23;
      transition: background .17s;
    }
    #installAsAppBtn:active, #installAsAppBtn:hover {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }
    #mobileInstallInstructions {
      display: none;
      margin-left: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #1a2233;
      color: var(--accent2);
      font-size: .93em;
      font-style: italic;
      box-shadow: 0 2px 8px #222c3d22;
      max-width: 310px;
      line-height: 1.45;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 0;
      align-items: stretch;
      justify-content: flex-start;
      width: 100%;
    }
    /* ---- Card UI ---- */
    .card {
      background: var(--bg2);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      margin-bottom: 32px;
      padding: 1.6rem 1.6rem 1.3rem 1.6rem;
      animation: fadeUp 0.7s cubic-bezier(.43,.8,.52,1.18);
      opacity: 0;
      transform: translateY(36px);
      animation-fill-mode: forwards;
      border: none;
      transition: box-shadow 0.15s, background 0.16s;
    }
    .card.show { opacity: 1; transform: translateY(0);}
    .card:focus-within, .card:hover {
      box-shadow: 0 4px 30px #348ee966,0 2px 6px #18346009;
      background: #232d3d;
    }
    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(45px);}
      65% { opacity: .6;}
      100% {opacity: 1; transform: translateY(0);}
    }

    /* ---- Search Bar and Actions UI ---- */
    .products-top-actions {
      display: flex;
      align-items: flex-end;
      gap: 11px;
      margin-bottom: 17px;
      flex-wrap: wrap;
    }
    .product-search-wrap {
      position: relative;
      flex: 1 1 192px;
      max-width: 370px;
      margin-bottom: 0;
    }
    #productSearch {
      width: 100%;
      border-radius: 8px;
      border: none;
      background: var(--bg3);
      color: var(--text);
      font-size: 1.06em;
      padding: 9px 38px 9px 15px;
      outline: none;
      box-shadow: 0 1.5px 6px #35455a23;
      transition: border 0.13s, box-shadow .13s;
      border: 1.5px solid #23314a;
      margin: 0;
    }
    #productSearch:focus {border-color: var(--accent);}
    .search-icon {
      position: absolute;
      right: 13px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent2);
      font-size: 1.15em;
      opacity: 0.7;
      pointer-events: none;
    }
    .products-top-actions button {
      border: none;
      border-radius: 8px;
      font-size: .99em;
      color: #fff !important;
      font-weight: 700;
      padding: 10px 20px;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      box-shadow: 0 2px 8px #28478718;
      cursor: pointer;
      margin: 0 2px;
      transition: background .17s;
      outline: none;
    }
    .products-top-actions button:active, .products-top-actions button:focus, .products-top-actions button:hover {
      background: linear-gradient(92deg, var(--accent), var(--accent2));
    }

    /* --- Product List --- */
    .product-list {
      margin: 0; padding: 0; list-style: none;
    }
    .prod-card {
      background: var(--bg3);
      border-radius: 13px;
      margin-bottom: 16px;
      box-shadow: 0 2px 10px #2c345128;
      display: flex;
      gap: 19px;
      align-items: center;
      padding: 18px 20px;
      position: relative;
      animation: fadeUp .35s cubic-bezier(.43,.8,.52,1.18);
      opacity: 0; transform: translateY(25px);
      animation-fill-mode: forwards;
      cursor: pointer;
      border: 2px solid transparent;
      transition: box-shadow 0.14s, border-color 0.16s;
    }
    .prod-card.show {opacity: 1;transform: none;}
    .prod-card:focus, .prod-card:hover { border-color: var(--accent2); box-shadow: 0 6px 24px #18346023;}

    .prod-img {
      min-width: 43px;
      width: 43px;
      height: 43px;
      border-radius: 10px;
      background: #21293f;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent2);
      font-size: 1.45em;
      overflow: hidden;
    }
    .prod-photo-thumb {
      max-width: 100%;
      max-height: 43px;
      border-radius: 8px;
      object-fit: cover;
      background: #232b36;
      display: block;
    }
    .prod-main-details {
      flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px;
    }
    .prod-name {
      font-weight: 700;
      font-size: 1.15em;
      color: var(--text);
      letter-spacing: -0.5px;
      margin-bottom: 1.5px;
    }
    .prod-cat {
      border-radius: 7px;
      padding: 2px 10px 2px 9px;
      font-size: .93em;
      background: #183881;
      color: var(--accent2);
      margin-left: 7px;
    }
    .prod-details {
      color: var(--gray);
      font-size: .97em;
      margin-top: 2px;
      margin-bottom: 2px;
      font-family: 'Inter', Arial, sans-serif;
    }
    .prod-actions {
      margin-left: auto;
      display: flex;
      gap: 7px;
      align-items: center;
      flex-wrap: wrap;
    }
    .prod-actions button {
      background: none;
      border: none;
      color: var(--accent2);
      font-size: 1.32em;
      cursor: pointer;
      transition: color 0.13s;
      border-radius: 5px;
      padding: 3px 5px;
      outline: none;
    }
    .prod-actions button.edit:hover, .prod-actions button.edit:focus { color: var(--accent);}
    .prod-actions button.delete:hover, .prod-actions button.delete:focus { color: var(--danger);}
    .prod-actions button:active {transform: scale(.95);}
    .no-products {
      text-align: center;
      color: var(--text-muted);
      font-size: 1.12em;
      margin: 34px 0 14px 0;
      letter-spacing: .01em;
    }
    /* Modal general and detail view modal */
    .modal-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(18, 23, 32, 0.92);
      z-index: 4999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      visibility: visible;
      transition: opacity .21s;
    }
    .modal-backdrop.hide { opacity: 0; visibility: hidden; pointer-events: none;}
    .modal {
      min-width: 320px;
      max-width: 98vw;
      background: var(--bg2);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow);
      z-index: 6000;
      padding: 36px 22px 23px 22px;
      animation: fadeUp .4s;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: relative;
    }
    .modal h3 {
      margin: 0 0 18px 0;
      color: var(--accent2);
      text-align: center;
      font-weight: 800;
      font-size: 1.26em;
      letter-spacing: -.2px;
    }
    .modal-close {
      position: absolute;
      top: 13px; right: 14px;
      background: none; border: none;
      color: var(--accent2);
      font-size: 1.24em;
      cursor: pointer;
      font-weight: bold;
      outline: none;
    }
    .modal label {
      font-weight: 600;
      font-size: .96em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .modal input[type=text],
    .modal input[type=number],
    .modal input[type=file],
    .modal textarea {
      border-radius: 7px;
      border: 1.5px solid #253048;
      background: var(--bg3);
      color: var(--text);
      font-size: 1em;
      padding: 8px 11px;
      margin-bottom: 13px;
      margin-top: 2px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      transition: border 0.13s;
    }
    .modal input:focus, .modal textarea:focus { border-color: var(--accent);}
    .modal textarea {
      min-height: 54px;
      resize: vertical;
    }
    .modal input[type=file] {
      border: none;
      background: none;
      padding: 0;
    }
    .modal-btnbar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 13px;
      margin-top: 6px;
    }
    .modal button[type=submit] {
      background: linear-gradient(95deg, var(--accent2), var(--accent));
      color: #fff;
      padding: 11px 22px 10px 22px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 10px #1b314e28;
      margin: 6px 0;
      transition: background .14s;
      outline: none;
    }
    .modal button[type=submit]:active,.modal button[type=submit]:focus {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }
    .modal .error {
      font-size: .98em;
      color: var(--danger);
      margin-bottom: 7px;
      min-height: 18px;
      text-align: left;
    }
    /* Product Detail Modal UI */
    #detailModal .prod-detail-photo {
      display: block;
      width: 124px;
      height: 124px;
      object-fit: cover;
      border-radius: 19px;
      margin: 6px auto 0 auto;
      box-shadow: 0 2px 12px #1b314e22;
      background: #21293f;
    }
    #detailModal .prod-detail-info-list {
      list-style: none;
      padding: 0;
      margin: 0 0 0 0;
      display: flex;
      flex-direction: column;
      gap: .57em;
    }
    #detailModal .prod-detail-value {
      color: var(--accent2);
      font-weight: 600;
      font-size: 1.08em;
    }
    #detailModal .prod-detail-notes {
      margin-top: 0.8em;
      font-size: 1em;
      color: var(--text-muted);
      background: #213047;
      border-radius: 8px;
      padding: 0.7em 0.9em;
    }

    /* Responsive */
    @media (max-width: 650px) {
      .container {padding: 14px 1vw 23px 1vw;}
      .card {padding: .8rem 0.4rem 1.05rem 0.75rem;}
      .app-title {font-size: 1.2rem;}
      .prod-card {padding: 12px 7px;}
      #detailModal .prod-detail-photo { width: 74px; height: 74px; }
      .modal {padding: 14vw 3vw 7vw 3vw; min-width:unset;}
      #mobileInstallInstructions {max-width: 94vw; font-size: 0.96em;}
    }
    ::selection {background: var(--accent2); color: #fff;}
    a {color: var(--accent);}
    /* Hide unused classes from previous design */
    .mockup-col, .phone-mockup { display: none !important; }
    .icon-title, .features-list, .privacy-list, .ux-list, .table-wrap, .screen-app-title, .screen-sub, .screen-product, .screen-product-img, .screen-product-actions, .screen-tiny { display: none !important; }

    /* Hide main app when login is active (resolve login/products overlap) */
    #dealerApp {
      display: none;
    }
    #dealerApp.active {
      display: block;
    }
    #login-modal.hide {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
      transition: opacity 0.21s, visibility 0.21s;
    }
    #login-modal {
      position: fixed;
      inset: 0;
      z-index: 7000;
      background: rgba(22, 27, 34, 0.89);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.2s;
    }
    .login-dialog {
      background: var(--bg2);
      border-radius: 20px;
      box-shadow: 0 8px 40px #22374b55;
      padding: 42px 28px 22px 28px;
      min-width: 310px;
      width: 90vw;
      max-width: 340px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .login-dialog h2 {
      font-weight: 900;
      color: var(--accent2);
      margin-bottom: 17px;
      text-align: center;
      font-size: 1.4em;
    }
    .login-dialog label {
      font-size: 1.01em;
      margin-bottom: 7px;
      color: var(--text-muted);
      font-weight: 600;
    }
    .login-dialog input[type=password] {
      border-radius: 7px;
      border: 1.5px solid #253048;
      background: var(--bg3);
      color: var(--text);
      font-size: 1em;
      padding: 10px 13px;
      margin-bottom: 19px;
      outline: none;
      width: 100%;
      box-sizing: border-box;
      transition: border 0.13s;
    }
    .login-dialog input[type=password]:focus {
      border-color: var(--accent);
    }
    .login-dialog button[type=submit] {
      background: linear-gradient(94deg, var(--accent2), var(--accent));
      color: #fff;
      padding: 11px 2px 10px 2px;
      font-size: 1.02em;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 10px #1b314e28;
      margin-bottom: 7px;
      transition: background .14s;
      outline: none;
    }
    .login-dialog button[type=submit]:active,.login-dialog button[type=submit]:focus {
      background: linear-gradient(92deg, var(--accent), var(--accent2));
    }
    .input-error {
      font-size: .99em;
      color: var(--danger);
      margin-bottom: 7px;
      min-height: 14px;
      text-align: left;
      display: block;
    }
    .login-dialog small {
      color: var(--text-muted);
      font-size: .93em;
      text-align: left;
      margin-top: 1.5em;
    }
    .login-dialog .success {
      font-size: .99em;
      color: var(--success);
      min-height: 14px;
      margin-bottom: 7px;
      text-align: left;
      display: block;
    }
  </style>
</head>
<body>
  <div id="login-modal">
    <form class="login-dialog" id="loginForm" autocomplete="off" novalidate>
      <h2>üîê Dealer Login</h2>
      <div class="input-error" id="login-error" style="display:block"></div>
      <label id="pinLabel" for="loginPIN">Create a secure PIN/Password:</label>
      <input type="password" id="loginPIN" minlength="4" maxlength="32" required autofocus autocomplete="new-password" placeholder="Enter PIN or password"/>
      <button type="submit" id="loginBtn">Set PIN</button>
      <small>
        Tip: This is stored securely (hashed), and cannot be recovered.<br>
        Stay private ‚Äì the app works 100% offline!
      </small>
    </form>
  </div>

  <div id="dealerApp" class="">
    <div class="container">
      <header>
        <div class="logo-wrap">
          <div class="app-logo" title="Local Dealer App">üè∑Ô∏è</div>
          <span class="app-title">Local Dealer App</span>
        </div>
        <button id="installPromptBtn" title="Install as App">üì≤ Install App</button>
        <button id="installAsAppBtn" title="Force Install App">üõ†Ô∏è Install as App</button>
        <span id="mobileInstallInstructions"></span>
      </header>
      <div class="main-content">
        <section class="card" style="animation-delay:.06s">
          <div class="products-top-actions">
            <div class="product-search-wrap">
              <input type="search" placeholder="üîç Search by name, category, or note..." id="productSearch" autocomplete="off" />
              <span class="search-icon">&#128269;</span>
            </div>
            <button type="button" id="addProductBtn">+ Add</button>
            <button type="button" id="exportBtn">Export</button>
            <button type="button" id="importBtn">Import</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
          <ul class="product-list" id="productList"></ul>
          <div class="no-products" id="noProducts" style="display:none">No products yet. Click <b>+ Add</b> to get started!</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <div class="modal-backdrop hide" id="productModalBackdrop">
    <form class="modal" id="productModal" autocomplete="off">
      <button class="modal-close" type="button" id="closeModalBtn" title="Close">‚úñ</button>
      <h3 id="modalTitle">Add Product</h3>
      <div class="error" id="modalError"></div>
      <label for="prodName">Name</label>
      <input type="text" id="prodName" required maxlength="64" />
      <label for="prodMrp">MRP (‚Çπ)</label>
      <input type="number" id="prodMrp" min="0" max="100000" step="0.01" required />
      <label for="prodCost">Cost Price (‚Çπ)</label>
      <input type="number" id="prodCost" min="0" max="100000" step="0.01"/>
      <label for="prodQty">Quantity</label>
      <input type="number" id="prodQty" min="0" max="100000" required />
      <label for="prodCategory">Category</label>
      <input type="text" id="prodCategory" maxlength="32" />
      <label for="prodNotes">Notes</label>
      <textarea id="prodNotes" maxlength="120" placeholder=""></textarea>
      <label for="prodPhoto">Photo</label>
      <input type="file" id="prodPhoto" accept="image/*" />
      <div class="modal-btnbar">
        <button type="submit" id="saveProductBtn">Save</button>
      </div>
    </form>
  </div>
  <!-- Delete confirmation modal -->
  <div class="modal-backdrop hide" id="deleteModalBackdrop">
    <form class="modal" id="deleteModal">
      <button class="modal-close" type="button" id="closeDeleteBtn" title="Close">‚úñ</button>
      <h3>Delete Product</h3>
      <div style="margin:11px 0 17px 0">Are you sure you want to delete <b id="deleteName"></b>?</div>
      <div class="modal-btnbar">
        <button type="button" id="cancelDeleteBtn">Cancel</button>
        <button type="submit" style="background:var(--danger)">Yes, Delete</button>
      </div>
    </form>
  </div>
  <!-- Product Detail Modal -->
  <div class="modal-backdrop hide" id="detailModalBackdrop">
    <div class="modal" id="detailModal" tabindex="-1">
      <button class="modal-close" type="button" id="closeDetailModalBtn" title="Close">‚úñ</button>
      <h3>Product Details</h3>
      <div id="detailModalBody"></div>
    </div>
  </div>

  <input type="file" id="hiddenImport" accept="application/json" style="display:none">
  <script>
    // --- FADES ON LOAD (cards and product cards) ---
    window.addEventListener('DOMContentLoaded', function(){
      setTimeout(function() {
        document.querySelectorAll(".card").forEach((el,i)=> {
          setTimeout(()=>{ el.classList.add('show') }, 160+60*i);
        });
      }, 180);
    });

    // --- PWA Install Prompt with Explicit "Install as App" Button ---
    let deferredPrompt;
    const installBtn = document.getElementById('installPromptBtn');
    const installAsAppBtn = document.getElementById('installAsAppBtn');
    const mobileInstall = document.getElementById('mobileInstallInstructions');

    // User-Agent test for Android Chrome mobile (loosely)
    function isMobileChromeStandaloneCapable() {
      const ua = navigator.userAgent || '';
      return /Android/.test(ua) && /Chrome\/[.0-9]* Mobile/.test(ua) && !window.matchMedia('(display-mode: standalone)').matches;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
      installAsAppBtn.style.display = 'inline-block';
      mobileInstall.style.display = 'none';
    });

    installBtn && (installBtn.onclick = async function() {
      installBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installBtn.disabled = false;
      }
    });

    installAsAppBtn && (installAsAppBtn.onclick = async function() {
      installAsAppBtn.disabled = true;
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.style.display = 'none';
        installAsAppBtn.style.display = 'none';
        installAsAppBtn.disabled = false;
      } else {
        alert("Install prompt not available at the moment. Try refreshing or using Chrome browser.");
        installAsAppBtn.disabled = false;
      }
    });

    window.addEventListener('appinstalled', ()=>{
      installBtn.style.display='none';
      installAsAppBtn.style.display='none';
      deferredPrompt = null;
      mobileInstall.style.display='none';
    });

    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (!window.matchMedia('(display-mode: standalone)').matches &&
            !window.matchMedia('(display-mode: fullscreen)').matches &&
            isMobileChromeStandaloneCapable()
        ) {
          if ((installBtn.style.display === "none" || getComputedStyle(installBtn).display === "none") &&
              (installAsAppBtn.style.display === "none" || getComputedStyle(installAsAppBtn).display === "none"))
          {
            mobileInstall.innerHTML =
              "To install this app: tap <b><span style='font-size:1.22em;'>‚ãÆ</span></b> at the top right of Chrome, and choose <b>Add to Home screen</b>.";
            mobileInstall.style.display = "inline-block";
          }
        }
      }, 1100);
    });

    // --- Service Worker registration for offline capability (UPDATED for GitHub Pages) ---
    // Register a custom service worker that handles caching of all assets for offline use,
    // especially so it works without internet on Android app install (GitHub Pages).
    if ('serviceWorker' in navigator) {
      // Use a more "offline-friendly" service worker for github pages PWA
      window.addEventListener('load', function() {
        // This inlined version handles the case where sw.js failed to update for GitHub pages, so we ensure
        // "Network falling back to cache" strategy everywhere.
        // We'll only do the registration here; for the worker code, see below.
        navigator.serviceWorker.register('sw.js', {scope: './'}).catch(()=>{});
      });
    }

    // If running from file:// or in case sw.js isn't present, inject a default fallback
    // Instruct: The sw.js MUST support offline for all assets, especially index.html,
    //   even when requests fail (for GitHub pages/PWA needs).
    //   So, inject *a minimal self-registering service worker* if sw.js doesn't respond.
    //   This guarantees offline works after one online visit.

    // Fallback inline service worker injection if sw.js fails to register (for robust offline on gh-pages/apps)
    (async function(){
      if ('serviceWorker' in navigator) {
        try {
          let reg = await navigator.serviceWorker.getRegistration('./');
          if (!reg) {
            // Try to register inline fallback
            const blob = new Blob([`
              const CACHE_NAME = 'dealer-app-cache-v1';
              const OFFLINE_URLS = [
                location.pathname.endsWith('/') ? location.pathname + 'index.html' : location.pathname,
                location.origin + location.pathname,
                './',
                '/index.html',
                location.origin + '/index.html',
                '/',
                self.location.href
              ];
              self.addEventListener('install', event => {
                event.waitUntil(
                  caches.open(CACHE_NAME).then(cache =>
                    cache.addAll(OFFLINE_URLS)
                  ).then(()=>self.skipWaiting())
                );
              });
              self.addEventListener('activate', event => {
                event.waitUntil(self.clients.claim());
              });
              self.addEventListener('fetch', event => {
                event.respondWith(
                  caches.match(event.request, {ignoreSearch:true}).then(response => {
                    return response || fetch(event.request).then(networkResponse => {
                      // Cache new requests as well (for offline after one visit)
                      return caches.open(CACHE_NAME).then(cache => {
                        cache.put(event.request, networkResponse.clone());
                        return networkResponse;
                      });
                    }).catch(()=>{
                      // fallback to index.html for navigation requests (SPA experience)
                      if(event.request.mode==='navigate'){
                        return caches.match('/index.html').then(r=>r||caches.match('index.html'));
                      }
                    });
                  })
                );
              });
            `], {type: 'application/javascript'});
            const url = URL.createObjectURL(blob);
            await navigator.serviceWorker.register(url);
            setTimeout(()=>{URL.revokeObjectURL(url)}, 3000);
          }
        } catch(e) { /* ignore - at least we tried */ }
      }
    })();
    // === end service worker code for offline ===

    // === Secure PIN logic ===
    async function hashPIN(pin) {
      let salt = window.localStorage.getItem('dealer-app-salt');
      if (!salt) {
        const arr = new Uint8Array(16);
        window.crypto.getRandomValues(arr);
        salt = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        window.localStorage.setItem('dealer-app-salt', salt);
      }
      const encoder = new TextEncoder();
      const baseKey = await window.crypto.subtle.importKey(
        'raw',
        encoder.encode(pin),
        'PBKDF2',
        false, ['deriveBits']
      );
      let rawBits;
      try {
        rawBits = await window.crypto.subtle.deriveBits(
          { name: "PBKDF2", salt: encoder.encode(salt), iterations: 3000, hash: "SHA-256" },
          baseKey,
          256
        );
      } catch (e) {
        const data = encoder.encode(pin + salt);
        const arrBuf = await window.crypto.subtle.digest('SHA-256', data);
        rawBits = arrBuf;
      }
      const hashArr = new Uint8Array(rawBits);
      return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
    }
    // Login / PIN logic
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('loginForm');
    const loginPIN = document.getElementById('loginPIN');
    const loginError = document.getElementById('login-error');
    const loginBtn = document.getElementById('loginBtn');
    const pinLabel = document.getElementById('pinLabel');
    function updatePINUI(hasPIN) {
      if (hasPIN) {
        loginBtn.textContent = "Unlock";
        pinLabel.textContent = "Enter your PIN/Password:";
        loginPIN.value = "";
        loginPIN.placeholder = "Enter PIN or password";
        loginPIN.autocomplete = "current-password";
      } else {
        loginBtn.textContent = "Set PIN";
        pinLabel.textContent = "Create a secure PIN/Password:";
        loginPIN.value = "";
        loginPIN.placeholder = "Set PIN or password";
        loginPIN.autocomplete = "new-password";
      }
      loginError.textContent = '';
      loginError.className = "input-error";
      loginError.style.display = "block";
    }
    function getHasPIN() { return !!window.localStorage.getItem('dealer-hash'); }
    updatePINUI(getHasPIN());

    // Control the visibility of the dealerApp and login modal
    function showDealerApp() {
      document.getElementById('dealerApp').classList.add('active');
      loginModal.classList.add('hide');
      setTimeout(()=>{loginModal.style.display='none'},260);
    }
    function hideDealerApp() {
      document.getElementById('dealerApp').classList.remove('active');
      loginModal.classList.remove('hide');
      loginModal.style.display = 'flex';
      loginError.style.display = "block";
    }

    // Show login modal at startup as needed
    document.addEventListener('DOMContentLoaded', ()=>{
      if (getHasPIN()) {
        hideDealerApp();
      } else {
        showDealerApp();   // No PIN set, go direct to app
      }
      loginError.style.display = "block";
    });

    // Modified login form logic to fix the error (don't hide login on set PIN, only on correct login)
    loginForm.onsubmit = async function(e) {
      e.preventDefault();
      loginError.textContent = '';
      loginError.className = "input-error";
      loginError.style.display = "block";
      const pinVal = loginPIN.value.trim();
      let hasPIN = getHasPIN();
      if (!pinVal || pinVal.length < 4) {
        loginError.textContent = hasPIN ? "Enter your PIN/Password." : "PIN/password must be at least 4 characters.";
        loginError.className = "input-error";
        loginError.style.display = "block";
        return;
      }
      loginBtn.disabled = true;
      const hash = await hashPIN(pinVal);
      if (!hasPIN) {
        // Only set pin, stay on login modal -- do NOT enter dashboard yet.
        window.localStorage.setItem('dealer-hash', hash);
        updatePINUI(true);
        loginError.className = "success";
        loginError.textContent = "PIN set! Please login.";
        loginError.style.display = "block";
        loginBtn.disabled = false;
        loginPIN.value = "";
        // Do not advance to dashboard, stay in login modal until user submits again with new PIN
        setTimeout(()=>{
          loginError.textContent = '';
          loginError.className = "input-error";
          loginError.style.display = "block";
        }, 1200);
        return;
      }
      const userHash = window.localStorage.getItem('dealer-hash');
      if (userHash === hash) {
        // Only after correct PIN, show dashboard and hide login
        showDealerApp();
        setTimeout(refreshProductList, 340);
      } else {
        loginError.textContent = "Incorrect PIN/Password.";
        loginError.className = "input-error";
        loginError.style.display = "block";
        loginBtn.disabled = false;
      }
    };

    // Products store
    const productListElem = document.getElementById('productList');
    const noProductsElem = document.getElementById('noProducts');
    let products = [];

    function saveProducts() {
      window.localStorage.setItem('dealer-products', JSON.stringify(products));
      refreshProductList();
    }
    function loadProducts() {
      products = [];
      try {
        const str = window.localStorage.getItem('dealer-products');
        if (str) {
          products = JSON.parse(str);
        }
      } catch {}
    }
    function escapeHTML(v) {
      if (typeof v !== "string") return "";
      return v.replace(/[&<>'"]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;',"'" :'&#39;','"':'&quot;'
      }[c]));
    }

    // --- Product Card and Detail Modal ---
    function createProductCard(product, idx) {
      const li = document.createElement('li');
      li.className = 'prod-card';
      li.setAttribute('tabindex', '0');
      setTimeout(()=>li.classList.add('show'), 121 + idx*64);
      let imgHTML = product.photo ? `<img src="${product.photo}" class="prod-photo-thumb" alt="Product Photo">`
        : `<span>üì¶</span>`;
      li.innerHTML = `
        <div class="prod-img">${imgHTML}</div>
        <div class="prod-main-details">
          <div class="prod-name">${escapeHTML(product.name)}${product.category ? `<span class="prod-cat">${escapeHTML(product.category).slice(0,18)}</span>` : ''}</div>
          <div class="prod-details">Stock: <b style="color:var(--success);font-weight:600">${product.qty}</b> ‚Ä¢ ‚Çπ${Number(product.mrp).toLocaleString(undefined, {maximumFractionDigits:2})}${product.cost?`<span style="color:var(--text-muted);font-size:.928em;"> (Cost: ‚Çπ${Number(product.cost).toLocaleString(undefined, {maximumFractionDigits:2})})</span>`:""}</div>
          ${product.notes ? `<div class="prod-details">${escapeHTML(product.notes).slice(0,55)}</div>` : ""}
        </div>
        <div class="prod-actions">
          <button type="button" title="Edit" class="edit" data-id="${product.id}">‚úèÔ∏è</button>
          <button type="button" title="Delete" class="delete" data-id="${product.id}">üóëÔ∏è</button>
        </div>
      `;
      li.querySelector('.edit').onclick = (e) => { e.stopPropagation(); showProductModal('edit', product);};
      li.querySelector('.delete').onclick = (e) => { e.stopPropagation(); showDeleteModal(product);};
      li.addEventListener('click', function(e){
        if(!e.target.closest('.prod-actions')) showDetailModal(product);
      });
      li.addEventListener('keydown', function(e){
        if((e.key === "Enter" || e.key === " ") && !e.target.closest('.prod-actions')) {
          e.preventDefault(); showDetailModal(product);
        }
      });
      return li;
    }

    // --- Product Detail Modal ---
    const detailModalBackdrop = document.getElementById('detailModalBackdrop');
    const detailModal = document.getElementById('detailModal');
    const detailModalBody = document.getElementById('detailModalBody');
    function showDetailModal(product) {
      detailModalBody.innerHTML = `
        <div style="text-align:center;">
          ${product.photo?`<img src="${escapeHTML(product.photo)}" class="prod-detail-photo" alt="${escapeHTML(product.name)}"/>`:`<div class="prod-detail-photo" style="font-size:60px;padding:22px 0 12px 0;">üì¶</div>`}
        </div>
        <ul class="prod-detail-info-list">
          <li><b>Name:</b> <span class="prod-detail-value">${escapeHTML(product.name)}</span></li>
          ${product.category?`<li><b>Category:</b> <span class="prod-detail-value">${escapeHTML(product.category)}</span></li>`:""}
          <li><b>Stock:</b> <span class="prod-detail-value">${product.qty}</span></li>
          <li><b>MRP:</b> <span class="prod-detail-value">‚Çπ${Number(product.mrp).toLocaleString(undefined, {maximumFractionDigits:2})}</span></li>
          ${product.cost?`<li><b>Cost:</b> <span class="prod-detail-value">‚Çπ${Number(product.cost).toLocaleString(undefined, {maximumFractionDigits:2})}</span></li>`:""}
        </ul>
        ${product.notes?`<div class="prod-detail-notes">${escapeHTML(product.notes)}</div>`:""}
      `;
      detailModalBackdrop.classList.remove('hide');
      setTimeout(()=>detailModal.focus(),100);
    }
    document.getElementById('closeDetailModalBtn').onclick = function() {
      detailModalBackdrop.classList.add('hide');
      setTimeout(()=>{detailModalBody.innerHTML="";},250);
    };

    document.addEventListener('keydown', function(e) {
      if(e.key === "Escape") {
        if(!detailModalBackdrop.classList.contains('hide')) {
          detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML='';
        }
        if(!productModalBackdrop.classList.contains('hide')) productModalBackdrop.classList.add('hide');
        if(!deleteModalBackdrop.classList.contains('hide')) deleteModalBackdrop.classList.add('hide');
      }
    });

    const searchInput = document.getElementById('productSearch');
    let lastSearchVal = "";
    searchInput.addEventListener('input', function() {
      refreshProductList();
    });
    searchInput.addEventListener('keydown', function(e){
      if(e.key==='Escape') { searchInput.value=''; refreshProductList();}
    });

    function refreshProductList() {
      loadProducts();
      productListElem.innerHTML = '';
      let q = searchInput.value.trim().toLowerCase();
      let filtered = !q
        ? products 
        : products.filter(prod =>
            (prod.name||"").toLowerCase().includes(q) ||
            (prod.category||"").toLowerCase().includes(q) ||
            (prod.notes||"").toLowerCase().includes(q)
          );
      if (!filtered.length) {
        noProductsElem.style.display = "";
        return;
      }
      noProductsElem.style.display = "none";
      filtered.sort((a, b) => (b.qty - a.qty) || a.name.localeCompare(b.name));
      filtered.forEach((prod,i) => {
        productListElem.appendChild(createProductCard(prod,i));
      });
    }

    // --- Add/Edit Product Modal ---
    let productEditing = null;
    const productModalBackdrop = document.getElementById('productModalBackdrop');
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modalError');
    function showProductModal(mode, product) {
      productModal.reset();
      modalError.textContent = '';
      if (mode==='add') {
        modalTitle.textContent = "Add Product";
        productEditing = null;
        productModal.prodName.value = "";
        productModal.prodMrp.value = "";
        productModal.prodCost.value = "";
        productModal.prodQty.value = "";
        productModal.prodCategory.value = "";
        productModal.prodNotes.value = "";
        productModal.prodPhoto.value = "";
      } else {
        modalTitle.textContent = "Edit Product";
        productEditing = product;
        productModal.prodName.value = product.name;
        productModal.prodMrp.value = product.mrp;
        productModal.prodCost.value = product.cost||"";
        productModal.prodQty.value = product.qty;
        productModal.prodCategory.value = product.category||"";
        productModal.prodNotes.value = product.notes||"";
        productModal.prodPhoto.value = "";
      }
      productModalBackdrop.classList.remove('hide');
      setTimeout(()=>{productModal.prodName.focus()},150);
    }
    document.getElementById('addProductBtn').onclick = ()=>showProductModal('add');
    document.getElementById('closeModalBtn').onclick = ()=>productModalBackdrop.classList.add('hide');

    productModal.onsubmit = async function(e) {
      e.preventDefault();
      modalError.textContent = "";
      let name = productModal.prodName.value.trim();
      let mrp = productModal.prodMrp.value.trim();
      let cost = productModal.prodCost.value.trim();
      let qty = Number(productModal.prodQty.value.trim());
      let category = productModal.prodCategory.value.trim();
      let notes = productModal.prodNotes.value.trim();
      let photo = null;
      if (!name) {modalError.textContent="Name required."; return;}
      if (!mrp || isNaN(mrp) || Number(mrp) < 0) {modalError.textContent="MRP required."; return;}
      if (qty<0 || isNaN(qty)) {modalError.textContent="Quantity required."; return;}
      let fileInput = productModal.prodPhoto;
      if (fileInput && fileInput.files && fileInput.files[0]) {
        photo = await readFileAsDataURL(fileInput.files[0]);
      } else if (productEditing && productEditing.photo) {
        photo = productEditing.photo;
      }
      if (!productEditing) {
        products.push({
          id: genID(),
          name, mrp, cost, qty, category, notes, photo
        });
      } else {
        Object.assign(productEditing, {name, mrp, cost, qty, category, notes, photo});
      }
      saveProducts();
      productModalBackdrop.classList.add('hide');
    };
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e=>resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // --- Delete modal logic ---
    const deleteModalBackdrop = document.getElementById('deleteModalBackdrop');
    const deleteModal = document.getElementById('deleteModal');
    const deleteName = document.getElementById('deleteName');
    let productToDelete = null;
    function showDeleteModal(product) {
      deleteModalBackdrop.classList.remove('hide');
      deleteName.textContent = product.name;
      productToDelete = product;
      setTimeout(()=>document.getElementById('cancelDeleteBtn').focus(),60);
    }
    document.getElementById('closeDeleteBtn').onclick =
    document.getElementById('cancelDeleteBtn').onclick = () => {
      deleteModalBackdrop.classList.add('hide');
      productToDelete = null;
    };
    deleteModal.onsubmit = function(e) {
      e.preventDefault();
      if (!productToDelete) return;
      products = products.filter(p=>p.id!==productToDelete.id);
      saveProducts();
      deleteModalBackdrop.classList.add('hide');
      productToDelete = null;
    };
    function genID() {
      return 'p'+(Date.now()+(''+Math.random()).slice(2, 7));
    }

    document.getElementById('exportBtn').onclick = function() {
      const dataStr = JSON.stringify(products, null, 2);
      const blob = new Blob([dataStr], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'dealer-products-backup.json';
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      setTimeout(()=>{document.body.removeChild(a)},200);
    };
    document.getElementById('importBtn').onclick = ()=>document.getElementById('importFile').click();
    document.getElementById('importFile').onchange = function(evt) {
      let file = evt.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(e){
        try {
          let arr = JSON.parse(e.target.result);
          if (Array.isArray(arr)) {
            arr.forEach(prod=>{
              if (!prod.id) prod.id = genID();
            });
            products = arr;
            saveProducts();
          } else throw new Error();
        } catch{ alert("Invalid file"); }
      };
      reader.readAsText(file);
      evt.target.value = '';
    };
  </script>
</body>
</html>
