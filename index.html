<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Al Rehman Electronics</title>
  <meta name="theme-color" content="#161B22" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  
  <link rel="icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">
  <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true">

<style>
    :root {
      --bg1: #0C1220;
      --bg2: #161B22;
      --bg3: #212936;
      --accent: #2563EB;
      --accent-hover: #164eab;
      --accent2: #06B6D4;
      --accent2-hover: #1095b7;
      --gray: #AEB9C7;
      --text: #F3F7FF;
      --text-muted: #B0B9C6;
      --radius: 16px;
      --radius-card: 13px;
      --shadow: 0 8px 32px 0 rgba(60,120,220,0.17);
      --shadow-soft: 0 2px 8px rgba(40,98,180,.11);
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --rounded-btn: 10px;
      --button-skyblue: #06B6D4;
      --button-gradient: linear-gradient(90deg, #06B6D4 40%, #2563EB 100%);
      --sell-mode-color: #f59e0b; 
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      font-size: 17px;
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
      color: var(--text);
      min-height: 100vh;
    overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
    }
    body { display:flex; flex-direction:column; min-height:100vh; }
    .container { max-width:640px; margin:0 auto; padding:34px 12px 54px; width:100%; box-sizing:border-box; }
    header { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:20px; gap:10px; }
    .logo-wrap { display:flex; align-items:center; gap:14px; }
    .app-logo { width:50px; height:50px; border-radius:18px; background:linear-gradient(135deg,var(--accent),var(--accent2)75%); display:flex; align-items:center; justify-content:center; font-size:2.11rem; box-shadow:var(--shadow-soft); color:#fff; font-weight:700; overflow: hidden; }
    .app-title { font-weight:900; font-size:1.7rem; line-height:1.13; letter-spacing:-1px; color:var(--text); margin-left:2px; }
    .top-controls { display:flex; align-items:center; gap:10px; }
    button.icon-btn { background:none; border:none; color:var(--accent2); font-size:1.23rem; padding:8px 10px; border-radius:9px; cursor:pointer; outline:none; }
    button#settingsBtn { font-size:1.33rem; color:var(--text); background:#1b2430; padding:8px 11px; border-radius:9px; box-shadow:0 1px 6px #0008; }
    #installPromptBtn, #installAsAppBtn { display:none; margin-left:12px; font-size:.99em; padding:8px 14px; border-radius:8px; background:linear-gradient(91deg,var(--accent2),var(--accent)); color:#fff; font-weight:700; border:none; cursor:pointer; box-shadow:0 1px 11px #2e5fad23; }
    #mobileInstallInstructions { display:none; margin-left:10px; padding:8px 10px; border-radius:8px; background:#1a2233; color:var(--accent2); font-size:.93em; font-style:italic; box-shadow:0 2px 8px #222c3d22; max-width:310px; line-height:1.45; }

    .main-content { display:flex; flex-direction:column; gap:0; align-items:stretch; width:100%; }
    
    .card { background:var(--bg2); border-radius:var(--radius-card); box-shadow:var(--shadow); margin-bottom:32px; padding:1.6rem 1.6rem 1.3rem; animation:fadeUp .5s ease-out; opacity:0; transform:translateY(20px); animation-fill-mode:forwards; border:none; transition:box-shadow .15s, background .16s; }
    .card.show { opacity:1; transform:none; }
    @keyframes fadeUp { 0%{opacity:0;transform:translateY(20px);}100%{opacity:1;transform:translateY(0);} }
    
    .products-top-actions { display:flex; align-items:flex-end; gap:11px; margin-bottom:17px; flex-wrap:wrap; }
    .product-search-wrap { position:relative; flex:1 1 192px; max-width:370px; margin-bottom:0; display:flex; align-items:center; }
    #productSearch { width:100%; border-radius:8px; border:none; background:var(--bg3); color:var(--text); font-size:1.06em; padding:9px 78px 9px 15px; outline:none; box-shadow:0 1.5px 6px #35455a23; transition:border .13s; border:1.5px solid #23314a; }
    #productSearch:focus { border-color:var(--accent); }
    .search-icon { position:absolute; right:42px; top:50%; transform:translateY(-50%); color:var(--accent2); font-size:1.15em; opacity:0.7; pointer-events:none; }
    
    /* Scan Button Style (In Search Bar) */
    .scan-btn-inline {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.3em;
      padding: 4px 6px;
      border-radius: 6px;
      transition: color 0.2s, background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .scan-btn-inline:hover { color: var(--accent2); background: rgba(255,255,255,0.05); }

    /* Scan Button inside Modal Input */
    .input-with-scan { position: relative; display:block; }
    .input-with-scan input { padding-right: 40px !important; width:100%; box-sizing:border-box; }
    .scan-btn-modal {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-60%);
      background: none;
      border: none;
      color: var(--accent2);
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 4px;
      z-index: 10;
    }

    #multiSelectControls {
      display: none;
      gap: 8px;
      margin-top: 6px;
      margin-left: 2px;
      align-items: center;
      flex-wrap: wrap;
    }
    #multiSelectControls.active { display: flex; }
    #deleteSelectedBtn {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 18px;
      font-size: 0.97em;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 1px 7px #ef444433;
      transition: background .14s, box-shadow .13s;
      margin-left: 0;
    }
    #shareSelectedBtn {
      background: #2b3548;
      color: var(--accent2);
      border: 1px solid #364052;
      border-radius: var(--rounded-btn);
      padding: 10px 16px;
      font-size: 0.95em;
      font-weight: 700;
      cursor: pointer;
      margin-left: 0;
    }
    #exportSelectedBtn {
      background: #18313c;
      color: var(--button-skyblue);
      border: 1.5px solid var(--button-skyblue);
      border-radius: var(--rounded-btn);
      padding: 10px 16px;
      font-size: 0.95em;
      font-weight: 700;
      cursor: pointer;
      margin-left: 0;
    }
    #exportSelectedBtn:disabled { background:#333; color:#777; border-color:transparent; cursor:not-allowed;}
    
    #deleteSelectedBtn:disabled, #shareSelectedBtn:disabled { background: #333; color:#777; cursor: not-allowed; border-color:transparent;}
    #selectAllCheckbox { accent-color: var(--accent2); margin-left:4px; margin-right:0; transform: scale(1.1); }

    .product-list { margin:0; padding:0; list-style:none; }

    .rounded-sky-btn {
      background: var(--button-gradient);
      color: #fff;
      border: none;
      border-radius: var(--rounded-btn);
      padding: 10px 20px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1.5px 10px #2eb9f733;
      transition: background .15s, box-shadow .14s, transform .10s;
      outline: none;
      margin: 2px 0;
      letter-spacing: 0.02em;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent; 
      -webkit-user-select: none;
      user-select: none;
      flex-shrink: 0;
    }
    .rounded-sky-btn:hover,
    .rounded-sky-btn:active {
      background: linear-gradient(90deg, #0e9fec, #2563EB 95%);
      box-shadow: 0 3px 16px #43c7fc43;
      transform: translateY(-1.5px) scale(1.03);
    }
    .rounded-sky-btn.cancel {
      background: #18313c;
      color: var(--button-skyblue);
      border: 1.5px solid var(--button-skyblue);
      font-weight: 600;
    }
    .rounded-sky-btn.cancel:hover, .rounded-sky-btn.cancel:active {
      background: #22384a;
      color: #fff;
      border-color: #1095b7;
    }
    
    /* Feature: Quick Sell Mode Active Styling */
    .quick-sell-btn {
        background: #333; 
        color: #fbbf24;
        border: 1.5px solid #fbbf24;
    }
    .quick-sell-btn.active {
        background: linear-gradient(90deg, #f59e0b, #d97706);
        color: #fff;
        border: none;
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
    }
    
    body.quick-sell-active .prod-card {
        cursor: copy; /* Visual cue */
    }
    body.quick-sell-active .prod-card:hover {
        border-color: var(--warning);
    }
    
    /* Feature: History Modal List */
    .history-list {
        max-height: 50vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .history-item {
        background: #1b2430;
        padding: 10px;
        border-radius: 8px;
        border-left: 3px solid var(--success);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
        position: relative; /* Added for delete button */
        padding-right: 40px; /* Space for delete button */
    }
    .history-meta { color: var(--text-muted); font-size: 0.85em; margin-top: 2px; }
    .history-profit { font-size: 0.82em; color: var(--accent2); margin-top: 2px; }
    
    /* NEW: History Delete Button */
    .history-delete-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--danger);
        font-size: 1.4em;
        cursor: pointer;
        padding: 8px;
        z-index: 2;
    }
    .history-delete-btn:hover { color: #ff8888; }
    
    /* Small Button Variant for Uploads */
    .btn-small {
        padding: 8px 12px !important;
        font-size: 0.9em !important;
    }
    
    #biometricUnlockBtn {
      background: linear-gradient(90deg, #10b981 30%, #059669 100%);
      width: 100%;
      margin-top: 10px;
      display: none; 
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    button, .rounded-sky-btn, .prod-actions button, .modal-close, input[type="button"], input[type="submit"], .remove-photo-btn, .scan-btn-inline, .scan-btn-modal, .history-delete-btn {
      -webkit-tap-highlight-color: transparent !important;
      tap-highlight-color: transparent !important;
      outline: none !important;
    }
    button:focus, .rounded-sky-btn:focus, .prod-actions button:focus, .modal-close:focus, .remove-photo-btn:focus, .scan-btn-inline:focus, .scan-btn-modal:focus, .history-delete-btn:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    input[type="button"]:focus, input[type="submit"]:focus { outline:none !important; box-shadow:none !important; }
    .card button:focus-visible, .card button:focus, .prod-actions button:focus, .rounded-sky-btn:focus, .remove-photo-btn:focus {
      outline: none !important;
      box-shadow: none !important;
      border-color: inherit !important;
      background-clip: padding-box;
    }
    .prod-card, .prod-card * {
      -webkit-tap-highlight-color: transparent !important;
      tap-highlight-color: transparent !important;
    }
    button:focus:not(:focus-visible), .rounded-sky-btn:focus:not(:focus-visible), .modal-close:focus:not(:focus-visible), .remove-photo-btn:focus:not(:focus-visible) {
      outline: none !important;
      box-shadow: none !important;
    }

    .modal-file-upload-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 13px;
      margin-top: 2px;
      flex-shrink: 0;
    }
    .modal-file-label {
      font-weight: 600;
      font-size: .96em;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
    }
    .modal-file-upload-btn {
      display: inline-block;
      position: relative;
    }
    .modal-file-upload-btn input[type="file"] {
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    /* Multi-image preview styles */
    .photo-preview-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      min-height: 1em;
      flex-shrink: 0;
    }
    .photo-preview-item {
        position: relative;
        display: inline-block;
    }
    .photo-preview-img-thumb {
      width: 60px;
      height: 60px;
      border-radius: 7px;
      object-fit: cover;
      border: 2px solid var(--accent2-hover);
      background: #273855;
      display: block;
    }
    .remove-photo-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.5);
      z-index: 2;
    }
    .remove-photo-btn:hover { background: #ce3737; }

    .prod-card { 
      background:var(--bg3); 
      border-radius:13px; 
      margin-bottom:16px; 
      box-shadow:0 2px 10px #2c345128; 
      display:flex; 
      gap:19px; 
      align-items:center; 
      padding:18px 20px; 
      position:relative; 
      animation:fadeUp .3s ease-out; 
      opacity:0; 
      transform:translateY(15px); 
      animation-fill-mode:forwards; 
      cursor:pointer; 
      border:2px solid transparent; 
      transition:box-shadow .14s, border-color .16s; 
      content-visibility: auto; 
    }
    .prod-card.show { opacity:1; transform:none; }
    .prod-card:hover { border-color:var(--accent2); box-shadow:0 6px 24px #18346023; }
    
    .prod-img { 
        min-width:43px; width:43px; height:43px; 
        border-radius:10px; background:#21293f; 
        flex-shrink:0; display:flex; align-items:center; justify-content:center; 
        color:var(--accent2); font-size:1.45em; overflow:hidden; 
        cursor: zoom-in;
    }
    .prod-photo-thumb { max-width:100%; max-height:43px; border-radius:8px; object-fit:cover; background:#232b36; display:block; }
    
    .prod-name { font-weight:700; font-size:1.15em; color:var(--text); letter-spacing:-0.5px; margin-bottom:1.5px; }
    .prod-details { color:var(--gray); font-size:.97em; margin-top:2px; margin-bottom:2px; }
    
    /* Low Stock Style */
    .prod-details.low-stock { color: var(--danger); font-weight: 700; }
    
    .prod-actions { margin-left:auto; display:flex; gap:7px; align-items:center; }
    .prod-actions button { background:none; border:none; color:var(--accent2); font-size:1.32em; cursor:pointer; transition:color .13s; border-radius:5px; padding:3px 5px; outline:none; }
    .prod-select-checkbox {
      margin-right: 18px;
      transform: scale(1.25);
      accent-color: var(--accent2);
      cursor:pointer;
    }
    .prod-card.selected { border-color: var(--danger); background: #1b1d2d; box-shadow: 0 4px 16px #ef44441a;}
    .prod-card .prod-select-checkbox:focus { outline: 2px solid var(--accent2); outline-offset:1px;}

    .category-header {
        font-size: 0.95em;
        font-weight: 800;
        color: var(--accent2);
        background: rgba(33, 41, 54, 0.5);
        padding: 8px 12px;
        margin-top: 15px;
        margin-bottom: 12px;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-left: 4px solid var(--accent);
    }
    .category-header:first-child { margin-top: 0; }
    
    #activeCategoryDisplay {
        display: none;
        width: 100%;
        margin-bottom: 12px;
        padding: 8px 12px;
        background: rgba(6, 182, 212, 0.15);
        color: var(--accent2);
        border: 1px dashed var(--accent2);
        border-radius: 10px;
        font-weight: 700;
        text-align: center;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
    }
    #activeCategoryDisplay:hover { background: rgba(6, 182, 212, 0.25); }
    #activeCategoryDisplay.show { display: flex; }
    #activeCategoryDisplay.show { box-sizing: border-box; }
    
    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 50vh;
        overflow-y: auto;
    }
    .category-item-btn {
        background: #253048;
        color: var(--text);
        border: 1px solid #364052;
        padding: 12px;
        border-radius: 10px;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: background 0.15s, transform 0.1s;
    }
    .category-item-btn:hover { background: #303d58; transform: translateY(-2px); border-color: var(--accent2); }
    .category-item-btn.active { background: var(--button-gradient); color: #fff; border-color: transparent; }

    .no-products { text-align:center; color:var(--text-muted); font-size:1.12em; margin:34px 0 14px 0; letter-spacing:.01em; }
    .modal-backdrop { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(18,23,32,0.92); z-index:4999; display:flex; align-items:center; justify-content:center; opacity:1; visibility:visible; transition:opacity .21s; }
    .modal-backdrop.hide { opacity:0; visibility:hidden; pointer-events:none; }
    
    /* MODAL FIX: Added box-sizing: border-box to handle padding correctly */
    .modal { 
        min-width:320px; 
        max-width:98vw; 
        max-height: 90vh; 
        overflow-y: auto; 
        background:var(--bg2); 
        border-radius:var(--radius-card); 
        box-shadow:var(--shadow); 
        z-index:6000; 
        padding:36px 22px 23px 22px; 
        animation:fadeUp .3s; 
        display:flex; 
        flex-direction:column; 
        align-items:stretch; 
        position:relative; 
        box-sizing: border-box; /* IMPORTANT: Includes padding in height calc */
    }
    
    #categoryModal {
        max-width: 650px; 
        width: 92%;
    }
    
    .modal h3 { margin:0 0 18px 0; color:var(--accent2); text-align:center; font-weight:800; font-size:1.26em; letter-spacing:-.2px; }
    .modal-close { position:absolute; top:13px; right:14px; background:none; border:none; color:var(--accent2); font-size:1.24em; cursor:pointer; font-weight:bold; outline:none; }
    .modal label { font-weight:600; font-size:.96em; color:var(--text-muted); margin-bottom:4px; }
    .modal input[type=text], .modal input[type=number], .modal input[type=file], .modal input[type=password], .modal textarea { border-radius:7px; border:1.5px solid #253048; background:var(--bg3); color:var(--text); font-size:1em; padding:8px 11px; margin-bottom:13px; margin-top:2px; outline:none; width:100%; box-sizing:border-box; transition:border .13s; }
    .modal textarea { min-height:54px; resize:vertical; }
    
    /* FIX: Added flex-shrink:0 */
    .modal-btnbar { 
        display:flex; align-items:center; justify-content:flex-end; gap:13px; margin-top:6px; 
        flex-shrink: 0; 
    }
    
    .modal button[type=submit] { background:linear-gradient(95deg,var(--accent2),var(--accent)); color:#fff; padding:11px 22px; font-size:1em; border:none; border-radius:8px; font-weight:700; cursor:pointer; box-shadow:0 2px 10px #1b314e28; margin:6px 0; transition:background .14s; outline:none; }
    .modal .error { font-size:.98em; color:var(--danger); margin-bottom:7px; min-height:18px; text-align:left; }
    
#detailModal {
  max-width: 260px;
  width: 85%;
  padding-top: 30px;
}

/* Updated for multi-image gallery SWIPE */
.detail-gallery {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding-bottom: 10px;
    margin-bottom: 10px;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    
    /* ENABLE SWIPING */
    scroll-snap-type: x mandatory;
    overscroll-behavior-x: contain;
}
.detail-gallery img {
  flex-shrink: 0;
  width: 170px;
  height: 170px;
  object-fit: cover; 
  border-radius: 20px; 
  box-shadow: 0 4px 16px #1b314e33; 
  background: #21293f; 
  cursor: zoom-in;
  
  /* ALIGN ITEMS */
  scroll-snap-align: center;
  scroll-snap-stop: always;
}

/* FIX: CENTER SINGLE IMAGE */
.detail-gallery img:only-child {
  margin: 0 auto;
}

#detailModalBody ul { font-size: 0.78em; }
#detailModalBody ul li { margin-bottom: 6px; }

    .show-password-wrap {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
    }
    #showLoginPINBtn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--accent2);
      cursor: pointer;
      font-size: 1.11em;
      opacity: 0.79;
      padding: 2px 7px;
      border-radius: 8px;
      z-index: 5;
      user-select: none;
      -webkit-tap-highlight-color: transparent !important;
      outline: none !important;
    }
    #showLoginPINBtn:active, #showLoginPINBtn:focus {
      background: #1f2336;
      color: var(--accent2-hover);
      outline: none !important;
      box-shadow: none !important;
    }
    
    .share-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 20px;
    }
    .share-option-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        background: #1e2530;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
    }
    .share-option-row:hover { background: #262f3d; }
    .share-option-row input[type="checkbox"] {
        width: auto;
        margin: 0;
        transform: scale(1.2);
        accent-color: var(--accent2);
        cursor: pointer;
    }

    /* --- FULL SCREEN IMAGE VIEWER (MODIFIED FOR SLIDER) --- */
    #imageViewerOverlay {
        position: fixed;
        inset: 0;
        z-index: 8000;
        background: rgba(0,0,0,0.95);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s ease-out;
    }
    #imageViewerOverlay.show { display: flex; }
    
    /* NEW: Slider Container */
    #imageViewerSlider {
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        width: 100%;
        height: 100%;
        align-items: center;
        /* Hide scrollbar */
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    #imageViewerSlider::-webkit-scrollbar { display: none; }

    /* NEW: Individual Slides */
    .full-screen-slide {
        flex: 0 0 100%;
        width: 100%;
        height: 100%;
        object-fit: contain;
        scroll-snap-align: center;
        scroll-snap-stop: always;
    }
        #imageViewerImg {

        max-width: 95vw;
        max-height: 85vh; 
        object-fit: contain;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);

    }
    #imageViewerClose {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        background: rgba(255,255,255,0.1);
        border: none;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
        z-index: 8001; /* Ensure above slider */
    }
    #imageViewerClose:hover { background: rgba(255,255,255,0.25); }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    /* --- SCANNER OVERLAY & CONFIRMATION UI --- */
    #scannerOverlay {
        position: fixed;
        inset: 0;
        z-index: 9000;
        background: #000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    #scannerOverlay.show { display: flex; }
    
    #scannerVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .scanner-controls {
        position: absolute;
        bottom: 40px;
        left: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 9002;
        align-items: center;
    }
    
    .scanner-btn-row {
        display: flex;
        gap: 15px;
        width: 100%;
        justify-content: center;
    }
    
    #closeScannerBtn, #toggleTorchBtn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.4);
        padding: 12px 24px;
        border-radius: 30px;
        font-weight: bold;
        backdrop-filter: blur(5px);
        font-size: 1em;
        min-width: 100px;
    }
    
    .zoom-control {
        width: 100%;
        max-width: 300px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0,0,0,0.5);
        padding: 8px 15px;
        border-radius: 20px;
        display: none; 
    }
    .zoom-control span { color: white; font-weight: bold; font-size: 0.9em; }
    input[type=range] { flex: 1; accent-color: var(--accent2); cursor: pointer; }

    .scanner-guide {
        position: absolute;
        top: 45%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 75%;
        height: 25%;
        border: 2px solid rgba(6, 182, 212, 0.8);
        border-radius: 12px;
        box-shadow: 0 0 0 4000px rgba(0,0,0,0.6);
        pointer-events: none;
        z-index: 9001;
    }
    
    /* Confirmation Popup inside Scanner */
    #scanConfirmation {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.85);
        z-index: 9010;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    .scan-code-display {
        font-size: 1.2em; /* Made smaller as requested */
        font-weight: 800;
        color: var(--accent2);
        background: #1e2530;
        padding: 15px 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        text-align: center;
        border: 2px solid var(--accent);
        word-break: break-all;
        max-width: 90%;
    }
    .scan-action-btns {
        display: flex;
        gap: 20px;
    }
    .scan-action-btns button {
        min-width: 110px;
        padding: 12px 20px;
        font-size: 1em;
    }

    /* --- PRINTING STYLES (PDF Generation) --- */
    #printableArea {
        display: none;
        background: white;
        color: black;
        font-family: 'Arial', sans-serif;
        padding: 40px;
    }
    @media print {
        body > *:not(#printableArea) {
            display: none !important;
        }
        #printableArea {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            z-index: 9999;
            background: white !important;
            color: black !important;
        }
        .print-product-page {
            page-break-after: always;
            margin-bottom: 50px;
        }
        .print-product-page:last-child {
            page-break-after: auto;
        }
        .print-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .print-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .print-title { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .print-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .print-product-img {
            max-width: 250px;
            max-height: 250px;
            object-fit: contain;
            border: 1px solid #ddd;
        }
        .print-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 18px;
        }
        .print-details-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .print-label { font-weight: bold; width: 40%; }
        .print-notes-box {
            margin-top: 30px;
            padding: 15px;
            border: 1px dashed #aaa;
            background: #f9f9f9;
        }
    }

    body.modal-open {
      overflow: hidden !important;
      position: fixed !important;
      width: 100vw;
    }
    body.detail-modal-open {
      overflow: hidden !important;
    }

    @media (max-width:650px){
      html, body { font-size: 15.5px; }
      .container{padding:10px 2vw 17px 2vw;}
      .card{padding:.54rem .26rem 0.7rem .47rem;}
      .app-title{font-size:1.02rem;}
      
      .prod-card{
        padding: 12px 10px;
        gap: 14px;
        border-radius: 9px;
        margin-bottom: 10px;
        min-height: 64px;
      }
      
      .prod-img{ 
          min-width: 48px; width: 48px; height: 48px; 
          font-size: 1.5em; border-radius: 9px;
      }
      .prod-photo-thumb { max-width:100%; max-height:48px; border-radius:8px; }
      
      .prod-name{ font-size: 1.1em; margin-bottom: 1px;}
      .prod-details{ font-size: 0.92em; margin-top: 2px; margin-bottom: 2px;}
      
      .prod-actions{ gap: 8px; }
      .prod-actions button{font-size: 1.15em; padding: 4px;}
      
      .prod-select-checkbox { margin-right: 12px; transform: scale(1.35); padding: 5px; }
      
      .modal{padding:12vw 2vw 3vw 2vw; min-width:unset;}
      
      /* FIX: FORCE FULL SCREEN ON MOBILE FOR EDIT POPUP - CHANGED 100vh to 100% to prevent overflow */
      #productModal {
          width: 100vw;
          height: 100%; /* FIX: Prevents being taller than screen */
          max-width: 100vw;
          max-height: 100%; /* FIX */
          border-radius: 0;
          padding-top: 75px; 
          padding-bottom: env(safe-area-inset-bottom);
      }
      
      /* FIX: LOWER CLOSE BUTTON ON MOBILE */
      #productModal .modal-close {
          top: 35px; /* Moved down significantly */
          right: 25px; /* Moved left away from edge */
          font-size: 1.4em; 
      }
      
      #detailModal .prod-detail-photo, .detail-gallery img { width: 100%; max-width: 190px; height: 190px;}
      
      #mobileInstallInstructions{max-width:98vw;font-size:0.92em;}
      #multiSelectControls{font-size:0.96em; flex-wrap:wrap;}
    }
    ::selection{background:var(--accent2); color:#fff;}
    a{color:var(--accent);}
    .hidden { display:none !important; }
    
    .keep-logged-toggle {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-top: 8px;
      user-select: none;
      font-size: .99em;
      color: var(--text-muted);
      cursor: pointer;
    }
    .keep-logged-toggle input[type="checkbox"] {
      accent-color: var(--accent2);
      transform: scale(1.13);
      margin-right: 2px;
    }
    #timeoutNotice {
      font-size: .97em;
      color: var(--accent2);
      margin-top: 11px;
      text-align: center;
      display: none;
      font-weight: 600;
      background: #122447;
      padding: 8px 10px;
      border-radius: 10px;
    }
  </style>

</head>
<body>
  <div id="printableArea"></div>

  <div id="imageViewerOverlay">
      <button id="imageViewerClose">‚úñ</button>
      <div id="imageViewerSlider"></div>
  </div>

  <div id="scannerOverlay">
      <video id="scannerVideo" autoplay playsinline muted></video>
      <div class="scanner-guide"></div>
      
      <div class="scanner-controls">
          <div class="zoom-control" id="zoomControl">
              <span>Zoom:</span>
              <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1">
          </div>
          <div class="scanner-btn-row">
              <button id="toggleTorchBtn" style="display:none;">üî¶ Torch</button>
              <button id="closeScannerBtn">Cancel</button>
          </div>
      </div>

      <div id="scanConfirmation">
          <div class="scan-code-display" id="scannedCodeDisplay"></div>
          <div class="scan-action-btns">
              <button id="scanRetryBtn" class="rounded-sky-btn cancel">üîÑ Retry</button>
              <button id="scanConfirmBtn" class="rounded-sky-btn">‚úÖ Paste</button>
          </div>
      </div>
  </div>

  <div id="login-modal" style="position:fixed; inset:0; z-index:7000; background:rgba(22,27,34,0.89); display:flex; justify-content:center; align-items:center;">
    <form class="login-dialog modal" id="loginForm" autocomplete="off" novalidate style="max-width:380px;">
      <button class="modal-close" type="button" id="loginCloseBtn" title="Close" aria-label="Close dialog" role="button" style="display:none">‚úñ</button>
      <h3 style="text-align:center;color:var(--accent2);margin-bottom:12px">üîê Dealer Login</h3>
      <div class="error input-error" id="login-error" style="min-height:18px;margin-bottom:8px"></div>

      <label id="pinLabel" for="loginPIN">Create a secure PIN / Password</label>
      <div class="show-password-wrap">
        <input type="password" id="loginPIN" minlength="4" maxlength="32" required placeholder="Set PIN or password" autocomplete="new-password" />
        <button type="button" id="showLoginPINBtn" title="Show/Hide PIN" tabindex="-1" aria-label="Show password" style="display:inline-flex;align-items:center;">
          <span id="showLoginPINBtnIcon" aria-hidden="true">&#128065;</span>
        </button>
      </div>

      <label class="keep-logged-toggle" title="If checked, you stay logged in for 5 minutes unless the app is closed or device is locked.">
        <input type="checkbox" id="keepLoggedInToggle" />
        <span>Keep me logged in for 30 Minutes</span>
      </label>
      <div id="timeoutNotice"></div>

      <div style="display:flex; flex-direction:column; gap:10px; align-items:center; width:100%; margin-top:10px;">
        <button type="submit" id="loginBtn" style="width:100%;">Set PIN</button>
        <button type="button" id="biometricUnlockBtn" class="rounded-sky-btn" title="Unlock with Fingerprint">
           üëÜ Unlock with Fingerprint
        </button>
        <button type="button" id="forgotBtn" style="display:none; background:transparent; border:1px solid #253048; color:var(--text); padding:9px 12px; border-radius:8px; cursor:pointer;">Forgot</button>
      </div>

      <small style="display:block;margin-top:12px;color:var(--text-muted);">All data is stored locally in your browser. PIN is hashed before saving.</small>
    </form>
  </div>

  <div id="dealerApp" class="" style="display:none;">
    <div class="container">
      <header>
        <div class="logo-wrap">
          <div class="app-logo" title="Al Rehman Electronics" style="padding:0;">
            <img src="https://github.com/ashardiyan/test/blob/e8a700de371269b411bebca7c951e8ce92c400d8/Al%20Rahman%20Electronics-02.png?raw=true" alt="App Logo" style="width:100%;height:100%;border-radius:16px;object-fit:cover;background:#fff;border:none;"/>
          </div>
          <span class="app-title">Al Rehman Electronics</span>
        </div>
        <div class="top-controls">
          <button id="installPromptBtn" title="Install as App">üì≤ Install</button>
          <button id="installAsAppBtn" title="Install as App (force)">üõ†Ô∏è</button>
          <button id="settingsBtn" title="Settings (‚ãÆ)">‚ãÆ</button>
          <span id="mobileInstallInstructions"></span>
        </div>
      </header>

      <div class="main-content">
        <section class="card" style="animation-delay:.06s">
          <div class="products-top-actions">
            <div class="product-search-wrap">
              <input type="search" placeholder="Search by name, category, or note..." id="productSearch" autocomplete="off" />
              <span class="search-icon">&#128269;</span>
              <button class="scan-btn-inline" id="scanSearchBtn" title="Scan to Search">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="7" y="7" width="10" height="10" rx="1"></rect><line x1="12" y1="7" x2="12" y2="17"></line></svg>
              </button>
            </div>
            
            <button type="button" id="quickSellToggleBtn" class="rounded-sky-btn quick-sell-btn" title="Toggle Quick Sell Mode">‚ö° Sell Mode</button>
            <button type="button" id="historyBtn" class="rounded-sky-btn">üìú History</button>
            <button type="button" id="addProductBtn" class="rounded-sky-btn">+ Add</button>
            <button type="button" id="categoryFilterBtn" class="rounded-sky-btn">Category</button>
            <button type="button" id="exportBtn" class="rounded-sky-btn">Export</button>
            <button type="button" id="importBtn" class="rounded-sky-btn">Import</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
          
          <div id="activeCategoryDisplay"></div>
          
          <div id="multiSelectControls">
            <label style="display:flex;align-items:center;gap:4px;margin-right:10px;">
              <input type="checkbox" id="selectAllCheckbox" title="Select all" />
              <span style="user-select:none;">Select all</span>
            </label>
            <div style="display:flex;gap:6px; flex-wrap:wrap;">
                <button type="button" id="deleteSelectedBtn" disabled>üóëÔ∏è Delete</button>
                <button type="button" id="exportSelectedBtn" disabled>üíæ Export JSON</button>
                <button type="button" id="shareSelectedBtn" disabled>üì§ Share PDF</button>
            </div>
            <span id="selectedCountText" style="color:var(--danger);font-weight:600;font-size:0.99em;margin-left:5px;"></span>
          </div>
          <ul class="product-list" id="productList"></ul>
          <div class="no-products" id="noProducts" style="display:none">No products yet. Click <b>+ Add</b> to get started!</div>
        </section>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="productModalBackdrop">
    <form class="modal" id="productModal" autocomplete="off">
      <button class="modal-close" type="button" id="closeModalBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3 id="modalTitle">Add Product</h3>
      <div class="error" id="modalError" style="min-height:18px"></div>
      
      <label for="prodName">Name</label>
      <input type="text" id="prodName" required maxlength="64" />

      <label for="prodBarcode">Barcode (Scan Multiple)</label>
      <div class="input-with-scan">
          <input type="text" id="prodBarcode" placeholder="Scan or Type multiple codes..." />
          <button type="button" class="scan-btn-modal" id="scanModalBtn" title="Scan Barcode">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="7" y="7" width="10" height="10" rx="1"></rect><line x1="12" y1="7" x2="12" y2="17"></line></svg>
          </button>
      </div>
      
      <label for="prodMrp">MRP (‚Ç®)</label>
      <input type="number" id="prodMrp" min="0" max="1000000" step="0.01" required />
      <label for="prodCost">Cost Price (‚Ç®)</label>
      <input type="number" id="prodCost" min="0" max="1000000" step="0.01"/>
      <label for="prodQty">Quantity</label>
      <input type="number" id="prodQty" min="0" max="1000000" required />
      <label for="prodCategory">Category</label>
      <input type="text" id="prodCategory" maxlength="32" placeholder="e.g. Washing Machine" />
      <label for="prodNotes">Notes</label>
      <textarea id="prodNotes" maxlength="120" placeholder=""></textarea>
      <span class="modal-file-label">Photos (Add Multiple) <span title="Binary Blob storage used for maximum efficiency." style="font-size:1.1em;color:var(--accent2)">[efficient binary format]</span></span>
      <div class="modal-file-upload-wrap" id="fileUploadWrap">
        <span class="modal-file-upload-btn rounded-sky-btn btn-small" id="uploadBtnText" style="flex:1; text-align:center;">
          <svg width="18" height="18" style="margin-right:6px;vertical-align:-4px" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <span id="uploadBtnInnerText">Gallery</span>
          <input type="file" id="prodPhoto" accept="image/jpeg, image/png" multiple style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;"/>
        </span>
        
        <span class="modal-file-upload-btn rounded-sky-btn btn-small" id="cameraBtnText" style="flex:1; text-align:center; background: var(--accent2);">
          <span style="font-size:1.15em; margin-right:4px;">üì∑</span>
          <span>Camera</span>
          <input type="file" id="prodCamera" accept="image/jpeg, image/png" capture="environment" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;"/>
        </span>
      </div>
      
      <div id="prodPhotoList" class="photo-preview-list"></div>
      
      <div class="modal-btnbar">
        <button type="button" class="rounded-sky-btn cancel" onclick="document.getElementById('closeModalBtn').click()">Close</button>
        <button type="submit" id="saveProductBtn" class="rounded-sky-btn">Save</button>
      </div>
      <div id="imageCompressMsg" style="font-size:.99em;color:var(--text-muted);margin-top:10px;user-select:none;display:none"></div>
    </form>
  </div>
  
  <div class="modal-backdrop hide" id="categoryModalBackdrop">
    <div class="modal" id="categoryModal">
        <button class="modal-close" type="button" id="closeCategoryBtn" title="Close" aria-label="Close dialog">‚úñ</button>
        <h3>Select Category</h3>
        <div id="categoryGrid" class="category-grid">
            </div>
    </div>
  </div>
  
  <div class="modal-backdrop hide" id="shareModalBackdrop">
    <div class="modal" id="shareModal">
      <button class="modal-close" type="button" id="closeShareBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>üì§ Share Product PDF</h3>
      <div id="shareSubtitle" style="margin-bottom:15px;color:var(--text-muted);text-align:center;">Select fields to include in the generated PDF/Print.</div>
      
      <div class="share-options">
          <label class="share-option-row">
              <input type="checkbox" id="sharePhoto" checked> <span>Include Photos</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareMrp" checked> <span>Include MRP (Price)</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareCost"> <span>Include Cost Price</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareQty" checked> <span>Include Quantity</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareCategory" checked> <span>Include Category</span>
          </label>
          <label class="share-option-row">
              <input type="checkbox" id="shareNotes" checked> <span>Include Notes</span>
          </label>
      </div>

      <div class="modal-btnbar">
        <button type="button" id="generatePdfBtn" class="rounded-sky-btn">üñ®Ô∏è Generate PDF / Print</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="deleteModalBackdrop">
    <form class="modal" id="deleteModal">
      <button class="modal-close" type="button" id="closeDeleteBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>Delete Product</h3>
      <div style="margin:11px 0 17px 0">Are you sure you want to delete <b id="deleteName"></b>?</div>
      <div class="modal-btnbar">
        <button type="button" id="cancelDeleteBtn" class="rounded-sky-btn cancel">Cancel</button>
        <button type="submit" style="background:var(--danger);border-radius:10px;padding:10px 22px;color:#fff;border:none;font-weight:700;box-shadow:0 2px 10px #1b314e28;transition:background .14s;outline:none;">Yes, Delete</button>
      </div>
    </form>
  </div>
  
  <div class="modal-backdrop hide" id="quickSellModalBackdrop">
    <form class="modal" id="quickSellModal" style="max-width:320px;">
      <button class="modal-close" type="button" id="closeQuickSellBtn" title="Close">‚úñ</button>
      <h3 style="color: var(--warning)">‚ö° Quick Sell</h3>
      <div style="text-align:center; margin-bottom:15px; font-weight:600;" id="quickSellName">Product Name</div>
      
      <label for="quickSellPrice">Sale Price (‚Ç®)</label>
      <input type="number" id="quickSellPrice" min="0" step="0.01" style="font-size:1.2em; text-align:center; margin-bottom:10px;" required />
      
      <label for="quickSellQty">Quantity Sold</label>
      <input type="number" id="quickSellQty" value="1" min="1" max="1000" style="font-size:1.5em; text-align:center;" required />
      
      <div class="modal-btnbar" style="justify-content:center;">
        <button type="submit" class="rounded-sky-btn" style="background:linear-gradient(90deg, #f59e0b, #d97706);">Confirm Sale</button>
      </div>
    </form>
  </div>
  
  <div class="modal-backdrop hide" id="historyModalBackdrop">
    <div class="modal" id="historyModal">
      <button class="modal-close" type="button" id="closeHistoryBtn" title="Close">‚úñ</button>
      <h3>üìú Sales History</h3>
      <div id="historyList" class="history-list">
          <div style="text-align:center; color:var(--text-muted); padding:20px;">Loading...</div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="detailModalBackdrop">
    <div class="modal" id="detailModal" tabindex="-1">
      <button class="modal-close" type="button" id="closeDetailModalBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3>Product Details</h3>
      <div id="detailModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop hide" id="settingsBackdrop">
    <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <button class="modal-close" type="button" id="closeSettingsBtn" title="Close" aria-label="Close dialog" role="button">‚úñ</button>
      <h3 id="settingsTitle">Settings</h3>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">Account</div>
            <div style="color:var(--text-muted);font-size:.94em;">Logout or reset your PIN</div>
          </div>
        </div>

        <button id="logoutBtn" style="padding:10px;border-radius:8px;border:none;background:#2b2f3a;color:var(--text);cursor:pointer;">üîí Logout</button>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700; display:flex; align-items:center; gap:6px;">
          Fingerprint / Face ID
        </div>
        <button id="setupBiometricBtn" class="rounded-sky-btn" style="background:#2b2f3a; border:1px solid #364052;">
           üëÜ Setup Fingerprint
        </button>
        <div style="color:var(--text-muted);font-size:.85em;margin-bottom:6px;">
           Enable easy unlock using your device's sensor.
        </div>

        <hr style="border:none;height:1px;background:#22272f;margin:6px 0;border-radius:2px;" />

        <div style="font-weight:700">Reset PIN</div>
        <div style="color:var(--text-muted);font-size:.93em;margin-bottom:6px;">Enter your current PIN, then choose a new one.</div>

        <label for="oldPin">Current PIN</label>
        <input type="password" id="oldPin" placeholder="Current PIN" maxlength="32" />

        <label for="newPin">New PIN</label>
        <input type="password" id="newPin" placeholder="New PIN (min 4 chars)" maxlength="32" />

        <label for="confirmPin">Confirm New PIN</label>
        <input type="password" id="confirmPin" placeholder="Confirm new PIN" maxlength="32" />

        <div class="error" id="resetPinError" style="min-height:18px;"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px;">
          <button id="resetPinCancel" class="rounded-sky-btn cancel">Cancel</button>
          <button id="resetPinSubmit" class="rounded-sky-btn">Reset PIN</button>
        </div>
      </div>

    </div>
  </div>

  <input type="file" id="hiddenImport" accept="application/json" style="display:none">


<script>
  /****************************************************************
     * BIOMETRIC (FINGERPRINT/FACE ID) LOGIC
     ****************************************************************/
    const strToBuffer = (str) => Uint8Array.from(str, c => c.charCodeAt(0));
    const randomBuffer = (len) => {
      const arr = new Uint8Array(len);
      window.crypto.getRandomValues(arr);
      return arr;
    };

    function hasBiometricSetup() {
       return !!localStorage.getItem('dealer-bio-cred-id');
    }

    async function registerBiometric() {
        if (!window.PublicKeyCredential) {
            alert("Biometrics not supported on this browser.");
            return;
        }
        const userId = window.localStorage.getItem('dealer-hash') || 'default-user';
        try {
            const publicKeyCredentialCreationOptions = {
                challenge: randomBuffer(32),
                rp: { name: "Al Rehman Electronics", id: window.location.hostname },
                user: { id: strToBuffer(userId), name: "dealer@local", displayName: "Dealer" },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }, { alg: -257, type: "public-key" }],
                authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required", residentKey: "preferred" },
                timeout: 60000,
                attestation: "none"
            };
            const credential = await navigator.credentials.create({ publicKey: publicKeyCredentialCreationOptions });
            const credId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
            localStorage.setItem('dealer-bio-cred-id', credId);
            alert("Fingerprint setup successful! You can now use it to unlock.");
            checkBiometricButtonVisibility();
        } catch (err) {
            console.error(err);
            if(err.name === 'NotAllowedError') alert("Setup cancelled or timed out.");
            else if (window.location.protocol === 'file:') alert("Security Error: Biometrics do not work on local files (file://).");
            else alert("Setup failed: " + err.message);
        }
    }

    async function authenticateBiometric() {
        if (!hasBiometricSetup()) return;
        try {
            // FIX: Correctly converting base64 string back to Uint8Array for allowCredentials
            const rawId = Uint8Array.from(atob(localStorage.getItem('dealer-bio-cred-id')), c => c.charCodeAt(0));
            
            const publicKeyCredentialRequestOptions = {
                challenge: randomBuffer(32),
                rpId: window.location.hostname,
                userVerification: "required",
                allowCredentials: [{ id: rawId, type: 'public-key', transports: ['internal'] }]
            };
            const assertion = await navigator.credentials.get({ publicKey: publicKeyCredentialRequestOptions });
            if (assertion) {
                showDealerApp();
                const keepLoggedInToggle = document.getElementById('keepLoggedInToggle');
                if (keepLoggedInToggle.checked) {
                     setKeepSessionActive(Date.now() + KEEP_LOGGED_TIMEOUT_MS);
                     startSessionTimeoutMonitor();
                } else {
                     clearKeepSession();
                     stopSessionTimeoutMonitor();
                }
            }
        } catch (err) {
            console.error(err);
            const loginError = document.getElementById('login-error');
            loginError.textContent = "Fingerprint not recognized. Use PIN.";
            loginError.style.color = 'var(--danger)';
        }
    }

    function checkBiometricButtonVisibility() {
        const btn = document.getElementById('biometricUnlockBtn');
        if(hasBiometricSetup() && getHasPIN()) btn.style.display = 'flex';
        else btn.style.display = 'none';
    }

    /****************************************************************
     * EXISTING APP LOGIC
     ****************************************************************/
    (function() {
      function lockBodyScroll() {
        if (!document.body.classList.contains('modal-open')) {
          document.body.dataset.scrollY = window.scrollY;
          document.body.style.top = `-${window.scrollY}px`;
          document.body.classList.add('modal-open');
        }
      }
      function unlockBodyScroll() {
        if (document.body.classList.contains('modal-open')) {
          document.body.classList.remove('modal-open');
          const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0;
          document.body.style.top = '';
          window.scrollTo(0, scrollY);
          delete document.body.dataset.scrollY;
        }
      }

      function observeProductModalOpen() {
        const productModalBackdrop = document.getElementById('productModalBackdrop');
        if (!productModalBackdrop) return;
        const config = { attributes: true, attributeFilter: ['class'] };
        const observer = new MutationObserver(() => {
          if (!productModalBackdrop.classList.contains('hide')) {
            lockBodyScroll();
          } else {
            unlockBodyScroll();
          }
        });
        observer.observe(productModalBackdrop, config);
        window.addEventListener('beforeunload', unlockBodyScroll);
      }
      window.addEventListener('DOMContentLoaded', observeProductModalOpen);
      window.addEventListener('keydown', function(e) {
        if (e.key === "Escape") {
          unlockBodyScroll();
        }
      });
    })();
  
    /****************************************************************
     * Keep-logged-in authentication logic
     ****************************************************************/
    const KEEP_LOGGED_TIMEOUT_MS = 30*60*1000;

    function setKeepSessionActive(expiresAt) { try { localStorage.setItem('dealer-keep-expires', String(expiresAt)); } catch(e) {} }
    function getKeepSessionActive() { try { const val = localStorage.getItem('dealer-keep-expires'); return val && /^\d+$/.test(val) ? parseInt(val, 10) : null; } catch(e) { return null; } }
    function clearKeepSession() { try { localStorage.removeItem('dealer-keep-expires'); } catch(e) {} }
    
    function showTimeoutNotice(msg) {
      const t = document.getElementById('timeoutNotice');
      if(t) {
          t.textContent = msg || '';
          t.style.display = msg ? 'block' : 'none';
      }
    }
    
    function isSessionStillActive() { const expiresAt = getKeepSessionActive(); return !!expiresAt && Date.now() < expiresAt; }
    
    function showTimeoutCountdownIfAny() {
      const expiresAt = getKeepSessionActive();
      if (expiresAt && Date.now() < expiresAt) {
        const secs = Math.max(0, Math.round((expiresAt-Date.now())/1000));
        if(secs<60) showTimeoutNotice("Session will auto-lock in "+secs+" sec" + (secs===1?"":"s") + ".");
        else if(secs<90) showTimeoutNotice("Session will auto-lock in about 1 min.");
        else showTimeoutNotice("Session will auto-lock in about "+Math.ceil(secs/60)+" min.");
      } else {
        showTimeoutNotice("");
      }
    }
    let timeoutCountdownInterval = null;

    function checkQuickAutoUnlock() {
      if (isSessionStillActive()) {
        updatePINUI(getHasPIN());
        showDealerApp();
        startSessionTimeoutMonitor();
        return true;
      }
      return false;
    }
    function startSessionTimeoutMonitor() {
      if (timeoutCountdownInterval) clearInterval(timeoutCountdownInterval);
      function check() {
        showTimeoutCountdownIfAny();
        if (!isSessionStillActive()) {
          showTimeoutNotice("Session expired for security. Please login again.");
          setTimeout(()=>manualLogoutDueToTimeout(), 1100);
        }
      }
      timeoutCountdownInterval = setInterval(check, 800);
      check();
    }
    function stopSessionTimeoutMonitor() { if (timeoutCountdownInterval) clearInterval(timeoutCountdownInterval); showTimeoutNotice(""); }
    
    function manualLogoutDueToTimeout() {
      stopSessionTimeoutMonitor();
      clearKeepSession();
      // FIX: Ensure scanner is closed before showing login
      if(typeof stopScanner === 'function') stopScanner();
      if(document.getElementById('imageViewerOverlay') && document.getElementById('imageViewerOverlay').classList.contains('show')) {
         document.getElementById('imageViewerOverlay').classList.remove('show');
      }
      
      document.getElementById('dealerApp').style.display = 'none';
      showLoginModal("Session expired for security. Please login again.");
      updatePINUI(getHasPIN());
    }

    /****************************************************************
     * Service Worker & PWA (Offline Logic)
     ****************************************************************/
    (function createManifestAndServiceWorker() {
      const imgIcon = "https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true";
      const manifestObj = {
        name: "Al Rehman Electronics",
        short_name: "ARE",
        description: "Local-only dealer product listing (offline-first)",
        start_url: "./index.html", 
        display: "standalone",
        background_color: "#161B22",
        theme_color: "#161B22",
        icons: [{ src: imgIcon, sizes: "192x192", type: "image/png" }, { src: imgIcon, sizes: "512x512", type: "image/png" }]
      };
      const manifestBlob = new Blob([JSON.stringify(manifestObj)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(manifestBlob);
      (function setManifestLink() {
        let existing = document.querySelector('link[rel="manifest"]');
        if (!existing) { existing = document.createElement('link'); existing.rel = 'manifest'; document.head.appendChild(existing); }
        existing.href = manifestURL;
      })();

      const swScript = `
        const CACHE_NAME = 'local-dealer-cache-v19';
        const OFFLINE_URL = self.registration.scope.endsWith('/') ? self.registration.scope + 'index.html' : self.registration.scope + '/index.html';
        const FILES_TO_CACHE = [ OFFLINE_URL, './index.html' ];
        
        self.addEventListener('install', function(event) { 
            event.waitUntil(caches.open(CACHE_NAME).then(function(cache) { return cache.addAll(FILES_TO_CACHE); })); 
            self.skipWaiting(); 
        });
        
        self.addEventListener('activate', function(event) { 
            event.waitUntil(
                caches.keys().then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            if (cacheName !== CACHE_NAME) {
                                return caches.delete(cacheName);
                            }
                        })
                    );
                }).then(() => self.clients.claim())
            );
        });
        
        // NETWORK FIRST, FALLBACK TO CACHE
        self.addEventListener('fetch', function(event) {
          if (event.request.method !== 'GET') return;
          
          event.respondWith(
            fetch(event.request)
              .then(function(response) {
                // Online: Return response and update cache
                if (!response || response.status !== 200 || response.type !== 'basic') {
                    return response;
                }
                const resClone = response.clone();
                caches.open(CACHE_NAME).then(cache => cache.put(event.request, resClone));
                return response;
              })
              .catch(function() {
                // Offline: Return cached version
                return caches.match(event.request).then(function(response) {
                    if (response) return response;
                    // Fallback for navigation
                    if (event.request.mode === 'navigate') return caches.match(OFFLINE_URL);
                });
              })
          );
        });
      `;
      try {
        const swBlob = new Blob([swScript], { type: 'text/javascript' });
        const swURL = URL.createObjectURL(swBlob);
        if ('serviceWorker' in navigator) { window.addEventListener('load', function() { navigator.serviceWorker.register(swURL); }); }
      } catch (e) {}
    })();

    window.addEventListener('DOMContentLoaded', function(){
      setTimeout(function() { document.querySelectorAll(".card").forEach((el,i)=> { el.classList.add('show'); }); }, 100);
    });

    let deferredPrompt;
    const installBtn = document.getElementById('installPromptBtn');
    const installAsAppBtn = document.getElementById('installAsAppBtn');
    const mobileInstall = document.getElementById('mobileInstallInstructions');
    function isMobileChromeStandaloneCapable() { const ua = navigator.userAgent || ''; return /Android/.test(ua) && /Chrome\/[.0-9]* Mobile/.test(ua) && !window.matchMedia('(display-mode: standalone)').matches; }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e; 
      if(installBtn) installBtn.style.display = 'inline-block'; 
      if(installAsAppBtn) installAsAppBtn.style.display = 'inline-block'; 
      if(mobileInstall) mobileInstall.style.display = 'none';
    });

    if(installBtn) {
        installBtn.onclick = async function() {
            installBtn.disabled = true;
            if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display = 'none'; installAsAppBtn.style.display = 'none'; installBtn.disabled = false; }
        };
    }

    if(installAsAppBtn) {
        installAsAppBtn.onclick = async function() {
            installAsAppBtn.disabled = true;
            if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display = 'none'; installAsAppBtn.style.display = 'none'; installAsAppBtn.disabled = false; } else { alert("Install prompt not available right now."); installAsAppBtn.disabled = false; }
        };
    }

    window.addEventListener('appinstalled', ()=>{ if(installBtn) installBtn.style.display='none'; if(installAsAppBtn) installAsAppBtn.style.display='none'; deferredPrompt = null; if(mobileInstall) mobileInstall.style.display='none'; });

    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (!window.matchMedia('(display-mode: standalone)').matches && !window.matchMedia('(display-mode: fullscreen)').matches && isMobileChromeStandaloneCapable()) {
          if ((installBtn.style.display === "none" || getComputedStyle(installBtn).display === "none") && (installAsAppBtn.style.display === "none" || getComputedStyle(installAsAppBtn).display === "none")) {
            if(mobileInstall) {
                mobileInstall.innerHTML = "To install this app: tap <b><span style='font-size:1.22em;'>‚ãÆ</span></b> at the top right of Chrome, and choose <b>Add to Home screen</b>."; 
                mobileInstall.style.display = "inline-block";
            }
          }
        }
      }, 1100);
    });

    (function handleAndroidBackButton() {
      let isHandlerAttached = false;
      let openedModals = [];
      const modalPriority = ['scannerOverlay', 'imageViewerOverlay', 'productModalBackdrop', 'deleteModalBackdrop', 'settingsBackdrop', 'detailModalBackdrop', 'shareModalBackdrop', 'categoryModalBackdrop', 'quickSellModalBackdrop', 'historyModalBackdrop'];

      function pushMainStateToHistory() { try { history.replaceState({dealerAppMain: true}, document.title, window.location.href); } catch (e) {} }
      function pushModalState(modalId) { try { history.pushState({modal: modalId}, document.title, window.location.href); openedModals.push(modalId); } catch (e) {} }
      
      function enablePwaBackHandler() {
        pushMainStateToHistory();
        window.addEventListener('popstate', function(e) {
            
          const topOpenModal = (() => { 
                for (let i = 0; i < modalPriority.length; ++i) { 
                    const el = document.getElementById(modalPriority[i]); 
                    if (!el) continue;
                    // Fix: Check class based on how each overlay works
                    if (modalPriority[i] === 'imageViewerOverlay' || modalPriority[i] === 'scannerOverlay') {
                         if (el.classList.contains('show')) return modalPriority[i];
                    } else {
                         if (!el.classList.contains('hide')) return modalPriority[i];
                    }
                } 
                return null; 
            })();
            
            if (topOpenModal) { 
                if (topOpenModal === 'imageViewerOverlay' || topOpenModal === 'scannerOverlay') {
                    // FIX: Ensure stream stops if scanner closed via back button
                    if(topOpenModal === 'scannerOverlay') stopScanner();
                    
                    document.getElementById(topOpenModal).classList.remove('show');
                } else {
                    document.getElementById(topOpenModal).classList.add('hide'); 
                }
                setTimeout(()=>{},10); 
                return; 
            }

            if (activeCategoryFilter) {
                activeCategoryFilter = null;
                refreshProductList();
                return;
            }

            const searchInput = document.getElementById('productSearch');
            if (document.getElementById('dealerApp').style.display !== 'none' && searchInput && searchInput.value) {
                 searchInput.value = '';
                 refreshProductList();
                 return; 
            }

            pushMainStateToHistory();
        });
      }
      function setupModalHistoryTracking() {
        modalPriority.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const observer = new MutationObserver(() => {
            let isOpen = false;
            if (id === 'imageViewerOverlay' || id === 'scannerOverlay') isOpen = el.classList.contains('show');
            else isOpen = !el.classList.contains('hide');
            
            if (isOpen) { if (!openedModals.includes(id)) pushModalState(id); } 
            else { const idx = openedModals.indexOf(id); if (idx !== -1) openedModals.splice(idx, 1); }
          });
          observer.observe(el, { attributes: true, attributeFilter: ['class'] });
        });
      }
      
      window.__enablePwaBackHandler = function() { 
          if(isHandlerAttached) return;
          isHandlerAttached = true;
          enablePwaBackHandler(); 
          setupModalHistoryTracking(); 
      };
    })();

    async function hashPIN(pin) {
      let salt = window.localStorage.getItem('dealer-app-salt');
      if (!salt) { const arr = new Uint8Array(16); window.crypto.getRandomValues(arr); salt = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join(''); window.localStorage.setItem('dealer-app-salt', salt); }
      const encoder = new TextEncoder();
      try {
        const baseKey = await window.crypto.subtle.importKey('raw', encoder.encode(pin), 'PBKDF2', false, ['deriveBits']);
        const rawBits = await window.crypto.subtle.deriveBits({ name: "PBKDF2", salt: encoder.encode(salt), iterations: 3000, hash: "SHA-256" }, baseKey, 256);
        const hashArr = new Uint8Array(rawBits);
        return Array.from(hashArr).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) { return pin + salt; }
    }
    function getHasPIN() { return !!window.localStorage.getItem('dealer-hash'); }
    
    function showDealerApp() {
      document.getElementById('dealerApp').style.display = '';
      document.getElementById('login-modal').style.display = 'none';
      setTimeout(refreshProductList, 100);
      if (typeof window.__enablePwaBackHandler === 'function') window.__enablePwaBackHandler();
    }
    
    function showLoginModal(msg) {
      document.getElementById('dealerApp').style.display = 'none';
      const loginModal = document.getElementById('login-modal');
      loginModal.style.display = 'flex';
      if (msg) { document.getElementById('login-error').textContent = msg; document.getElementById('login-error').style.color = 'var(--danger)'; } else { document.getElementById('login-error').textContent = ''; document.getElementById('login-error').style.color = ''; }
      document.getElementById('loginPIN').value = '';
      if (!hasBiometricSetup()) { setTimeout(()=>document.getElementById('loginPIN').focus(),120); }
      checkBiometricButtonVisibility();
    }
    
    let justSetPIN = false;

    window.addEventListener('load', async ()=> {
      await loadProducts(); 
      updatePINUI(getHasPIN());
      if (!checkQuickAutoUnlock()) { showLoginModal(); if (hasBiometricSetup()) { setTimeout(authenticateBiometric, 400); } }
      setTimeout(function() { if ("serviceWorker" in navigator && window.matchMedia('(display-mode: standalone)').matches) { try { history.replaceState({start:true}, document.title, window.location.href); } catch (e) {} } }, 180);
    });

    const loginBtn = document.getElementById('loginBtn');
    const loginForm = document.getElementById('loginForm');
    const loginPIN = document.getElementById('loginPIN');
    const loginError = document.getElementById('login-error');
    const pinLabel = document.getElementById('pinLabel');
    const keepLoggedInToggle = document.getElementById('keepLoggedInToggle');
    const setupBiometricBtn = document.getElementById('setupBiometricBtn');
    const biometricUnlockBtn = document.getElementById('biometricUnlockBtn');

    if(setupBiometricBtn) setupBiometricBtn.onclick = (e) => { e.preventDefault(); registerBiometric(); };
    if(biometricUnlockBtn) biometricUnlockBtn.onclick = (e) => { e.preventDefault(); authenticateBiometric(); };

    (function() {
      const showBtn = document.getElementById('showLoginPINBtn');
      const pinInput = document.getElementById('loginPIN');
      const iconSpan = document.getElementById('showLoginPINBtnIcon');
      let visible = false;
      if (showBtn && pinInput) {
        showBtn.addEventListener('click', function(e) { e.preventDefault(); visible = !visible; pinInput.type = visible ? 'text' : 'password'; iconSpan.textContent = visible ? 'üôà' : 'üëÅÔ∏è'; showBtn.setAttribute('aria-label', visible ? "Hide PIN" : "Show PIN"); });
        pinInput.addEventListener('keydown', function(e) { if (visible && e.key === "Escape") { pinInput.type = 'password'; visible = false; iconSpan.textContent = 'üëÅÔ∏è'; showBtn.setAttribute('aria-label', "Show PIN"); } });
      }
    })();

    function updatePINUI(hasPIN) {
      if (hasPIN) { loginBtn.textContent = "Unlock"; pinLabel.textContent = "Enter your PIN / Password:"; loginPIN.placeholder = "Enter PIN or password"; loginPIN.autocomplete = "current-password"; } else { loginBtn.textContent = "Set PIN"; pinLabel.textContent = "Create a secure PIN / Password:"; loginPIN.placeholder = "Set PIN or password"; loginPIN.autocomplete = "new-password"; }
      loginError.textContent = ''; loginError.style.color = ''; checkBiometricButtonVisibility();
    }

    loginForm.onsubmit = async function(e) {
      e.preventDefault(); loginError.textContent = ''; loginError.style.color = '';
      const pinVal = (loginPIN.value || '').trim();
      const hasPIN = getHasPIN();
      if (!pinVal || pinVal.length < 4) { loginError.style.color = 'var(--danger)'; loginError.textContent = hasPIN ? "Enter your PIN/Password." : "PIN/password must be at least 4 characters."; return; }
      loginBtn.disabled = true;
      try {
        const hash = await hashPIN(pinVal);
        if (!hasPIN) {
          window.localStorage.setItem('dealer-hash', hash);
          justSetPIN = true; updatePINUI(true); loginError.style.color = 'var(--success)'; loginError.textContent = "PIN set. Now use it to unlock."; loginBtn.disabled = false; loginPIN.value = '';
          setTimeout(()=>{ loginError.textContent = ''; loginError.style.color=''; }, 1500); keepLoggedInToggle.checked = false; return;
        }
        const userHash = window.localStorage.getItem('dealer-hash');
        if (userHash === hash) {
          if (keepLoggedInToggle.checked) { setKeepSessionActive(Date.now() + KEEP_LOGGED_TIMEOUT_MS); startSessionTimeoutMonitor(); } else { clearKeepSession(); stopSessionTimeoutMonitor(); }
          showDealerApp(); loginBtn.disabled = false; loginError.textContent = ''; loginError.style.color = ''; justSetPIN = false;
        } else { loginBtn.disabled = false; loginError.style.color='var(--danger)'; loginError.textContent = 'Incorrect PIN / Password.'; }
      } catch (ex) { loginBtn.disabled = false; loginError.style.color='var(--danger)'; loginError.textContent = 'An error occurred. Try again.'; }
    };

    keepLoggedInToggle.onchange = function() { showTimeoutNotice(""); if (!this.checked) clearKeepSession(); };
    document.getElementById('login-modal').addEventListener('transitionend', function() { loginPIN.value = ''; });
    
    // FIX: Ensure scanner/viewer are closed on logout
    function doLogout(showMsg) { 
        stopSessionTimeoutMonitor(); 
        clearKeepSession(); 
        
        if(typeof stopScanner === 'function') stopScanner();
        if(document.getElementById('imageViewerOverlay') && document.getElementById('imageViewerOverlay').classList.contains('show')) {
           document.getElementById('imageViewerOverlay').classList.remove('show');
        }

        document.getElementById('dealerApp').style.display = 'none'; 
        showLoginModal(showMsg || 'You have been logged out.'); 
        updatePINUI(getHasPIN()); 
    }

    const settingsBtn = document.getElementById('settingsBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const resetPinSubmit = document.getElementById('resetPinSubmit');
    const resetPinCancel = document.getElementById('resetPinCancel');
    const resetPinError = document.getElementById('resetPinError');

    settingsBtn.onclick = () => { settingsBackdrop.classList.remove('hide'); document.getElementById('oldPin').value = ''; document.getElementById('newPin').value = ''; document.getElementById('confirmPin').value = ''; resetPinError.textContent = ''; resetPinError.style.color = ''; };
    closeSettingsBtn.onclick = () => settingsBackdrop.classList.add('hide');
    logoutBtn.onclick = () => { settingsBackdrop.classList.add('hide'); doLogout(); };
    resetPinCancel.onclick = () => { resetPinError.textContent = ''; resetPinError.style.color = ''; settingsBackdrop.classList.add('hide'); };

    resetPinSubmit.onclick = async function() {
      resetPinError.textContent = ''; resetPinError.style.color = '';
      const oldPin = (document.getElementById('oldPin').value || '').trim();
      const newPin = (document.getElementById('newPin').value || '').trim();
      const confirmPin = (document.getElementById('confirmPin').value || '').trim();
      if (!oldPin || oldPin.length < 4) { resetPinError.textContent = "Enter current PIN (min 4 chars)."; resetPinError.style.color='var(--danger)'; return; }
      if (!newPin || newPin.length < 4) { resetPinError.textContent = "New PIN must be at least 4 characters."; resetPinError.style.color='var(--danger)'; return; }
      if (newPin !== confirmPin) { resetPinError.textContent = "New PIN and confirmation do not match."; resetPinError.style.color='var(--danger)'; return; }
      if (oldPin === newPin) { resetPinError.textContent = "New PIN cannot be same as old PIN."; resetPinError.style.color='var(--danger)'; return;}
      resetPinSubmit.disabled = true;
      try {
        const oldHash = await hashPIN(oldPin);
        const stored = window.localStorage.getItem('dealer-hash');
        if (stored !== oldHash) { resetPinError.textContent = "Current PIN is incorrect."; resetPinError.style.color='var(--danger)'; resetPinSubmit.disabled = false; return; }
        const newHash = await hashPIN(newPin);
        window.localStorage.setItem('dealer-hash', newHash);
        resetPinError.style.color = 'var(--success)'; resetPinError.textContent = "PIN updated successfully.";
        setTimeout(()=>{ resetPinError.textContent = ''; resetPinError.style.color = ''; settingsBackdrop.classList.add('hide'); }, 1000);
      } catch (err) { resetPinError.textContent = "Failed to update PIN."; resetPinError.style.color='var(--danger)'; }
      resetPinSubmit.disabled = false;
    };

    const productListElem = document.getElementById('productList');
    const noProductsElem = document.getElementById('noProducts');
    let products = [];
    let selectedProductIds = new Set();
    
    let currentFilteredProducts = []; 
    let activeCategoryFilter = null; 
    let isQuickSellMode = false;

    // FIX NO 1: Global array to track active URLs for revocation (prevents memory leak)
    let activeObjectUrls = [];

    // ***************************************************************
    // * INDEXED DB STORAGE ENGINE (Updated for History)             *
    // ***************************************************************
    const DB_NAME = 'DealerDB';
    const STORE_NAME = 'products';
    const STORE_HISTORY = 'sales_history'; // NEW STORE
    const DB_VERSION = 3; // UPDATED VERSION TO FORCE UPGRADE

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = function(e) {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains(STORE_HISTORY)) {
                    // Create History Store
                    db.createObjectStore(STORE_HISTORY, { keyPath: 'id', autoIncrement: true });
                }
            };
            request.onsuccess = e => resolve(e.target.result);
            request.onerror = e => reject(e.target.error);
        });
    }


async function saveProductsToDB(productsArray) {
    const db = await openDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);

    // Clear first and wait
    await new Promise((resolve, reject) => {
        const clearReq = store.clear();
        clearReq.onsuccess = resolve;
        clearReq.onerror = reject;
    });

    // Then add all products
    productsArray.forEach(p => store.put(p));

    // Wait for transaction to complete
    return new Promise((resolve, reject) => {
        tx.oncomplete = resolve;
        tx.onerror = reject;
    });
}

    async function loadProductsFromDB() {
        // MIGRATION STEP: Check if LocalStorage has old data
        const localData = localStorage.getItem('dealer-products');
        if (localData) {
            try {
                const parsed = JSON.parse(localData);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    console.log("Migrating data from LocalStorage to IndexedDB...");
                    await saveProductsToDB(parsed);
                    localStorage.removeItem('dealer-products');
                    console.log("Migration Complete. LocalStorage cleared.");
                    return parsed;
                }
            } catch(e) { console.error("Migration check failed", e); }
        }

        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        return new Promise((resolve, reject) => {
            const req = store.getAll();
            req.onsuccess = async () => {
                let results = req.result || [];
                let needsMigration = false;
                
                // Data Migration: Ensure 'photos' array exists for all products
                results.forEach(p => {
                    if(!p.photos) {
                        needsMigration = true;
                        if(p.photo) p.photos = [p.photo];
                        else p.photos = [];
                    }
                });
                
                // Save migration back to DB
                if(needsMigration) {
                    console.log("Migrating photo data structure...");
                    await saveProductsToDB(results);
                }
                
                resolve(results);
            };
            req.onerror = () => reject(req.error);
        });
    }
    
    // NEW: Sales History Functions
    async function logSaleToDB(entry) {
        const db = await openDB();
        const tx = db.transaction(STORE_HISTORY, 'readwrite');
        const store = tx.objectStore(STORE_HISTORY);
        store.add(entry);
        return new Promise((resolve, reject) => {
            tx.oncomplete = resolve;
            tx.onerror = reject;
        });
    }
    
    // NEW: Delete sale logic
    async function deleteSaleFromDB(id) {
        const db = await openDB();
        const tx = db.transaction(STORE_HISTORY, 'readwrite');
        const store = tx.objectStore(STORE_HISTORY);
        store.delete(id);
        return new Promise((resolve, reject) => {
            tx.oncomplete = resolve;
            tx.onerror = reject;
        });
    }
    
    async function getSalesHistoryFromDB() {
        const db = await openDB();
        if(!db.objectStoreNames.contains(STORE_HISTORY)) return [];
        const tx = db.transaction(STORE_HISTORY, 'readonly');
        const store = tx.objectStore(STORE_HISTORY);
        return new Promise((resolve, reject) => {
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => reject(req.error);
        });
    }

    async function saveProducts() { 
        // We update memory immediately, but save async
        try { await saveProductsToDB(products); } catch(e){ console.error("Save failed", e); }
        refreshProductList(); 
    }
    
    async function loadProducts() { 
        products = []; 
        try { products = await loadProductsFromDB(); } catch (e) { products = []; } 
    }

    function escapeHTML(v) { if (typeof v !== "string") return v === undefined || v === null ? "" : String(v); return v.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'" :'&#39;','"':'&quot;'}[c])); }

    function handleCheckboxChange(productId, checked) { if (checked) selectedProductIds.add(productId); else selectedProductIds.delete(productId); updateMultiSelectControls(); }
    
    function updateMultiSelectControls() {
      const multiSelectControls = document.getElementById('multiSelectControls');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const shareSelectedBtn = document.getElementById('shareSelectedBtn');
      const exportSelectedBtn = document.getElementById('exportSelectedBtn');
      const selectedCountText = document.getElementById('selectedCountText');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      
      if (selectedProductIds.size > 0) { 
          multiSelectControls.classList.add('active'); 
          deleteSelectedBtn.disabled = false; 
          shareSelectedBtn.disabled = false;
          if(exportSelectedBtn) exportSelectedBtn.disabled = false;
          selectedCountText.textContent = `${selectedProductIds.size} selected`; 
      } else { 
          multiSelectControls.classList.remove('active'); 
          deleteSelectedBtn.disabled = true; 
          shareSelectedBtn.disabled = true;
          if(exportSelectedBtn) exportSelectedBtn.disabled = true;
          selectedCountText.textContent = ""; 
      }
      
      if (currentFilteredProducts.length > 0) {
          const allVisibleSelected = currentFilteredProducts.every(p => selectedProductIds.has(p.id));
          const someVisibleSelected = currentFilteredProducts.some(p => selectedProductIds.has(p.id));
          
          if(allVisibleSelected) {
              selectAllCheckbox.checked = true;
              selectAllCheckbox.indeterminate = false;
          } else if (someVisibleSelected) {
              selectAllCheckbox.checked = false;
              selectAllCheckbox.indeterminate = true;
          } else {
              selectAllCheckbox.checked = false;
              selectAllCheckbox.indeterminate = false;
          }
      } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
      }
    }
    
    const imageViewerOverlay = document.getElementById('imageViewerOverlay');
    const imageViewerClose = document.getElementById('imageViewerClose');
    
    // --- UPDATED IMAGE VIEWER FOR FULL-SCREEN SWIPING ---
    function openImageViewer(images, startIdx = 0) {
        // Handle legacy call with single string
        if (typeof images === 'string') images = [images];
        if (!images || !Array.isArray(images) || images.length === 0) return;

        // Try to find slider container first (new HTML), fallback to old img tag
        let slider = document.getElementById('imageViewerSlider');
        
        // If the HTML hasn't been updated to include the slider div, we create/inject it dynamically
        // or clear the existing image tag and use it as a container if needed.
        if (!slider) {
            // Fallback for previous HTML structure: replace img with div
            const oldImg = document.getElementById('imageViewerImg');
            if (oldImg) {
                slider = document.createElement('div');
                slider.id = 'imageViewerSlider';
                slider.style.cssText = "display:flex; overflow-x:auto; scroll-snap-type:x mandatory; width:100%; height:100%; align-items:center;";
                oldImg.parentNode.replaceChild(slider, oldImg);
            }
        }
        
        if(!slider) return;
        
        slider.innerHTML = ''; // Clear previous

        images.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            // Add inline styles to ensure swipe works even if CSS is missing
            img.style.cssText = "flex: 0 0 100%; width:100%; height:100%; object-fit:contain; scroll-snap-align:center; display:block;";
            slider.appendChild(img);
        });

        imageViewerOverlay.classList.add('show');
        
        // Snap to index
        if(startIdx > 0) {
            // Need small delay for layout to stabilize
            setTimeout(() => {
                 slider.scrollTo({ left: slider.clientWidth * startIdx, behavior: 'auto' });
            }, 10);
        }
    }
    
    imageViewerClose.onclick = () => { 
        imageViewerOverlay.classList.remove('show'); 
        const slider = document.getElementById('imageViewerSlider');
        if(slider) {
            slider.innerHTML = '';
        }
    };
    
    imageViewerOverlay.onclick = (e) => {
        if(e.target === imageViewerOverlay) { 
            imageViewerOverlay.classList.remove('show'); 
            const slider = document.getElementById('imageViewerSlider');
            if(slider) {
                
                slider.innerHTML = '';
            }
        }
    };

    // --- HELPER: GET URL FROM BLOB OR STRING (WITH TRACKING) ---
    function getPhotoSrc(photo) {
        if (!photo) return null;
        if (photo instanceof Blob) {
            const url = URL.createObjectURL(photo);
            activeObjectUrls.push(url); // Track for cleanup
            return url;
        }
        return photo; // Base64 string fallback
    }

    function createProductCard(product, idx) {
      const li = document.createElement('li');
      li.className = 'prod-card';
      li.setAttribute('tabindex','0');
      li.classList.add('show');

      // Use the first photo as the main thumbnail
      let firstPhoto = null;
      if (product.photos && product.photos.length > 0) {
          firstPhoto = product.photos[0];
      } else if (product.photo) {
          // Fallback legacy
          firstPhoto = product.photo;
      }

      const imgSrc = getPhotoSrc(firstPhoto);
      let imgHTML = imgSrc ? `<img src="${imgSrc}" class="prod-photo-thumb" alt="Product Photo" loading="lazy">` : `<span>üì¶</span>`;
      
      const nameSafe = escapeHTML(product.name || "Unnamed");
      const qtyNum = Number(product.qty) || 0;
      const mrpNum = Number(product.mrp) || 0;
      let checkboxHTML = `<input type="checkbox" class="prod-select-checkbox" title="Select" data-id="${product.id}" tabindex="0" ${selectedProductIds.has(product.id) ? "checked" : ""}/>`;

      // Feature 1: Low Stock Logic
      const isLowStock = qtyNum <= 0;
      const stockColor = isLowStock ? 'var(--danger)' : 'var(--success)';
      const stockIcon = isLowStock ? '‚ö†Ô∏è ' : '';
      const lowStockClass = isLowStock ? 'low-stock' : '';

      li.innerHTML = `
        ${checkboxHTML}
        <div class="prod-img">${imgHTML}</div>
        <div class="prod-main-details">
          <div class="prod-name">${nameSafe}</div>
          <div class="prod-details ${lowStockClass}">Stock: <b style="color:${stockColor};font-weight:600">${stockIcon}${qtyNum}</b> ‚Ä¢ ‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</div>
          ${product.notes?`<div class="prod-details">${escapeHTML(String(product.notes)).slice(0,55)}</div>`:""}
        </div>
        <div class="prod-actions">
           <button type="button" title="Edit" aria-label="Edit product" role="button" class="edit" data-id="${product.id}">‚úèÔ∏è</button>
           <button type="button" title="Share PDF" aria-label="Share product" role="button" class="share" data-id="${product.id}">üì§</button>
        </div>
      `;
      if (selectedProductIds.has(product.id)) li.classList.add('selected');
      const checkbox = li.querySelector('.prod-select-checkbox');
      if (checkbox) {
        checkbox.addEventListener('change', (e) => { handleCheckboxChange(product.id, checkbox.checked); });
        checkbox.addEventListener('click', (e)=>e.stopPropagation());
        checkbox.addEventListener('keydown', (e)=>e.stopPropagation());
      }
      
      const editBtn = li.querySelector('.edit');
      if (editBtn) editBtn.onclick = (e)=>{ e.stopPropagation(); showProductModal('edit', product); };
      
      const shareBtn = li.querySelector('.share');
      if (shareBtn) shareBtn.onclick = (e)=>{ e.stopPropagation(); openShareModal(product); };
      
      const thumb = li.querySelector('.prod-img');
      if (thumb && imgSrc) {
          thumb.onclick = (e) => {
              e.stopPropagation();
              // Pass ALL photos to viewer for swiping
              let allSrcs = [];
              if (product.photos && product.photos.length) {
                  allSrcs = product.photos.map(p => getPhotoSrc(p)).filter(s => s);
              } else if (product.photo) {
                  const s = getPhotoSrc(product.photo);
                  if(s) allSrcs.push(s);
              }
              
              if(allSrcs.length > 0) openImageViewer(allSrcs, 0);
          };
      }

      // Feature 2: Quick Sell Logic integration
      li.addEventListener('click', function(e){ 
          if(e.target.classList.contains('prod-select-checkbox')) return; 
          if(e.target.closest('.prod-actions')) return; 
          
          if(isQuickSellMode) {
              openQuickSellModal(product);
          } else {
              showDetailModal(product); 
          }
      });
      
      li.addEventListener('keydown', function(e){ 
          if((e.key==="Enter"||e.key===" ") && !e.target.closest('.prod-actions')) { 
              e.preventDefault(); 
              if(isQuickSellMode) openQuickSellModal(product);
              else showDetailModal(product); 
          } 
      });
      return li;
    }

    document.getElementById("selectAllCheckbox").addEventListener("change", function() { 
        if (this.checked) { 
            currentFilteredProducts.forEach(prod => selectedProductIds.add(prod.id)); 
        } else { 
            currentFilteredProducts.forEach(prod => selectedProductIds.delete(prod.id)); 
        } 
        refreshProductList(); 
        updateMultiSelectControls(); 
    });
    
    document.getElementById("deleteSelectedBtn").onclick = function() { if (selectedProductIds.size === 0) return; if (!confirm(`Are you sure you want to delete ${selectedProductIds.size} selected item(s)?`)) return; products = products.filter(p => !selectedProductIds.has(p.id)); selectedProductIds.clear(); saveProducts(); updateMultiSelectControls(); };

    document.getElementById("shareSelectedBtn").onclick = function() {
        if (selectedProductIds.size === 0) return;
        const itemsToShare = products.filter(p => selectedProductIds.has(p.id));
        if(itemsToShare.length > 0) {
            openShareModal(null, itemsToShare);
        }
    };

    // --- REFACTORED EXPORT LOGIC: ROBUST AND SHARED ---
    // UPDATED FOR MULTI-IMAGE SUPPORT
    async function performExport(itemsToExport, filename) {
        try {
            // Convert Blobs to Base64 for JSON storage
            const dataToExport = await Promise.all(itemsToExport.map(async (p) => {
                // Handle photos array
                let photoDataArray = [];
                if(p.photos && p.photos.length > 0) {
                     photoDataArray = await Promise.all(p.photos.map(async (photo) => {
                         if (photo instanceof Blob) {
                            return await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.onerror = () => resolve(null);
                                reader.readAsDataURL(photo);
                            });
                         }
                         return photo; // already string or null
                     }));
                } 
                // Legacy fallback
                else if (p.photo) {
                     let singlePhoto = p.photo;
                     if(singlePhoto instanceof Blob) {
                         singlePhoto = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.readAsDataURL(singlePhoto);
                         });
                     }
                     photoDataArray.push(singlePhoto);
                }

                // Remove legacy 'photo' key, only use 'photos'
                const { photo, ...cleanP } = p;
                return { ...cleanP, photos: photoDataArray };
            }));

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type:"application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.style.display='none'; 
            a.href = url; 
            a.download = filename; 
            document.body.appendChild(a); 
            a.click(); 
            URL.revokeObjectURL(url); 
            setTimeout(()=>{ document.body.removeChild(a); }, 200);
        } catch (err) {
            console.error("Export failed:", err);
            alert("Export failed: " + (err.message || "Unknown error"));
        }
    }

    // Main Export Button (All Products)
    document.getElementById('exportBtn').onclick = async function() {
      if(!products || products.length === 0) {
          alert("No products to export.");
          return;
      }
      const now = new Date();
      const dateStr = now.toISOString().slice(0,10);
      const timeStr = now.toTimeString().slice(0,5).replace(/:/g, '-');
      const filename = `dealer-backup-${dateStr}_${timeStr}.json`;
      
      await performExport(products, filename);
    };

    // Selected Export Button (Multi-select)
    const exportSelectedBtn = document.getElementById('exportSelectedBtn');
    if (exportSelectedBtn) {
        exportSelectedBtn.onclick = async function() {
            if (selectedProductIds.size === 0) return;
            const itemsToExport = products.filter(p => selectedProductIds.has(p.id));
            if(itemsToExport.length === 0) return;

            const now = new Date();
            const dateStr = now.toISOString().slice(0,10);
            const timeStr = now.toTimeString().slice(0,5).replace(/:/g, '-');
            const filename = `dealer-selected-${dateStr}_${timeStr}.json`;

            await performExport(itemsToExport, filename);
        };
    }

    document.getElementById('importBtn').onclick = function () { 
        let fileInput = document.getElementById('hiddenImport'); 
        if (fileInput) fileInput.value = ''; 
        if (fileInput) fileInput.click(); 
    };

    // --- UPDATED IMPORT LOGIC: CONVERT BASE64 STRINGS BACK TO BLOBS (ARRAY SUPPORT) ---
    document.getElementById('hiddenImport').onchange = async function (e) {
      const fileInput = e.target;
      if (!fileInput.files || !fileInput.files.length) return;
      const file = fileInput.files[0];

      if (!(file && (file.type === 'application/json' || /\.json$/i.test(file.name)))) { alert('Please select a valid .json backup file.'); return; }

      try {
        let text = await file.text();
        let importedArr = JSON.parse(text); 
        if (!Array.isArray(importedArr)) throw new Error('Invalid file format. Data must be an array.');
        
        // Convert Base64 strings back to Blobs for efficiency
        importedArr = await Promise.all(importedArr.map(async (p) => {
            // Handle photos array
            if (p.photos && Array.isArray(p.photos)) {
                p.photos = await Promise.all(p.photos.map(async (photoStr) => {
                    if (typeof photoStr === 'string' && photoStr.startsWith('data:')) {
                        try {
                            const res = await fetch(photoStr);
                            return await res.blob();
                        } catch(err) { return photoStr; }
                    }
                    return photoStr;
                }));
            } 
            // Handle legacy photo string
            else if (p.photo && typeof p.photo === 'string' && p.photo.startsWith('data:')) {
                try {
                    const res = await fetch(p.photo);
                    const blob = await res.blob();
                    p.photos = [blob];
                    delete p.photo;
                } catch(err) { /* fallback */ }
            }
            // Ensure array exists
            if(!p.photos) p.photos = [];
            
            return p;
        }));

        importedArr = importedArr.filter(p => p && typeof p === 'object' && p.name);
        if (!importedArr.length) throw new Error('No valid products found in this file.');

        const userWantsToMerge = confirm(`Found ${importedArr.length} products in file.\n\n‚Ä¢ Click [OK] to MERGE.\n(Adds new items and updates existing ones. Safe.)\n\n‚Ä¢ Click [Cancel] to REPLACE.\n(Deletes everything currently in app and restores backup.)`);

        if (userWantsToMerge) {
    const productMap = new Map();
    products.forEach(p => productMap.set(p.id, p));
    let addedCount = 0;
    let updatedCount = 0;
    let unchangedCount = 0;
    
    importedArr.forEach(p => {
        if (!p.id) p.id = genID();
        
        if (productMap.has(p.id)) {
            const existing = productMap.get(p.id);
            
            // Check if data actually changed
            const hasChanged = (
                existing.name !== p.name ||
                existing.barcode !== p.barcode ||
                existing.mrp !== p.mrp ||
                existing.cost !== p.cost ||
                existing.qty !== p.qty ||
                existing.category !== p.category ||
                existing.notes !== p.notes ||
                (existing.photos?.length || 0) !== (p.photos?.length || 0)
            );
            
            if (hasChanged) {
                productMap.set(p.id, p);
                updatedCount++;
            } else {
                unchangedCount++;
            }
        } else {
            productMap.set(p.id, p);
            addedCount++;
        }
    });
    
    products = Array.from(productMap.values());
    
    let message = `Import Successful!\n\nüÜï Added: ${addedCount}\nüîÑ Updated: ${updatedCount}`;
    if (unchangedCount > 0) {
        message += `\n‚è≠Ô∏è Unchanged: ${unchangedCount}`;
    }
    alert(message);
    } else {
            if(!confirm("‚ö†Ô∏è WARNING: This will DELETE all current products and replace them with the backup.\n\nAre you sure?")) { return; }
            products = importedArr;
            products.forEach(p => { if(!p.id) p.id = genID(); });
            alert(`Restore Successful! App now has ${products.length} products.`);
        }
        saveProducts(); selectedProductIds.clear(); updateMultiSelectControls(); 
      } catch (ex) { alert("Failed to import: " + (ex.message || ex)); }
    };

    const detailModalBackdrop = document.getElementById('detailModalBackdrop');
    const detailModalBody = document.getElementById('detailModalBody');
    function disableDetailBackgroundScroll() { document.body.classList.add('detail-modal-open'); }
    function enableDetailBackgroundScroll() { document.body.classList.remove('detail-modal-open'); }
    
    // -- Global variable to hold current detail images for the viewer to access --
    let currentDetailImages = [];
    
    // Wrapper function to be called from inline HTML
    window.openImageViewerGlobal = function(index) {
        if(currentDetailImages && currentDetailImages.length > 0) {
            openImageViewer(currentDetailImages, index);
        }
    };

    function showDetailModal(product) {
      const nameSafe = escapeHTML(product.name || 'Unnamed');
      
      // Prepare photos for viewer
      currentDetailImages = [];
      if (product.photos && product.photos.length > 0) {
          currentDetailImages = product.photos.map(p => getPhotoSrc(p)).filter(s => s);
      } else if (product.photo) {
          const s = getPhotoSrc(product.photo);
          if(s) currentDetailImages.push(s);
      }
      
      // Build Gallery HTML
      let galleryHtml = "";
      if(currentDetailImages.length > 0) {
          galleryHtml = `<div class="detail-gallery">`;
          currentDetailImages.forEach((src, idx) => {
              // Pass index to global wrapper
              galleryHtml += `<img src="${src}" onclick="openImageViewerGlobal(${idx})" alt="${nameSafe}"/>`;
          });
          galleryHtml += `</div>`;
      } else {
          galleryHtml = `<div class="prod-detail-photo" style="font-size:60px;padding:22px 0 12px 0;text-align:center;">üì¶</div>`;
      }
      
      const mrpNum = Number(product.mrp) || 0;
      const costNum = (product.cost !== undefined && product.cost !== null) ? Number(product.cost) : null;
      const barcodeHtml = product.barcode ? `<li><b>Barcode:</b> <span style="font-family:monospace;background:#2b3548;padding:2px 6px;border-radius:4px;">${escapeHTML(product.barcode)}</span></li>` : "";

      detailModalBody.innerHTML = `
        ${galleryHtml}
        <ul style="list-style:none;padding:0;margin:10px 0 0 0;display:flex;flex-direction:column;gap:.57em;">
          <li><b>Name:</b> <span style="color:var(--accent2);font-weight:600">${nameSafe}</span></li>
          ${barcodeHtml}
          ${product.category?`<li><b>Category:</b> <span style="color:var(--accent2);font-weight:600">${escapeHTML(String(product.category))}</span></li>`:""}
          <li><b>Stock:</b> <span style="color:var(--accent2);font-weight:600">${Number(product.qty)||0}</span></li>
          <li><b>MRP:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${mrpNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>
          ${costNum!==null?`<li><b>Cost:</b> <span style="color:var(--accent2);font-weight:600">‚Ç®${costNum.toLocaleString(undefined,{maximumFractionDigits:2})}</span></li>`:""}
        </ul>
        ${product.notes?`<div style="margin-top:.8em;color:var(--text-muted);background:#213047;border-radius:8px;padding:.7em .9em">${escapeHTML(String(product.notes))}</div>`:""}
      `;

      detailModalBackdrop.classList.remove('hide'); disableDetailBackgroundScroll(); setTimeout(()=>document.getElementById('closeDetailModalBtn').focus(),100);
    }
    document.getElementById('closeDetailModalBtn').onclick = function(){ detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML = ''; enableDetailBackgroundScroll(); };
    
    document.addEventListener('keydown', function(e){
      if (e.key === "Escape") {
        let closedAModal = false;
        if(document.getElementById('imageViewerOverlay') && document.getElementById('imageViewerOverlay').classList.contains('show')) { 
            document.getElementById('imageViewerOverlay').classList.remove('show'); 
            const slider = document.getElementById('imageViewerSlider');
            if(slider) slider.innerHTML = '';
            closedAModal=true; 
        }
        else if(document.getElementById('scannerOverlay') && document.getElementById('scannerOverlay').classList.contains('show')) { stopScanner(); document.getElementById('scannerOverlay').classList.remove('show'); closedAModal=true; }
        else if (!detailModalBackdrop.classList.contains('hide')) { detailModalBackdrop.classList.add('hide'); detailModalBody.innerHTML=''; enableDetailBackgroundScroll(); closedAModal = true; }
        else if (!productModalBackdrop.classList.contains('hide')) { productModalBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!deleteModalBackdrop.classList.contains('hide')) { deleteModalBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!settingsBackdrop.classList.contains('hide')) { settingsBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!shareModalBackdrop.classList.contains('hide')) { shareModalBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!categoryModalBackdrop.classList.contains('hide')) { categoryModalBackdrop.classList.add('hide'); closedAModal = true; }
        // NEW MODAL ESC HANDLERS
        else if (!quickSellModalBackdrop.classList.contains('hide')) { quickSellModalBackdrop.classList.add('hide'); closedAModal = true; }
        else if (!historyModalBackdrop.classList.contains('hide')) { historyModalBackdrop.classList.add('hide'); closedAModal = true; }
        
        if (closedAModal) enableDetailBackgroundScroll();
      }
    });
    
    function maybeResetBodyScroll() {
      if (
        detailModalBackdrop.classList.contains('hide') &&
        (!productModalBackdrop || productModalBackdrop.classList.contains('hide')) &&
        (!settingsBackdrop || settingsBackdrop.classList.contains('hide')) &&
        (!deleteModalBackdrop || deleteModalBackdrop.classList.contains('hide')) &&
        (!shareModalBackdrop || shareModalBackdrop.classList.contains('hide')) &&
        (!categoryModalBackdrop || categoryModalBackdrop.classList.contains('hide')) &&
        // NEW
        (!quickSellModalBackdrop || quickSellModalBackdrop.classList.contains('hide')) &&
        (!historyModalBackdrop || historyModalBackdrop.classList.contains('hide'))
      ) {
        enableDetailBackgroundScroll();
      }
    }
    detailModalBackdrop.addEventListener('transitionend', maybeResetBodyScroll);
    detailModalBackdrop.addEventListener('animationend', maybeResetBodyScroll);
    window.addEventListener('popstate', maybeResetBodyScroll);

    const searchInput = document.getElementById('productSearch');
    let isSearchState = false;
    searchInput.addEventListener('input', function(){ 
        const hasText = (this.value || '').trim().length > 0;
        if(hasText && !isSearchState) {
             try { history.pushState({search: true}, document.title, window.location.href); isSearchState = true; } catch(e) {}
        }
        refreshProductList(); 
    });
    searchInput.addEventListener('keydown', function(e){ if(e.key==='Escape'){ searchInput.value=''; refreshProductList(); } });
    
    /****************************************************************
     * NEW FEATURE: QUICK SELL LOGIC
     ****************************************************************/
    const quickSellToggleBtn = document.getElementById('quickSellToggleBtn');
    const quickSellModalBackdrop = document.getElementById('quickSellModalBackdrop');
    const quickSellModal = document.getElementById('quickSellModal');
    const quickSellName = document.getElementById('quickSellName');
    const quickSellQty = document.getElementById('quickSellQty');
    const quickSellPrice = document.getElementById('quickSellPrice'); // NEW FIELD
    const closeQuickSellBtn = document.getElementById('closeQuickSellBtn');
    let quickSellProductTarget = null;
    
    quickSellToggleBtn.onclick = function() {
        isQuickSellMode = !isQuickSellMode;
        if(isQuickSellMode) {
            quickSellToggleBtn.classList.add('active');
            document.body.classList.add('quick-sell-active');
            if (navigator.vibrate) navigator.vibrate(50);
        } else {
            quickSellToggleBtn.classList.remove('active');
            document.body.classList.remove('quick-sell-active');
        }
    };
    
    function openQuickSellModal(product) {
        quickSellProductTarget = product;
        quickSellName.textContent = `Sell: ${product.name}`;
        quickSellQty.value = 1;
        quickSellPrice.value = product.mrp || 0; // Pre-fill with MRP
        
        quickSellModalBackdrop.classList.remove('hide');
        
        // Focus Price first (as requested to ask for price)
        setTimeout(() => quickSellPrice.focus(), 100);
    }
    
    closeQuickSellBtn.onclick = () => quickSellModalBackdrop.classList.add('hide');
    
    quickSellModal.onsubmit = async function(e) {
        e.preventDefault();
        if(!quickSellProductTarget) return;
        
        const qtyToSell = parseInt(quickSellQty.value);
        const actualSellPrice = parseFloat(quickSellPrice.value) || 0;
        
        if(qtyToSell <= 0) return;
        if(actualSellPrice < 0) { alert("Price cannot be negative."); return; }
        
        // Update Stock
        const currentQty = quickSellProductTarget.qty || 0;
        const newQty = Math.max(0, currentQty - qtyToSell);
        quickSellProductTarget.qty = newQty;
        
        // Calculate Profit
        const costPrice = quickSellProductTarget.cost || 0;
        const profit = (actualSellPrice - costPrice) * qtyToSell;
        
        // Log to History
        const logEntry = {
            productId: quickSellProductTarget.id,
            productName: quickSellProductTarget.name,
            qtySold: qtyToSell,
            salePricePerUnit: actualSellPrice,
            costPricePerUnit: costPrice,
            totalValue: qtyToSell * actualSellPrice,
            totalProfit: profit,
            timestamp: new Date().toISOString()
        };
        
        try {
            await logSaleToDB(logEntry);
            await saveProducts(); // Saves updated qty and refreshes UI
            
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            
            // Close
            quickSellModalBackdrop.classList.add('hide');
            quickSellProductTarget = null;
        } catch(err) {
            alert("Error saving sale: " + err.message);
        }
    };
    
    /****************************************************************
     * NEW FEATURE: HISTORY LOGIC (Updated with Delete)
     ****************************************************************/
    const historyBtn = document.getElementById('historyBtn');
    const historyModalBackdrop = document.getElementById('historyModalBackdrop');
    const historyList = document.getElementById('historyList');
    const closeHistoryBtn = document.getElementById('closeHistoryBtn');
    
    async function loadHistoryItems() {
        historyList.innerHTML = '<div style="text-align:center;padding:20px;">Loading history...</div>';
        
        try {
            const history = await getSalesHistoryFromDB();
            
            if(!history || history.length === 0) {
                historyList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">No sales recorded yet.</div>';
                return;
            }
            
            // Sort newest first
            history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let html = '';
            history.forEach(item => {
                const dateObj = new Date(item.timestamp);
                const dateStr = dateObj.toLocaleDateString();
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const salePrice = item.salePricePerUnit || 0;
                const costPrice = item.costPricePerUnit || 0;
                const profit = item.totalProfit !== undefined ? item.totalProfit : ((salePrice - costPrice) * item.qtySold);
                
                const profitColor = profit >= 0 ? 'var(--success)' : 'var(--danger)';
                const profitSign = profit >= 0 ? '+' : '';

                html += `
                    <div class="history-item">
                        <div>
                            <div style="font-weight:700; color:var(--text);">${escapeHTML(item.productName)}</div>
                            <div class="history-meta">${dateStr} at ${timeStr}</div>
                            <div class="history-meta">Sold @ ‚Ç®${salePrice.toLocaleString()} (Cost: ‚Ç®${costPrice.toLocaleString()})</div>
                        </div>
                        <div style="text-align:right; margin-right:10px;">
                            <div style="font-weight:bold; color:var(--text); font-size:1.1em;">-${item.qtySold}</div>
                            <div style="font-size:0.85em; color:var(--text-muted);">Total: ‚Ç®${item.totalValue.toLocaleString()}</div>
                            <div class="history-profit" style="color:${profitColor}">${profitSign}‚Ç®${profit.toLocaleString()}</div>
                        </div>
                        <button class="history-delete-btn" data-id="${item.id}" data-prod-id="${item.productId}" data-qty="${item.qtySold}" title="Delete & Restore Stock">‚úñ</button>
                    </div>
                `;
            });
            historyList.innerHTML = html;
            
            const deleteBtns = historyList.querySelectorAll('.history-delete-btn');
            deleteBtns.forEach(btn => {
                btn.onclick = async function() {
                    const id = Number(this.getAttribute('data-id'));
                    const prodId = this.getAttribute('data-prod-id');
                    const qty = Number(this.getAttribute('data-qty'));
                    
                    if(!confirm("Remove this record and restore " + qty + " item(s) to stock?")) return;
                    
                    try {
                        await deleteSaleFromDB(id);
                        
                        const product = products.find(p => p.id === prodId);
                        if(product) {
                            product.qty = (product.qty || 0) + qty;
                            await saveProducts(); 
                        }
                        
                        loadHistoryItems();
                        
                    } catch(err) {
                        alert("Error removing item: " + err.message);
                    }
                };
            });
            
        } catch(err) {
            console.error(err);
            historyList.innerHTML = `<div style="color:var(--danger)">Error loading history.</div>`;
        }
    }
    
    historyBtn.onclick = function() {
        historyModalBackdrop.classList.remove('hide');
        loadHistoryItems();
    };
    
    closeHistoryBtn.onclick = () => historyModalBackdrop.classList.add('hide');

    // --- NEW: CATEGORY BUTTON & MODAL LOGIC ---
    const categoryBtn = document.getElementById('categoryFilterBtn');
    const categoryModalBackdrop = document.getElementById('categoryModalBackdrop');
    const categoryGrid = document.getElementById('categoryGrid');
    const closeCategoryBtn = document.getElementById('closeCategoryBtn');
    const activeCategoryDisplay = document.getElementById('activeCategoryDisplay');

    categoryBtn.onclick = function() {
        const uniqueCategories = [...new Set(products.map(p => p.category ? p.category.trim() : "").filter(c => c))];
        uniqueCategories.sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        
        const seenLower = new Set();
        const cleanedCats = [];
        uniqueCategories.forEach(c => {
            const low = c.toLowerCase();
            if(!seenLower.has(low)){
                seenLower.add(low);
                const niceName = c.charAt(0).toUpperCase() + c.slice(1);
                cleanedCats.push(niceName);
            }
        });
        
        let html = `<div class="category-item-btn ${activeCategoryFilter === null ? 'active' : ''}" onclick="selectCategory(null)">All Categories</div>`;
        cleanedCats.forEach(cat => {
            const isActive = (activeCategoryFilter && activeCategoryFilter.toLowerCase() === cat.toLowerCase()) ? 'active' : '';
            html += `<div class="category-item-btn ${isActive}" onclick="selectCategory('${escapeHTML(cat)}')">${escapeHTML(cat)}</div>`;
        });
        
        categoryGrid.innerHTML = html;
        categoryModalBackdrop.classList.remove('hide');
    };

    closeCategoryBtn.onclick = function() { categoryModalBackdrop.classList.add('hide'); };

    window.selectCategory = function(cat) {
        activeCategoryFilter = cat; // null means 'All'
        categoryModalBackdrop.classList.add('hide');
        refreshProductList();
        
        if(activeCategoryFilter) {
            try { history.pushState({category: true}, document.title, window.location.href); } catch(e){}
        }
    };

    activeCategoryDisplay.onclick = function() {
        activeCategoryFilter = null;
        refreshProductList();
    };

    function refreshProductList() {
      // FIX NO 1: Memory Leak Protection - Revoke old object URLs
      activeObjectUrls.forEach(url => URL.revokeObjectURL(url));
      activeObjectUrls = [];

      productListElem.innerHTML = '';
      let q = (searchInput.value || '').trim().toLowerCase();
      const terms = q.split(/\s+/).filter(t => t.length > 0);
      
      let filtered = products;

      if (terms.length > 0) {
          filtered = products.filter(prod => {
             // MODIFIED: Search inside Barcode field too!
             const searchString = ((prod.name || "") + " " + (prod.barcode || "") + " " + (prod.category || "") + " " + (prod.notes || "")).toLowerCase();
             return terms.every(term => searchString.includes(term));
          });
      }

      if (activeCategoryFilter) {
          const targetLower = activeCategoryFilter.toLowerCase();
          filtered = filtered.filter(p => (p.category || '').trim().toLowerCase() === targetLower);
          
          const displayNice = activeCategoryFilter.charAt(0).toUpperCase() + activeCategoryFilter.slice(1);
          activeCategoryDisplay.textContent = `Filtered by: ${displayNice} ‚úñ`;
          activeCategoryDisplay.classList.add('show');
      } else {
          activeCategoryDisplay.classList.remove('show');
      }
      
      currentFilteredProducts = filtered;

      if (!filtered.length) { noProductsElem.style.display = ""; document.getElementById('multiSelectControls').classList.remove('active'); return; }
      noProductsElem.style.display = "none";
      
      filtered.sort((a,b) => {
          const catA = (a.category || '').trim().toLowerCase();
          const catB = (b.category || '').trim().toLowerCase();
          if (catA < catB) return -1;
          if (catA > catB) return 1;
          return (a.name || '').localeCompare(b.name || '');
      });
      
      const fragment = document.createDocumentFragment();
      let lastCategoryLower = "@@INIT@@";

      filtered.forEach((prod,i) => {
          const currentCatRaw = (prod.category || '').trim();
          const currentCatLower = currentCatRaw.toLowerCase();
          
          let displayCat = currentCatRaw || "Uncategorized";
          if (displayCat !== "Uncategorized") {
              displayCat = displayCat.charAt(0).toUpperCase() + displayCat.slice(1);
          }
          
          if (currentCatLower !== lastCategoryLower) {
              const header = document.createElement('div');
              header.className = 'category-header';
              header.textContent = `--- ${displayCat} ---`;
              fragment.appendChild(header);
              lastCategoryLower = currentCatLower;
          }

          // FIX NO 1: Register URL after creation
          const card = createProductCard(prod,i);
          fragment.appendChild(card);
      });
      productListElem.appendChild(fragment);
      
      updateMultiSelectControls();
    }

    let productEditing = null;
    const prodName = document.getElementById('prodName');
    const prodBarcode = document.getElementById('prodBarcode'); 
    const prodMrp = document.getElementById('prodMrp');
    const prodCost = document.getElementById('prodCost');
    const prodQty = document.getElementById('prodQty');
    const prodCategory = document.getElementById('prodCategory');
    const prodNotes = document.getElementById('prodNotes');
    const prodPhoto = document.getElementById('prodPhoto');
    const prodCamera = document.getElementById('prodCamera');
    const productModalBackdrop = document.getElementById('productModalBackdrop');
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modalError');
    const uploadBtnInnerText = document.getElementById('uploadBtnInnerText');
    const prodPhotoList = document.getElementById('prodPhotoList');
    const fileUploadWrap = document.getElementById('fileUploadWrap');
    const imageCompressMsg = document.getElementById('imageCompressMsg');
    
    // CHANGED: Array to hold multiple blobs
    let currentProductBlobs = [];

    /****************************************************************
     * BINARY BLOB COMPRESSION (NO BASE64 STRINGS)
     ****************************************************************/
    async function compressImageFileToBlob(file, maxDim = 800, quality = 0.85) { 
      // 1. SAFETY CHECK
      if (file.size > 20 * 1024 * 1024) return Promise.reject("File too large (>20MB).");
      if (!/^image\//.test(file.type)) return Promise.reject("Not an image file.");
      
      // 2. ATTEMPT: createImageBitmap (Low Memory)
      if ('createImageBitmap' in window) {
          try {
              const bitmap = await createImageBitmap(file);
              let { width, height } = bitmap;
              if (width > maxDim || height > maxDim) {
                  const scale = maxDim / Math.max(width, height);
                  width = Math.round(width * scale);
                  height = Math.round(height * scale);
              }
              const canvas = document.createElement('canvas');
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(bitmap, 0, 0, width, height);
              bitmap.close(); 
              
              return new Promise((resolve, reject) => {
                  canvas.toBlob(blob => {
                      canvas.width = 0; canvas.height = 0; 
                      if (!blob) return reject("Compression error.");
                      resolve(blob);
                  }, 'image/jpeg', quality);
              });
          } catch(e) {
              console.warn("createImageBitmap failed, falling back.", e);
          }
      }

      // 3. FALLBACK: Standard Image Load
      return new Promise((resolve, reject) => {
        let img = new window.Image();
        let url = URL.createObjectURL(file);
        
        img.onload = function() {
          let [w, h] = [img.naturalWidth, img.naturalHeight];
          if (w > maxDim || h > maxDim) {
            if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
            else { w = Math.round(w * maxDim / h); h = maxDim; }
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          URL.revokeObjectURL(url);
          img.src = ""; img = null;

          canvas.toBlob(blob => {
            canvas.width = 0; canvas.height = 0; 
            if (!blob) return reject("Compression error.");
            resolve(blob);
          }, 'image/jpeg', quality);
        };
        img.onerror = () => { URL.revokeObjectURL(url); img = null; reject("Invalid image data"); };
        img.src = url;
      });
    }

    // UPDATE UI TO SHOW LIST OF THUMBNAILS
    function updatePhotoPreviewUI() {
      prodPhotoList.innerHTML = '';
      currentProductBlobs.forEach((blob, index) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'photo-preview-item';
          
          const img = document.createElement('img');
          // Handle Blob vs String
          if (blob instanceof Blob) {
              img.src = URL.createObjectURL(blob);
          } else {
              img.src = blob; 
          }
          img.className = 'photo-preview-img-thumb';
          
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button'; 
          removeBtn.className = 'remove-photo-btn'; 
          removeBtn.innerHTML = '‚úñ';
          removeBtn.onclick = () => {
              currentProductBlobs.splice(index, 1);
              updatePhotoPreviewUI();
          };
          
          itemDiv.appendChild(img);
          itemDiv.appendChild(removeBtn);
          prodPhotoList.appendChild(itemDiv);
      });
      
      if(currentProductBlobs.length === 0) {
          imageCompressMsg.style.display = 'none';
      }
    }

    function showProductModal(mode, product) {
      productModal.reset(); 
      modalError.textContent = ''; 
      currentProductBlobs = []; 
      imageCompressMsg.style.display = 'none'; 
      
      if (mode === 'add') {
        modalTitle.textContent = "Add Product"; productEditing = null;
        prodName.value = ""; prodBarcode.value = ""; prodMrp.value = ""; prodCost.value = ""; prodQty.value = ""; prodCategory.value = activeCategoryFilter || ""; prodNotes.value = "";
      } else {
        modalTitle.textContent = "Edit Product"; productEditing = product;
        prodName.value = product.name || ""; prodBarcode.value = product.barcode || ""; prodMrp.value = product.mrp !== undefined ? product.mrp : ""; prodCost.value = product.cost !== undefined ? product.cost : ""; prodQty.value = product.qty !== undefined ? product.qty : ""; prodCategory.value = product.category || ""; prodNotes.value = product.notes || "";
        
        // Load existing photos
        if (product.photos && Array.isArray(product.photos)) {
            currentProductBlobs = [...product.photos];
        } else if (product.photo) {
            currentProductBlobs = [product.photo]; // Backward compatibility
        }
      }
      updatePhotoPreviewUI();
      productModalBackdrop.classList.remove('hide');
      if (!document.body.classList.contains('modal-open')) { document.body.dataset.scrollY = window.scrollY; document.body.style.top = `-${window.scrollY}px`; document.body.classList.add('modal-open'); }
      setTimeout(()=>prodName.focus(),150);
      firstSubmitAttempt = true;
    }

    let firstSubmitAttempt = true;
    let prodPhotoLastPendingPromise = null;

    // --- SHARED IMAGE HANDLER FOR BOTH BUTTONS ---
    function handleImageSelection(files) {
        if(!files || files.length === 0) return;
        
        imageCompressMsg.textContent = `Processing ${files.length} image(s)...`; 
        imageCompressMsg.style.display = 'block';
        
        const promises = Array.from(files).map(file => compressImageFileToBlob(file, 1200, 0.90));
        
        const allPromise = Promise.all(promises).then(blobs => {
             blobs.forEach(blob => {
                 if(blob) currentProductBlobs.push(blob);
             });
             updatePhotoPreviewUI();
             imageCompressMsg.textContent = `${currentProductBlobs.length} photo(s) attached`;
        }).catch(err => {
            console.error(err);
            modalError.textContent = "Some photos failed to process.";
        });
        
        prodPhotoLastPendingPromise = allPromise;
    }

    prodPhoto.addEventListener('change', function () {
      if (prodPhoto.files && prodPhoto.files.length) {
          handleImageSelection(prodPhoto.files);
      }
    });
    
    prodCamera.addEventListener('change', function () {
      if (prodCamera.files && prodCamera.files.length) {
          handleImageSelection(prodCamera.files);
      }
    });

    document.getElementById('addProductBtn').onclick = ()=>showProductModal('add');
    document.getElementById('closeModalBtn').onclick = ()=>{
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) { document.body.classList.remove('modal-open'); const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0; document.body.style.top = ''; window.scrollTo(0, scrollY); delete document.body.dataset.scrollY; }
      imageCompressMsg.style.display = 'none';
    };

    productModal.onsubmit = async function(e) {
      e.preventDefault(); modalError.textContent = "";
      
      // Wait for images to finish processing
      if (prodPhotoLastPendingPromise) {
          try { await prodPhotoLastPendingPromise; } catch(e) {}
      }

      firstSubmitAttempt = false;
      const name = (prodName.value || '').trim(); const barcodeVal = (prodBarcode.value || '').trim(); const mrpVal = prodMrp.value; const costVal = prodCost.value; const qtyVal = prodQty.value; const notes = (prodNotes.value || '').trim();
      
      let category = (prodCategory.value || '').trim();
      if(category.length > 0) {
          category = category.charAt(0).toUpperCase() + category.slice(1);
      }
      
      if (!name) { modalError.textContent = "Name required."; return; }
      if (mrpVal === "" || isNaN(Number(mrpVal)) || Number(mrpVal) < 0) { modalError.textContent = "Valid MRP required."; return; }
      if (qtyVal === "" || isNaN(Number(qtyVal)) || Number(qtyVal) < 0) { modalError.textContent = "Valid quantity required."; return; }
      
      // Store the Array of BLOBS
      const productObj = { id: productEditing ? productEditing.id : genID(), name, barcode: barcodeVal, mrp: Number(mrpVal), cost: costVal !== "" ? Number(costVal) : null, qty: Number(qtyVal), category, notes, photos: currentProductBlobs };
      
      // Remove old photo property if it exists on edit
      if(productObj.photo) delete productObj.photo;
      
      if (!productEditing) products.push(productObj); else { const idx = products.findIndex(p => p.id === productEditing.id); if (idx >= 0) products[idx] = productObj; else products.push(productObj); }
      
      saveProducts();
      
      productModalBackdrop.classList.add('hide');
      if (document.body.classList.contains('modal-open')) { document.body.classList.remove('modal-open'); const scrollY = document.body.dataset.scrollY ? parseInt(document.body.dataset.scrollY, 10) : 0; document.body.style.top = ''; window.scrollTo(0, scrollY); delete document.body.dataset.scrollY; }
      selectedProductIds.clear(); updateMultiSelectControls();
    };

    const deleteModalBackdrop = document.getElementById('deleteModalBackdrop');
    const deleteModal = document.getElementById('deleteModal');
    const deleteName = document.getElementById('deleteName');
    let productToDelete = null;

    function showDeleteModal(product) { deleteModalBackdrop.classList.remove('hide'); deleteName.textContent = product.name || ''; productToDelete = product; setTimeout(()=>document.getElementById('cancelDeleteBtn').focus(),60); }
    document.getElementById('closeDeleteBtn').onclick = document.getElementById('cancelDeleteBtn').onclick = () => { deleteModalBackdrop.classList.add('hide'); productToDelete = null; };
    deleteModal.onsubmit = function(e){ e.preventDefault(); if (!productToDelete) return; products = products.filter(p => p.id !== productToDelete.id); saveProducts(); deleteModalBackdrop.classList.add('hide'); productToDelete = null; selectedProductIds.delete(productToDelete.id); updateMultiSelectControls(); };
    function genID() { return 'p' + (Date.now() + ('' + Math.random()).slice(2,7)); }

    /****************************************************************
     * SHARE / PDF LOGIC
     ****************************************************************/
    const shareModalBackdrop = document.getElementById('shareModalBackdrop');
    const closeShareBtn = document.getElementById('closeShareBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const shareSubtitle = document.getElementById('shareSubtitle');
    
    const chkPhoto = document.getElementById('sharePhoto');
    const chkMrp = document.getElementById('shareMrp');
    const chkCost = document.getElementById('shareCost');
    const chkQty = document.getElementById('shareQty');
    const chkCategory = document.getElementById('shareCategory');
    const chkNotes = document.getElementById('shareNotes');
    
    let productsToShareQueue = [];
    
    function openShareModal(product, list = null) {
        if(list) {
            productsToShareQueue = list;
            shareSubtitle.textContent = `Generate PDF for ${list.length} selected product(s).`;
        } else {
            productsToShareQueue = [product];
            shareSubtitle.textContent = "Select fields to include in the generated PDF/Print.";
        }
        chkPhoto.checked = true; chkMrp.checked = true; chkCost.checked = false; chkQty.checked = true; chkCategory.checked = true; chkNotes.checked = true;
        shareModalBackdrop.classList.remove('hide');
    }
    closeShareBtn.onclick = () => { shareModalBackdrop.classList.add('hide'); productsToShareQueue = []; };
    
    generatePdfBtn.onclick = function() {
        if(productsToShareQueue.length === 0) return;
        const printableArea = document.getElementById('printableArea');
        let fullHtml = '';
        productsToShareQueue.forEach(prod => {
            
            // Collect all photos
            let photoHtml = "";
            if (chkPhoto.checked && prod.photos && prod.photos.length > 0) {
                photoHtml = `<div class="print-gallery">`;
                prod.photos.forEach(p => {
                    const src = getPhotoSrc(p);
                    if(src) photoHtml += `<img src="${src}" class="print-product-img" />`;
                });
                photoHtml += `</div>`;
            } else if (chkPhoto.checked && prod.photo) {
                // legacy
                 const src = getPhotoSrc(prod.photo);
                 if(src) photoHtml = `<div class="print-gallery"><img src="${src}" class="print-product-img" /></div>`;
            }

            let html = `
                <div class="print-product-page">
                    <div class="print-header">
                        <img src="https://github.com/ashardiyan/test/blob/main/Al%20Rahman%20Electronics-02.png?raw=true" class="print-logo" />
                        <div class="print-title">Al Rehman Electronics</div>
                        <div style="font-size:14px;color:#555">Product Specification Sheet</div>
                        <div style="font-size:12px;color:#777">Generated: ${new Date().toLocaleDateString()}</div>
                    </div>
                    <h1 style="text-align:center;margin-top:20px;">${escapeHTML(prod.name)}</h1>
                    ${photoHtml}
            `;
            html += `<table class="print-details-table"><tbody>`;
            if(chkCategory.checked && prod.category) { html += `<tr><td class="print-label">Category</td><td>${escapeHTML(prod.category)}</td></tr>`; }
            // Include barcode in print
            if(prod.barcode) { html += `<tr><td class="print-label">Barcode</td><td>${escapeHTML(prod.barcode)}</td></tr>`; }
            if(chkQty.checked) { html += `<tr><td class="print-label">In Stock</td><td>${prod.qty}</td></tr>`; }
            if(chkMrp.checked) { html += `<tr><td class="print-label">Price (MRP)</td><td>‚Ç® ${Number(prod.mrp).toLocaleString()}</td></tr>`; }
            if(chkCost.checked && prod.cost !== null && prod.cost !== undefined) { html += `<tr><td class="print-label">Cost Price</td><td>‚Ç® ${Number(prod.cost).toLocaleString()}</td></tr>`; }
            html += `</tbody></table>`;
            if(chkNotes.checked && prod.notes) { html += `<div class="print-notes-box"><strong>Notes:</strong><br/>${escapeHTML(prod.notes)}</div>`; }
            html += `<div style="text-align:center; margin-top:50px; font-size:12px; color:#888;">Thank you for your interest. For any detail contact on this Phone number:0300-3685270</div></div>`;
            fullHtml += html;
        });
        printableArea.innerHTML = fullHtml;
        shareModalBackdrop.classList.add('hide');
        setTimeout(() => { window.print(); productsToShareQueue = []; }, 300);
    };

    /****************************************************************
     * SUPER SCANNER LOGIC (Confirm/Retry) - FIXED for Performance
     ****************************************************************/
    const scanSearchBtn = document.getElementById('scanSearchBtn');
    const scanModalBtn = document.getElementById('scanModalBtn');
    const scannerOverlay = document.getElementById('scannerOverlay');
    const scannerVideo = document.getElementById('scannerVideo');
    const closeScannerBtn = document.getElementById('closeScannerBtn');
    const zoomControl = document.getElementById('zoomControl');
    const zoomSlider = document.getElementById('zoomSlider');
    const toggleTorchBtn = document.getElementById('toggleTorchBtn');
    
    // Confirmation UI Elements
    const scanConfirmation = document.getElementById('scanConfirmation');
    const scannedCodeDisplay = document.getElementById('scannedCodeDisplay');
    const scanRetryBtn = document.getElementById('scanRetryBtn');
    const scanConfirmBtn = document.getElementById('scanConfirmBtn');
    
    let scannerStream = null;
    let scannerTimeout = null; // REPLACED interval with timeout
    let activeScanTarget = null;
    let videoTrack = null;
    let currentScannedCode = null; 

    async function startScanner(target) {
        if (!('BarcodeDetector' in window)) {
            alert("‚ö†Ô∏è Camera scanning not supported in this browser.\n\n" +
                  "Supported browsers:\n" +
                  "‚Ä¢ Chrome/Edge on Android\n" +
                  "‚Ä¢ Chrome on Desktop\n\n" +
                  "Please type the barcode manually or switch browsers.");
            return;
        }

        activeScanTarget = target;
        scanConfirmation.style.display = 'none'; // Hide confirmation initially

        try {
            // 1. Ask for High Resolution (1080p) to see thin lines
            const constraints = {
                video: { 
                    facingMode: { ideal: "environment" },
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    focusMode: { ideal: "continuous" }
                },
                audio: false
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            scannerStream = stream;
            scannerVideo.srcObject = stream;
            scannerOverlay.classList.add('show');
            
            videoTrack = stream.getVideoTracks()[0];
            const capabilities = videoTrack.getCapabilities();

            // 2. ENABLE ZOOM (If supported)
            if (capabilities.zoom) {
                zoomControl.style.display = 'flex';
                zoomSlider.min = capabilities.zoom.min;
                zoomSlider.max = capabilities.zoom.max;
                zoomSlider.step = capabilities.zoom.step;
                zoomSlider.value = 1; // Start at 1x
                
                zoomSlider.oninput = async () => {
                    await videoTrack.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
                };
            } else {
                zoomControl.style.display = 'none';
            }

            // 3. ENABLE TORCH (If supported)
            if (capabilities.torch) {
                toggleTorchBtn.style.display = 'block';
                let torchState = false;
                toggleTorchBtn.onclick = async () => {
                    torchState = !torchState;
                    await videoTrack.applyConstraints({ advanced: [{ torch: torchState }] });
                    toggleTorchBtn.style.background = torchState ? 'rgba(6, 182, 212, 0.6)' : 'rgba(255,255,255,0.2)';
                };
            } else {
                toggleTorchBtn.style.display = 'none';
            }

            // 4. DETECT SUPPORTED FORMATS
            const supportedFormats = await BarcodeDetector.getSupportedFormats();
            const barcodeDetector = new BarcodeDetector({ formats: supportedFormats });

            startDetectionLoop(barcodeDetector);

        } catch (err) {
            console.error(err);
            alert("Camera error: " + err.message);
            stopScanner();
        }
    }

    function startDetectionLoop(detector) {
        // Clear any previous timeout just in case
        if (scannerTimeout) clearTimeout(scannerTimeout);

        const scanLoop = async () => {
            // Check if overlay is still visible to stop processing if closed
            if (!scannerOverlay.classList.contains('show')) return;
            
            if (scannerVideo.videoWidth) {
                try {
                    const barcodes = await detector.detect(scannerVideo);
                    if (barcodes.length > 0) {
                        const code = barcodes[0].rawValue;
                        currentScannedCode = code;

                        // DIRECT ACTION FOR SEARCH (No Confirmation)
                        if (activeScanTarget === 'search') {
                            stopScanner();
                            searchInput.value = code;
                            searchInput.dispatchEvent(new Event('input'));
                            if (navigator.vibrate) navigator.vibrate(50);
                            return; // Stop looping
                        }

                        // CONFIRMATION FOR ADD/EDIT (Modal)
                        // Pause the loop by NOT calling setTimeout again
                        scannedCodeDisplay.textContent = code;
                        scanConfirmation.style.display = 'flex';
                        
                        if (navigator.vibrate) navigator.vibrate(100);
                        return; // Stop looping to wait for user action
                    }
                } catch (err) {
                    // console.error(err);
                }
            }

            // Recursively schedule the next scan only after processing finishes
            scannerTimeout = setTimeout(scanLoop, 200);
        };

        scanLoop();
    }

    // RETRY Button Logic - Restarts the loop
    scanRetryBtn.onclick = async () => {
        scanConfirmation.style.display = 'none';
        currentScannedCode = null;
        const supportedFormats = await BarcodeDetector.getSupportedFormats();
        const barcodeDetector = new BarcodeDetector({ formats: supportedFormats });
        startDetectionLoop(barcodeDetector);
    };

    // PASTE/CONFIRM Button Logic
    scanConfirmBtn.onclick = () => {
        if(!currentScannedCode) return;
        
        // --- FIXED: CAPTURE TARGET BEFORE CLOSING ---
        const target = activeScanTarget; // Save the target because stopScanner() clears it
        const code = currentScannedCode;
        
        stopScanner();
        
        if (target === 'search') {
             searchInput.value = code;
             searchInput.dispatchEvent(new Event('input'));
        } else if (target === 'modal') {
             const prodBarcode = document.getElementById('prodBarcode');
             
             // 1. Get current values into an array
             let codes = prodBarcode.value ? prodBarcode.value.split(',').map(s => s.trim()).filter(s => s) : [];
             
             // 2. Add new code if unique
             if (!codes.includes(code)) {
                 codes.push(code);
                 
                 // 3. FIFO Logic: If more than 3, remove the first one
                 if (codes.length > 3) {
                     codes.shift(); 
                 }
                 
                 // 4. Update Input
                 prodBarcode.value = codes.join(', ');
             }
        }
    };

function stopScanner() {
        // FIX: Pause the video element to release DOM memory immediately
        if (scannerVideo) {
            scannerVideo.pause();
            scannerVideo.srcObject = null;
        }

        // Stop the camera hardware
        if (scannerStream) {
            scannerStream.getTracks().forEach(track => {
                track.stop();
            });
            scannerStream = null;
        }

        // Clear timeout logic
        if (scannerTimeout) {
            clearTimeout(scannerTimeout);
            scannerTimeout = null;
        }

        // Hide UI
        scannerOverlay.classList.remove('show');
        scanConfirmation.style.display = 'none'; 
        activeScanTarget = null;
        videoTrack = null;
    }

    scanSearchBtn.onclick = () => startScanner('search');
    scanModalBtn.onclick = () => startScanner('modal');
    closeScannerBtn.onclick = stopScanner;
</script>

</body>
</html>
